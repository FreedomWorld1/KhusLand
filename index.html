<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CC-Shop Finanzsystem</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.bunny.net/css?family=inter:400,500,600,700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; color: #e2e8f0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; background: rgba(26, 32, 44, 0.9); padding: 1.5rem 2rem; border-radius: 15px; border: 1px solid rgba(101, 119, 149, 0.3); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        
        .connection-panel {
            background: rgba(30, 41, 59, 0.8);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            border: 1px solid rgba(101, 119, 149, 0.3);
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-indicator.connected {
            background: rgba(72, 187, 120, 0.2);
            color: #48bb78;
            border: 1px solid #48bb78;
        }
        
        .status-indicator.disconnected {
            background: rgba(245, 101, 101, 0.2);
            color: #f56565;
            border: 1px solid #f56565;
        }
        
        .status-indicator.connecting {
            background: rgba(246, 173, 85, 0.2);
            color: #f6ad55;
            border: 1px solid #f6ad55;
        }
        
        .hold-section { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .hold-balance-card { background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); padding: 2rem; border-radius: 15px; text-align: center; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .available-balance-card { background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%); padding: 2rem; border-radius: 15px; text-align: center; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .balance-label { font-size: 1.1rem; opacity: 0.9; margin-bottom: 0.5rem; }
        .balance-amount { font-size: 3.5rem; font-weight: bold; margin: 1rem 0; }
        .balance-detail { font-size: 0.9rem; opacity: 0.8; }
        
        .transaction-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .transaction-btn { padding: 1.2rem 1rem; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; }
        .hold-btn { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .deposit-btn { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); color: white; }
        .withdraw-btn { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); color: white; }
        .transaction-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        
        .debug-panel {
            background: rgba(26, 32, 44, 0.9);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid rgba(101, 119, 149, 0.3);
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-message {
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(101, 119, 149, 0.2);
        }
        
        .debug-message.success { color: #48bb78; }
        .debug-message.error { color: #f56565; }
        .debug-message.info { color: #4299e1; }
        .debug-message.warning { color: #f6ad55; }
        
        .btn-test {
            padding: 0.5rem 1rem;
            background: rgba(66, 153, 225, 0.2);
            color: #90cdf4;
            border: 1px solid #4299e1;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }
        
        .btn-test:hover {
            background: rgba(66, 153, 225, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 style="color: #90cdf4; font-size: 2rem;">
                <i class="fas fa-chart-line"></i> CC-Shop Finanzsystem
            </h1>
            <div>
                <div class="status-indicator connecting" id="statusIndicator">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <span id="statusText">Verbinde mit Firebase...</span>
                </div>
            </div>
        </div>
        
        <!-- Connection Panel -->
        <div class="connection-panel">
            <h3 style="color: #90cdf4; margin-bottom: 1rem;">
                <i class="fas fa-plug"></i> Firebase Verbindung
            </h3>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                <button class="btn-test" onclick="testConnection()">
                    <i class="fas fa-bolt"></i> Verbindung testen
                </button>
                <button class="btn-test" onclick="createTestData()">
                    <i class="fas fa-vial"></i> Testdaten erstellen
                </button>
                <button class="btn-test" onclick="clearAllData()">
                    <i class="fas fa-trash"></i> Daten löschen
                </button>
                <button class="btn-test" onclick="showDatabaseContent()">
                    <i class="fas fa-database"></i> Datenbank anzeigen
                </button>
                <button class="btn-test" onclick="clearDebugLog()">
                    <i class="fas fa-broom"></i> Log löschen
                </button>
            </div>
            
            <div id="debugLog" class="debug-panel">
                <!-- Debug messages will appear here -->
            </div>
        </div>
        
        <!-- Hold Information -->
        <div style="background: rgba(139, 92, 246, 0.1); border-left: 4px solid #8b5cf6; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0 8px 8px 0;">
            <i class="fas fa-info-circle" style="color: #8b5cf6;"></i>
            <strong style="margin-left: 8px;">Deine Einnahmen werden erst 2 Tage nach dem Kauf freigegeben.</strong> 
        </div>
        
        <!-- Balance Cards -->
        <div class="hold-section">
            <div class="hold-balance-card">
                <div class="balance-label">Zurückgehaltene Beträge</div>
                <div class="balance-amount" id="holdBalance" style="color: white;">0 $</div>
                <div class="balance-detail">Werden zu den jeweiligen Freigabedaten verfügbar</div>
            </div>
            
            <div class="available-balance-card">
                <div class="balance-label">Verfügbares Guthaben</div>
                <div class="balance-amount" id="availableBalance">0 $</div>
                <div class="balance-detail">Sofort verfügbar für Auszahlungen</div>
            </div>
        </div>
        
        <!-- Transaction Buttons -->
        <div class="transaction-buttons">
            <button class="transaction-btn hold-btn" onclick="openHoldModal()">
                <i class="fas fa-pause-circle"></i>
                <span>Betrag zurückhalten</span>
            </button>
            <button class="transaction-btn deposit-btn" onclick="openDepositModal()">
                <i class="fas fa-plus-circle"></i>
                <span>Direkt einzahlen</span>
            </button>
            <button class="transaction-btn withdraw-btn" onclick="openWithdrawModal()">
                <i class="fas fa-minus-circle"></i>
                <span>Auszahlen</span>
            </button>
        </div>
    </div>
    
    <!-- Debug Modal -->
    <div id="debugModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: #1a202c; padding: 2rem; border-radius: 10px; max-width: 800px; max-height: 80vh; overflow: auto; width: 90%;">
            <h3 style="color: #90cdf4; margin-bottom: 1rem;">
                <i class="fas fa-database"></i> Firebase Datenbank-Inhalt
            </h3>
            <pre id="databaseContent" style="background: #2d3748; padding: 1rem; border-radius: 5px; color: #e2e8f0; font-family: monospace; white-space: pre-wrap; max-height: 60vh; overflow: auto;"></pre>
            <div style="margin-top: 1rem; text-align: right;">
                <button onclick="closeDebugModal()" style="padding: 0.5rem 1rem; background: #4a5568; color: white; border: none; border-radius: 5px; cursor: pointer;">Schließen</button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" style="position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1001; transform: translateX(150%); transition: transform 0.3s ease;"></div>

    <!-- Firebase Script -->
    <script type="module">
        // Firebase Import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        // Firebase Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyB7AmLb6NwR8sKyDXtIhmghGszpX_VsICY",
            authDomain: "cc-shop-36c3b.firebaseapp.com",
            databaseURL: "https://cc-shop-36c3b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cc-shop-36c3b",
            storageBucket: "cc-shop-36c3b.firebasestorage.app",
            messagingSenderId: "376170741825",
            appId: "1:376170741825:web:bc6102e277da5ad7cbc6c0",
            measurementId: "G-FJVHHQWZFW"
        };

        // Globale Variablen
        let app;
        let db;
        let transactionsRef;
        let balanceRef;
        let isConnected = false;
        let debugLog = [];

        // Debug Funktionen
        function addDebugMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push({ timestamp, message, type });
            
            const logElement = document.getElementById('debugLog');
            if (logElement) {
                const messageElement = document.createElement('div');
                messageElement.className = `debug-message ${type}`;
                messageElement.innerHTML = `<span style="color: #a0aec0;">[${timestamp}]</span> ${message}`;
                logElement.appendChild(messageElement);
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearDebugLog() {
            debugLog = [];
            const logElement = document.getElementById('debugLog');
            if (logElement) {
                logElement.innerHTML = '';
            }
            addDebugMessage('Debug-Log geleert', 'info');
        }

        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const textElement = document.getElementById('statusText');
            
            indicator.className = `status-indicator ${status}`;
            textElement.textContent = text;
            
            addDebugMessage(`Status: ${text}`, status === 'error' ? 'error' : 'info');
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'success' ? '#48bb78' : 
                                               type === 'error' ? '#f56565' : 
                                               type === 'warning' ? '#f6ad55' : '#4299e1';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
            
            addDebugMessage(`Notification: ${message}`, type);
        }

        // Firebase Initialisierung
        async function initializeFirebase() {
            try {
                addDebugMessage('Initialisiere Firebase...', 'info');
                updateStatus('connecting', 'Firebase wird initialisiert...');
                
                // App initialisieren
                app = initializeApp(firebaseConfig);
                addDebugMessage('Firebase App initialisiert', 'success');
                
                // Database erhalten
                db = getDatabase(app);
                addDebugMessage('Database Referenz erhalten', 'success');
                
                // Referenzen setzen
                transactionsRef = ref(db, 'finanz_transactions');
                balanceRef = ref(db, 'finanz_balance/current');
                
                // Verbindung testen
                await testConnection();
                
                // Echtzeit-Listener einrichten
                setupRealtimeListeners();
                
            } catch (error) {
                addDebugMessage(`Fehler bei Firebase Initialisierung: ${error.message}`, 'error');
                updateStatus('disconnected', `Fehler: ${error.message}`);
                showNotification('Firebase Fehler!', 'error');
            }
        }

        // Verbindung testen
        async function testConnection() {
            try {
                addDebugMessage('Teste Firebase Verbindung...', 'info');
                updateStatus('connecting', 'Verbindung wird getestet...');
                
                // Einfache Abfrage um Verbindung zu testen
                const testRef = ref(db, '.info/connected');
                onValue(testRef, (snapshot) => {
                    if (snapshot.val() === true) {
                        addDebugMessage('✅ Firebase ist verbunden!', 'success');
                        updateStatus('connected', 'Verbunden mit Firebase');
                        isConnected = true;
                        showNotification('Mit Firebase verbunden!', 'success');
                        
                        // Datenbank-Struktur prüfen und ggf. erstellen
                        checkDatabaseStructure();
                    } else {
                        addDebugMessage('❌ Firebase ist nicht verbunden', 'error');
                        updateStatus('disconnected', 'Nicht verbunden');
                        isConnected = false;
                    }
                }, { onlyOnce: true });
                
                // Alternative Test: Root-Verzeichnis lesen
                const rootSnapshot = await get(ref(db, '/'));
                addDebugMessage(`Datenbank Root gelesen: ${rootSnapshot.exists() ? 'Daten vorhanden' : 'Datenbank leer'}`, 'info');
                
            } catch (error) {
                addDebugMessage(`❌ Verbindungstest fehlgeschlagen: ${error.message}`, 'error');
                updateStatus('disconnected', `Verbindungsfehler: ${error.message}`);
                isConnected = false;
                showNotification('Verbindungsfehler!', 'error');
            }
        }

        // Datenbank-Struktur prüfen und erstellen
        async function checkDatabaseStructure() {
            try {
                addDebugMessage('Prüfe Datenbank-Struktur...', 'info');
                
                // Prüfe ob finanz_transactions existiert
                const transactionsSnapshot = await get(transactionsRef);
                if (!transactionsSnapshot.exists()) {
                    addDebugMessage('Erstelle finanz_transactions...', 'info');
                    await set(transactionsRef, {});
                    addDebugMessage('✅ finanz_transactions erstellt', 'success');
                }
                
                // Prüfe ob finanz_balance existiert
                const balanceSnapshot = await get(balanceRef);
                if (!balanceSnapshot.exists()) {
                    addDebugMessage('Erstelle finanz_balance...', 'info');
                    await set(balanceRef, {
                        amount: 0,
                        lastUpdated: new Date().toISOString(),
                        currency: 'USD'
                    });
                    addDebugMessage('✅ finanz_balance erstellt', 'success');
                }
                
                addDebugMessage('✅ Datenbank-Struktur ist bereit', 'success');
                
            } catch (error) {
                addDebugMessage(`❌ Fehler bei Datenbank-Struktur: ${error.message}`, 'error');
            }
        }

        // Echtzeit-Listener einrichten
        function setupRealtimeListeners() {
            // Transaktionen Listener
            onValue(transactionsRef, (snapshot) => {
                const data = snapshot.val();
                addDebugMessage(`Transaktionen aktualisiert: ${data ? Object.keys(data).length : 0} Einträge`, 'info');
                updateUI();
            }, (error) => {
                addDebugMessage(`❌ Fehler bei Transaktionen-Listener: ${error.message}`, 'error');
            });
            
            // Balance Listener
            onValue(balanceRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    addDebugMessage(`Balance aktualisiert: ${data.amount} USD`, 'info');
                }
                updateUI();
            }, (error) => {
                addDebugMessage(`❌ Fehler bei Balance-Listener: ${error.message}`, 'error');
            });
        }

        // Testdaten erstellen
        async function createTestData() {
            if (!isConnected) {
                showNotification('Nicht mit Firebase verbunden!', 'error');
                return;
            }
            
            try {
                addDebugMessage('Erstelle Testdaten...', 'info');
                
                // Test-Balance
                await set(balanceRef, {
                    amount: 2500,
                    lastUpdated: new Date().toISOString(),
                    currency: 'USD',
                    note: 'Testdaten'
                });
                
                // Test-Transaktionen
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const nextWeek = new Date(today);
                nextWeek.setDate(nextWeek.getDate() + 7);
                
                const testTransactions = [
                    {
                        amount: 500,
                        purchaseDate: yesterday.toISOString().split('T')[0],
                        releaseDate: today.toISOString().split('T')[0],
                        status: 'pending',
                        type: 'hold',
                        description: 'Test Transaktion 1',
                        createdAt: new Date().toISOString()
                    },
                    {
                        amount: 300,
                        purchaseDate: today.toISOString().split('T')[0],
                        releaseDate: tomorrow.toISOString().split('T')[0],
                        status: 'pending',
                        type: 'hold',
                        description: 'Test Transaktion 2',
                        createdAt: new Date().toISOString()
                    },
                    {
                        amount: 1200,
                        purchaseDate: today.toISOString().split('T')[0],
                        releaseDate: today.toISOString().split('T')[0],
                        status: 'released',
                        type: 'deposit',
                        description: 'Test Einzahlung',
                        createdAt: new Date().toISOString()
                    }
                ];
                
                // Vorherige Transaktionen löschen
                await remove(transactionsRef);
                
                // Neue Transaktionen hinzufügen
                for (const transaction of testTransactions) {
                    const newRef = push(transactionsRef);
                    await set(newRef, transaction);
                }
                
                addDebugMessage('✅ Testdaten erfolgreich erstellt!', 'success');
                showNotification('Testdaten erstellt!', 'success');
                
            } catch (error) {
                addDebugMessage(`❌ Fehler beim Erstellen von Testdaten: ${error.message}`, 'error');
                showNotification('Fehler beim Erstellen der Testdaten!', 'error');
            }
        }

        // Alle Daten löschen
        async function clearAllData() {
            if (!confirm('⚠️ WIRKLICH alle Daten löschen?\n\nDies löscht ALLE Transaktionen und setzt die Balance auf 0 zurück.')) {
                return;
            }
            
            try {
                addDebugMessage('Lösche alle Daten...', 'warning');
                
                await remove(transactionsRef);
                await set(balanceRef, {
                    amount: 0,
                    lastUpdated: new Date().toISOString(),
                    currency: 'USD'
                });
                
                addDebugMessage('✅ Alle Daten gelöscht', 'success');
                showNotification('Alle Daten gelöscht!', 'success');
                
            } catch (error) {
                addDebugMessage(`❌ Fehler beim Löschen: ${error.message}`, 'error');
                showNotification('Fehler beim Löschen!', 'error');
            }
        }

        // Datenbank-Inhalt anzeigen
        async function showDatabaseContent() {
            try {
                addDebugMessage('Lade Datenbank-Inhalt...', 'info');
                
                const [transactionsSnapshot, balanceSnapshot] = await Promise.all([
                    get(transactionsRef),
                    get(balanceRef)
                ]);
                
                const content = {
                    finanz_transactions: transactionsSnapshot.exists() ? transactionsSnapshot.val() : 'KEINE DATEN',
                    finanz_balance: balanceSnapshot.exists() ? balanceSnapshot.val() : 'KEINE DATEN'
                };
                
                document.getElementById('databaseContent').textContent = JSON.stringify(content, null, 2);
                document.getElementById('debugModal').style.display = 'flex';
                
                addDebugMessage('Datenbank-Inhalt geladen', 'success');
                
            } catch (error) {
                addDebugMessage(`❌ Fehler beim Laden des Datenbank-Inhalts: ${error.message}`, 'error');
                showNotification('Fehler beim Laden!', 'error');
            }
        }

        function closeDebugModal() {
            document.getElementById('debugModal').style.display = 'none';
        }

        // UI aktualisieren
        async function updateUI() {
            try {
                const [transactionsSnapshot, balanceSnapshot] = await Promise.all([
                    get(transactionsRef),
                    get(balanceRef)
                ]);
                
                // Balance anzeigen
                if (balanceSnapshot.exists()) {
                    const balanceData = balanceSnapshot.val();
                    document.getElementById('availableBalance').textContent = `${balanceData.amount || 0} $`;
                }
                
                // Transaktionen verarbeiten
                if (transactionsSnapshot.exists()) {
                    const transactions = transactionsSnapshot.val();
                    const pendingTransactions = Object.values(transactions).filter(t => t.status === 'pending');
                    const totalHold = pendingTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                    
                    document.getElementById('holdBalance').textContent = `${totalHold} $`;
                }
                
            } catch (error) {
                addDebugMessage(`Fehler beim UI Update: ${error.message}`, 'error');
            }
        }

        // Modal Funktionen (vereinfacht)
        function openHoldModal() {
            if (!isConnected) {
                showNotification('Nicht verbunden!', 'error');
                return;
            }
            alert('Hold Modal - Funktionalität muss noch implementiert werden');
        }
        
        function openDepositModal() {
            if (!isConnected) {
                showNotification('Nicht verbunden!', 'error');
                return;
            }
            alert('Deposit Modal - Funktionalität muss noch implementiert werden');
        }
        
        function openWithdrawModal() {
            if (!isConnected) {
                showNotification('Nicht verbunden!', 'error');
                return;
            }
            alert('Withdraw Modal - Funktionalität muss noch implementiert werden');
        }

        // DOM Ready
        document.addEventListener('DOMContentLoaded', () => {
            addDebugMessage('CC-Shop Finanzsystem wird gestartet...', 'info');
            initializeFirebase();
            
            // Automatische Prüfung alle 30 Sekunden
            setInterval(() => {
                if (isConnected) {
                    testConnection();
                }
            }, 30000);
        });

        // Manuelle Export-Funktionen für die Browser-Konsole
        window.firebaseDebug = {
            testConnection,
            createTestData,
            clearAllData,
            showDatabaseContent,
            getConfig: () => firebaseConfig,
            getStatus: () => ({ isConnected, app, db })
        };
        
        addDebugMessage('System bereit. Verwende window.firebaseDebug für Debug-Funktionen', 'info');
    </script>
</body>
</html>

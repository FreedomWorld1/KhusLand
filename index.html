<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Weed Ankauf</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
    }
    .card { 
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%); 
      border: 1px solid rgba(74, 222, 128, 0.2); 
      border-radius: 16px; 
      backdrop-filter: blur(10px);
    }
    .shadow-soft { 
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 
                  0 5px 10px rgba(0, 0, 0, 0.3),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1); 
    }
    .small-muted { 
      color: #94a3b8; 
      font-size: 0.85rem; 
    }
    .btn { 
      transition: all 0.2s ease; 
      font-size: 0.9rem; 
      font-weight: 500;
    }
    .btn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .hidden { 
      display: none !important; 
    }
    input { 
      transition: all 0.2s ease; 
      font-size: 0.95rem; 
    }
    input:focus { 
      outline: none; 
      border-color: #7e22ce; 
      box-shadow: 0 0 0 3px rgba(126, 34, 206, 0.3); 
    }
    .active-link { 
      background-color: #16a34a !important; 
      color: #fff !important; 
      font-weight: 600; 
    }
    .gradient-text {
      background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .glass-effect {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(74, 222, 128, 0.1);
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .pulse-glow {
      animation: pulseGlow 2s infinite;
    }
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
      50% { box-shadow: 0 0 20px rgba(74, 222, 128, 0.8); }
      100% { box-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
    }
    .scrollbar-custom::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-custom::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
    }
    .scrollbar-custom::-webkit-scrollbar-thumb {
      background: #4ade80;
      border-radius: 10px;
    }
    .hamburger-container {
      position: relative;
      z-index: 1000;
    }
    .hamburger-menu {
      z-index: 1001;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateX(150%);
      transition: transform 0.3s ease;
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.success {
      background-color: #10b981;
    }
    .notification.error {
      background-color: #ef4444;
    }
    .notification.info {
      background-color: #3b82f6;
    }
    .notification.warning {
      background-color: #f59e0b;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: rgba(30, 41, 59, 0.6);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid rgba(74, 222, 128, 0.1);
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 8px 0;
    }
    .stat-label {
      font-size: 0.85rem;
      color: #94a3b8;
    }
    .search-box {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(74, 222, 128, 0.2);
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 15px;
    }
    .search-box input {
      background: transparent;
      border: none;
      width: 100%;
      color: white;
      font-size: 0.95rem;
    }
    .search-box input::placeholder {
      color: #94a3b8;
    }
    .search-box input:focus {
      outline: none;
      box-shadow: none;
    }
    .export-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    .export-btn {
      flex: 1;
      min-width: 120px;
    }
    .access-badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 8px;
    }
    .access-permanent {
      background-color: #10b981;
      color: white;
    }
    .access-temporary {
      background-color: #f59e0b;
      color: black;
    }
    .access-expired {
      background-color: #ef4444;
      color: white;
    }
    .force-check-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: #ef4444;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      z-index: 1000;
      opacity: 0.5;
      transition: opacity 0.3s;
    }
    .force-check-btn:hover {
      opacity: 1;
    }
    .discount-badge {
      font-size: 0.65rem;
      padding: 1px 5px;
      border-radius: 6px;
      margin-left: 5px;
      font-weight: 600;
    }
    .discount-btn {
      transition: all 0.2s ease;
      font-size: 0.75rem;
      padding: 4px 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(30, 41, 59, 0.6);
    }
    .discount-btn.active {
      transform: scale(1.02);
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
    }
    .price-change {
      font-size: 0.7rem;
      margin-top: 2px;
    }
    .price-increase {
      color: #10b981;
    }
    .price-decrease {
      color: #ef4444;
    }
    .discount-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: 6px;
      margin-bottom: 8px;
    }
    .settings-section {
      background: rgba(30, 41, 59, 0.4);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid rgba(74, 222, 128, 0.1);
    }
  </style>
</head>
<body class="text-gray-100 antialiased min-h-screen">
  
  <!-- Notification System -->
  <div id="notification" class="notification hidden"></div>
  
  <!-- Force Check Button -->
  <div id="forceCheckBtn" class="force-check-btn hidden" title="Sofort-√úberpr√ºfung">
    <i class="fas fa-shield-alt"></i>
  </div>
  
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="card p-8 shadow-soft max-w-md w-full text-center">
      <div class="w-20 h-20 rounded-full bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center mx-auto mb-6">
        <span class="text-white text-2xl">üåø</span>
      </div>
      <h1 class="text-3xl font-bold gradient-text mb-2">Weed Ankauf</h1>
      <p class="text-gray-400 mb-6">Bitte mit Discord einloggen um fortzufahren</p>
      
      <button id="discordLogin" class="w-full py-3 bg-[#5865F2] hover:bg-[#4752c4] rounded-lg btn font-medium flex items-center justify-center gap-3 transition-all duration-200">
        <i class="fab fa-discord text-xl"></i>
        Mit Discord anmelden
      </button>
      
      <div id="loginError" class="mt-4 p-3 bg-red-900/20 border border-red-700 rounded-lg text-red-400 hidden">
        <p id="errorMessage">Zugriff verweigert. Du bist nicht autorisiert.</p>
      </div>

      <div id="debugInfo" class="mt-4 p-3 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-400 text-xs hidden">
        <p id="debugMessage"></p>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT (Versteckt bis Login) -->
  <div id="mainContent" class="hidden">
    <div class="max-w-6xl mx-auto p-4 md:p-6">

      <!-- HEADER -->
      <header class="glass-effect rounded-2xl shadow-soft mb-6 p-4 md:p-6 flex justify-between items-center relative z-10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center">
            <span class="text-white font-bold">üåø</span>
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold gradient-text tracking-tight">Weed Ankauf</h1>
            <p id="userInfo" class="text-sm text-gray-400">
              Eingeloggt als: <span id="username">Unbekannt</span>
              <span id="accessBadge" class="access-badge access-permanent hidden">Permanent</span>
            </p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnNew" class="btn px-3 py-2 bg-green-600 hover:bg-green-500 rounded-lg shadow-sm pulse-glow">
            <i class="fas fa-plus mr-1"></i> Neuer Ankauf
          </button>
          <button id="btnOverview" class="btn px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg shadow-sm">
            <i class="fas fa-list mr-1"></i> √úbersicht
          </button>
          <button id="btnAdmin" class="btn px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg shadow-sm">
            <i class="fas fa-cog mr-1"></i> Admin
          </button>
          <div class="hamburger-container">
            <button id="hamburgerBtn" class="p-2 flex flex-col justify-between h-6 w-8 focus:outline-none ml-1 rounded-md bg-gray-800 hover:bg-gray-700">
              <span class="block h-0.5 bg-gray-100 rounded-full"></span>
              <span class="block h-0.5 bg-gray-100 rounded-full"></span>
              <span class="block h-0.5 bg-gray-100 rounded-full"></span>
            </button>
            <div id="hamburgerMenu" class="hamburger-menu hidden absolute right-0 mt-2 w-44 glass-effect border border-gray-700 rounded-lg shadow-lg overflow-hidden">
              <a href="index.html" class="block px-4 py-3 hover:bg-gray-700 active-link transition-colors">
                <i class="fas fa-cannabis mr-2"></i> Weed
              </a>
              <a href="seite2.html" class="block px-4 py-3 hover:bg-gray-700 transition-colors">
                <i class="fas fa-pills mr-2"></i> Kokain
              </a>
              <a href="https://khusland.github.io/KhusLand2/" class="block px-4 py-3 hover:bg-gray-700 transition-colors">
                <i class="fas fa-calculator mr-2"></i> 30% Rechner
              </a>
              <a href="seite4.html" class="block px-4 py-3 hover:bg-gray-700 transition-colors">
                <i class="fas fa-industry mr-2"></i> Herstellung
              </a>
              <a href="seite3.html" class="block px-4 py-3 hover:bg-gray-700 transition-colors">
                <i class="fas fa-recycle mr-2"></i> Materialrecycler
              </a>
              <a href="seite5.html" class="block px-4 py-3 hover:bg-gray-700 transition-colors">
                <i class="fas fa-route mr-2"></i> Routen
              </a>
            </div>
          </div>
          <button id="logoutBtn" class="btn px-3 py-2 bg-red-600 hover:bg-red-500 rounded-lg shadow-sm ml-2">
            <i class="fas fa-sign-out-alt mr-1"></i> Logout
          </button>
        </div>
      </header>

      <div id="mainContainer" class="space-y-6 relative z-0">

        <!-- NEUER ANKAUF -->
        <div id="newEntry" class="card p-6 shadow-soft fade-in">
          <h2 class="text-xl font-semibold mb-4 text-green-400 flex items-center gap-2">
            <i class="fas fa-shopping-cart"></i>
            Neuer Ankauf
          </h2>
          <form id="entryForm" class="space-y-5">
            
            <!-- RABATT-SYSTEM - UNTERSCHEIDLICH UND KLEIN -->
            <div class="bg-gray-800/20 p-3 rounded-lg border border-gray-700">
              <label class="block text-sm font-medium text-gray-300 mb-2 text-center">
                <i class="fas fa-percentage mr-1"></i> Rabatt ausw√§hlen
              </label>
              <div id="discountButtonsContainer" class="discount-grid">
                <!-- Discount buttons will be generated here -->
              </div>
              <div class="mt-2 text-xs text-gray-400 text-center">
                Aktiver Rabatt: <span id="activeDiscountText" class="font-bold text-white">0%</span>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="buyer" class="block text-sm font-medium text-gray-300 mb-1">
                  <i class="fas fa-user mr-1"></i> K√§ufer (Cloudflare Username)
                </label>
                <input id="buyer" type="text" placeholder="Name des K√§ufers - muss autorisierter Cloudflare User sein" class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 w-full focus:border-green-500" required list="buyer-options"/>
              </div>
              <div>
                <label for="seller" class="block text-sm font-medium text-gray-300 mb-1">
                  <i class="fas fa-user-tag mr-1"></i> Verk√§ufer
                </label>
                <input id="seller" type="text" placeholder="Name des Verk√§ufers" class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 w-full focus:border-green-500" required/>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="quantity" class="block text-sm font-medium text-gray-300 mb-1">
                  <i class="fas fa-weight-hanging mr-1"></i> Menge (Bricks)
                </label>
                <input id="quantity" type="number" min="1" placeholder="Geben Sie die Menge ein" class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 w-full focus:border-green-500"/>
              </div>
              <div class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 flex items-center justify-center">
                <div class="text-center">
                  <div class="small-muted mb-0.5">
                    <i class="fas fa-dollar-sign mr-1"></i> Gesamtpreis
                  </div>
                  <div id="totalPrice" class="text-lg font-bold text-purple-400">0 $</div>
                </div>
              </div>
            </div>

            <!-- PREIS√úBERSICHT MIT RABATT-EFFEKT AUF ANTEILE -->
            <div class="bg-gray-800/20 p-4 rounded-lg border border-gray-700">
              <div class="text-center mb-4">
                <div class="small-muted mb-1">Gesamtpreis bleibt immer gleich</div>
                <div id="finalPrice" class="font-bold text-green-400 text-xl">0 $</div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div class="p-3 rounded-lg bg-gray-800/40 text-center">
                  <div class="small-muted mb-1">
                    <i class="fas fa-user-tag mr-1"></i> Verk√§uferanteil
                  </div>
                  <div id="sellerShare" class="text-lg font-bold text-green-400">0 $</div>
                  <div id="sellerShareChange" class="price-change price-increase hidden">
                    <i class="fas fa-arrow-up"></i> +0 $
                  </div>
                </div>
                <div class="p-3 rounded-lg bg-gray-800/40 text-center">
                  <div class="small-muted mb-1">
                    <i class="fas fa-user mr-1"></i> K√§uferanteil
                  </div>
                  <div id="yourShare" class="text-lg font-bold text-blue-400">0 $</div>
                  <div id="yourShareChange" class="price-change price-decrease hidden">
                    <i class="fas fa-arrow-down"></i> -0 $
                  </div>
                </div>
              </div>
              
              <!-- Erkl√§rung der Rabattwirkung -->
              <div id="discountExplanation" class="mt-3 p-2 bg-blue-900/20 rounded-lg border border-blue-700/30">
                <div class="text-xs text-blue-300 text-center">
                  <i class="fas fa-info-circle mr-1"></i>
                  <span id="discountExplanationText">Der Rabatt ver√§ndert die Verteilung zwischen K√§ufer und Verk√§ufer</span>
                </div>
              </div>
            </div>

            <div class="flex gap-3 pt-2">
              <button type="submit" class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-500 rounded-lg btn font-medium flex items-center justify-center gap-2">
                <i class="fas fa-save"></i>
                Speichern
              </button>
              <button type="button" id="resetForm" class="px-4 py-3 bg-red-600 hover:bg-red-500 rounded-lg btn font-medium flex items-center justify-center gap-2">
                <i class="fas fa-undo"></i>
                Zur√ºcksetzen
              </button>
            </div>
          </form>
        </div>

        <!-- √úBERSICHT -->
        <div id="overview" class="card p-5 shadow-soft hidden fade-in">
          <h2 class="text-lg font-semibold mb-4 text-green-400 flex items-center gap-2">
            <i class="fas fa-list"></i>
            √úbersicht
          </h2>
          
          <!-- Statistik-Karten -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Gesamtumsatz</div>
              <div id="totalRevenueOverview" class="stat-value text-green-400">0 $</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Anzahl Ank√§ufe</div>
              <div id="totalCountOverview" class="stat-value text-blue-400">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Durchschnitt pro Ankauf</div>
              <div id="avgPerPurchase" class="stat-value text-purple-400">0 $</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Dein Gesamtanteil</div>
              <div id="yourTotalShare" class="stat-value text-yellow-400">0 $</div>
            </div>
          </div>
          
          <!-- Rabatt-Filter -->
          <div class="flex gap-2 mb-4 flex-wrap" id="discountFilterContainer">
            <!-- Discount filter buttons will be generated here -->
          </div>
          
          <!-- Suchfeld -->
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="Nach K√§ufer oder Verk√§ufer suchen...">
          </div>
          
          <div id="entriesList" class="space-y-3 max-h-[55vh] overflow-auto scrollbar-custom p-1"></div>
        </div>

        <!-- ADMIN -->
        <div id="adminPanel" class="card p-5 shadow-soft hidden fade-in">
          <h2 class="text-lg font-semibold mb-4 text-blue-400 flex items-center gap-2">
            <i class="fas fa-cog"></i>
            Adminbereich
          </h2>
          <div id="adminLoginSection">
            <div class="mb-4">
              <label for="adminPass" class="block text-sm font-medium text-gray-300 mb-1">
                <i class="fas fa-key mr-1"></i> Admin-Passwort
              </label>
              <input id="adminPass" type="password" placeholder="Geben Sie das Passwort ein" class="w-full p-3 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-blue-500"/>
            </div>
            <button id="adminLoginBtn" class="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-lg btn font-medium flex items-center justify-center gap-2">
              <i class="fas fa-sign-in-alt"></i>
              Einloggen
            </button>
            <span id="adminError" class="text-red-400 mt-3 block hidden text-center text-sm py-2 bg-red-900/20 rounded-lg">
              <i class="fas fa-exclamation-triangle mr-1"></i> Falsches Passwort
            </span>
          </div>
          <div id="adminContent" class="hidden">
            
            <!-- RABATT-EINSTELLUNGEN -->
            <div class="settings-section">
              <h3 class="text-md font-semibold mb-3 text-purple-400 flex items-center gap-2">
                <i class="fas fa-percentage"></i>
                Rabatt-Einstellungen
              </h3>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">
                  Verf√ºgbare Rabatte verwalten
                </label>
                <div class="space-y-2">
                  <div class="flex gap-2">
                    <input type="number" id="newDiscountValue" min="0" max="100" placeholder="Rabatt in %" class="flex-1 p-2 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-purple-500"/>
                    <input type="text" id="newDiscountLabel" placeholder="Bezeichnung" class="flex-1 p-2 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-purple-500"/>
                    <button id="addDiscountBtn" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg btn">
                      <i class="fas fa-plus"></i> Hinzuf√ºgen
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="bg-gray-800/30 rounded-lg p-3">
                <div class="text-sm font-medium text-gray-300 mb-2">Aktive Rabatte:</div>
                <div id="discountSettingsList" class="space-y-2">
                  <!-- Discount settings will be listed here -->
                </div>
              </div>
            </div>

            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 p-3 rounded-lg bg-gray-800/30">
              <div class="small-muted">Gesamtanzahl: <span id="totalCount" class="font-bold text-white">0</span></div>
              <div class="small-muted">Gesamtumsatz: <span id="totalRevenue" class="font-bold text-green-400">0 $</span></div>
            </div>

            <!-- Export-Optionen -->
            <div class="export-options">
              <button id="exportCsvDetailed" class="export-btn px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg shadow-sm btn flex items-center gap-2">
                <i class="fas fa-file-csv mr-1"></i>
                Detailliertes CSV
              </button>
              <button id="exportCsvSummary" class="export-btn px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg shadow-sm btn flex items-center gap-2">
                <i class="fas fa-file-alt mr-1"></i>
                Zusammenfassung CSV
              </button>
              <button id="exportCsvMonthly" class="export-btn px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg shadow-sm btn flex items-center gap-2">
                <i class="fas fa-calendar-alt mr-1"></i>
                Monatsbericht
              </button>
            </div>

            <div class="overflow-auto max-h-[50vh] rounded-lg border border-gray-800 scrollbar-custom">
              <table class="w-full text-left text-sm">
                <thead class="text-gray-400 bg-gray-800/70 sticky top-0">
                  <tr>
                    <th class="p-3 font-medium">Datum</th>
                    <th class="p-3 font-medium">K√§ufer</th>
                    <th class="p-3 font-medium">Verk√§ufer</th>
                    <th class="p-3 font-medium">Menge</th>
                    <th class="p-3 font-medium">Rabatt</th>
                    <th class="p-3 font-medium">Preis</th>
                    <th class="p-3 font-medium">Verk√§uferanteil</th>
                    <th class="p-3 font-medium">K√§uferanteil</th>
                    <th class="p-3 font-medium">Aktion</th>
                  </tr>
                </thead>
                <tbody id="adminTableBody" class="divide-y divide-gray-800"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Datalist f√ºr Cloudflare Username Autocomplete -->
  <datalist id="buyer-options">
    <option value="Rey Ehrlich">
    <option value="Philipp Yane">
    <option value="Kai Dimauro">
    <option value="Lisa Ehrlich">
  </datalist>

  <script type="module">
    // Discord OAuth Konfiguration
    const DISCORD_CLIENT_ID = '1432942180770644079';
    const DISCORD_REDIRECT_URI = window.location.origin + window.location.pathname;
    const BACKEND_URL = 'https://discord-oauth.ehrlichcolin2.workers.dev';

    // Firebase Import und Konfiguration
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import { getDatabase, ref, push, onValue, remove, set } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
      authDomain: "khusland-b7d13.firebaseapp.com",
      databaseURL: "https://khusland-b7d13-default-rtdb.firebaseio.com",
      projectId: "khusland-b7d13",
      storageBucket: "khusland-b7d13.firebasestorage.app",
      messagingSenderId: "69573193613",
      appId: "1:69573193613:web:86c4d839281b1e343cd7c4",
      measurementId: "G-JSCWR4207G"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    const entriesRef = ref(db,'weed_entries');
    const discountsRef = ref(db,'discount_settings');

    // CLOUDFLARE USERNAME VALIDIERUNG - K√ÑUFER MUSS AUTORISIERTER CLOUDFLARE USER SEIN
    const CLOUDFLARE_USERNAMES = ['Rey Ehrlich', 'Philipp Yane', 'Kai Dimauro', 'Lisa Ehrlich'];

    function validateBuyerName(buyerName) {
      return CLOUDFLARE_USERNAMES.includes(buyerName);
    }

    // RABATT-SYSTEM VARIABLEN
    let currentDiscount = 0; // Standard: Kein Rabatt
    let availableDiscounts = [
      { value: 0, label: 'Kein Rabatt', color: 'gray' },
      { value: 10, label: 'Mitarbeiter', color: 'yellow' },
      { value: 15, label: 'Eink√§ufer', color: 'blue' },
      { value: 20, label: 'Normal', color: 'green' }
    ];

    // Event-Listener f√ºr K√§ufer-Feld-√Ñnderungen
    document.getElementById('buyer').addEventListener('blur', function() {
      const buyerName = this.value.trim();
      if (buyerName && !validateBuyerName(buyerName)) {
        showNotification('Hinweis: Der eingegebene Name stimmt nicht mit einem autorisierten Cloudflare-Benutzernamen √ºberein.', 'warning');
      }
    });

    // DOM Elemente
    const loginScreen = document.getElementById('loginScreen');
    const mainContent = document.getElementById('mainContent');
    const discordLoginBtn = document.getElementById('discordLogin');
    const loginError = document.getElementById('loginError');
    const errorMessage = document.getElementById('errorMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const debugInfo = document.getElementById('debugInfo');
    const debugMessage = document.getElementById('debugMessage');
    const usernameElement = document.getElementById('username');
    const notification = document.getElementById('notification');
    const accessBadge = document.getElementById('accessBadge');
    const forceCheckBtn = document.getElementById('forceCheckBtn');

    // Notification System
    function showNotification(message, type = 'info', duration = 5000) {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.remove('hidden');
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          notification.classList.add('hidden');
        }, 300);
      }, duration);
    }

    // Debug-Funktion
    function showDebugInfo(message) {
      debugMessage.textContent = message;
      debugInfo.classList.remove('hidden');
    }

    // Discord OAuth Login
    function startDiscordOAuth() {
      const scope = 'identify';
      const state = generateRandomState();
      
      const authUrl = new URL('https://discord.com/api/oauth2/authorize');
      authUrl.searchParams.set('client_id', DISCORD_CLIENT_ID);
      authUrl.searchParams.set('redirect_uri', DISCORD_REDIRECT_URI);
      authUrl.searchParams.set('response_type', 'code');
      authUrl.searchParams.set('scope', scope);
      authUrl.searchParams.set('state', state);
      
      showDebugInfo('Starte OAuth Flow...');
      window.location.href = authUrl.toString();
    }

    // Generiere random state f√ºr OAuth
    function generateRandomState() {
      return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    }

    // Token Austausch
    async function exchangeCodeForToken(code) {
      try {
        showDebugInfo('Tausche Code gegen Token...');
        
        const response = await fetch(`${BACKEND_URL}/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            code, 
            redirect_uri: DISCORD_REDIRECT_URI
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          showDebugInfo(`Worker Response Error: ${response.status} - ${errorText}`);
          throw new Error(`Worker responded with status ${response.status}`);
        }

        const data = await response.json();
        showDebugInfo(`Token Response: ${JSON.stringify(data)}`);

        if (data.access_token) {
          showDebugInfo('Access Token erhalten, √ºberpr√ºfe Benutzer...');
          await verifyUser(data.access_token);
        } else {
          showDebugInfo(`Kein Access Token: ${JSON.stringify(data)}`);
          throw new Error('Kein Access Token erhalten');
        }
      } catch (error) {
        console.error('Fehler beim Token-Austausch:', error);
        showError('Fehler bei der Anmeldung. Bitte versuche es sp√§ter erneut.');
        showDebugInfo(`Fehler: ${error.message}`);
      }
    }

    // Benutzer √ºberpr√ºfen mit Lifetime-Check
    async function verifyUser(accessToken) {
      try {
        showDebugInfo('√úberpr√ºfe Benutzer mit Lifetime-Check...');
        
        const response = await fetch(`${BACKEND_URL}/verify-user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            accessToken
          })
        });

        if (!response.ok) {
          throw new Error('Verification failed');
        }

        const data = await response.json();
        showDebugInfo(`Verification Response: ${JSON.stringify(data)}`);

        if (data.isAuthorized) {
          showDebugInfo('Benutzer autorisiert!');
          localStorage.setItem('discord_user', JSON.stringify(data.user));
          localStorage.setItem('discord_access_token', accessToken);
          localStorage.setItem('user_access_info', JSON.stringify(data.accessInfo || {}));
          showMainContent(data.accessInfo || {});
          showNotification(`Erfolgreich eingeloggt als ${data.user.username}`, 'success');
        } else {
          let errorMsg = 'Zugriff verweigert. ';
          if (data.accessInfo && data.accessInfo.message === 'access expired') {
            errorMsg += 'Dein Zugang ist abgelaufen.';
          } else if (data.accessInfo && data.accessInfo.message === 'not in authorized list') {
            errorMsg += 'Du bist nicht in der Liste der autorisierten Benutzer.';
          } else {
            errorMsg += 'Du bist nicht autorisiert.';
          }
          showError(errorMsg);
          showDebugInfo('Benutzer nicht autorisiert: ' + (data.accessInfo?.message || 'unknown reason'));
        }
      } catch (error) {
        console.error('Fehler bei der Benutzer√ºberpr√ºfung:', error);
        showError('Fehler bei der Berechtigungspr√ºfung');
        showDebugInfo(`Verification Error: ${error.message}`);
      }
    }

    // Regelm√§√üige √úberpr√ºfung ob User noch autorisiert ist
    async function checkUserAuthorization() {
      const token = localStorage.getItem('discord_access_token');
      const user = localStorage.getItem('discord_user');
      
      if (!token || !user) {
        return { isAuthorized: false, reason: 'No token or user' };
      }
      
      try {
        const response = await fetch(`${BACKEND_URL}/verify-user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            accessToken: token
          })
        });

        if (!response.ok) {
          // Token ist ung√ºltig - l√∂sche lokal
          localStorage.removeItem('discord_access_token');
          localStorage.removeItem('discord_user');
          localStorage.removeItem('user_access_info');
          return { isAuthorized: false, reason: 'Token invalid' };
        }

        const data = await response.json();
        
        // SOFORTIGE Reaktion wenn nicht autorisiert
        if (!data.isAuthorized) {
          // L√∂sche lokale Daten
          localStorage.removeItem('discord_access_token');
          localStorage.removeItem('discord_user');
          localStorage.removeItem('user_access_info');
        }
        
        return data;
        
      } catch (error) {
        console.error('Fehler bei der Autorisierungspr√ºfung:', error);
        return { isAuthorized: false, reason: error.message };
      }
    }

    // Sofortige erzwungene √úberpr√ºfung
    async function forceImmediateCheck() {
      const token = localStorage.getItem('discord_access_token');
      if (!token) return;
      
      try {
        showNotification('√úberpr√ºfe Zugriff...', 'info', 2000);
        const response = await fetch(`${BACKEND_URL}/verify-user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            accessToken: token
          })
        });
        
        const data = await response.json();
        
        if (!data.isAuthorized) {
          showNotification('Zugriff wurde entzogen!', 'error');
          setTimeout(logout, 1000);
        } else {
          showNotification('Zugriff ist weiterhin aktiv ‚úì', 'success', 3000);
        }
      } catch (error) {
        console.error('Sofort-√úberpr√ºfung fehlgeschlagen:', error);
        showNotification('√úberpr√ºfung fehlgeschlagen', 'error');
      }
    }

    // Alle 30 Sekunden √ºberpr√ºfen ob User noch berechtigt ist
    setInterval(async () => {
      if (localStorage.getItem('discord_user')) {
        const authResult = await checkUserAuthorization();
        if (!authResult.isAuthorized) {
          let message = 'Deine Berechtigung wurde widerrufen';
          if (authResult.accessInfo?.message === 'access expired') {
            message = 'Dein Zugang ist abgelaufen';
          }
          showNotification(message, 'error');
          setTimeout(() => {
            logout();
          }, 3000);
        }
      }
    }, 30000); // 30 Sekunden

    // Auch beim Seitenwechsel √ºberpr√ºfen
    document.addEventListener('visibilitychange', async () => {
      if (!document.hidden && localStorage.getItem('discord_user')) {
        const authResult = await checkUserAuthorization();
        if (!authResult.isAuthorized) {
          let message = 'Deine Berechtigung wurde widerrufen';
          if (authResult.accessInfo?.message === 'access expired') {
            message = 'Dein Zugang ist abgelaufen';
          }
          showNotification(message, 'error');
          setTimeout(() => {
            logout();
          }, 2000);
        }
      }
    });

    // √úberpr√ºfung bei wichtigen Aktionen
    async function validateAccess() {
      const authResult = await checkUserAuthorization();
      if (!authResult.isAuthorized && localStorage.getItem('discord_user')) {
        let message = 'Zugriff wurde entzogen';
        if (authResult.accessInfo?.message === 'access expired') {
          message = 'Dein Zugang ist abgelaufen';
        }
        showNotification(message, 'error');
        setTimeout(logout, 2000);
        return false;
      }
      return true;
    }

    function showError(message) {
      errorMessage.textContent = message;
      loginError.classList.remove('hidden');
    }

    function showMainContent(accessInfo) {
      console.log('Zeige Main Content an...');
      
      // WICHTIG: Korrekte Klassen verwenden - nur 'hidden'
      loginScreen.classList.add('hidden');
      mainContent.classList.remove('hidden');
      debugInfo.classList.add('hidden');
      forceCheckBtn.classList.remove('hidden');
      
      // Benutzerinformationen anzeigen
      const user = JSON.parse(localStorage.getItem('discord_user'));
      if (user) {
        usernameElement.textContent = user.username;
      }
      
      // Access Badge anzeigen
      if (accessInfo) {
        accessBadge.classList.remove('hidden');
        if (accessInfo.isPermanent) {
          accessBadge.textContent = 'Permanent';
          accessBadge.className = 'access-badge access-permanent';
        } else {
          accessBadge.textContent = accessInfo.message || 'Temporary';
          accessBadge.className = 'access-badge access-temporary';
        }
      }
      
      // Setze URL zur√ºck ohne Code-Parameter
      const cleanUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
      
      console.log('Main Content sollte jetzt sichtbar sein');
    }

    function logout() {
      console.log('Logout durchgef√ºhrt');
      
      // Alle gespeicherten Daten l√∂schen
      localStorage.removeItem('discord_user');
      localStorage.removeItem('discord_access_token');
      localStorage.removeItem('user_access_info');
      
      // UI zur√ºcksetzen - nur 'hidden' verwenden
      mainContent.classList.add('hidden');
      loginScreen.classList.remove('hidden');
      loginError.classList.add('hidden');
      debugInfo.classList.add('hidden');
      accessBadge.classList.add('hidden');
      forceCheckBtn.classList.add('hidden');
      
      // Formular zur√ºcksetzen
      document.getElementById('entryForm').reset();
      updateShares();
      
      showNotification('Erfolgreich ausgeloggt', 'info');
    }

    // √úberpr√ºfe gespeicherten Login beim Laden
    function checkExistingLogin() {
      const user = localStorage.getItem('discord_user');
      const token = localStorage.getItem('discord_access_token');
      const accessInfo = localStorage.getItem('user_access_info');
      
      console.log('Check existing login:', { user: !!user, token: !!token });
      
      if (user && token) {
        showDebugInfo('Bereits eingeloggt');
        showMainContent(accessInfo ? JSON.parse(accessInfo) : null);
        
        // Zus√§tzliche √úberpr√ºfung ob wirklich autorisiert
        setTimeout(async () => {
          const authResult = await checkUserAuthorization();
          if (!authResult.isAuthorized) {
            showNotification('Deine Sitzung ist abgelaufen', 'error');
            setTimeout(logout, 2000);
          }
        }, 1000);
        
      } else {
        showDebugInfo('Nicht eingeloggt');
        // L√∂sche eventuelle fehlerhafte Daten
        localStorage.removeItem('discord_user');
        localStorage.removeItem('discord_access_token');
        localStorage.removeItem('user_access_info');
      }
    }

    // Event Listeners
    discordLoginBtn.addEventListener('click', startDiscordOAuth);
    logoutBtn.addEventListener('click', logout);
    forceCheckBtn.addEventListener('click', forceImmediateCheck);

    // Initialisierung
    checkExistingLogin();

    // URL Parameters √ºberpr√ºfen
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    if (code) {
      console.log('OAuth Code gefunden:', code);
      exchangeCodeForToken(code);
    }

    // Deine bestehenden Firebase-Funktionen
    const ADMIN_PASSWORD = '1101';
    let entries = [];
    let filteredEntries = [];

    // KORRIGIERT: Einheitliche hide/show Funktionen
    function show(el) { 
      el.classList.remove('hidden'); 
    }
    function hide(el) { 
      el.classList.add('hidden'); 
    }

    function formatCurrency(n) { 
      return new Intl.NumberFormat('de-DE').format(Math.round(n)) + ' $'; 
    }
    function formatDate(d) {
      const date = new Date(d);
      const pad = n => n.toString().padStart(2,'0');
      return `${pad(date.getDate())}.${pad(date.getMonth()+1)}.${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    // Hamburger Menu
    document.getElementById('hamburgerBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('hamburgerMenu').classList.toggle('hidden');
    });

    // Close hamburger menu when clicking outside
    document.addEventListener('click', (e) => {
      const hamburgerMenu = document.getElementById('hamburgerMenu');
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      
      if (!hamburgerMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
        hamburgerMenu.classList.add('hidden');
      }
    });

    // Tabs Navigation
    document.getElementById('btnNew').addEventListener('click', async () => {
      await validateAccess();
      show(document.getElementById('newEntry')); 
      hide(document.getElementById('overview')); 
      hide(document.getElementById('adminPanel'));
      updateButtonStates('new');
    });
    
    document.getElementById('btnOverview').addEventListener('click', async () => {
      await validateAccess();
      hide(document.getElementById('newEntry')); 
      show(document.getElementById('overview')); 
      hide(document.getElementById('adminPanel'));
      renderOverview();
      updateButtonStates('overview');
    });
    
    document.getElementById('btnAdmin').addEventListener('click', async () => {
      await validateAccess();
      hide(document.getElementById('newEntry')); 
      hide(document.getElementById('overview')); 
      show(document.getElementById('adminPanel'));
      updateButtonStates('admin');
    });

    function updateButtonStates(activeButton) {
      const buttons = {
        new: document.getElementById('btnNew'),
        overview: document.getElementById('btnOverview'),
        admin: document.getElementById('btnAdmin')
      };
      
      Object.values(buttons).forEach(btn => {
        btn.classList.remove('pulse-glow', 'bg-green-600', 'bg-blue-600');
        btn.classList.add('bg-gray-700');
      });
      
      if (buttons[activeButton]) {
        buttons[activeButton].classList.remove('bg-gray-700');
        if (activeButton === 'new') {
          buttons[activeButton].classList.add('bg-green-600', 'pulse-glow');
        } else if (activeButton === 'admin') {
          buttons[activeButton].classList.add('bg-blue-600');
        } else {
          buttons[activeButton].classList.add('bg-gray-600');
        }
      }
    }

    // Initialize with New Entry active
    updateButtonStates('new');

    // KORRIGIERTE RABATT-SYSTEM FUNKTIONEN
    function loadDiscountSettings() {
      onValue(discountsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          availableDiscounts = Object.values(data);
          renderDiscountButtons();
          renderDiscountFilters();
          renderDiscountSettings();
        } else {
          // Standard-Rabatte setzen, falls keine in Firebase existieren
          set(discountsRef, availableDiscounts);
        }
      });
    }

    function renderDiscountButtons() {
      const container = document.getElementById('discountButtonsContainer');
      container.innerHTML = '';
      
      availableDiscounts.sort((a, b) => a.value - b.value).forEach(discount => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = `discount-btn ${discount.value === currentDiscount ? 'active' : ''}`;
        button.innerHTML = `
          <div class="font-bold text-xs">${discount.value}%</div>
          <div class="text-xs opacity-90">${discount.label}</div>
        `;
        button.addEventListener('click', () => {
          // Entferne aktive Klasse von allen Buttons
          document.querySelectorAll('.discount-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          
          // Setze aktiven Button
          button.classList.add('active');
          currentDiscount = discount.value;
          
          // Aktualisiere Anzeige
          updateDiscountDisplay();
          updateShares();
          
          if (discount.value > 0) {
            showNotification(`${discount.value}% Rabatt aktiv - Verteilung: Verk√§ufer ${100 - discount.value}% / K√§ufer ${discount.value}%`, 'info', 2000);
          } else {
            showNotification('Kein Rabatt aktiv - Verteilung: Verk√§ufer 100% / K√§ufer 0%', 'info', 2000);
          }
        });
        
        container.appendChild(button);
      });
      
      updateDiscountDisplay();
    }

    function renderDiscountFilters() {
      const container = document.getElementById('discountFilterContainer');
      container.innerHTML = '';
      
      // "Alle" Button
      const allButton = document.createElement('button');
      allButton.className = 'px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-all';
      allButton.textContent = 'Alle Rabatte';
      allButton.setAttribute('data-discount', 'all');
      allButton.addEventListener('click', () => {
        filteredEntries = [...entries];
        renderOverview();
      });
      container.appendChild(allButton);
      
      // Rabatt-Filter Buttons
      availableDiscounts.sort((a, b) => a.value - b.value).forEach(discount => {
        if (discount.value === 0) return; // "Kein Rabatt" nicht als Filter anzeigen
        
        const button = document.createElement('button');
        button.className = 'px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-all';
        button.textContent = `${discount.value}% ${discount.label}`;
        button.setAttribute('data-discount', discount.value);
        button.addEventListener('click', () => {
          filteredEntries = entries.filter(entry => entry.discount === discount.value);
          renderOverview();
        });
        container.appendChild(button);
      });
    }

    function renderDiscountSettings() {
      const container = document.getElementById('discountSettingsList');
      container.innerHTML = '';
      
      availableDiscounts.sort((a, b) => a.value - b.value).forEach((discount, index) => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between p-2 bg-gray-700/30 rounded';
        item.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="font-medium">${discount.value}%</span>
            <span class="text-sm text-gray-300">${discount.label}</span>
          </div>
          <button class="delete-discount-btn px-2 py-1 bg-red-600 hover:bg-red-500 rounded text-xs" data-index="${index}">
            <i class="fas fa-trash"></i>
          </button>
        `;
        
        container.appendChild(item);
      });
      
      // Event Listener f√ºr L√∂sch-Buttons
      document.querySelectorAll('.delete-discount-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const index = parseInt(e.target.closest('button').getAttribute('data-index'));
          deleteDiscount(index);
        });
      });
    }

    function updateDiscountDisplay() {
      const activeDiscount = availableDiscounts.find(d => d.value === currentDiscount);
      if (activeDiscount) {
        document.getElementById('activeDiscountText').textContent = 
          currentDiscount === 0 ? '0% (Kein Rabatt)' : `${activeDiscount.value}% (${activeDiscount.label})`;
      }
    }

    // VOLLST√ÑNDIG KORRIGIERTE FUNKTION: Rabatt wirkt sich auf die GESAMTVERTEILUNG aus
    function calculateSharesWithDiscount(totalPrice) {
      if (currentDiscount === 0) {
        // Bei 0% Rabatt: Verk√§ufer 100%, K√§ufer 0%
        return {
          totalPrice: Math.round(totalPrice),
          sellerShare: Math.round(totalPrice),
          yourShare: 0,
          discountAmount: 0,
          sellerIncrease: Math.round(totalPrice * 0.3), // Verk√§ufer bekommt 30% mehr als Basis
          yourDecrease: Math.round(totalPrice * 0.3) // K√§ufer verliert kompletten Anteil
        };
      }
      
      // Bei Rabatt > 0%: Verk√§ufer bekommt (100 - Rabatt)%, K√§ufer bekommt Rabatt% vom GESAMTBETRAG
      const sellerPercentage = (100 - currentDiscount) / 100;
      const yourPercentage = currentDiscount / 100;
      
      const finalSellerShare = totalPrice * sellerPercentage;
      const finalYourShare = totalPrice * yourPercentage;
      
      // Berechnung der √Ñnderungen f√ºr die Anzeige (verglichen mit Basis 70/30)
      const baseSellerShare = totalPrice * 0.7;
      const baseYourShare = totalPrice * 0.3;
      const sellerIncrease = finalSellerShare - baseSellerShare;
      const yourDecrease = baseYourShare - finalYourShare;
      
      return {
        totalPrice: Math.round(totalPrice),
        sellerShare: Math.round(finalSellerShare),
        yourShare: Math.round(finalYourShare),
        discountAmount: Math.round(yourDecrease),
        sellerIncrease: Math.round(sellerIncrease),
        yourDecrease: Math.round(yourDecrease)
      };
    }

    // Share Calculation MIT KORRIGIERTER RABATT-BERECHNUNG
    const quantityInput = document.getElementById('quantity');
    const sellerShareEl = document.getElementById('sellerShare');
    const yourShareEl = document.getElementById('yourShare');
    const totalPriceEl = document.getElementById('totalPrice');
    const finalPriceEl = document.getElementById('finalPrice');
    const sellerShareChangeEl = document.getElementById('sellerShareChange');
    const yourShareChangeEl = document.getElementById('yourShareChange');
    const discountExplanationEl = document.getElementById('discountExplanationText');
    
    function updateShares() { 
      const q = Number(quantityInput.value) || 0;
      const totalPrice = q * 2500;
      
      // Berechne Anteile mit Rabatt-Effekt
      const shares = calculateSharesWithDiscount(totalPrice);
      
      // Aktualisiere alle Preisanzeigen
      totalPriceEl.textContent = formatCurrency(totalPrice);
      finalPriceEl.textContent = formatCurrency(totalPrice); // Gesamtpreis bleibt immer gleich
      
      // Aktualisiere Anteile
      sellerShareEl.textContent = formatCurrency(shares.sellerShare);
      yourShareEl.textContent = formatCurrency(shares.yourShare);
      
      // Zeige √Ñnderungen an
      if (shares.sellerIncrease > 0) {
        sellerShareChangeEl.textContent = `+${formatCurrency(shares.sellerIncrease)}`;
        sellerShareChangeEl.classList.remove('hidden');
      } else {
        sellerShareChangeEl.classList.add('hidden');
      }
      
      if (shares.yourDecrease > 0) {
        yourShareChangeEl.textContent = `-${formatCurrency(shares.yourDecrease)}`;
        yourShareChangeEl.classList.remove('hidden');
      } else {
        yourShareChangeEl.classList.add('hidden');
      }
      
      // Aktualisiere Rabatt-Erkl√§rung
      if (currentDiscount === 0) {
        discountExplanationEl.textContent = 'Bei 0% Rabatt: Verk√§ufer erh√§lt 100%, K√§ufer erh√§lt 0% vom Gesamtbetrag';
      } else {
        discountExplanationEl.textContent = `Bei ${currentDiscount}% Rabatt: Verk√§ufer erh√§lt ${100 - currentDiscount}%, K√§ufer erh√§lt ${currentDiscount}% vom Gesamtbetrag`;
      }
    }
    
    quantityInput.addEventListener('input', updateShares);
    
    // Rabatt-System initialisieren
    loadDiscountSettings();
    updateShares();

    // RABATT-EINSTELLUNGEN FUNKTIONEN
    document.getElementById('addDiscountBtn').addEventListener('click', () => {
      const value = parseInt(document.getElementById('newDiscountValue').value);
      const label = document.getElementById('newDiscountLabel').value.trim();
      
      if (isNaN(value) || value < 0 || value > 100) {
        showNotification('Bitte geben Sie einen g√ºltigen Rabattwert zwischen 0 und 100 ein.', 'error');
        return;
      }
      
      if (!label) {
        showNotification('Bitte geben Sie eine Bezeichnung f√ºr den Rabatt ein.', 'error');
        return;
      }
      
      if (availableDiscounts.some(d => d.value === value)) {
        showNotification('Ein Rabatt mit diesem Wert existiert bereits.', 'error');
        return;
      }
      
      const newDiscount = {
        value: value,
        label: label,
        color: 'gray' // Standardfarbe
      };
      
      availableDiscounts.push(newDiscount);
      set(discountsRef, availableDiscounts);
      
      // Felder zur√ºcksetzen
      document.getElementById('newDiscountValue').value = '';
      document.getElementById('newDiscountLabel').value = '';
      
      showNotification(`Rabatt ${value}% (${label}) hinzugef√ºgt`, 'success');
    });

    function deleteDiscount(index) {
      if (availableDiscounts.length <= 1) {
        showNotification('Mindestens ein Rabatt muss vorhanden sein.', 'error');
        return;
      }
      
      const discount = availableDiscounts[index];
      if (confirm(`M√∂chten Sie den Rabatt ${discount.value}% (${discount.label}) wirklich l√∂schen?`)) {
        availableDiscounts.splice(index, 1);
        set(discountsRef, availableDiscounts);
        showNotification(`Rabatt ${discount.value}% gel√∂scht`, 'success');
      }
    }

    // Form submit MIT KORRIGIERTER RABATT-BERECHNUNG
    document.getElementById('entryForm').addEventListener('submit', async e => {
      e.preventDefault();
      
      const hasAccess = await validateAccess();
      if (!hasAccess) {
        e.preventDefault();
        return;
      }
      
      const buyer = document.getElementById('buyer').value.trim();
      const seller = document.getElementById('seller').value.trim();
      const quantity = Number(quantityInput.value);
      
      // K√ÑUFER-VALIDIERUNG: Muss autorisierter Cloudflare User sein
      if (!validateBuyerName(buyer)) {
        showNotification('Fehler: Bitte geben Sie einen g√ºltigen Cloudflare-Benutzernamen als K√§ufer ein. Erlaubte Namen: ' + CLOUDFLARE_USERNAMES.join(', '), 'error');
        return;
      }
      
      if (!buyer || !seller || !quantity) {
        showNotification('Bitte f√ºllen Sie alle Felder aus!', 'error');
        return;
      }
      
      const totalPrice = quantity * 2500;
      const shares = calculateSharesWithDiscount(totalPrice);
      
      const activeDiscount = availableDiscounts.find(d => d.value === currentDiscount);
      
      const entry = {
        buyer,
        seller,
        quantity,
        totalPrice: totalPrice,
        discount: currentDiscount,
        discountLabel: activeDiscount ? activeDiscount.label : 'Kein Rabatt',
        discountAmount: shares.discountAmount,
        sellerShare: shares.sellerShare,
        yourShare: shares.yourShare,
        sellerIncrease: shares.sellerIncrease,
        yourDecrease: shares.yourDecrease,
        date: formatDate(new Date()),
        timestamp: Date.now()
      };

      try {
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<div class="loading mr-2"></div> Speichere...';
        submitBtn.disabled = true;
        
        await push(entriesRef, entry);
        e.target.reset();
        updateShares();
        
        if (currentDiscount === 0) {
          showNotification('Eintrag ohne Rabatt gespeichert! Verteilung: Verk√§ufer 100% / K√§ufer 0%', 'success');
        } else {
          showNotification(`Eintrag mit ${currentDiscount}% Rabatt gespeichert! Verteilung: Verk√§ufer ${100 - currentDiscount}% / K√§ufer ${currentDiscount}%`, 'success');
        }
        
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
      } catch (error) {
        console.error('Fehler beim Speichern:', error);
        showNotification('Fehler beim Speichern der Daten!', 'error');
      }
    });

    // Reset form
    document.getElementById('resetForm').addEventListener('click', () => {
      if (confirm('M√∂chten Sie das Formular wirklich zur√ºcksetzen?')) {
        document.getElementById('entryForm').reset(); 
        updateShares();
        showNotification('Formular zur√ºckgesetzt', 'info');
      }
    });

    // Real-time listener
    onValue(entriesRef, snapshot => {
      entries = [];
      snapshot.forEach(child => {
        const data = child.val();
        data.key = child.key;
        entries.push(data);
      });
      // Sortierung: Neueste oben (absteigend nach timestamp)
      entries.sort((a, b) => b.timestamp - a.timestamp);
      filteredEntries = [...entries];
      renderOverview();
      renderAdminTable();
    });

    // Suchfunktion
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      
      if (searchTerm.trim() === '') {
        filteredEntries = [...entries];
      } else {
        filteredEntries = entries.filter(entry => 
          entry.buyer.toLowerCase().includes(searchTerm) || 
          entry.seller.toLowerCase().includes(searchTerm)
        );
      }
      
      renderOverview();
    });

    // √úbersicht rendern MIT KORRIGIERTER RABATT-ANZEIGE
    const entriesList = document.getElementById('entriesList');
    function renderOverview() {
      entriesList.innerHTML = '';
      if (filteredEntries.length === 0) {
        entriesList.innerHTML = '<div class="text-center py-8 text-gray-400"><p>Keine Eintr√§ge vorhanden.</p></div>'; 
        return;
      }
      
      // Statistiken berechnen
      let totalRevenue = 0;
      let yourTotalShare = 0;
      
      filteredEntries.forEach(entry => {
        totalRevenue += entry.totalPrice;
        yourTotalShare += entry.yourShare;
      });
      
      const avgPerPurchase = filteredEntries.length > 0 ? totalRevenue / filteredEntries.length : 0;
      
      // Statistiken anzeigen
      document.getElementById('totalRevenueOverview').textContent = formatCurrency(totalRevenue);
      document.getElementById('totalCountOverview').textContent = filteredEntries.length;
      document.getElementById('avgPerPurchase').textContent = formatCurrency(avgPerPurchase);
      document.getElementById('yourTotalShare').textContent = formatCurrency(yourTotalShare);
      
      // Eintr√§ge anzeigen
      filteredEntries.forEach(en => {
        const discountText = en.discountLabel || (en.discount === 0 ? 'Kein Rabatt' : `${en.discount}%`);
        
        const el = document.createElement('div');
        el.className = 'p-4 rounded-lg bg-gray-800/50 border border-gray-700 hover:border-green-500/30 transition-all duration-200';
        el.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="text-sm text-gray-400">${en.date}</div>
            <div class="flex gap-2">
              <div class="px-2 py-1 bg-green-900/30 text-green-400 text-xs rounded-full">${en.quantity} Bricks</div>
              <div class="discount-badge bg-gray-600">${discountText}</div>
            </div>
          </div>
          <div class="font-semibold text-lg mb-2">${en.buyer} ‚Üí ${en.seller}</div>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="bg-gray-800/40 p-2 rounded-lg">
              <div class="text-gray-400">Gesamtpreis</div>
              <div class="font-medium text-white">${formatCurrency(en.totalPrice)}</div>
            </div>
            <div class="bg-gray-800/40 p-2 rounded-lg">
              <div class="text-gray-400">Rabattwirkung</div>
              <div class="font-medium text-red-400">-${formatCurrency(en.discountAmount)}</div>
            </div>
            <div class="bg-gray-800/40 p-2 rounded-lg">
              <div class="text-gray-400">Verk√§uferanteil</div>
              <div class="font-medium text-green-400">${formatCurrency(en.sellerShare)}</div>
              ${en.sellerIncrease > 0 ? `<div class="price-change price-increase"><i class="fas fa-arrow-up"></i> +${formatCurrency(en.sellerIncrease)}</div>` : ''}
            </div>
            <div class="bg-gray-800/40 p-2 rounded-lg">
              <div class="text-gray-400">K√§uferanteil</div>
              <div class="font-medium text-blue-400">${formatCurrency(en.yourShare)}</div>
              ${en.yourDecrease > 0 ? `<div class="price-change price-decrease"><i class="fas fa-arrow-down"></i> -${formatCurrency(en.yourDecrease)}</div>` : ''}
            </div>
            <div class="bg-gray-800/40 p-2 rounded-lg">
              <div class="text-gray-400">Pro St√ºck</div>
              <div class="font-medium text-purple-400">${formatCurrency(en.totalPrice / en.quantity)}</div>
            </div>
            <div class="bg-gray-800/40 p-2 rounded-lg">
              <div class="text-gray-400">Rabatt</div>
              <div class="font-medium text-yellow-400">${en.discount === 0 ? 'Verk√§ufer 100% / K√§ufer 0%' : `Verk√§ufer ${100 - en.discount}% / K√§ufer ${en.discount}%`}</div>
            </div>
          </div>
        `;
        entriesList.appendChild(el);
      });
    }

    // Admin
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminPassInput = document.getElementById('adminPass');
    const adminError = document.getElementById('adminError');
    const adminTableBody = document.getElementById('adminTableBody');
    const totalCount = document.getElementById('totalCount');
    const totalRevenue = document.getElementById('totalRevenue');

    adminLoginBtn.addEventListener('click', () => {
      if (adminPassInput.value === ADMIN_PASSWORD) {
        adminError.classList.add('hidden'); 
        show(document.getElementById('adminContent')); 
        renderAdminTable();
        renderDiscountSettings();
        adminPassInput.value = ''; // Clear password field after login
        showNotification('Admin-Bereich erfolgreich betreten', 'success');
      } else {
        adminError.classList.remove('hidden');
        adminPassInput.value = ''; // Clear password field on error
        adminPassInput.focus();
        showNotification('Falsches Admin-Passwort', 'error');
      }
    });

    // Allow login with Enter key
    adminPassInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        adminLoginBtn.click();
      }
    });

    function renderAdminTable() {
      adminTableBody.innerHTML = '';
      let revenue = 0;
      
      // Die neuesten Eintr√§ge werden oben angezeigt (bereits sortiert)
      entries.forEach(en => {
        revenue += en.yourShare;
        const discountText = en.discountLabel || (en.discount === 0 ? 'Kein Rabatt' : `${en.discount}%`);
        
        const tr = document.createElement('tr');
        tr.className = 'border-t border-gray-800 hover:bg-gray-800/30 transition-colors';
        tr.innerHTML = `
          <td class="p-3 small-muted">${en.date}</td>
          <td class="p-3">${en.buyer}</td>
          <td class="p-3">${en.seller}</td>
          <td class="p-3">${en.quantity}</td>
          <td class="p-3">
            <span class="discount-badge bg-gray-600">${discountText}</span>
          </td>
          <td class="p-3">${formatCurrency(en.totalPrice)}</td>
          <td class="p-3 text-green-400">
            ${formatCurrency(en.sellerShare)}
            ${en.sellerIncrease > 0 ? `<div class="text-xs price-increase">+${formatCurrency(en.sellerIncrease)}</div>` : ''}
          </td>
          <td class="p-3 text-blue-400">
            ${formatCurrency(en.yourShare)}
            ${en.yourDecrease > 0 ? `<div class="text-xs price-decrease">-${formatCurrency(en.yourDecrease)}</div>` : ''}
          </td>
          <td class="p-3">
            <button class="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-sm rounded-lg btn flex items-center gap-1" onclick="deleteEntry('${en.key}')">
              <i class="fas fa-trash mr-1"></i>
              L√∂schen
            </button>
          </td>`;
        adminTableBody.appendChild(tr);
      });
      
      totalCount.innerText = entries.length;
      totalRevenue.innerText = formatCurrency(revenue);
    }

    window.deleteEntry = function(key) {
      if (confirm('Eintrag wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
        remove(ref(db, 'weed_entries/' + key));
        showNotification('Eintrag erfolgreich gel√∂scht', 'success');
      }
    }

    // CSV Export Funktionen MIT KORRIGIERTEN RABATT-DATEN
    function generateDetailedCSV() {
      if (entries.length === 0) {
        showNotification('Keine Eintr√§ge zum Exportieren vorhanden.', 'error');
        return;
      }
      
      // Sortierung: Neueste oben
      const sortedEntries = [...entries].sort((a, b) => b.timestamp - a.timestamp);
      
      // Header mit deutschen Beschreibungen
      const header = [
        'Datum',
        'Uhrzeit', 
        'K√§ufer',
        'Verk√§ufer',
        'Menge (Bricks)',
        'Rabatt (%)',
        'Rabatt-Typ',
        'Gesamtpreis ($)',
        'Rabattbetrag ($)',
        'Verk√§uferanteil ($)',
        'K√§uferanteil ($)',
        'Verk√§ufer-Bonus ($)',
        'K√§ufer-Reduktion ($)',
        'Transaktions-ID'
      ];
      
      // Datenzeilen mit besserer Formatierung
      const rows = sortedEntries.map((e, index) => {
        const dateTime = e.date.split(' ');
        const date = dateTime[0];
        const time = dateTime[1] || '';
        const discountType = e.discountLabel || (e.discount === 0 ? 'Kein Rabatt' : `${e.discount}% Rabatt`);
        
        return [
          date,
          time,
          `"${e.buyer}"`,
          `"${e.seller}"`,
          e.quantity,
          e.discount,
          discountType,
          Math.round(e.totalPrice),
          Math.round(e.discountAmount),
          Math.round(e.sellerShare),
          Math.round(e.yourShare),
          Math.round(e.sellerIncrease || 0),
          Math.round(e.yourDecrease || 0),
          e.key || `T-${index + 1}`
        ].join(';'); // Semikolon als Trennzeichen f√ºr bessere Kompatibilit√§t mit Excel
      });
      
      const csv = [header.join(';'), ...rows].join('\n');
      downloadCSV(csv, 'detailliert');
    }

    function generateSummaryCSV() {
      if (entries.length === 0) {
        showNotification('Keine Eintr√§ge zum Exportieren vorhanden.', 'error');
        return;
      }
      
      // Zusammenfassung nach K√§ufer und Rabatt
      const buyerSummary = {};
      let totalRevenue = 0;
      let totalYourShare = 0;
      
      entries.forEach(entry => {
        const key = `${entry.buyer}_${entry.discount}`;
        if (!buyerSummary[key]) {
          buyerSummary[key] = {
            buyer: entry.buyer,
            discount: entry.discount,
            discountType: entry.discountLabel || (entry.discount === 0 ? 'Kein Rabatt' : `${entry.discount}% Rabatt`),
            transactions: 0,
            totalQuantity: 0,
            totalSpent: 0,
            yourShare: 0,
            totalDiscount: 0
          };
        }
        
        buyerSummary[key].transactions++;
        buyerSummary[key].totalQuantity += entry.quantity;
        buyerSummary[key].totalSpent += entry.totalPrice;
        buyerSummary[key].yourShare += entry.yourShare;
        buyerSummary[key].totalDiscount += (entry.yourDecrease || 0);
        
        totalRevenue += entry.totalPrice;
        totalYourShare += entry.yourShare;
      });
      
      // Header f√ºr Zusammenfassung
      const header = [
        'K√§ufer',
        'Rabatt (%)',
        'Rabatt-Typ',
        'Anzahl Transaktionen',
        'Gesamtmenge (Bricks)',
        'Gesamtausgaben ($)',
        'K√§uferanteil ($)',
        'Gesamtersparnis Verk√§ufer ($)',
        'Durchschnitt pro Transaktion ($)'
      ];
      
      // Datenzeilen
      const rows = Object.values(buyerSummary).map(data => [
        `"${data.buyer}"`,
        data.discount,
        data.discountType,
        data.transactions,
        data.totalQuantity,
        Math.round(data.totalSpent),
        Math.round(data.yourShare),
        Math.round(data.totalDiscount),
        Math.round(data.totalSpent / data.transactions)
      ].join(';'));
      
      // Gesamtsummen hinzuf√ºgen
      rows.push('');
      rows.push(['GESAMT', '', '', entries.length, '', Math.round(totalRevenue), Math.round(totalYourShare), '', ''].join(';'));
      
      const csv = [header.join(';'), ...rows].join('\n');
      downloadCSV(csv, 'zusammenfassung');
    }

    function generateMonthlyReport() {
      if (entries.length === 0) {
        showNotification('Keine Eintr√§ge zum Exportieren vorhanden.', 'error');
        return;
      }
      
      // Gruppierung nach Monat
      const monthlyData = {};
      
      entries.forEach(entry => {
        const date = new Date(entry.timestamp);
        const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        const monthName = date.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
        
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = {
            monthName: monthName,
            transactions: 0,
            totalQuantity: 0,
            totalRevenue: 0,
            totalDiscount: 0,
            yourShare: 0,
            sellerBonus: 0,
            buyers: new Set(),
            sellers: new Set()
          };
        }
        
        monthlyData[monthKey].transactions++;
        monthlyData[monthKey].totalQuantity += entry.quantity;
        monthlyData[monthKey].totalRevenue += entry.totalPrice;
        monthlyData[monthKey].totalDiscount += (entry.discountAmount || 0);
        monthlyData[monthKey].yourShare += entry.yourShare;
        monthlyData[monthKey].sellerBonus += (entry.sellerIncrease || 0);
        monthlyData[monthKey].buyers.add(entry.buyer);
        monthlyData[monthKey].sellers.add(entry.seller);
      });
      
      // Header f√ºr Monatsbericht
      const header = [
        'Monat',
        'Anzahl Transaktionen',
        'Gesamtmenge (Bricks)',
        'Gesamtumsatz ($)',
        'Gesamtersparnis durch Rabatt ($)',
        'Verk√§ufer-Bonus ($)',
        'Ihr Anteil ($)',
        'Durchschnitt pro Transaktion ($)',
        'Eindeutige K√§ufer',
        'Eindeutige Verk√§ufer'
      ];
      
      // Datenzeilen
      const rows = Object.entries(monthlyData)
        .sort((a, b) => b[0].localeCompare(a[0])) // Neueste Monate zuerst
        .map(([key, data]) => [
          `"${data.monthName}"`,
          data.transactions,
          data.totalQuantity,
          Math.round(data.totalRevenue),
          Math.round(data.totalDiscount),
          Math.round(data.sellerBonus),
          Math.round(data.yourShare),
          Math.round(data.totalRevenue / data.transactions),
          data.buyers.size,
          data.sellers.size
        ].join(';'));
      
      const csv = [header.join(';'), ...rows].join('\n');
      downloadCSV(csv, 'monatsbericht');
    }

    function downloadCSV(csvData, type) {
      const blob = new Blob(['\uFEFF' + csvData], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      // Generate filename with current date
      const now = new Date();
      const dateStr = `${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()}`;
      a.download = `weed_ankauf_${type}_${dateStr}.csv`;
      
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
      
      showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} CSV erfolgreich exportiert`, 'success');
    }

    // Event Listener f√ºr CSV-Export Buttons
    document.getElementById('exportCsvDetailed').addEventListener('click', generateDetailedCSV);
    document.getElementById('exportCsvSummary').addEventListener('click', generateSummaryCSV);
    document.getElementById('exportCsvMonthly').addEventListener('click', generateMonthlyReport);

  </script>
</body>
</html>

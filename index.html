<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CC-Shop Finanzsystem</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a202c; color: white; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { 
            background: #2d3748; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status {
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .connected { background: green; }
        .disconnected { background: red; }
        
        .balance-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: #4a5568;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        
        .card h2 { margin-bottom: 10px; color: #90cdf4; }
        .amount { font-size: 48px; font-weight: bold; margin: 20px 0; }
        
        .buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        
        .hold { background: #805ad5; }
        .deposit { background: #38a169; }
        .withdraw { background: #e53e3e; }
        
        .debug {
            background: #2d3748;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: monospace;
        }
        
        .log { 
            background: #1a202c; 
            padding: 10px; 
            border-radius: 5px; 
            max-height: 200px; 
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .log-item { padding: 5px 0; border-bottom: 1px solid #4a5568; }
        .success { color: #68d391; }
        .error { color: #fc8181; }
        .info { color: #63b3ed; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ CC-Shop Finanzsystem</h1>
            <div class="status disconnected" id="status">Nicht verbunden</div>
        </div>
        
        <!-- Debug Buttons -->
        <div style="margin-bottom: 20px;">
            <button onclick="testConnection()" style="background: #3182ce;">üîå Verbindung testen</button>
            <button onclick="createTestData()" style="background: #d69e2e;">üß™ Testdaten erstellen</button>
            <button onclick="clearAllData()" style="background: #c53030;">üóëÔ∏è Alle Daten l√∂schen</button>
            <button onclick="showDatabase()" style="background: #38a169;">üìä DB anzeigen</button>
        </div>
        
        <!-- Balance Cards -->
        <div class="balance-cards">
            <div class="card">
                <h2>üí∞ Verf√ºgbares Guthaben</h2>
                <div class="amount" id="availableBalance">0 $</div>
                <p>Sofort verf√ºgbar f√ºr Auszahlungen</p>
            </div>
            <div class="card">
                <h2>‚è≥ Zur√ºckgehaltene Betr√§ge</h2>
                <div class="amount" id="holdBalance">0 $</div>
                <p>Werden in 2 Tagen freigegeben</p>
            </div>
        </div>
        
        <!-- Transaction Buttons -->
        <div class="buttons">
            <button class="hold" onclick="addHold()">‚è∏Ô∏è Betrag zur√ºckhalten</button>
            <button class="deposit" onclick="addDeposit()">‚ûï Direkt einzahlen</button>
            <button class="withdraw" onclick="addWithdraw()">‚ûñ Auszahlen</button>
        </div>
        
        <!-- Debug Panel -->
        <div class="debug">
            <h3>üîß Debug Log:</h3>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE KONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyB7AmLb6NwR8sKyDXtIhmghGszpX_VsICY",
            authDomain: "cc-shop-36c3b.firebaseapp.com",
            databaseURL: "https://cc-shop-36c3b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cc-shop-36c3b",
            storageBucket: "cc-shop-36c3b.firebasestorage.app",
            messagingSenderId: "376170741825",
            appId: "1:376170741825:web:bc6102e277da5ad7cbc6c0",
            measurementId: "G-FJVHHQWZFW"
        };
        
        // ==================== GLOBALE VARIABLEN ====================
        let app;
        let database;
        let isConnected = false;
        
        // ==================== HELPER FUNCTIONS ====================
        function log(message, type = 'info') {
            const logElement = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            logItem.textContent = `[${time}] ${message}`;
            logElement.appendChild(logItem);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type}] ${message}`);
        }
        
        function updateStatus(connected) {
            const statusElement = document.getElementById('status');
            if (connected) {
                statusElement.className = 'status connected';
                statusElement.textContent = '‚úÖ Verbunden mit Firebase';
                isConnected = true;
            } else {
                statusElement.className = 'status disconnected';
                statusElement.textContent = '‚ùå Nicht verbunden';
                isConnected = false;
            }
        }
        
        function showAlert(message, type = 'info') {
            alert(`[${type}] ${message}`);
        }
        
        // ==================== FIREBASE FUNCTIONS ====================
        function initializeFirebase() {
            try {
                log('Initialisiere Firebase...', 'info');
                
                // Firebase initialisieren
                app = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                log('Firebase App initialisiert', 'success');
                
                // Verbindung √ºberwachen
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', function(snap) {
                    updateStatus(snap.val() === true);
                    if (snap.val() === true) {
                        log('‚úÖ Firebase Realtime Database ist verbunden!', 'success');
                        loadData();
                    } else {
                        log('‚ùå Firebase ist nicht verbunden', 'error');
                    }
                });
                
                // Referenzen
                window.transactionsRef = database.ref('finanz_transactions');
                window.balanceRef = database.ref('finanz_balance/current');
                
            } catch (error) {
                log(`Fehler: ${error.message}`, 'error');
                showAlert(`Firebase Fehler: ${error.message}`, 'error');
            }
        }
        
        // ==================== DATABASE OPERATIONS ====================
        async function testConnection() {
            try {
                log('Teste Firebase Verbindung...', 'info');
                const testRef = database.ref('.info/connected');
                
                testRef.once('value').then((snapshot) => {
                    if (snapshot.val() === true) {
                        log('‚úÖ Verbindungstest erfolgreich!', 'success');
                        showAlert('Firebase ist verbunden!', 'success');
                    } else {
                        log('‚ùå Firebase nicht verbunden', 'error');
                        showAlert('Firebase nicht verbunden!', 'error');
                    }
                });
                
                // Test-Schreiben
                const testDataRef = database.ref('test_connection');
                await testDataRef.set({
                    timestamp: new Date().toISOString(),
                    message: 'Test vom Finanzsystem'
                });
                
                log('‚úÖ Test-Daten erfolgreich geschrieben', 'success');
                
                // Test-Lesen
                const snapshot = await testDataRef.once('value');
                log(`‚úÖ Test-Daten gelesen: ${JSON.stringify(snapshot.val())}`, 'success');
                
                // Test-Daten l√∂schen
                await testDataRef.remove();
                log('‚úÖ Test-Daten gel√∂scht', 'info');
                
            } catch (error) {
                log(`‚ùå Verbindungstest fehlgeschlagen: ${error.message}`, 'error');
                showAlert(`FEHLER: ${error.message}\n\nPr√ºfe die Firebase-Regeln!`, 'error');
            }
        }
        
        async function createTestData() {
            if (!isConnected) {
                showAlert('Nicht mit Firebase verbunden!', 'error');
                return;
            }
            
            try {
                log('Erstelle Testdaten...', 'info');
                
                // 1. Balance setzen
                await window.balanceRef.set({
                    amount: 5000,
                    lastUpdated: new Date().toISOString(),
                    currency: 'USD',
                    note: 'Testdaten'
                });
                log('‚úÖ Balance erstellt: 5000 $', 'success');
                
                // 2. Test-Transaktionen
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const testTransactions = [
                    {
                        amount: 1000,
                        purchaseDate: yesterday.toISOString().split('T')[0],
                        releaseDate: today.toISOString().split('T')[0],
                        status: 'pending',
                        type: 'hold',
                        createdAt: new Date().toISOString()
                    },
                    {
                        amount: 500,
                        purchaseDate: today.toISOString().split('T')[0],
                        releaseDate: tomorrow.toISOString().split('T')[0],
                        status: 'pending',
                        type: 'hold',
                        createdAt: new Date().toISOString()
                    },
                    {
                        amount: 2000,
                        purchaseDate: today.toISOString().split('T')[0],
                        releaseDate: today.toISOString().split('T')[0],
                        status: 'released',
                        type: 'deposit',
                        createdAt: new Date().toISOString()
                    }
                ];
                
                // Alte Transaktionen l√∂schen
                await window.transactionsRef.remove();
                
                // Neue Transaktionen hinzuf√ºgen
                for (const transaction of testTransactions) {
                    const newRef = window.transactionsRef.push();
                    await newRef.set(transaction);
                }
                
                log(`‚úÖ ${testTransactions.length} Test-Transaktionen erstellt`, 'success');
                showAlert('Testdaten erfolgreich erstellt!', 'success');
                
                // UI aktualisieren
                loadData();
                
            } catch (error) {
                log(`‚ùå Fehler beim Erstellen von Testdaten: ${error.message}`, 'error');
                showAlert(`Fehler: ${error.message}`, 'error');
            }
        }
        
        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è WIRKLICH alle Daten l√∂schen?\n\nDies wird ALLES unwiderruflich l√∂schen!')) {
                return;
            }
            
            try {
                log('L√∂sche alle Daten...', 'warning');
                
                await window.transactionsRef.remove();
                await window.balanceRef.set({
                    amount: 0,
                    lastUpdated: new Date().toISOString(),
                    currency: 'USD'
                });
                
                log('‚úÖ Alle Daten gel√∂scht', 'success');
                showAlert('Alle Daten wurden gel√∂scht!', 'success');
                
                // UI aktualisieren
                loadData();
                
            } catch (error) {
                log(`‚ùå Fehler beim L√∂schen: ${error.message}`, 'error');
            }
        }
        
        async function showDatabase() {
            try {
                log('Lade Datenbank-Inhalt...', 'info');
                
                const [transactionsSnap, balanceSnap] = await Promise.all([
                    window.transactionsRef.once('value'),
                    window.balanceRef.once('value')
                ]);
                
                const data = {
                    transactions: transactionsSnap.val(),
                    balance: balanceSnap.val()
                };
                
                console.log('üìä Firebase Datenbank-Inhalt:', data);
                
                // In Log anzeigen
                log('=== DATENBANK-INHALT ===', 'info');
                log(`Balance: ${JSON.stringify(data.balance)}`, 'info');
                
                if (data.transactions) {
                    const transactionCount = Object.keys(data.transactions).length;
                    log(`Transaktionen: ${transactionCount} Eintr√§ge`, 'info');
                    Object.entries(data.transactions).forEach(([key, value], index) => {
                        log(`${index + 1}. ${value.amount}$ - ${value.status} - ${value.releaseDate}`, 'info');
                    });
                } else {
                    log('Keine Transaktionen vorhanden', 'info');
                }
                
                // Alert mit Daten
                showAlert(`Datenbank-Inhalt geladen!\n\nBalance: ${data.balance?.amount || 0}$\nTransaktionen: ${data.transactions ? Object.keys(data.transactions).length : 0}`, 'info');
                
            } catch (error) {
                log(`‚ùå Fehler beim Laden: ${error.message}`, 'error');
            }
        }
        
        // ==================== LOAD DATA ====================
        async function loadData() {
            try {
                log('Lade Daten...', 'info');
                
                // Balance laden
                window.balanceRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        document.getElementById('availableBalance').textContent = `${data.amount || 0} $`;
                        log(`Balance geladen: ${data.amount}$`, 'info');
                    }
                });
                
                // Transaktionen laden
                window.transactionsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    let totalHold = 0;
                    
                    if (data) {
                        Object.values(data).forEach(transaction => {
                            if (transaction.status === 'pending') {
                                totalHold += transaction.amount || 0;
                            }
                        });
                        
                        const transactionCount = Object.keys(data).length;
                        log(`${transactionCount} Transaktionen geladen, Hold: ${totalHold}$`, 'info');
                    }
                    
                    document.getElementById('holdBalance').textContent = `${totalHold} $`;
                });
                
            } catch (error) {
                log(`Fehler beim Laden: ${error.message}`, 'error');
            }
        }
        
        // ==================== TRANSACTION FUNCTIONS ====================
        async function addHold() {
            if (!isConnected) {
                showAlert('Nicht verbunden!', 'error');
                return;
            }
            
            const amount = prompt('Betrag ($) zur√ºckhalten:');
            if (!amount || isNaN(amount) || amount <= 0) {
                showAlert('Ung√ºltiger Betrag!', 'error');
                return;
            }
            
            try {
                const today = new Date();
                const releaseDate = new Date(today);
                releaseDate.setDate(releaseDate.getDate() + 2);
                
                const transaction = {
                    amount: parseInt(amount),
                    purchaseDate: today.toISOString().split('T')[0],
                    releaseDate: releaseDate.toISOString().split('T')[0],
                    status: 'pending',
                    type: 'hold',
                    createdAt: new Date().toISOString()
                };
                
                const newRef = window.transactionsRef.push();
                await newRef.set(transaction);
                
                log(`‚úÖ ${amount}$ zur√ºckgehalten (Freigabe: ${releaseDate.toISOString().split('T')[0]})`, 'success');
                showAlert(`${amount}$ erfolgreich zur√ºckgehalten!`, 'success');
                
            } catch (error) {
                log(`‚ùå Fehler: ${error.message}`, 'error');
            }
        }
        
        async function addDeposit() {
            if (!isConnected) {
                showAlert('Nicht verbunden!', 'error');
                return;
            }
            
            const amount = prompt('Betrag ($) einzahlen:');
            if (!amount || isNaN(amount) || amount <= 0) {
                showAlert('Ung√ºltiger Betrag!', 'error');
                return;
            }
            
            try {
                // Aktuelle Balance holen
                const balanceSnap = await window.balanceRef.once('value');
                const currentBalance = balanceSnap.val()?.amount || 0;
                const newBalance = currentBalance + parseInt(amount);
                
                // Balance aktualisieren
                await window.balanceRef.set({
                    amount: newBalance,
                    lastUpdated: new Date().toISOString(),
                    currency: 'USD'
                });
                
                // Transaktion speichern
                const transaction = {
                    amount: parseInt(amount),
                    date: new Date().toISOString().split('T')[0],
                    status: 'released',
                    type: 'deposit',
                    createdAt: new Date().toISOString()
                };
                
                const newRef = window.transactionsRef.push();
                await newRef.set(transaction);
                
                log(`‚úÖ ${amount}$ eingezahlt. Neue Balance: ${newBalance}$`, 'success');
                showAlert(`${amount}$ erfolgreich eingezahlt!`, 'success');
                
            } catch (error) {
                log(`‚ùå Fehler: ${error.message}`, 'error');
            }
        }
        
        async function addWithdraw() {
            if (!isConnected) {
                showAlert('Nicht verbunden!', 'error');
                return;
            }
            
            const amount = prompt('Betrag ($) auszahlen:');
            if (!amount || isNaN(amount) || amount <= 0) {
                showAlert('Ung√ºltiger Betrag!', 'error');
                return;
            }
            
            try {
                // Aktuelle Balance holen
                const balanceSnap = await window.balanceRef.once('value');
                const currentBalance = balanceSnap.val()?.amount || 0;
                
                if (parseInt(amount) > currentBalance) {
                    showAlert(`Nicht genug Guthaben! Verf√ºgbar: ${currentBalance}$`, 'error');
                    return;
                }
                
                const newBalance = currentBalance - parseInt(amount);
                
                // Balance aktualisieren
                await window.balanceRef.set({
                    amount: newBalance,
                    lastUpdated: new Date().toISOString(),
                    currency: 'USD'
                });
                
                // Transaktion speichern
                const transaction = {
                    amount: parseInt(amount),
                    date: new Date().toISOString().split('T')[0],
                    status: 'released',
                    type: 'withdrawal',
                    createdAt: new Date().toISOString()
                };
                
                const newRef = window.transactionsRef.push();
                await newRef.set(transaction);
                
                log(`‚úÖ ${amount}$ ausgezahlt. Neue Balance: ${newBalance}$`, 'success');
                showAlert(`${amount}$ erfolgreich ausgezahlt!`, 'success');
                
            } catch (error) {
                log(`‚ùå Fehler: ${error.message}`, 'error');
            }
        }
        
        // ==================== INITIALIZE ====================
        document.addEventListener('DOMContentLoaded', () => {
            log('CC-Shop Finanzsystem wird gestartet...', 'info');
            initializeFirebase();
            
            // Global f√ºr Debugging
            window.firebase = firebase;
            window.db = database;
            
            log('‚úÖ System bereit. Dr√ºcke F12 f√ºr Entwicklertools.', 'success');
            log('Verwende: testConnection(), createTestData(), showDatabase()', 'info');
        });
    </script>
</body>
</html>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
  authDomain: "khusland-b7d13.firebaseapp.com",
  databaseURL: "https://khusland-b7d13-default-rtdb.firebaseio.com",
  projectId: "khusland-b7d13",
  storageBucket: "khusland-b7d13.firebasestorage.app",
  messagingSenderId: "69573193613",
  appId: "1:69573193613:web:86c4d839281b1e343cd7c4",
  measurementId: "G-JSCWR4207G"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase(app);
const entriesRef = ref(db,'weed_entries');

const ADMIN_PASSWORD='admin123';
let entries=[];

function show(el){el.classList.remove('hidden-el');}
function hide(el){el.classList.add('hidden-el');}
function formatCurrency(n){return Math.round(n)+' $';}
function formatDate(d){ 
  const date=new Date(d); 
  const pad=n=>n.toString().padStart(2,'0'); 
  return `${pad(date.getDate())}.${pad(date.getMonth()+1)}.${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`; 
}

// Hamburger
document.getElementById('hamburgerBtn').addEventListener('click',()=>document.getElementById('hamburgerMenu').classList.toggle('hidden'));

// Tabs
document.getElementById('btnNew').addEventListener('click',()=>{
  show(document.getElementById('newEntry'));
  hide(document.getElementById('overview'));
  hide(document.getElementById('adminPanel'));
});
document.getElementById('btnOverview').addEventListener('click',()=>{
  hide(document.getElementById('newEntry'));
  show(document.getElementById('overview'));
  hide(document.getElementById('adminPanel'));
  renderOverview();
});
document.getElementById('btnAdmin').addEventListener('click',()=>{
  hide(document.getElementById('newEntry'));
  hide(document.getElementById('overview'));
  show(document.getElementById('adminPanel'));
});

// Shares
const quantityInput=document.getElementById('quantity');
const sellerShareEl=document.getElementById('sellerShare');
const yourShareEl=document.getElementById('yourShare');

function updateShares(){
  const q=Number(quantityInput.value)||0;
  const price=q*2500;
  sellerShareEl.textContent=formatCurrency(price*0.6);
  yourShareEl.textContent=formatCurrency(price*0.4);
}
quantityInput.addEventListener('input',updateShares);
updateShares();

// Form submit
document.getElementById('entryForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const buyer=document.getElementById('buyer').value;
  const seller=document.getElementById('seller').value;
  const quantity=Number(quantityInput.value);
  const price=quantity*2500;
  const sellerShare=price*0.6;
  const yourShare=price*0.4;
  const entry={
    buyer,
    seller,
    quantity,
    price,
    sellerShare,
    yourShare,
    date: formatDate(new Date()),
    timestamp: Date.now() // NEU: für Sortierung
  };
  await push(entriesRef,entry);
  e.target.reset();
  updateShares();
});

// Reset
document.getElementById('resetForm').addEventListener('click',()=>{document.getElementById('entryForm').reset(); updateShares();});

// Real-time listener
onValue(entriesRef,snapshot=>{
  entries=[];
  snapshot.forEach(child=>{
    const data=child.val();
    data.key=child.key;
    entries.push(data);
  });
  // Neueste oben
  entries.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0) );
  renderOverview();
  renderAdminTable();
});

// Übersicht rendern
const entriesList=document.getElementById('entriesList');
function renderOverview(){
  entriesList.innerHTML='';
  if(entries.length===0){
    entriesList.innerHTML='<p class="text-gray-400">Keine Einträge vorhanden.</p>';
    return;
  }
  entries.forEach(en=>{
    const el=document.createElement('div');
    el.className='p-3 rounded-md bg-gray-800 border border-gray-700';
    el.innerHTML=`
      <div class="text-sm text-gray-400 mb-1">${en.date}</div>
      <div class="font-semibold">${en.buyer} → ${en.seller}</div>
      <div class="text-sm mt-1">Menge: ${en.quantity} | Preis: ${formatCurrency(en.price)}</div>
      <div class="text-sm text-green-400">Verkäufer: ${formatCurrency(en.sellerShare)}</div>
      <div class="text-sm text-blue-400">Käufer: ${formatCurrency(en.yourShare)}</div>
    `;
    entriesList.appendChild(el);
  });
}

// Admin
const adminLoginBtn=document.getElementById('adminLoginBtn');
const adminPassInput=document.getElementById('adminPass');
const adminError=document.getElementById('adminError');
const adminTableBody=document.getElementById('adminTableBody');
const totalCount=document.getElementById('totalCount');
const totalRevenue=document.getElementById('totalRevenue');
const exportCsv=document.getElementById('exportCsv');

adminLoginBtn.addEventListener('click',()=>{
  if(adminPassInput.value===ADMIN_PASSWORD){
    adminError.classList.add('hidden-el');
    show(document.getElementById('adminContent'));
    renderAdminTable();
  } else adminError.classList.remove('hidden-el');
});

function renderAdminTable(){
  adminTableBody.innerHTML='';
  let revenue=0;
  entries.forEach(en=>{
    revenue+=en.yourShare;
    const tr=document.createElement('tr');
    tr.className='border-t border-gray-800';
    tr.innerHTML=`
      <td class="p-2 small-muted">${en.date}</td>
      <td class="p-2">${en.buyer}</td>
      <td class="p-2">${en.seller}</td>
      <td class="p-2">${en.quantity}</td>
      <td class="p-2">${formatCurrency(en.price)}</td>
      <td class="p-2">${formatCurrency(en.sellerShare)}</td>
      <td class="p-2">${formatCurrency(en.yourShare)}</td>
      <td class="p-2"><button class="px-2 py-1 bg-red-600 text-sm rounded btn" onclick="deleteEntry('${en.key}')">Löschen</button></td>
    `;
    adminTableBody.appendChild(tr);
  });
  totalCount.innerText=entries.length;
  totalRevenue.innerText=formatCurrency(revenue);
}

window.deleteEntry=function(key){if(confirm('Eintrag wirklich löschen?')) remove(ref(db,'weed_entries/'+key));}

// CSV Export
exportCsv.addEventListener('click',()=>{
  if(entries.length===0) return alert('Keine Einträge zum Exportieren.');
  const header=['date','buyer','seller','quantity','price','sellerShare','yourShare'];
  const rows=entries.map(e=>[e.date,e.buyer,e.seller,e.quantity,e.price,e.sellerShare,e.yourShare].join(','));
  const csv=[header.join(','),...rows].join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='entries_weed.csv';
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  a.remove();
});
</script>

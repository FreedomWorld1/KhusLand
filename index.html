<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Weed Ankauf</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
    }
    .card { 
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%); 
      border: 1px solid rgba(74, 222, 128, 0.2); 
      border-radius: 16px; 
      backdrop-filter: blur(10px);
    }
    .shadow-soft { 
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 
                  0 5px 10px rgba(0, 0, 0, 0.3),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1); 
    }
    .small-muted { 
      color: #94a3b8; 
      font-size: 0.85rem; 
    }
    .btn { 
      transition: all 0.2s ease; 
      font-size: 0.9rem; 
      font-weight: 500;
    }
    .btn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .hidden-el { 
      display: none; 
    }
    input { 
      transition: all 0.2s ease; 
      font-size: 0.95rem; 
    }
    input:focus { 
      outline: none; 
      border-color: #7e22ce; 
      box-shadow: 0 0 0 3px rgba(126, 34, 206, 0.3); 
    }
    .active-link { 
      background-color: #16a34a !important; 
      color: #fff !important; 
      font-weight: 600; 
    }
    .gradient-text {
      background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .glass-effect {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(74, 222, 128, 0.1);
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .pulse-glow {
      animation: pulseGlow 2s infinite;
    }
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
      50% { box-shadow: 0 0 20px rgba(74, 222, 128, 0.8); }
      100% { box-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
    }
    .scrollbar-custom::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-custom::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
    }
    .scrollbar-custom::-webkit-scrollbar-thumb {
      background: #4ade80;
      border-radius: 10px;
    }
    .hamburger-container {
      position: relative;
      z-index: 1000;
    }
    .hamburger-menu {
      z-index: 1001;
    }
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
  </style>
</head>
<body class="text-gray-100 antialiased">

  <!-- LOGIN SCREEN (wird zuerst angezeigt) -->
  <div id="loginScreen" class="login-container">
    <div class="card p-8 shadow-soft w-full max-w-md">
      <div class="text-center mb-8">
        <div class="w-20 h-20 rounded-full bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center mx-auto mb-4">
          <span class="text-2xl">🌿</span>
        </div>
        <h1 class="text-3xl font-bold gradient-text mb-2">Weed Ankauf</h1>
        <p class="text-gray-400">Bitte mit Discord anmelden</p>
      </div>
      
      <button onclick="discordLogin()" class="w-full py-4 bg-purple-600 hover:bg-purple-500 rounded-lg btn font-medium flex items-center justify-center gap-3 text-lg">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02c-2.72 4.07-3.47 8.03-3.1 11.95c0 .02.01.04.03.05c1.8 1.32 3.53 2.12 5.24 2.65c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.25c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.68 1.19 1.07 1.74c.03.01.06.02.09.01c1.72-.53 3.45-1.33 5.25-2.65c.02-.01.03-.03.03-.05c.44-4.53-.73-8.46-3.1-11.95c-.01-.01-.02-.02-.04-.02zM8.52 14.91c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12zm6.97 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12z"/>
        </svg>
        Mit Discord anmelden
      </button>
      
      <div id="loginError" class="mt-4 p-3 bg-red-900/30 border border-red-700 rounded-lg text-red-300 text-center hidden-el">
        Login fehlgeschlagen. Bitte versuche es erneut.
      </div>
    </div>
  </div>

  <!-- HAUPTPAGE (nur nach Login sichtbar) -->
  <div id="mainApp" class="hidden-el">
    <div class="max-w-4xl mx-auto p-4 md:p-6">
      <!-- HEADER -->
      <header class="glass-effect rounded-2xl shadow-soft mb-6 p-4 md:p-6 flex justify-between items-center relative z-10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center">
            <span class="text-white font-bold">🌿</span>
          </div>
          <h1 class="text-2xl md:text-3xl font-bold gradient-text tracking-tight">Weed Ankauf</h1>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnNew" class="btn px-3 py-2 bg-green-600 hover:bg-green-500 rounded-lg shadow-sm pulse-glow">Neuer Ankauf</button>
          <button id="btnOverview" class="btn px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg shadow-sm">Übersicht</button>
          <button id="btnAdmin" class="btn px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg shadow-sm">Admin</button>
          <div class="hamburger-container">
            <button id="hamburgerBtn" class="p-2 flex flex-col justify-between h-6 w-8 focus:outline-none ml-1 rounded-md bg-gray-800 hover:bg-gray-700">
              <span class="block h-0.5 bg-gray-100 rounded-full"></span>
              <span class="block h-0.5 bg-gray-100 rounded-full"></span>
              <span class="block h-0.5 bg-gray-100 rounded-full"></span>
            </button>
            <div id="hamburgerMenu" class="hamburger-menu hidden absolute right-0 mt-2 w-44 glass-effect border border-gray-700 rounded-lg shadow-lg overflow-hidden">
              <a href="index.html" class="block px-4 py-3 hover:bg-gray-700 active-link transition-colors">Weed</a>
              <a href="seite2.html" class="block px-4 py-3 hover:bg-gray-700 transition-colors">Kokain</a>
              <a href="seite3.html" class="block px-4 py-3 hover:bg-gray-700 transition-colors">Scarface Weed</a>
              <a href="seite4.html" class="block px-4 py-3 hover:bg-gray-700 transition-colors">Herstellung</a>
              <a href="seite5.html" class="block px-4 py-3 hover:bg-gray-700 transition-colors">Routen</a>
              <a href="https://khusland.github.io/KhusLand2/" class="block px-4 py-3 hover:bg-gray-700 transition-colors">30% Rechner</a>
            </div>
          </div>
        </div>
      </header>

      <div id="mainContainer" class="space-y-6 relative z-0">
        <!-- NEUER ANKAUF -->
        <div id="newEntry" class="card p-6 shadow-soft fade-in">
          <h2 class="text-xl font-semibold mb-4 text-green-400 flex items-center gap-2">
            <span class="bg-green-900/30 p-2 rounded-lg">💰</span>
            Neuer Ankauf
          </h2>
          <form id="entryForm" class="space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="buyer" class="block text-sm font-medium text-gray-300 mb-1">Käufer</label>
                <input id="buyer" type="text" placeholder="Name des Käufers" class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 w-full focus:border-green-500" required/>
              </div>
              <div>
                <label for="seller" class="block text-sm font-medium text-gray-300 mb-1">Verkäufer</label>
                <input id="seller" type="text" placeholder="Name des Verkäufers" class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 w-full focus:border-green-500" required/>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="quantity" class="block text-sm font-medium text-gray-300 mb-1">Menge</label>
                <input id="quantity" type="number" min="1" placeholder="Geben Sie die Menge ein" class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 w-full focus:border-green-500"/>
              </div>
              <div class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 flex items-center justify-center">
                <div class="text-center">
                  <div class="small-muted mb-0.5">Gesamtpreis</div>
                  <div id="totalPrice" class="text-lg font-bold text-purple-400">0 $</div>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 text-center">
                <div class="small-muted mb-1">Verkäufer (70%)</div>
                <div id="sellerShare" class="text-lg font-bold text-green-400">0 $</div>
              </div>
              <div class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 text-center">
                <div class="small-muted mb-1">Käufer (30%)</div>
                <div id="yourShare" class="text-lg font-bold text-blue-400">0 $</div>
              </div>
            </div>
            <div class="flex gap-3 pt-2">
              <button type="submit" class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-500 rounded-lg btn font-medium flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                Speichern
              </button>
              <button type="button" id="resetForm" class="px-4 py-3 bg-red-600 hover:bg-red-500 rounded-lg btn font-medium flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                Zurücksetzen
              </button>
            </div>
          </form>
        </div>

        <!-- ÜBERSICHT -->
        <div id="overview" class="card p-5 shadow-soft hidden-el fade-in">
          <h2 class="text-lg font-semibold mb-4 text-green-400 flex items-center gap-2">
            <span class="bg-green-900/30 p-2 rounded-lg">📋</span>
            Übersicht
          </h2>
          <div id="entriesList" class="space-y-3 max-h-[55vh] overflow-auto scrollbar-custom p-1"></div>
        </div>

        <!-- ADMIN -->
        <div id="adminPanel" class="card p-5 shadow-soft hidden-el fade-in">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-blue-400 flex items-center gap-2">
              <span class="bg-blue-900/30 p-2 rounded-lg">🔐</span>
              Adminbereich
            </h2>
            <button onclick="logout()" class="px-3 py-1 bg-red-600 hover:bg-red-500 rounded-lg btn text-sm flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
              </svg>
              Logout
            </button>
          </div>
          <div id="adminContent">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 p-3 rounded-lg bg-gray-800/30">
              <div class="small-muted">Gesamtanzahl: <span id="totalCount" class="font-bold text-white">0</span></div>
              <div class="small-muted">Gesamtumsatz: <span id="totalRevenue" class="font-bold text-green-400">0 $</span></div>
              <button id="exportCsv" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg shadow-sm btn flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                CSV Export
              </button>
            </div>
            <div class="overflow-auto max-h-[50vh] rounded-lg border border-gray-800 scrollbar-custom">
              <table class="w-full text-left text-sm">
                <thead class="text-gray-400 bg-gray-800/70 sticky top-0">
                  <tr>
                    <th class="p-3 font-medium">Datum</th>
                    <th class="p-3 font-medium">Käufer</th>
                    <th class="p-3 font-medium">Verkäufer</th>
                    <th class="p-3 font-medium">Menge</th>
                    <th class="p-3 font-medium">Preis</th>
                    <th class="p-3 font-medium">Verkäufer (70%)</th>
                    <th class="p-3 font-medium">Käufer (30%)</th>
                    <th class="p-3 font-medium">Aktion</th>
                  </tr>
                </thead>
                <tbody id="adminTableBody" class="divide-y divide-gray-800"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Discord Login Funktionen
    const CLIENT_ID = '1432942180770644079';

    // UI Funktionen
    function show(el) { 
      el.classList.remove('hidden-el'); 
      el.classList.add('fade-in');
    }
    function hide(el) { 
      el.classList.add('hidden-el'); 
      el.classList.remove('fade-in');
    }

    // Discord Login
    function discordLogin() {
      const REDIRECT_URI = encodeURIComponent('https://freedomworld1.github.io/KhusLand/');
      const SCOPE = encodeURIComponent('identify');
      
      const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=${SCOPE}`;
      
      // Öffne Discord Login in neuem Tab
      const popup = window.open(authUrl, 'Discord Login', 'width=500,height=600,scrollbars=yes');
      
      if (!popup) {
        alert('Pop-up blockiert! Bitte erlaube Pop-ups für diese Seite.');
        return;
      }
      
      // Prüfe ob Login erfolgreich
      const checkPopup = setInterval(() => {
        try {
          if (popup.closed) {
            clearInterval(checkPopup);
            return;
          }
          
          const popupUrl = popup.location.href;
          if (popupUrl.includes('access_token=')) {
            clearInterval(checkPopup);
            
            // Token aus URL extrahieren
            const hash = popup.location.hash;
            const tokenMatch = hash.match(/access_token=([^&]+)/);
            
            if (tokenMatch) {
              const token = tokenMatch[1];
              popup.close();
              getUserInfo(token);
            }
          }
        } catch (e) {
          // Cross-origin error, normal während des Logins
        }
      }, 1000);
    }

    // User Info von Discord API holen
    async function getUserInfo(token) {
      try {
        const response = await fetch('https://discord.com/api/users/@me', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) throw new Error('API Fehler');
        
        const userData = await response.json();
        
        // In localStorage speichern
        localStorage.setItem('discordUser', JSON.stringify(userData));
        localStorage.setItem('discordToken', token);
        
        // Zur Hauptapp wechseln
        showMainApp();
        
      } catch (error) {
        console.error('Fehler beim User Info holen:', error);
        showLoginError();
      }
    }

    // Hauptapp anzeigen nach Login
    function showMainApp() {
      hide(document.getElementById('loginScreen'));
      show(document.getElementById('mainApp'));
      initApp();
    }

    // Login Fehler anzeigen
    function showLoginError() {
      const errorEl = document.getElementById('loginError');
      show(errorEl);
      setTimeout(() => hide(errorEl), 5000);
    }

    // Logout
    function logout() {
      localStorage.removeItem('discordUser');
      localStorage.removeItem('discordToken');
      location.reload();
    }

    // Auth Status prüfen beim Laden
    function checkAuthStatus() {
      const savedUser = localStorage.getItem('discordUser');
      if (savedUser) {
        showMainApp();
      }
    }

    // App initialisieren
    function initApp() {
      // Dein bestehender App Code hier...
      console.log('App initialisiert');
    }

    // Beim Laden prüfen
    document.addEventListener('DOMContentLoaded', checkAuthStatus);

    // Firebase und bestehender App Code...
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
      authDomain: "khusland-b7d13.firebaseapp.com",
      databaseURL: "https://khusland-b7d13-default-rtdb.firebaseio.com",
      projectId: "khusland-b7d13",
      storageBucket: "khusland-b7d13.firebasestorage.app",
      messagingSenderId: "69573193613",
      appId: "1:69573193613:web:86c4d839281b1e343cd7c4",
      measurementId: "G-JSCWR4207G"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    const entriesRef = ref(db,'weed_entries');

    let entries = [];

    function formatCurrency(n) { 
      return new Intl.NumberFormat('de-DE').format(Math.round(n)) + ' $'; 
    }
    function formatDate(d) {
      const date = new Date(d);
      const pad = n => n.toString().padStart(2,'0');
      return `${pad(date.getDate())}.${pad(date.getMonth()+1)}.${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    // Hamburger Menu
    document.getElementById('hamburgerBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('hamburgerMenu').classList.toggle('hidden');
    });

    // Close hamburger menu when clicking outside
    document.addEventListener('click', (e) => {
      const hamburgerMenu = document.getElementById('hamburgerMenu');
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      
      if (!hamburgerMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
        hamburgerMenu.classList.add('hidden');
      }
    });

    // Tabs Navigation
    document.getElementById('btnNew').addEventListener('click', () => {
      show(document.getElementById('newEntry')); 
      hide(document.getElementById('overview')); 
      hide(document.getElementById('adminPanel'));
      updateButtonStates('new');
    });
    
    document.getElementById('btnOverview').addEventListener('click', () => {
      hide(document.getElementById('newEntry')); 
      show(document.getElementById('overview')); 
      hide(document.getElementById('adminPanel'));
      renderOverview();
      updateButtonStates('overview');
    });
    
    document.getElementById('btnAdmin').addEventListener('click', () => {
      hide(document.getElementById('newEntry')); 
      hide(document.getElementById('overview')); 
      show(document.getElementById('adminPanel'));
      updateButtonStates('admin');
    });

    function updateButtonStates(activeButton) {
      const buttons = {
        new: document.getElementById('btnNew'),
        overview: document.getElementById('btnOverview'),
        admin: document.getElementById('btnAdmin')
      };
      
      Object.values(buttons).forEach(btn => {
        btn.classList.remove('pulse-glow', 'bg-green-600', 'bg-blue-600');
        btn.classList.add('bg-gray-700');
      });
      
      if (buttons[activeButton]) {
        buttons[activeButton].classList.remove('bg-gray-700');
        if (activeButton === 'new') {
          buttons[activeButton].classList.add('bg-green-600', 'pulse-glow');
        } else if (activeButton === 'admin') {
          buttons[activeButton].classList.add('bg-blue-600');
        } else {
          buttons[activeButton].classList.add('bg-gray-600');
        }
      }
    }

    // Initialize with New Entry active
    updateButtonStates('new');

    // Share Calculation
    const quantityInput = document.getElementById('quantity');
    const sellerShareEl = document.getElementById('sellerShare');
    const yourShareEl = document.getElementById('yourShare');
    const totalPriceEl = document.getElementById('totalPrice');
    
    function updateShares() { 
      const q = Number(quantityInput.value) || 0;
      const price = q * 2500;
      totalPriceEl.textContent = formatCurrency(price);
      sellerShareEl.textContent = formatCurrency(price * 0.7);
      yourShareEl.textContent = formatCurrency(price * 0.3);
    }
    
    quantityInput.addEventListener('input', updateShares);
    updateShares();

    // Form submit
    document.getElementById('entryForm').addEventListener('submit', async e => {
      e.preventDefault();
      const buyer = document.getElementById('buyer').value.trim();
      const seller = document.getElementById('seller').value.trim();
      const quantity = Number(quantityInput.value);
      
      if (!buyer || !seller || !quantity) {
        alert('Bitte füllen Sie alle Felder aus!');
        return;
      }
      
      const price = quantity * 2500;
      const sellerShare = price * 0.7;
      const yourShare = price * 0.3;
      
      const entry = {
        buyer,
        seller,
        quantity,
        price,
        sellerShare,
        yourShare,
        date: formatDate(new Date()),
        timestamp: Date.now()
      };

      try {
        await push(entriesRef, entry);
        e.target.reset();
        updateShares();
        
        // Show success message
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
          Erfolgreich gespeichert!
        `;
        submitBtn.classList.remove('bg-green-600');
        submitBtn.classList.add('bg-green-500');
        
        setTimeout(() => {
          submitBtn.innerHTML = originalText;
          submitBtn.classList.remove('bg-green-500');
          submitBtn.classList.add('bg-green-600');
        }, 2000);
        
      } catch (error) {
        console.error('Fehler beim Speichern:', error);
        alert('Fehler beim Speichern der Daten!');
      }
    });

    // Reset form
    document.getElementById('resetForm').addEventListener('click', () => {
      if (confirm('Möchten Sie das Formular wirklich zurücksetzen?')) {
        document.getElementById('entryForm').reset(); 
        updateShares();
      }
    });

    // Real-time listener
    onValue(entriesRef, snapshot => {
      entries = [];
      snapshot.forEach(child => {
        const data = child.val();
        data.key = child.key;
        entries.push(data);
      });
      // Sortierung: Neueste oben (absteigend nach timestamp)
      entries.sort((a, b) => b.timestamp - a.timestamp);
      renderOverview();
      renderAdminTable();
    });

    // Übersicht rendern
    const entriesList = document.getElementById('entriesList');
    function renderOverview() {
      entriesList.innerHTML = '';
      if (entries.length === 0) {
        entriesList.innerHTML = '<div class="text-center py-8 text-gray-400"><p>Keine Einträge vorhanden.</p></div>'; 
        return;
      }
      
      // Die neuesten Einträge werden oben angezeigt (bereits sortiert)
      entries.forEach(en => {
        const el = document.createElement('div');
        el.className = 'p-4 rounded-lg bg-gray-800/50 border border-gray-700 hover:border-green-500/30 transition-all duration-200';
        el.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="text-sm text-gray-400">${en.date}</div>
            <div class="px-2 py-1 bg-green-900/30 text-green-400 text-xs rounded-full">${en.quantity} Bricks</div>
          </div>
          <div class="font-semibold text-lg mb-2">${en.buyer} → ${en.seller}</div>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="bg-gray-800/40 p-2 rounded-lg">
              <div class="text-gray-400">Gesamtpreis</div>
              <div class="font-medium text-white">${formatCurrency(en.price)}</div>
            </div>
            <div class="bg-gray-800/40 p-2 rounded-lg">
              <div class="text-gray-400">Verkäuferanteil</div>
              <div class="font-medium text-green-400">${formatCurrency(en.sellerShare)}</div>
            </div>
            <div class="bg-gray-800/40 p-2 rounded-lg">
              <div class="text-gray-400">Käuferanteil</div>
              <div class="font-medium text-blue-400">${formatCurrency(en.yourShare)}</div>
            </div>
            <div class="bg-gray-800/40 p-2 rounded-lg">
              <div class="text-gray-400">Pro Stück</div>
              <div class="font-medium text-purple-400">${formatCurrency(en.price / en.quantity)}</div>
            </div>
          </div>
        `;
        entriesList.appendChild(el);
      });
    }

    // Admin
    const adminTableBody = document.getElementById('adminTableBody');
    const totalCount = document.getElementById('totalCount');
    const totalRevenue = document.getElementById('totalRevenue');
    const exportCsv = document.getElementById('exportCsv');

    function renderAdminTable() {
      adminTableBody.innerHTML = '';
      let revenue = 0;
      
      // Die neuesten Einträge werden oben angezeigt (bereits sortiert)
      entries.forEach(en => {
        revenue += en.yourShare;
        const tr = document.createElement('tr');
        tr.className = 'border-t border-gray-800 hover:bg-gray-800/30 transition-colors';
        tr.innerHTML = `
          <td class="p-3 small-muted">${en.date}</td>
          <td class="p-3">${en.buyer}</td>
          <td class="p-3">${en.seller}</td>
          <td class="p-3">${en.quantity} </td>
          <td class="p-3">${formatCurrency(en.price)}</td>
          <td class="p-3 text-green-400">${formatCurrency(en.sellerShare)}</td>
          <td class="p-3 text-blue-400">${formatCurrency(en.yourShare)}</td>
          <td class="p-3">
            <button class="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-sm rounded-lg btn flex items-center gap-1" onclick="deleteEntry('${en.key}')">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 000-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
              Löschen
            </button>
          </td>`;
        adminTableBody.appendChild(tr);
      });
      
      totalCount.innerText = entries.length;
      totalRevenue.innerText = formatCurrency(revenue);
    }

    window.deleteEntry = function(key) {
      if (confirm('Eintrag wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) {
        remove(ref(db, 'weed_entries/' + key));
      }
    }

    // CSV Export
    exportCsv.addEventListener('click', () => {
      if (entries.length === 0) {
        alert('Keine Einträge zum Exportieren vorhanden.');
        return;
      }
      
      // Sortierung: Neueste oben
      const sortedEntries = [...entries].sort((a, b) => b.timestamp - a.timestamp);
      const header = ['Datum', 'Käufer', 'Verkäufer', 'Menge ', 'Preis ', 'Verkäuferanteil (70%)', 'Käuferanteil (30%)'];
      const rows = sortedEntries.map(e => [
        e.date,
        `"${e.buyer}"`,
        `"${e.seller}"`,
        e.quantity,
        e.price,
        e.sellerShare,
        e.yourShare
      ].join(','));
      
      const csv = [header.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      // Generate filename with current date
      const now = new Date();
      const dateStr = `${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()}`;
      a.download = `weed_ankauf_${dateStr}.csv`;
      
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    });
  </script>
</body>
</html>

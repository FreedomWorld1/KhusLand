<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="htmlTitle">ðŸŒ´ ITALIANA Bestellrechner ðŸŒ´</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root { --tab-left:0; --tab-width:100px; }
  #tabsSlider { position:absolute; bottom:0; left:var(--tab-left); width:var(--tab-width); height:2px; background:red; transition:left 0.3s, width 0.3s; }
  .hidden { display:none; }
</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

<div class="container mx-auto p-4">
  <h1 id="calculatorTitle" class="text-2xl font-bold mb-4 text-center">ðŸŒ´ ITALIANA Bestellrechner ðŸŒ´</h1>
  <img id="headerImage" src="https://via.placeholder.com/150" class="mx-auto mb-4 rounded">
  
  <!-- Tabs -->
  <div id="tabsContainer" class="relative flex justify-between mb-2">
    <button class="tab-button active px-4 py-2 border-b-2 border-red-500" data-tab="1">Tab 1</button>
    <button class="tab-button px-4 py-2" data-tab="2">Tab 2</button>
    <button class="tab-button px-4 py-2" data-tab="3">Tab 3</button>
    <button class="tab-button px-4 py-2" data-tab="4">Tab 4</button>
    <button class="tab-button px-4 py-2" data-tab="5">Tab 5</button>
    <div id="tabsSlider"></div>
  </div>

  <!-- Calculator Content -->
  <div id="calculatorContent" class="space-y-4">
    <input id="personCountInput" type="number" min="0" placeholder="Personenzahl" class="w-full p-2 rounded border">
    <div id="categoriesGrid" class="space-y-6"></div>
    <div class="flex justify-between mt-4">
      <span id="grund">Noch nichts berechnet</span>
      <span id="preis">0$</span>
    </div>
    <button onclick="berechne()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Berechnen</button>
    <button onclick="resetRechner()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded mt-2">ZurÃ¼cksetzen</button>
  </div>

  <!-- Theme Toggle -->
  <label class="flex items-center mt-4">
    <input type="checkbox" id="themeToggle" class="mr-2" onchange="toggleTheme()"> Dunkles Theme
  </label>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
    <div class="bg-white dark:bg-gray-800 p-6 rounded w-full max-w-xl relative">
      <button onclick="closeSettings()" class="absolute top-2 right-2 text-red-600">X</button>
      <div id="passwordSection">
        <input type="password" id="passwordInput" placeholder="Admin Passwort" class="w-full p-2 mb-2 border rounded">
        <button onclick="checkPassword()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Login</button>
        <span id="passwordError" class="text-red-600 hidden">Falsches Passwort!</span>
      </div>
      <div id="editSection" class="hidden">
        <div class="tabs flex space-x-2 mb-4">
          <button onclick="showEditor('item')">Artikel</button>
          <button onclick="showEditor('category')">Kategorie</button>
          <button onclick="showEditor('general')">Allgemein</button>
        </div>
        <div id="itemEditor" class="hidden">
          <div id="itemEditorContent"></div>
        </div>
        <div id="categoryEditor" class="hidden">
          <div id="categoryEditorContent"></div>
        </div>
        <div id="generalSettingsEditor" class="hidden">
          <h4 class="text-lg font-bold mb-3">Generelle Einstellungen</h4>
          <div class="mb-4">
            <label for="titleInput" class="block text-sm font-medium mb-2">Titel Ã¤ndern:</label>
            <input type="text" id="titleInput" placeholder="Neuer Titel" class="w-full p-2 border rounded">
          </div>
          <div class="mb-4">
            <label for="imageUpload" class="block text-sm font-medium mb-2">Bild hochladen (150x150px):</label>
            <input type="file" id="imageUpload" accept="image/*" class="w-full p-2 border rounded">
          </div>
          <button onclick="saveGeneralSettings()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Speichern</button>
          <button onclick="resetImage()" class="mt-2 w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded">Bild zurÃ¼cksetzen</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-20 hidden flex justify-center items-center">
  <div class="loader border-4 border-t-4 border-blue-500 rounded-full w-12 h-12 animate-spin"></div>
</div>

<script>
tailwind.config = { darkMode: 'class' };

const JSONBIN_MASTER_KEY = 'DEIN_MASTER_KEY';
const JSONBIN_BIN_ID = 'DEINE_BIN_ID';
const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
const JSONBIN_HEADERS = {
  'X-Master-Key': JSONBIN_MASTER_KEY,
  'Content-Type': 'application/json'
};

const ENCODED_PASSWORD = "MTIzIUtSQyExMjM=";
const DEFAULT_IMAGE_URL = 'https://via.placeholder.com/150';
const itemsPerPerson = 5;
const numTabs = 5;

let currentPreise = {};
let categories = [];
let foodCategories = [];
let drinkCategories = [];
let rauchwarenCategories = [];
let miscellaneousCategories = [];
let customTitle = 'ðŸŒ´ ITALIANA Bestellrechner ðŸŒ´';
let customImage = DEFAULT_IMAGE_URL;
let activeTab = 1;
let calculatorStates = {};

function decodeBase64(str){ return atob(str); }
function showLoading(){ document.getElementById('loadingOverlay').classList.remove('hidden'); }
function hideLoading(){ document.getElementById('loadingOverlay').classList.add('hidden'); }

async function loadPreise() {
  showLoading();
  try{
    const res = await fetch(JSONBIN_URL,{headers:{'X-Master-Key':JSONBIN_MASTER_KEY}});
    if(!res.ok) throw new Error(res.status);
    const data = await res.json();
    if(data.record){
      currentPreise = data.record.items||{};
      categories = data.record.categories||[];
      foodCategories = data.record.foodCategories||[];
      drinkCategories = data.record.drinkCategories||[];
      rauchwarenCategories = data.record.rauchwarenCategories||[];
      miscellaneousCategories = data.record.miscellaneousCategories||[];
      customTitle = data.record.title||customTitle;
      customImage = data.record.image||DEFAULT_IMAGE_URL;
    } else { console.warn('Keine Daten, Standard laden'); }
  } catch(e){
    console.error(e); alert('Fehler beim Laden, Standarddaten werden verwendet.');
  } finally{
    hideLoading();
    renderCalculatorInputs(); updateGeneralSettingsDisplay();
  }
}

async function savePreise() {
  showLoading();
  try{
    const payload = { items:currentPreise, categories, foodCategories, drinkCategories, rauchwarenCategories, miscellaneousCategories, title:customTitle, image:customImage };
    await fetch(JSONBIN_URL,{method:'PUT',headers:JSONBIN_HEADERS,body:JSON.stringify(payload)});
  } catch(e){ console.error(e); alert('Speichern fehlgeschlagen'); }
  finally{ hideLoading(); }
}

function renderCalculatorInputs(){
  const grid = document.getElementById('categoriesGrid');
  grid.innerHTML='';
  categories.forEach(cat=>{
    const div = document.createElement('div');
    div.innerHTML = `<h2 class="text-xl font-bold">${cat}</h2><div class="space-y-2"></div>`;
    const itemsDiv = div.querySelector('div');
    Object.values(currentPreise).filter(i=>i.category===cat).forEach(item=>{
      const itemDiv = document.createElement('div');
      itemDiv.className='flex justify-between items-center';
      itemDiv.innerHTML = `
        <span>${item.name} (${item.price}$)</span>
        <div class="flex items-center space-x-1">
          <button onclick="changeQuantity('${item.id}',-1)">-</button>
          <input id="${item.id}" type="number" min="0" value="0" class="w-12 text-center" oninput="berechne()">
          <button onclick="changeQuantity('${item.id}',1)">+</button>
        </div>`;
      itemsDiv.appendChild(itemDiv);
    });
    grid.appendChild(div);
  });
}

function changeQuantity(id,change){
  const input=document.getElementById(id);
  let val=parseInt(input.value)||0; val+=change; if(val<0) val=0; input.value=val; berechne();
}

function berechne(){
  let summe=0,foodCount=0,drinkCount=0,rauchCount=0;
  const ordered=[],misc=[];
  const manualPersonCount = parseInt(document.getElementById('personCountInput').value)||0;
  for(const k in currentPreise){
    const el=document.getElementById(k);
    if(el){
      const a=parseInt(el.value)||0;
      if(a>0){
        summe+=a*currentPreise[k].price;
        const cat=currentPreise[k].category;
        if(foodCategories.includes(cat)) { foodCount+=a; ordered.push(`${a}x ${currentPreise[k].name}`); }
        else if(drinkCategories.includes(cat)) { drinkCount+=a; ordered.push(`${a}x ${currentPreise[k].name}`); }
        else if(rauchwarenCategories.includes(cat)) { rauchCount+=a; ordered.push(`${a}x ${currentPreise[k].name}`); }
        else if(miscellaneousCategories.includes(cat)) misc.push(`${a}x ${currentPreise[k].name}`);
      }
    }
  }
  document.getElementById('preis').innerText=summe+'$';
  let grund='';
  const totalItems=foodCount+drinkCount+rauchCount+misc.length;
  const today=new Date();
  const dateStr=`${String(today.getDate()).padStart(2,'0')}.${String(today.getMonth()+1).padStart(2,'0')}.`;
  if(totalItems>0||manualPersonCount>0){
    const parts=[`KRC | ${dateStr}`];
    if(manualPersonCount>0) parts.push(`${manualPersonCount}P`);
    else { const persons=Math.max(foodCount,drinkCount)>0?Math.ceil(Math.max(foodCount,drinkCount)/itemsPerPerson):0; if(persons>0) parts.push(`${persons}P`); }
    const allOrdered=[...ordered,...misc]; if(allOrdered.length>0) parts.push(allOrdered.join(' + '));
    const cats=[]; if(foodCount>0) cats.push('Essen'); if(drinkCount>0) cats.push('Trinken'); if(rauchCount>0) cats.push('Rauchwaren'); if(cats.length>0) parts.push(cats.join(' & '));
    grund=parts.join(' | ');
  } else grund='Noch nichts berechnet';
  document.getElementById('grund').innerText=grund;
  saveCalculatorState();
}

function toggleTheme(){
  const html=document.documentElement;
  const isDark=html.classList.toggle('dark');
  localStorage.setItem('theme',isDark?'dark':'light');
}

function resetRechner(){
  document.getElementById('personCountInput').value=0;
  document.querySelectorAll('#calculatorContent input[type="number"]').forEach(i=>i.value=0);
  document.getElementById('grund').innerText='Noch nichts berechnet';
  document.getElementById('preis').innerText='0$';
  saveCalculatorState();
}

function initializeCalculatorStates(){
  for(let i=1;i<=numTabs;i++) calculatorStates[i]={inputs:{},grund:'Noch nichts berechnet',preis:'0$',personCount:'0'};
  const saved=localStorage.getItem('calculatorStates');
  if(saved){ Object.assign(calculatorStates,JSON.parse(saved)); }
}

function saveCalculatorState(){
  const inputs=document.querySelectorAll('#calculatorContent input[type="number"]');
  const state={inputs:{}};
  inputs.forEach(i=>state.inputs[i.id]=i.value);
  state.grund=document.getElementById('grund').innerText;
  state.preis=document.getElementById('preis').innerText;
  state.personCount=document.getElementById('personCountInput').value;
  calculatorStates[activeTab]=state;
  localStorage.setItem('calculatorStates',JSON.stringify(calculatorStates));
}

function loadCalculatorState(){
  const state=calculatorStates[activeTab];
  if(state){
    Object.keys(state.inputs).forEach(id=>{ const el=document.getElementById(id); if(el) el.value=state.inputs[id]; });
    document.getElementById('grund').innerText=state.grund;
    document.getElementById('preis').innerText=state.preis;
    document.getElementById('personCountInput').value=state.personCount;
  }
}

function updateGeneralSettingsDisplay(){
  document.getElementById('htmlTitle').innerText=customTitle;
  document.getElementById('calculatorTitle').innerText=customTitle;
  document.getElementById('headerImage').src=customImage;
}

window.onload=async function(){
  await loadPreise();
  initializeCalculatorStates();
  const savedTab=localStorage.getItem('activeTab');
  if(savedTab) activeTab=parseInt(savedTab);
  const btn=document.querySelector(`.tab-button[data-tab="${activeTab}"]`);
  if(btn) btn.classList.add('active');
  const savedTheme=localStorage.getItem('theme');
  if(savedTheme==='dark'||(!savedTheme&&window.matchMedia('(prefers-color-scheme: dark)').matches)){
    document.documentElement.classList.add('dark');
    document.body.classList.add('dark');
    document.getElementById('themeToggle').checked=true;
  }
  loadCalculatorState();
  document.querySelectorAll('.tab-button').forEach(btn=>btn.addEventListener('click',()=>{ switchTab(parseInt(btn.dataset.tab)); }));
  window.addEventListener('resize',()=>{ const b=document.querySelector(`.tab-button[data-tab="${activeTab}"]`); if(b) updateSliderPosition(b); });
};

function updateSliderPosition(tabButton){
  const slider=document.getElementById('tabsSlider');
  const container=document.getElementById('tabsContainer');
  const rect=tabButton.getBoundingClientRect();
  const containerRect=container.getBoundingClientRect();
  slider.style.setProperty('--tab-left',`${rect.left-containerRect.left}px`);
  slider.style.setProperty('--tab-width',`${rect.width}px`);
}

const originalSwitchTab=switchTab;
function switchTab(tabNumber){
  if(tabNumber===activeTab) return;
  saveCalculatorState();
  document.querySelectorAll('.tab-button').forEach(btn=>btn.classList.remove('active'));
  const newBtn=document.querySelector(`.tab-button[data-tab="${tabNumber}"]`);
  if(newBtn){ newBtn.classList.add('active'); updateSliderPosition(newBtn);}
  activeTab=tabNumber;
  localStorage.setItem('activeTab',tabNumber);
  loadCalculatorState();
  berechne();
}
</script>
</body>
</html>

<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bullet Farm v2 ‚Äî Shop</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#0f1724;--card:#0b1220;--muted:#9ca3af;--accent:#06b6d4}
body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:#071025;color:#e6eef8;margin:0}
.container{max-width:1100px;margin:0 auto;padding:20px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);border-radius:12px;padding:16px}
.shadow-soft{box-shadow:0 8px 30px rgba(2,6,23,0.6)}
.small-muted{color:var(--muted);font-size:0.85rem;margin-top:4px}
.btn{transition:all .12s ease;border-radius:8px;padding:.45rem .8rem;cursor:pointer;background:#111827;color:#e6eef8;border:1px solid rgba(255,255,255,0.03)}
.btn:hover{transform:translateY(-2px)}
.hidden-el{display:none !important}
.product-image{width:100%;height:130px;object-fit:cover;border-radius:8px}
.product-image-admin{width:80px;height:50px;object-fit:cover;border-radius:6px}
#productsGrid .card{max-width:220px;margin:0 auto}
.modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(4,6,11,0.6);opacity:0;pointer-events:none;transition:opacity .22s ease;z-index:80}
.modal-overlay.active{opacity:1;pointer-events:all}
.modal-box{width:96%;max-width:980px;background:linear-gradient(180deg,#0b1220,#0f1724);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 20px 60px rgba(2,6,23,0.7);transform:translateY(-8px);transition:transform .22s ease;max-height:90vh;overflow:auto}
.tab-btn{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
.tab-btn.active{background:linear-gradient(90deg,#94a3b8,#06b6d4);color:#041628;font-weight:700}
.table {width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:0.92rem}
.kv{font-size:0.9rem;color:var(--muted)}
.category-item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:6px}
.input,textarea,select{background:#071224;border:1px solid rgba(255,255,255,0.04);color:#e6eef8;padding:.5rem;border-radius:8px;width:100%}
.color-input{width:48px;height:36px;padding:0;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#fff}
.small-btn{padding:.35rem .6rem;border-radius:6px}
.flex-row{display:flex;gap:8px;align-items:center}
.right{margin-left:auto}
/* Snackbar */
#snackbar{visibility:hidden;min-width:250px;background-color:#333;color:#fff;text-align:center;border-radius:4px;padding:12px;position:fixed;z-index:100;left:50%;bottom:30px;font-size:1rem;transform:translateX(-50%);opacity:0;transition:opacity 0.3s, bottom 0.3s;}
#snackbar.show{visibility:visible;opacity:1;bottom:50px;}
@media(max-width:480px){.modal-box{width:100%;height:100%;border-radius:0;}}
</style>
</head>
<body>
<div class="container">
  <header class="card shadow-soft mb-6 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <img id="headerLogo" src="https://via.placeholder.com/48" alt="Logo" style="width:48px;height:48px;object-fit:cover;border-radius:8px">
      <div>
        <h1 id="pageTitle" style="font-size:1.4rem;font-weight:700;color:#22c55e;margin:0">Bullet Farm v2</h1>
        <div class="small-muted">Shop</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnShop" class="btn">Shop</button>
      <button id="btnCart" class="btn">Warenkorb</button>
      <button id="openSettingsBtn" class="btn">‚öôÔ∏è</button>
    </div>
  </header>

  <main id="mainContent">
    <section id="shopView" class="card mb-6">
      <div class="flex items-center justify-between mb-4">
        <div style="display:flex;gap:10px;align-items:center">
          <h2 style="font-weight:700;color:#22c55e;margin:0">üõí Produkte</h2>
          <div class="kv">Filter:</div>
          <select id="shopCategoryFilter" class="input" style="width:200px">
            <option value="">‚Äî Alle Kategorien ‚Äî</option>
          </select>
        </div>
        <div class="kv">Produkte anzeigen</div>
      </div>
      <div id="productsGrid" class="grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px"></div>
    </section>

    <section id="cartView" class="card mb-6 hidden-el">
      <div class="flex items-center justify-between mb-4">
        <h2 style="font-weight:700;color:#22c55e">üõçÔ∏è Warenkorb</h2>
        <div class="kv">Ressourcen & Anzahl</div>
      </div>
      <table class="table" id="cartTable">
        <thead><tr><th>Produkt</th><th>Ressourcen</th><th style="text-align:right">Anzahl</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:12px;font-weight:700" id="cartSummary">Gesamt Ressourcen: keine</div>
    </section>
  </main>
</div>

<div id="settingsModal" class="modal-overlay hidden-el" aria-hidden="true">
  <div class="modal-box">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h3 style="font-size:1.15rem;font-weight:700;color:#94a3b8;margin:0">‚öôÔ∏è Einstellungen</h3>
        <div class="kv">Passwortgesch√ºtzt ‚Äî Admin Funktionen</div>
      </div>
      <div class="flex gap-2 items-center">
        <button id="settingsCloseBtn" class="btn">‚úñ</button>
      </div>
    </div>
    <div id="settingsLoginArea">
      <label class="kv mb-2">Admin Passwort</label>
      <div class="flex items-center gap-2 mb-3">
        <input id="settingsPassword" type="password" class="input" placeholder="Passwort (admin123)"/>
        <button id="settingsUnlockBtn" class="btn">Einloggen</button>
      </div>
      <div id="settingsLoginError" class="kv" style="color:#ff7b7b;display:none">‚ùå Falsches Passwort</div>
    </div>
    <div id="settingsEditor" class="hidden-el">
      <!-- Tabs wie bisher, unver√§ndert -->
    </div>
  </div>
</div>

<div id="snackbar"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = { apiKey:"AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo", authDomain:"khusland-b7d13.firebaseapp.com", databaseURL:"https://khusland-b7d13-default-rtdb.firebaseio.com", projectId:"khusland-b7d13", storageBucket:"khusland-b7d13.firebasestorage.app", messagingSenderId:"69573193613", appId:"1:69573193613:web:86c4d839281b1e343cd7c4", measurementId:"G-JSCWR4207G" };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productsRef = ref(db, 'products');
const settingsRef = ref(db, 'settings');
const categoriesRef = ref(db, 'categories');
const ordersRef = ref(db, 'orders');

const ADMIN_PASSWORD = 'admin123';
const cartKey = 'bfv2_cart';
let cart = JSON.parse(localStorage.getItem(cartKey) || '[]');

// Snackbar helper
function showSnackbar(msg){ 
  const sb = document.getElementById('snackbar');
  sb.textContent = msg; sb.classList.add('show');
  setTimeout(()=>sb.classList.remove('show'),3000);
}

// Save cart to localStorage
function saveCart(){ localStorage.setItem(cartKey, JSON.stringify(cart)); }

// Generate unique order code
function generateOrderCode(){ return Date.now().toString(36).slice(-6); }

// Convert resources string to JSON map
function resourcesToMap(resourcesString){
  if(!resourcesString) return {};
  const map = {};
  resourcesString.split(';').filter(Boolean).forEach(r=>{
    const [k,v] = r.split(':');
    if(k && v) map[k] = Number(v);
  });
  return map;
}

// Add to cart
function addToCart(product){
  const resMap = resourcesToMap(product.resources || '');
  const idx = cart.findIndex(c=>c.key===product.key);
  if(idx===-1){
    cart.push({ key:product.key, name:product.name, resources:resMap, qty:1 });
  } else {
    cart[idx].qty +=1;
    for(const k in resMap) cart[idx].resources[k] = (cart[idx].resources[k]||0)+resMap[k];
  }
  saveCart();
  renderCart();
  showSnackbar(`${product.name} hinzugef√ºgt`);
}

// Render cart
function renderCart(){
  const tbody = document.querySelector('#cartTable tbody');
  tbody.innerHTML='';
  const total = {};
  cart.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.name}</td><td>${Object.entries(c.resources).map(([k,v])=>k+': '+v).join(', ')}</td><td style="text-align:right">${c.qty}</td>`;
    tbody.appendChild(tr);
    for(const k in c.resources) total[k] = (total[k]||0)+c.resources[k];
  });
  document.getElementById('cartSummary').innerText='Gesamt Ressourcen: '+(Object.entries(total).map(([k,v])=>k+': '+v).join(', ')||'keine');
}

// Initial render
renderCart();

// Shop/Cart toggle
document.getElementById('btnShop').onclick=()=>{ document.getElementById('shopView').classList.remove('hidden-el'); document.getElementById('cartView').classList.add('hidden-el'); };
document.getElementById('btnCart').onclick=()=>{ document.getElementById('shopView').classList.add('hidden-el'); document.getElementById('cartView').classList.remove('hidden-el'); renderCart(); };

// Admin login
const settingsModal = document.getElementById('settingsModal');
document.getElementById('openSettingsBtn').onclick=()=>{ settingsModal.classList.remove('hidden-el'); setTimeout(()=>settingsModal.classList.add('active'),10); };
document.getElementById('settingsCloseBtn').onclick=()=>{ settingsModal.classList.remove('active'); setTimeout(()=>settingsModal.classList.add('hidden-el'),200); };
document.getElementById('settingsUnlockBtn').onclick=()=>{
  if(document.getElementById('settingsPassword').value.trim()===ADMIN_PASSWORD){
    document.getElementById('settingsLoginArea').classList.add('hidden-el');
    document.getElementById('settingsEditor').classList.remove('hidden-el');
    showSnackbar('Admin angemeldet');
  } else { showSnackbar('Falsches Passwort'); }
};
</script>
</body>
</html>

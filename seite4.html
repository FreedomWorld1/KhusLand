<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Weed Ankauf ‚Äî Shop</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Grundlayout */
body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto; }
.bg-card { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.05); border-radius: 12px; }
.small-muted { color: #9ca3af; font-size: 0.8rem; margin-top:2px; display:block; }
.btn { transition: all .12s ease; font-size: 0.9rem; cursor:pointer; }
.btn:hover { transform: translateY(-2px); }

/* product images */
.product-image { width:100%; height:120px; object-fit:cover; border-radius:8px; }
.product-image-admin { width:80px; height:50px; object-fit:cover; border-radius:4px; }

/* helper */
.hidden-el { display:none !important; }

/* SETTINGS MODAL - centered with fade */
.modal-overlay {
  position: fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background: rgba(0,0,0,0.6); z-index:60; opacity:0; pointer-events:none; transition:opacity .22s ease;
}
.modal-overlay.active { opacity:1; pointer-events:all; }
.modal-box {
  width: 96%; max-width: 980px; background: linear-gradient(180deg,#0b1220,#0f1724); padding:18px; border-radius:12px;
  border:1px solid rgba(255,255,255,0.04); box-shadow: 0 18px 50px rgba(0,0,0,0.6);
  transform: translateY(-8px); transition:transform .22s ease;
}
.modal-overlay.active .modal-box { transform: translateY(0); }

/* tabs */
.tab-btn { padding:8px 12px; border-radius:8px; background: rgba(255,255,255,0.02); cursor:pointer; }
.tab-btn.active { background: linear-gradient(90deg,#10b981,#06b6d4); color:#051124; font-weight:600; }

/* categories list */
.category-item { display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px; background: rgba(255,255,255,0.02); border-radius:8px; margin-bottom:6px; }

/* small text */
.kv { font-size:0.9rem; color:#9ca3af; }
</style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen antialiased">

<div class="max-w-6xl mx-auto p-6">
  <!-- Header -->
  <header class="flex items-center justify-between mb-6 p-4 bg-gradient-to-r from-gray-800 to-gray-900 rounded-lg">
    <div class="flex items-center gap-4">
      <img id="headerLogo" src="https://via.placeholder.com/48" alt="Logo" class="rounded" style="width:48px;height:48px;object-fit:cover;">
      <h1 id="pageTitle" class="text-2xl font-bold text-green-400 tracking-tight">üåø Weed Ankauf ‚Äî Shop</h1>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnShop" class="btn px-3 py-1.5 bg-gray-800 rounded-md hover:bg-gray-700">Shop</button>
      <!-- Admin button removed; settings replaces admin -->
      <button id="openSettingsBtn" class="btn px-3 py-1.5 bg-gray-700 rounded-md hover:bg-gray-600">‚öôÔ∏è Einstellungen</button>
    </div>
  </header>

  <!-- Main content -->
  <div id="mainContainer" class="space-y-5">
    <section id="shopView" class="bg-card p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-green-400">üõí Produkte</h2>
        <div class="small-muted">Produkte anzeigen</div>
      </div>
      <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>
  </div>
</div>

<!-- SETTINGS MODAL (zentriert, Tabs: Produkte / Kategorien / Allgemein) -->
<div id="settingsModal" class="modal-overlay hidden-el" aria-hidden="true">
  <div class="modal-box text-gray-100">
    <div class="flex justify-between items-start mb-3">
      <h3 class="text-xl font-semibold">‚öôÔ∏è Einstellungen</h3>
      <div class="flex gap-2 items-center">
        <button id="settingsCloseBtn" class="text-red-400 text-xl font-bold">&times;</button>
      </div>
    </div>

    <!-- Login -->
    <div id="settingsLoginArea" class="">
      <label class="block kv mb-2">Admin-Passwort</label>
      <div class="flex gap-2 mb-3">
        <input id="settingsPassword" type="password" placeholder="Passwort" class="w-full p-2 rounded bg-gray-800 border border-gray-700" />
        <button id="settingsUnlockBtn" class="px-4 py-2 bg-blue-600 rounded">Einloggen</button>
      </div>
      <div id="settingsLoginError" class="kv text-red-400 hidden-el">‚ùå Falsches Passwort</div>
    </div>

    <!-- Editor (hidden until password ok) -->
    <div id="settingsEditor" class="hidden-el">
      <!-- tabs -->
      <div class="mb-3">
        <div class="flex gap-2">
          <button class="tab-btn active" data-tab="products">Produkte</button>
          <button class="tab-btn" data-tab="categories">Kategorien</button>
          <button class="tab-btn" data-tab="general">Allgemein</button>
        </div>
      </div>

      <!-- tab contents -->
      <div id="tabProducts" class="tab-panel">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold">Produkte verwalten</h4>
          <div class="flex gap-2">
            <button id="btnNewProduct" class="px-3 py-2 bg-green-600 rounded">Neues Produkt</button>
            <button id="btnReloadProducts" class="px-3 py-2 bg-gray-700 rounded">Neu laden</button>
          </div>
        </div>

        <!-- product form -->
        <div id="productFormCard" class="p-4 bg-gray-800 rounded mb-3 hidden-el">
          <form id="productForm" class="space-y-3">
            <input id="prodId" type="hidden"/>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input id="prodName" placeholder="Name" class="p-2 rounded bg-gray-900 border border-gray-700 w-full" required />
              <input id="prodImg" placeholder="Bild-URL" class="p-2 rounded bg-gray-900 border border-gray-700 w-full" />
            </div>
            <textarea id="prodDesc" rows="2" placeholder="Beschreibung (optional)" class="p-2 rounded bg-gray-900 border border-gray-700 w-full"></textarea>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="flex flex-col">Kategorie
                <select id="prodCategorySelect" class="p-2 rounded bg-gray-900 border border-gray-700 w-full"></select>
              </label>
              <label class="flex flex-col">Name-Farbe
                <input type="color" id="colorNameInput" value="#22c55e" />
              </label>
            </div>

            <div class="flex gap-2">
              <button type="submit" class="px-4 py-2 bg-green-600 rounded">Speichern</button>
              <button id="cancelProductBtn" type="button" class="px-4 py-2 bg-red-600 rounded">Abbrechen</button>
            </div>
          </form>
        </div>

        <!-- product list -->
        <div class="overflow-auto max-h-[50vh] rounded-md border border-gray-800 p-2">
          <table class="w-full text-left text-sm">
            <thead class="text-gray-300">
              <tr><th class="p-2">Vorschau</th><th class="p-2">Name</th><th class="p-2">Kategorie</th><th class="p-2">Aktion</th></tr>
            </thead>
            <tbody id="productsTableBody" class="divide-y divide-gray-800"></tbody>
          </table>
        </div>
      </div>

      <div id="tabCategories" class="tab-panel hidden-el">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold">Kategorien</h4>
          <div class="kv">Hinweis: Kategorien werden im Settings-Pfad gespeichert</div>
        </div>

        <div id="categoriesList" class="mb-3"></div>

        <div class="flex gap-2">
          <input id="newCategoryInput" placeholder="Neue Kategorie" class="p-2 rounded bg-gray-900 border border-gray-700 w-full" />
          <button id="addCategoryBtn" class="px-4 py-2 bg-green-600 rounded">Hinzuf√ºgen</button>
        </div>

        <div class="mt-3 flex gap-2">
          <button id="saveCategoriesBtn" class="px-4 py-2 bg-blue-600 rounded">Speichern</button>
          <button id="reloadCategoriesBtn" class="px-4 py-2 bg-gray-700 rounded">Neu laden</button>
        </div>
      </div>

      <div id="tabGeneral" class="tab-panel hidden-el">
        <h4 class="font-semibold mb-3">Allgemeine Einstellungen</h4>

        <label class="block kv mb-2">Titel</label>
        <input id="settingTitle" class="w-full p-2 rounded bg-gray-900 border border-gray-700 mb-3" />

        <label class="block kv mb-2">Header-Bild URL (48x48 empfohlen)</label>
        <input id="settingHeaderImage" class="w-full p-2 rounded bg-gray-900 border border-gray-700 mb-3" />

        <div class="flex gap-2">
          <button id="saveGeneralBtn" class="px-4 py-2 bg-green-600 rounded">Speichern</button>
          <button id="resetGeneralBtn" class="px-4 py-2 bg-red-600 rounded">Zur√ºcksetzen</button>
        </div>
      </div>

    </div> <!-- end settingsEditor -->
  </div>
</div>

<!-- Firebase + Logic -->
<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, set, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

/* --- Firebase config - unver√§ndert --- */
const firebaseConfig = { apiKey:"AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo", authDomain:"khusland-b7d13.firebaseapp.com", databaseURL:"https://khusland-b7d13-default-rtdb.firebaseio.com", projectId:"khusland-b7d13", storageBucket:"khusland-b7d13.firebasestorage.app", messagingSenderId:"69573193613", appId:"1:69573193613:web:86c4d839281b1e343cd7c4", measurementId:"G-JSCWR4207G" };

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productsRef = ref(db, 'products');
const settingsRef = ref(db, 'settings');

/* Admin password */
const ADMIN_PASSWORD = 'admin123';

/* --- Elements --- */
const openSettingsBtn = document.getElementById('openSettingsBtn');
const settingsModal = document.getElementById('settingsModal');
const settingsCloseBtn = document.getElementById('settingsCloseBtn');
const settingsPassword = document.getElementById('settingsPassword');
const settingsUnlockBtn = document.getElementById('settingsUnlockBtn');
const settingsLoginError = document.getElementById('settingsLoginError');
const settingsLoginArea = document.getElementById('settingsLoginArea');
const settingsEditor = document.getElementById('settingsEditor');

const tabBtns = document.querySelectorAll('.tab-btn');
const tabPanels = document.querySelectorAll('.tab-panel');

/* Products UI */
const btnNewProduct = document.getElementById('btnNewProduct');
const productFormCard = document.getElementById('productFormCard');
const productForm = document.getElementById('productForm');
const cancelProductBtn = document.getElementById('cancelProductBtn');
const prodId = document.getElementById('prodId');
const prodName = document.getElementById('prodName');
const prodImg = document.getElementById('prodImg');
const prodDesc = document.getElementById('prodDesc');
const prodCategorySelect = document.getElementById('prodCategorySelect');
const colorNameInput = document.getElementById('colorNameInput');

const productsTableBody = document.getElementById('productsTableBody');
const btnReloadProducts = document.getElementById('btnReloadProducts');

/* Categories UI */
const categoriesList = document.getElementById('categoriesList');
const newCategoryInput = document.getElementById('newCategoryInput');
const addCategoryBtn = document.getElementById('addCategoryBtn');
const saveCategoriesBtn = document.getElementById('saveCategoriesBtn');
const reloadCategoriesBtn = document.getElementById('reloadCategoriesBtn');

/* General UI */
const settingTitle = document.getElementById('settingTitle');
const settingHeaderImage = document.getElementById('settingHeaderImage');
const saveGeneralBtn = document.getElementById('saveGeneralBtn');
const resetGeneralBtn = document.getElementById('resetGeneralBtn');

const pageTitle = document.getElementById('pageTitle');
const headerLogo = document.getElementById('headerLogo');
const productsGrid = document.getElementById('productsGrid');

/* state */
let products = [];
let settings = { title: 'üåø Weed Ankauf ‚Äî Shop', headerImage: 'https://via.placeholder.com/48', categories: [] };

/* ---------- Utility ---------- */
function showModal(){
  settingsModal.classList.remove('hidden-el');
  setTimeout(()=> settingsModal.classList.add('active'), 10);
  document.body.style.overflow = 'hidden';
}
function hideModal(){
  settingsModal.classList.remove('active');
  document.body.style.overflow = '';
  setTimeout(()=> settingsModal.classList.add('hidden-el'), 220);
}

/* open/close handlers */
openSettingsBtn.addEventListener('click', ()=> {
  // reset login UI
  settingsPassword.value = '';
  settingsLoginError.classList.add('hidden-el');
  settingsLoginArea.classList.remove('hidden-el');
  settingsEditor.classList.add('hidden-el');
  showModal();
});
settingsCloseBtn.addEventListener('click', hideModal);
settingsModal.addEventListener('click', (e)=> { if(e.target === settingsModal) hideModal(); });
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape' && !settingsModal.classList.contains('hidden-el')) hideModal(); });

/* tab switching */
tabBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.tab;
    tabPanels.forEach(p=> p.classList.add('hidden-el'));
    document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden-el');
  });
});

/* ------------- Firebase: Settings load/save ------------- */
onValue(settingsRef, snapshot=>{
  const val = snapshot.val();
  if(val){
    settings.title = val.title || settings.title;
    settings.headerImage = val.headerImage || settings.headerImage;
    settings.categories = Array.isArray(val.categories) ? val.categories : (val.categories ? Object.values(val.categories) : []);
  }
  applySettings();
  renderCategoryEditor();
  populateCategorySelect();
  renderProductsGrid(); // to ensure categories may show in product cards if present
});

/* Apply settings to UI */
function applySettings(){
  pageTitle.innerText = settings.title || 'üåø Weed Ankauf ‚Äî Shop';
  headerLogo.src = settings.headerImage || 'https://via.placeholder.com/48';
  // fill general fields if editor open
  if(settingTitle) settingTitle.value = settings.title || '';
  if(settingHeaderImage) settingHeaderImage.value = settings.headerImage || '';
}

/* Save general settings */
saveGeneralBtn.addEventListener('click', async ()=>{
  const t = (settingTitle.value || '').trim() || 'üåø Weed Ankauf ‚Äî Shop';
  const img = (settingHeaderImage.value || '').trim() || 'https://via.placeholder.com/48';
  try{
    await update(settingsRef, { title: t, headerImage: img });
    alert('Allgemeine Einstellungen gespeichert.');
    applySettings();
  }catch(err){ console.error(err); alert('Speichern fehlgeschlagen'); }
});

/* Reset general settings */
resetGeneralBtn.addEventListener('click', async ()=>{
  if(!confirm('Auf Standard zur√ºcksetzen?')) return;
  try{
    await update(settingsRef, { title: 'üåø Weed Ankauf ‚Äî Shop', headerImage: 'https://via.placeholder.com/48' });
    alert('Zur√ºckgesetzt');
  }catch(err){ console.error(err); alert('Fehler'); }
});

/* ------------- Categories editor ------------- */
function renderCategoryEditor(){
  categoriesList.innerHTML = '';
  const cats = Array.isArray(settings.categories) ? settings.categories : [];
  if(cats.length === 0){
    categoriesList.innerHTML = '<div class="kv">Keine Kategorien vorhanden.</div>';
    return;
  }
  cats.forEach((c, idx)=>{
    const wrapper = document.createElement('div');
    wrapper.className = 'category-item';
    const input = document.createElement('input');
    input.className = 'p-2 rounded bg-gray-900 border border-gray-700 w-full';
    input.value = c;
    input.dataset.idx = idx;
    const actions = document.createElement('div');
    actions.style.display = 'flex';
    actions.style.gap = '6px';
    const saveBtn = document.createElement('button');
    saveBtn.className = 'px-2 py-1 bg-yellow-500 rounded';
    saveBtn.textContent = '‚úî';
    const delBtn = document.createElement('button');
    delBtn.className = 'px-2 py-1 bg-red-600 rounded';
    delBtn.textContent = 'üóë';
    actions.appendChild(saveBtn);
    actions.appendChild(delBtn);
    wrapper.appendChild(input);
    wrapper.appendChild(actions);
    categoriesList.appendChild(wrapper);

    saveBtn.onclick = ()=> {
      const v = input.value.trim();
      if(!v){ alert('Name nicht leer'); return; }
      settings.categories[idx] = v;
      alert('Ge√§ndert (noch nicht gespeichert). Klicke "Speichern".');
    };
    delBtn.onclick = ()=> {
      if(!confirm(`Kategorie "${settings.categories[idx]}" l√∂schen?`)) return;
      settings.categories.splice(idx,1);
      renderCategoryEditor();
    };
  });
}

addCategoryBtn.addEventListener('click', ()=>{
  const v = (newCategoryInput.value||'').trim();
  if(!v){ alert('Bitte Namen eingeben'); return; }
  settings.categories.push(v);
  newCategoryInput.value = '';
  renderCategoryEditor();
});

/* Save categories to Firebase */
saveCategoriesBtn.addEventListener('click', async ()=>{
  try{
    await update(settingsRef, { categories: settings.categories || [] });
    alert('Kategorien gespeichert.');
    populateCategorySelect();
  }catch(err){ console.error(err); alert('Speichern fehlgeschlagen'); }
});

reloadCategoriesBtn && reloadCategoriesBtn.addEventListener('click', ()=> {
  // reload from DB (onValue already updates), but force apply:
  get(settingsRef).then(snap => {
    const val = snap.val();
    if(val && Array.isArray(val.categories)) settings.categories = val.categories;
    renderCategoryEditor(); populateCategorySelect();
    alert('Kategorien neu geladen.');
  }).catch(err => { console.error(err); alert('Laden fehlgeschlagen'); });
});

/* populate category dropdown for product form */
function populateCategorySelect(){
  prodCategorySelect.innerHTML = '';
  const cats = Array.isArray(settings.categories) ? settings.categories : [];
  const none = document.createElement('option'); none.value=''; none.textContent = '‚Äî Keine ‚Äî';
  prodCategorySelect.appendChild(none);
  cats.forEach(c=>{
    const o = document.createElement('option'); o.value = c; o.textContent = c; prodCategorySelect.appendChild(o);
  });
}

/* ------------- Products (CRUD) ------------- */
onValue(productsRef, snapshot=>{
  products = [];
  snapshot.forEach(child=>{
    const d = child.val(); d.key = child.key; products.push(d);
  });
  products.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
  renderProductsTable();
  renderProductsGrid();
});

/* Render products grid (shop) */
function renderProductsGrid(){
  productsGrid.innerHTML = '';
  if(products.length === 0){ productsGrid.innerHTML = '<div class="text-gray-400 p-4">Keine Produkte verf√ºgbar.</div>'; return; }
  products.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'p-4 rounded bg-gray-800 border border-gray-700';
    const img = document.createElement('img');
    img.src = p.image || 'https://via.placeholder.com/300x120';
    img.className = 'product-image mb-2';
    const title = document.createElement('div');
    title.className = 'font-semibold text-lg';
    title.style.color = p.colorName || '#22c55e';
    title.textContent = p.name || '';
    const desc = document.createElement('div');
    desc.className = 'small-muted';
    desc.textContent = p.description || '';
    card.appendChild(img); card.appendChild(title); card.appendChild(desc);
    productsGrid.appendChild(card);
  });
}

/* Render products in admin table */
function renderProductsTable(){
  productsTableBody.innerHTML = '';
  products.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2"><img src="${p.image||'https://via.placeholder.com/80'}" class="product-image-admin"/></td>
      <td class="p-2">${escapeHtml(p.name||'')}</td>
      <td class="p-2">${escapeHtml(p.category||'')}</td>
      <td class="p-2">
        <button class="px-2 py-1 bg-yellow-600 rounded mr-1" data-edit="${p.key}">Bearbeiten</button>
        <button class="px-2 py-1 bg-red-600 rounded" data-del="${p.key}">L√∂schen</button>
      </td>`;
    productsTableBody.appendChild(tr);

    tr.querySelector('[data-edit]').onclick = ()=> editProduct(p.key);
    tr.querySelector('[data-del]').onclick = ()=> {
      if(confirm('Produkt wirklich l√∂schen?')) remove(ref(db, 'products/' + p.key));
    };
  });
}

/* product form open */
btnNewProduct.addEventListener('click', ()=> openProductForm());
function openProductForm(product){
  productFormCard.classList.remove('hidden-el');
  if(product){
    prodId.value = product.key || '';
    prodName.value = product.name || '';
    prodImg.value = product.image || '';
    prodDesc.value = product.description || '';
    prodCategorySelect.value = product.category || '';
    colorNameInput.value = product.colorName || '#22c55e';
  } else {
    productForm.reset();
    prodId.value = '';
    colorNameInput.value = '#22c55e';
  }
}

/* cancel */
cancelProductBtn.addEventListener('click', ()=> {
  productFormCard.classList.add('hidden-el');
  productForm.reset();
  prodId.value = '';
});

/* submit product */
productForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload = {
    name: (prodName.value||'').trim(),
    image: (prodImg.value||'').trim(),
    description: (prodDesc.value||'').trim(),
    category: (prodCategorySelect.value||'').trim(),
    colorName: (colorNameInput.value||'#22c55e'),
    updatedAt: Date.now()
  };
  try{
    if(prodId.value){
      await update(ref(db, 'products/' + prodId.value), payload);
    } else {
      await push(productsRef, payload);
    }
    productFormCard.classList.add('hidden-el');
    productForm.reset();
    prodId.value = '';
  }catch(err){ console.error(err); alert('Fehler beim Speichern des Produkts'); }
});

/* edit product */
function editProduct(key){
  const p = products.find(x=>x.key === key);
  if(p) openProductForm(p);
}

/* reload products (force) */
btnReloadProducts.addEventListener('click', ()=> {
  // onValue already keeps data updated; we briefly fetch to confirm
  get(productsRef).then(()=> alert('Produkte neu geladen (Realtime).')).catch(()=> alert('Laden fehlgeschlagen.'));
});

/* ------------- Login for settings ------------- */
settingsUnlockBtn.addEventListener('click', ()=> {
  const pw = (settingsPassword.value||'').trim();
  if(pw === ADMIN_PASSWORD){
    settingsLoginError.classList.add('hidden-el');
    settingsLoginArea.classList.add('hidden-el');
    settingsEditor.classList.remove('hidden-el');
    // prefill editors
    renderCategoryEditor();
    populateCategorySelect();
    settingTitle.value = settings.title || '';
    settingHeaderImage.value = settings.headerImage || '';
  } else {
    settingsLoginError.classList.remove('hidden-el');
  }
});

/* helper escape */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

/* initial UI apply */
applySettings();
populateCategorySelect();

</script>
</body>
</html>

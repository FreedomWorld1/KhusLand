<!-- Teil 1: HTML + Head + Shop/Warenkorb bleiben unver√§ndert -->
<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bullet Farm v2 ‚Äî Shop</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#0f1724;--card:#0b1220;--muted:#9ca3af;--accent:#06b6d4}
/* ... dein gesamtes CSS bleibt unver√§ndert ... */
</style>
</head>
<body>
  <div class="container">
    <header class="card shadow-soft mb-6 flex items-center justify-between">
      <!-- Header unver√§ndert -->
    </header>

    <main id="mainContent">
      <!-- Shop + Warenkorb unver√§ndert -->
    </main>
  </div>

  <!-- Settings Modal unver√§ndert -->
  <div id="settingsModal" class="modal-overlay hidden-el" aria-hidden="true">
    <div class="modal-box">
      <!-- Settings Login + Editor unver√§ndert -->
      <div id="settingsEditor" class="hidden-el">
        <!-- Tabs + Products/Categories/General unver√§ndert -->
        <div id="tabOrders" class="tab-panel hidden-el">
          <h4 style="font-weight:700;margin-bottom:8px">Bestellungen verwalten</h4>
          <div class="flex items-center gap-2 mb-3">
            <input id="orderCodeInput" class="input" placeholder="Bestellcode eingeben (z. B. 4272)" style="width:200px">
            <button id="loadOrderBtn" class="btn">Laden</button>
          </div>
          <div id="orderDetails" class="card" style="margin-bottom:12px;display:none">
            <!-- Bestelldetails unver√§ndert -->
          </div>

          <h5 style="margin-top:10px">Alle Bestellungen</h5>
          <div id="ordersList" class="card" style="max-height:40vh;overflow:auto;padding:12px"></div>

          <!-- NEU: Nutzerliste neben Bestellungen -->
          <h5 style="margin-top:10px">Nutzer</h5>
          <div id="usersList" class="card" style="max-height:40vh;overflow:auto;padding:12px"></div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

/* ---------- Config & Firebase ---------- */
const firebaseConfig = { 
  apiKey:"AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
  authDomain:"khusland-b7d13.firebaseapp.com",
  databaseURL:"https://khusland-b7d13-default-rtdb.firebaseio.com",
  projectId:"khusland-b7d13",
  storageBucket:"khusland-b7d13.firebasestorage.app",
  messagingSenderId:"69573193613",
  appId:"1:69573193613:web:86c4d839281b1e343cd7c4",
  measurementId:"G-JSCWR4207G"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------- Firebase-Refs ---------- */
const productsRef = ref(db, 'products');
const settingsRef = ref(db, 'settings');
const categoriesRef = ref(db, 'categories');
const ordersRef = ref(db, 'orders');
const usersRef = ref(db, 'users'); // NEU: Nutzer-Tabelle

/* ---------- Globals ---------- */
let products = [];
let categories = [];
let cart = [];
let allOrders = [];
let allUsers = []; // NEU: Nutzer-Array

/* ---------- Elemente ---------- */
const ordersList = document.getElementById('ordersList');
const usersList = document.getElementById('usersList');
const orderCodeInput = document.getElementById('orderCodeInput');
const loadOrderBtn = document.getElementById('loadOrderBtn');
const orderDetails = document.getElementById('orderDetails');
const orderUserName = document.getElementById('orderUserName');
const orderPhone = document.getElementById('orderPhone');
const saveOrderUserBtn = document.getElementById('saveOrderUserBtn');
const markOrderResetBtn = document.getElementById('markOrderResetBtn');

/* ---------- Hilfsfunktionen ---------- */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[c])); }
function generate4DigitCode(){ return Math.floor(1000 + Math.random() * 9000).toString(); }
    /* ---------- USERS / NUTZER ---------- */
onValue(usersRef, snapshot => {
  allUsers = [];
  snapshot.forEach(child => {
    const u = child.val(); u.key = child.key;
    allUsers.push(u);
  });
  renderUsersList();
});

function renderUsersList() {
  usersList.innerHTML = '';
  if(allUsers.length === 0){
    usersList.innerHTML = '<div class="kv">Keine Nutzer vorhanden.</div>';
    return;
  }

  allUsers.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));

  allUsers.forEach(u=>{
    const div = document.createElement('div');
    div.className = 'category-item';
    const name = u.name || '‚Äî unbekannt ‚Äî';
    const phone = u.phone || '';
    div.innerHTML = `
      <div>
        <strong>${escapeHtml(name)}</strong> ${phone ? 'üìû '+escapeHtml(phone) : ''}
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn small-btn" data-view="${escapeHtml(u.key)}">üëÅÔ∏è</button>
        <button class="btn small-btn" data-del="${escapeHtml(u.key)}" style="background:#ef4444">üóëÔ∏è</button>
      </div>`;
    usersList.appendChild(div);

    div.querySelector('[data-del]').onclick = ()=> {
      if(confirm('Nutzer wirklich l√∂schen?')) remove(ref(db,'users/'+u.key));
    };
    div.querySelector('[data-view]').onclick = ()=> loadOrdersByUser(u.key);
  });
}

/* ---------- LOAD ORDERS BY USER ---------- */
function loadOrdersByUser(userKey){
  const user = allUsers.find(u=>u.key===userKey);
  if(!user) return alert('Nutzer nicht gefunden.');
  const userOrders = allOrders.filter(o=>o.userKey === userKey);
  if(userOrders.length === 0) return alert('Keine Bestellungen von diesem Nutzer.');
  
  let text = `Bestellungen von ${user.name} (${user.phone || '‚Äì'}):\n\n`;
  userOrders.forEach(o=>{
    const date = o.createdAt ? new Date(o.createdAt).toLocaleString('de-DE') : '-';
    const total = o.items?.length || 0;
    text += `${o.code} ‚Äì ${date} ‚Äì ${total} Artikel\n`;
  });
  alert(text);
}

/* ---------- SAVE CART AS ORDER (mit Nutzer-Handling) ---------- */
async function saveCartAsOrder(){
  if(cart.length === 0) return alert('Warenkorb ist leer.');

  let code = generate4DigitCode();

  const orderData = {
    code: code,
    createdAt: Date.now(),
    items: cart,
    status: 'offen',
    userName: '',
    phone: '',
    userKey: ''
  };

  // Pr√ºfe, ob Name + Telefonnummer bereits existieren
  const name = (orderUserName?.value||'').trim();
  const phone = (orderPhone?.value||'').trim();
  if(name && phone){
    let user = allUsers.find(u => u.name === name && u.phone === phone);
    if(!user){
      // NEUEN Nutzer anlegen
      const newUserRef = await push(usersRef, { name, phone, createdAt: Date.now() });
      user = { key: newUserRef.key, name, phone };
      allUsers.push(user);
      renderUsersList();
    }
    orderData.userKey = user.key;
    orderData.userName = user.name;
    orderData.phone = user.phone;
  }

  try {
    await push(ordersRef, orderData);
    if(!orderCodeDisplayEl) ensureOrderUiInCart();
    orderCodeDisplayEl.textContent = 'Bestellcode: ' + code;
    cart = [];
    renderCartView();
  } catch (e) {
    console.error(e);
    alert('Fehler beim Speichern der Bestellung.');
  }
}

/* ---------- LOAD ORDER BY CODE (Admin) ---------- */
function loadOrderByCode(code){
  const order = allOrders.find(o=> (o.code||'').toString() === code.toString());
  if(!order) return alert('Keine Bestellung mit diesem Code gefunden.');

  orderDetails.style.display = '';
  orderItems.innerHTML = '';
  (order.items || []).forEach(i=>{
    const div = document.createElement('div');
    const resText = Object.entries(i.resources || {}).map(([k,v])=>`${k}: ${v}`).join(', ');
    div.innerHTML = `<div style="margin-bottom:6px"><b>${escapeHtml(i.name)}</b> ‚Äî ${escapeHtml(String(i.qty))}x</div><div class="kv">${escapeHtml(resText)}</div>`;
    orderItems.appendChild(div);
  });

  orderUserName.value = order.userName || '';
  orderPhone.value = order.phone || '';

  saveOrderUserBtn.onclick = async ()=> {
    const name = (orderUserName.value||'').trim();
    const phone = (orderPhone.value||'').trim();
    if(!name || !phone) return alert('Name und Telefonnummer angeben.');

    // Pr√ºfe ob Nutzer existiert
    let user = allUsers.find(u=>u.name===name && u.phone===phone);
    if(!user){
      const newUserRef = await push(usersRef, { name, phone, createdAt: Date.now() });
      user = { key: newUserRef.key, name, phone };
      allUsers.push(user);
      renderUsersList();
    }

    // Update Bestellung
    try{
      await update(ref(db,'orders/'+order.key), { userName: name, phone, userKey: user.key });
      alert('Kundendaten gespeichert.');
    }catch(e){ console.error(e); alert('Fehler beim Speichern.'); }
  };

  markOrderResetBtn.onclick = async ()=> {
    if(!confirm('Bestellung als bearbeitet markieren?')) return;
    try {
      await update(ref(db,'orders/'+order.key), { status: 'bearbeitet' });
      alert('Bestellung markiert.');
    } catch(e){ console.error(e); alert('Fehler.'); }
  };
}

/* ---------- INITIAL LOAD ---------- */
onValue(ordersRef, snapshot => {
  allOrders = [];
  snapshot.forEach(child => {
    const o = child.val(); o.key = child.key;
    allOrders.push(o);
  });
  renderOrdersList();
});

ensureOrderUiInCart();
renderCartView();

<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bullet Farm v2 ‚Äî Shop</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root {
  --bg: #0f1724;
  --card: #0b1220;
  --muted: #9ca3af;
  --accent: #06b6d4;
}

body {
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
  background: #071025;
  color: #e6eef8;
  margin: 0;
  line-height: 1.5;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 12px;
}

.card {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: 12px;
  padding: 16px;
}

.shadow-soft {
  box-shadow: 0 8px 30px rgba(2,6,23,0.6);
}

.small-muted {
  color: var(--muted);
  font-size: 0.85rem;
  margin-top: 4px;
}

.btn {
  transition: all 0.12s ease;
  border-radius: 8px;
  padding: 0.45rem 0.8rem;
  cursor: pointer;
  background: #111827;
  color: #e6eef8;
  border: 1px solid rgba(255,255,255,0.03);
  font-size: 0.9rem;
  white-space: nowrap;
}

.btn:hover {
  transform: translateY(-2px);
  background: #1f2937;
}

.hidden-el {
  display: none !important;
}

.product-image {
  width: 100%;
  height: 130px;
  object-fit: cover;
  border-radius: 8px;
}

.product-image-admin {
  width: 80px;
  height: 50px;
  object-fit: cover;
  border-radius: 6px;
}

#productsGrid .card {
  margin: 0 auto;
  transition: transform 0.2s ease;
}

.modal-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(4,6,11,0.6);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.22s ease;
  z-index: 80;
  backdrop-filter: blur(4px);
  padding: 12px;
}

.modal-overlay.active {
  opacity: 1;
  pointer-events: all;
}

.modal-box {
  width: 100%;
  max-width: 980px;
  background: linear-gradient(180deg, #0b1220, #0f1724);
  border-radius: 12px;
  padding: 16px;
  border: 1px solid rgba(255,255,255,0.04);
  box-shadow: 0 20px 60px rgba(2,6,23,0.7);
  transform: translateY(-8px);
  transition: transform 0.22s ease;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-overlay.active .modal-box {
  transform: translateY(0);
}

.tab-btn {
  padding: 8px 12px;
  border-radius: 8px;
  background: rgba(255,255,255,0.02);
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid transparent;
  font-size: 0.85rem;
  white-space: nowrap;
}

.tab-btn.active {
  background: linear-gradient(90deg, #94a3b8, #06b6d4);
  color: #041628;
  font-weight: 700;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table th, .table td {
  padding: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  text-align: left;
  font-size: 0.92rem;
}

.kv {
  font-size: 0.9rem;
  color: var(--muted);
}

.category-item {
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: space-between;
  padding: 8px;
  background: rgba(255,255,255,0.02);
  border-radius: 8px;
  margin-bottom: 6px;
}

.input, textarea, select {
  background: #071224;
  border: 1px solid rgba(255,255,255,0.04);
  color: #e6eef8;
  padding: 0.5rem;
  border-radius: 8px;
  width: 100%;
  font-size: 16px;
}

.color-input {
  width: 48px;
  height: 36px;
  padding: 0;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.04);
  background: #fff;
  cursor: pointer;
}

.small-btn {
  padding: 0.35rem 0.6rem;
  border-radius: 6px;
  font-size: 0.8rem;
}

.success { color: #10b981; }
.warning { color: #f59e0b; }
.error { color: #ef4444; }

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

.fade-in {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.orders-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-top: 16px;
}

.orders-column {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.user-order-item {
  background: rgba(255,255,255,0.02);
  border-radius: 8px;
  padding: 12px;
  border: 1px solid rgba(255,255,255,0.03);
  cursor: pointer;
}

.user-order-item.active {
  background: rgba(6, 182, 212, 0.1);
  border-color: rgba(6, 182, 212, 0.3);
}

.user-orders-list, .order-details-container {
  max-height: 50vh;
  overflow-y: auto;
}

/* Mobile Styles */
@media (max-width: 768px) {
  .container {
    padding: 8px;
  }
  
  .card {
    padding: 12px;
  }
  
  .grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .product-image {
    height: 120px;
  }
  
  .flex.gap-2 {
    flex-wrap: wrap;
    gap: 6px;
  }
  
  .tab-btn {
    padding: 6px 10px;
    font-size: 0.8rem;
    flex: 1;
    text-align: center;
  }
  
  .table-container {
    overflow-x: auto;
  }
  
  .table {
    font-size: 0.8rem;
    min-width: 500px;
  }
  
  .btn {
    padding: 0.4rem 0.7rem;
    font-size: 0.85rem;
  }
  
  .orders-layout {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .shop-header {
    flex-direction: column;
    gap: 10px;
    align-items: flex-start !important;
  }
  
  .shop-filter {
    width: 100% !important;
  }
  
  .admin-actions {
    flex-direction: column;
    gap: 8px;
  }
  
  .admin-actions .btn {
    width: 100%;
  }
}

@media (max-width: 480px) {
  .grid {
    gap: 10px;
  }
  
  .product-image {
    height: 100px;
  }
  
  .container {
    padding: 6px;
  }
  
  .card {
    padding: 10px;
  }
}

/* FIX: Text-Optimierungen f√ºr bessere Darstellung auf allen Ger√§ten */
.mobile-optimized-text {
  word-break: break-word;
  overflow-wrap: break-word;
  hyphens: auto;
  line-height: 1.4;
}

.product-card-text {
  word-break: break-word;
  overflow-wrap: break-word;
  line-height: 1.4;
}

.table-text-fix {
  word-break: break-word;
  overflow-wrap: break-word;
  max-width: 200px;
}

.resource-text-fix {
  word-break: break-word;
  overflow-wrap: break-word;
  white-space: normal !important;
}
</style>
</head>
<body>
  <div class="container">
    <header class="card shadow-soft mb-6 flex items-center justify-between fade-in">
      <div class="flex items-center gap-4">
        <img id="headerLogo" src="https://via.placeholder.com/48" alt="Logo" style="width:48px;height:48px;object-fit:cover;border-radius:8px">
        <div>
          <h1 id="pageTitle" style="font-size:1.4rem;font-weight:700;color:#22c55e;margin:0" class="mobile-optimized-text">Bullet Farm v2</h1>
          <div class="small-muted mobile-optimized-text">Shop</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnShop" class="btn">Shop</button>
        <button id="btnCart" class="btn">Warenkorb</button>
        <button id="openSettingsBtn" class="btn">‚öôÔ∏è</button>
      </div>
    </header>

    <main id="mainContent">
      <section id="shopView" class="card mb-6 fade-in">
        <div class="shop-header flex items-center justify-between mb-4">
          <div class="flex items-center gap-3" style="flex-wrap: wrap;">
            <h2 style="font-weight:700;color:#22c55e;margin:0" class="mobile-optimized-text">üõí Produkte</h2>
            <div class="kv mobile-optimized-text" style="white-space: nowrap;">Filter:</div>
            <select id="shopCategoryFilter" class="input shop-filter" style="width:200px; min-width: 150px;">
              <option value="">‚Äî Alle Kategorien ‚Äî</option>
            </select>
          </div>
          <div class="kv mobile-optimized-text" id="productsCount" style="white-space: nowrap;">Produkte anzeigen</div>
        </div>
        <div id="productsGrid" class="grid"></div>
      </section>

      <section id="cartView" class="card mb-6 hidden-el fade-in">
        <div class="flex items-center justify-between mb-4">
          <h2 style="font-weight:700;color:#22c55e" class="mobile-optimized-text">üõçÔ∏è Warenkorb</h2>
          <div class="kv mobile-optimized-text">Ressourcen & Anzahl</div>
        </div>
        <div class="table-container">
          <table class="table" id="cartTable">
            <thead>
              <tr>
                <th class="mobile-optimized-text">Produkt</th>
                <th class="mobile-optimized-text">Ressourcen</th>
                <th style="text-align:right" class="mobile-optimized-text">Anzahl</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:12px;font-weight:700" id="cartSummary" class="mobile-optimized-text">Gesamt Ressourcen: keine</div>
      </section>
    </main>
  </div>

  <div id="settingsModal" class="modal-overlay hidden-el" aria-hidden="true">
    <div class="modal-box">
      <div class="flex items-start justify-between mb-4">
        <div>
          <h3 style="font-size:1.15rem;font-weight:700;color:#94a3b8;margin:0" class="mobile-optimized-text">‚öôÔ∏è Einstellungen</h3>
          <div class="kv mobile-optimized-text">Passwortgesch√ºtzt ‚Äî Admin Funktionen</div>
        </div>
        <div class="flex gap-2 items-center">
          <button id="settingsCloseBtn" class="btn">‚úñ</button>
        </div>
      </div>

      <div id="settingsLoginArea">
        <label class="kv mb-2 mobile-optimized-text">Admin Passwort</label>
        <div class="flex items-center gap-2 mb-3">
          <input id="settingsPassword" type="password" class="input" placeholder="Passwort (admin123)"/>
          <button id="settingsUnlockBtn" class="btn">Einloggen</button>
        </div>
        <div id="settingsLoginError" class="error kv mobile-optimized-text" style="display:none">‚ùå Falsches Passwort</div>
      </div>

      <div id="settingsEditor" class="hidden-el">
        <div class="mb-4">
          <div class="flex gap-2">
            <button class="tab-btn active" data-tab="products">Produkte</button>
            <button class="tab-btn" data-tab="categories">Kategorien</button>
            <button class="tab-btn" data-tab="general">Allgemein</button>
            <button class="tab-btn" data-tab="orders">Bestellungen</button>
            <button class="tab-btn" data-tab="users">Nutzer</button>
          </div>
        </div>

        <div id="tabProducts" class="tab-panel">
          <div class="flex items-center justify-between mb-3 admin-actions">
            <h4 style="font-weight:700" class="mobile-optimized-text">Produkte verwalten</h4>
            <div class="flex gap-2">
              <button id="btnNewProduct" class="btn">Neues Produkt</button>
              <button id="btnReloadProducts" class="btn">Neu laden</button>
            </div>
          </div>

          <div id="productFormCard" class="card mb-3 hidden-el">
            <form id="productForm">
              <input id="prodId" type="hidden"/>
              <div style="display:grid;grid-template-columns:1fr 120px;gap:10px;margin-bottom:10px">
                <div>
                  <input id="prodName" class="input mobile-optimized-text" placeholder="Name" required />
                  <input id="prodImg" class="input mobile-optimized-text" placeholder="Bild-URL" style="margin-top:8px"/>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px">
                  <label class="kv mobile-optimized-text">Vorschau</label>
                  <img id="prodPreview" src="https://via.placeholder.com/150x100" alt="Vorschau" style="width:100%;height:80px;object-fit:cover;border-radius:6px;border:1px solid rgba(255,255,255,0.03)">
                </div>
              </div>

              <textarea id="prodDesc" class="input mobile-optimized-text" rows="2" placeholder="Beschreibung (optional)" style="margin-bottom:8px"></textarea>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px">
                <select id="prodCategorySelect" class="input mobile-optimized-text">
                  <option value="">‚Äî Keine Kategorie ‚Äî</option>
                </select>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <label class="kv mobile-optimized-text">Name-Farbe</label>
                  <input id="colorNameInput" type="color" class="color-input" value="#22c55e">
                  <label class="kv mobile-optimized-text">Anzahl-Farbe</label>
                  <input id="colorQuantityInput" type="color" class="color-input" value="#3b82f6">
                </div>
              </div>

              <div id="resourceTableContainer" style="margin-bottom:8px">
                <h5 style="margin:0 0 8px 0;font-weight:700" class="mobile-optimized-text">Ressourcen (Name:Anzahl:Farbe)</h5>
                <div class="table-container">
                  <table class="table" id="resourceTable">
                    <thead>
                      <tr>
                        <th class="mobile-optimized-text">Ressource</th>
                        <th style="width:120px;text-align:right" class="mobile-optimized-text">Anzahl</th>
                        <th style="width:120px" class="mobile-optimized-text">Farbe</th>
                        <th style="width:60px" class="mobile-optimized-text">Aktion</th>
                      </tr>
                    </thead>
                    <tbody style="background:transparent"></tbody>
                  </table>
                </div>
                <div style="margin-top:8px">
                  <button id="addResourceBtn" type="button" class="btn">Ressource hinzuf√ºgen</button>
                </div>
              </div>

              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button type="submit" class="btn" style="background:#10b981">‚úÖ Speichern</button>
                <button id="cancelProductBtn" type="button" class="btn" style="background:#ef4444">‚ùå Abbrechen</button>
              </div>
            </form>
          </div>

          <div class="card" style="max-height:46vh;overflow:auto">
            <div class="table-container">
              <table class="table" style="width:100%">
                <thead>
                  <tr>
                    <th class="mobile-optimized-text">Vorschau</th>
                    <th class="mobile-optimized-text">Name</th>
                    <th class="mobile-optimized-text">Kategorie</th>
                    <th class="mobile-optimized-text">Ressourcen</th>
                    <th style="width:140px" class="mobile-optimized-text">Aktionen</th>
                  </tr>
                </thead>
                <tbody id="productsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="tabCategories" class="tab-panel hidden-el">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
            <h4 style="font-weight:700" class="mobile-optimized-text">Kategorien verwalten</h4>
            <div style="display:flex;gap:8px;width:100%;max-width:360px;">
              <input id="newCategoryInput" class="input mobile-optimized-text" placeholder="Neue Kategorie" />
              <button id="addCategoryBtn" class="btn">Hinzuf√ºgen</button>
            </div>
          </div>
          <div id="categoriesList" class="card" style="max-height:36vh;overflow:auto;padding:12px"></div>
        </div>

        <div id="tabGeneral" class="tab-panel hidden-el">
          <h4 style="font-weight:700;margin-bottom:8px" class="mobile-optimized-text">Allgemein</h4>
          <label class="kv mb-2 mobile-optimized-text">Titel</label>
          <input id="settingTitle" class="input mobile-optimized-text" placeholder="Seiten-Titel"/>
          <label class="kv mb-2 mobile-optimized-text" style="margin-top:8px">Header Bild URL (48x48 empfohlen)</label>
          <input id="settingHeaderImage" class="input mobile-optimized-text" placeholder="Bild-URL"/>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
            <button id="saveGeneralBtn" class="btn" style="background:#10b981">‚úÖ Speichern</button>
            <button id="resetGeneralBtn" class="btn" style="background:#ef4444">‚ùå Zur√ºcksetzen</button>
          </div>
        </div>

        <div id="tabOrders" class="tab-panel hidden-el">
          <h4 style="font-weight:700;margin-bottom:8px" class="mobile-optimized-text">Bestellungen verwalten</h4>

          <div class="flex items-center gap-2 mb-3" style="flex-wrap:wrap;">
            <input id="orderCodeInput" class="input mobile-optimized-text" placeholder="Bestellcode eingeben (z. B. 4272)" style="width:200px;min-width:150px;">
            <button id="loadOrderBtn" class="btn">Laden</button>
          </div>

          <div id="orderDetails" class="card" style="margin-bottom:12px;display:none">
            <h5 style="margin:0 0 8px 0" class="mobile-optimized-text">Bestelldetails</h5>
            <div id="orderItems" class="kv mobile-optimized-text"></div>
            <div style="margin-top:8px">
              <input id="orderUserName" class="input mobile-optimized-text" placeholder="Name des Kunden" style="margin-top:6px">
              <input id="orderPhone" class="input mobile-optimized-text" placeholder="Telefonnummer" style="margin-top:6px">
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                <button id="saveOrderUserBtn" class="btn" style="background:#10b981">‚úÖ Daten speichern</button>
                <button id="markOrderResetBtn" class="btn" style="background:#ef4444">‚ùå Als bearbeitet / zur√ºcksetzen</button>
              </div>
            </div>
          </div>

          <h5 style="margin-top:10px" class="mobile-optimized-text">Alle Bestellungen</h5>
          <div id="ordersList" class="card" style="max-height:40vh;overflow:auto;padding:12px"></div>
        </div>

        <div id="tabUsers" class="tab-panel hidden-el">
          <h4 style="font-weight:700;margin-bottom:8px" class="mobile-optimized-text">Nutzer & Bestellungen</h4>
          <div class="kv mb-3 mobile-optimized-text">Klicke auf einen Nutzer, um alle seine Bestellungen zu sehen</div>
          
          <div class="orders-layout">
            <div class="orders-column">
              <h5 class="mobile-optimized-text">üìû Nutzer</h5>
              <div id="usersList" class="card user-orders-list" style="padding:12px">
                <div class="kv mobile-optimized-text">Lade Nutzer...</div>
              </div>
            </div>
            
            <div class="orders-column">
              <h5 class="mobile-optimized-text">üìã Bestellungen des Nutzers</h5>
              <div id="userOrdersDetails" class="card order-details-container" style="padding:12px">
                <div class="kv mobile-optimized-text">W√§hle einen Nutzer aus, um seine Bestellungen zu sehen</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = { 
  apiKey: "AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
  authDomain: "khusland-b7d13.firebaseapp.com",
  databaseURL: "https://khusland-b7d13-default-rtdb.firebaseio.com",
  projectId: "khusland-b7d13",
  storageBucket: "khusland-b7d13.firebasestorage.app",
  messagingSenderId: "69573193613",
  appId: "1:69573193613:web:86c4d839281b1e343cd7c4",
  measurementId: "G-JSCWR4207G"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productsRef = ref(db, 'products');
const settingsRef = ref(db, 'settings');
const categoriesRef = ref(db, 'categories');
const ordersRef = ref(db, 'orders');

const ADMIN_PASSWORD = 'admin123';

// DOM Elemente
const elements = {
  openSettingsBtn: document.getElementById('openSettingsBtn'),
  settingsModal: document.getElementById('settingsModal'),
  settingsCloseBtn: document.getElementById('settingsCloseBtn'),
  settingsPassword: document.getElementById('settingsPassword'),
  settingsUnlockBtn: document.getElementById('settingsUnlockBtn'),
  settingsLoginError: document.getElementById('settingsLoginError'),
  settingsLoginArea: document.getElementById('settingsLoginArea'),
  settingsEditor: document.getElementById('settingsEditor'),
  tabBtns: document.querySelectorAll('.tab-btn'),
  tabPanels: document.querySelectorAll('.tab-panel'),
  btnNewProduct: document.getElementById('btnNewProduct'),
  productFormCard: document.getElementById('productFormCard'),
  productForm: document.getElementById('productForm'),
  cancelProductBtn: document.getElementById('cancelProductBtn'),
  prodId: document.getElementById('prodId'),
  prodName: document.getElementById('prodName'),
  prodImg: document.getElementById('prodImg'),
  prodPreview: document.getElementById('prodPreview'),
  prodDesc: document.getElementById('prodDesc'),
  prodCategorySelect: document.getElementById('prodCategorySelect'),
  colorNameInput: document.getElementById('colorNameInput'),
  colorQuantityInput: document.getElementById('colorQuantityInput'),
  addResourceBtn: document.getElementById('addResourceBtn'),
  resourceTable: document.querySelector('#resourceTable tbody'),
  productsTableBody: document.getElementById('productsTableBody'),
  btnReloadProducts: document.getElementById('btnReloadProducts'),
  settingTitle: document.getElementById('settingTitle'),
  settingHeaderImage: document.getElementById('settingHeaderImage'),
  saveGeneralBtn: document.getElementById('saveGeneralBtn'),
  resetGeneralBtn: document.getElementById('resetGeneralBtn'),
  pageTitle: document.getElementById('pageTitle'),
  headerLogo: document.getElementById('headerLogo'),
  productsGrid: document.getElementById('productsGrid'),
  shopView: document.getElementById('shopView'),
  cartView: document.getElementById('cartView'),
  btnShop: document.getElementById('btnShop'),
  btnCart: document.getElementById('btnCart'),
  cartTableBody: document.querySelector('#cartTable tbody'),
  cartSummary: document.getElementById('cartSummary'),
  shopCategoryFilter: document.getElementById('shopCategoryFilter'),
  newCategoryInput: document.getElementById('newCategoryInput'),
  addCategoryBtn: document.getElementById('addCategoryBtn'),
  categoriesList: document.getElementById('categoriesList'),
  orderCodeInput: document.getElementById('orderCodeInput'),
  loadOrderBtn: document.getElementById('loadOrderBtn'),
  orderDetails: document.getElementById('orderDetails'),
  orderItems: document.getElementById('orderItems'),
  orderUserName: document.getElementById('orderUserName'),
  orderPhone: document.getElementById('orderPhone'),
  saveOrderUserBtn: document.getElementById('saveOrderUserBtn'),
  markOrderResetBtn: document.getElementById('markOrderResetBtn'),
  ordersList: document.getElementById('ordersList'),
  productsCount: document.getElementById('productsCount'),
  usersList: document.getElementById('usersList'),
  userOrdersDetails: document.getElementById('userOrdersDetails')
};

let products = [];
let settings = { title: 'Bullet Farm', headerImage: 'https://via.placeholder.com/48' };
let categories = [];
let cart = [];
let allOrders = [];
let saveOrderBtnEl = null;
let orderCodeDisplayEl = null;
let selectedUserId = null;

function showModal() { 
  elements.settingsModal.classList.remove('hidden-el'); 
  setTimeout(() => elements.settingsModal.classList.add('active'), 10); 
  document.body.style.overflow = 'hidden'; 
}

function hideModal() { 
  elements.settingsModal.classList.remove('active'); 
  document.body.style.overflow = ''; 
  setTimeout(() => elements.settingsModal.classList.add('hidden-el'), 240); 
}

elements.openSettingsBtn.addEventListener('click', () => {
  elements.settingsPassword.value = '';
  elements.settingsLoginError.style.display = 'none';
  elements.settingsLoginArea.style.display = '';
  elements.settingsEditor.classList.add('hidden-el');
  showModal();
});

elements.settingsCloseBtn.addEventListener('click', hideModal);
elements.settingsModal.addEventListener('click', (e) => { 
  if(e.target === elements.settingsModal) hideModal(); 
});

document.addEventListener('keydown', (e) => { 
  if(e.key === 'Escape' && !elements.settingsModal.classList.contains('hidden-el')) hideModal(); 
});

elements.tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    elements.tabBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const tabName = btn.dataset.tab;
    elements.tabPanels.forEach(p => p.classList.add('hidden-el'));
    document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.remove('hidden-el');
    if (tabName === 'users') renderUsersList();
  });
});

onValue(settingsRef, snapshot => {
  const val = snapshot.val();
  if(val){
    settings.title = val.title || settings.title;
    settings.headerImage = val.headerImage || settings.headerImage;
  }
  applySettings();
});

function applySettings(){
  elements.pageTitle.innerText = settings.title || 'Bullet Farm';
  elements.headerLogo.src = settings.headerImage || 'https://via.placeholder.com/48';
  if(elements.settingTitle) elements.settingTitle.value = settings.title || '';
  if(elements.settingHeaderImage) elements.settingHeaderImage.value = settings.headerImage || '';
}

elements.saveGeneralBtn.addEventListener('click', async () => {
  const title = (elements.settingTitle.value || '').trim() || 'Bullet Farm';
  const image = (elements.settingHeaderImage.value || '').trim() || 'https://via.placeholder.com/48';
  try{ 
    await update(settingsRef, { title, headerImage: image }); 
    alert('‚úÖ Allgemeine Einstellungen gespeichert'); 
  } catch(e){ console.error(e); alert('‚ùå Fehler beim Speichern'); }
});

elements.resetGeneralBtn.addEventListener('click', async () => {
  if(!confirm('Auf Standard zur√ºcksetzen?')) return;
  try{ 
    await update(settingsRef, { title: 'Bullet Farm', headerImage: 'https://via.placeholder.com/48' }); 
    alert('‚úÖ Zur√ºckgesetzt'); 
  } catch(e){ console.error(e); alert('‚ùå Fehler'); }
});

onValue(categoriesRef, snapshot => {
  categories = [];
  snapshot.forEach(child => {
    const data = child.val(); 
    data.key = child.key; 
    categories.push(data);
  });
  renderCategoriesList();
  populateCategorySelects();
});

function renderCategoriesList(){
  elements.categoriesList.innerHTML = '';
  if(categories.length === 0){ 
    elements.categoriesList.innerHTML = '<div class="kv mobile-optimized-text">Keine Kategorien vorhanden.</div>'; 
    return; 
  }
  
  categories.forEach(category => {
    const div = document.createElement('div');
    div.className = 'category-item fade-in';
    div.innerHTML = `
      <div class="mobile-optimized-text">${escapeHtml(category.name)}</div>
      <div style="display:flex;gap:6px">
        <button class="btn small-btn" data-edit="${category.key}">‚úèÔ∏è</button>
        <button class="btn small-btn" data-del="${category.key}" style="background:#ef4444">üóëÔ∏è L√∂schen</button>
      </div>`;
    elements.categoriesList.appendChild(div);
    
    div.querySelector('[data-del]').onclick = async () => {
      if(!confirm('Kategorie wirklich l√∂schen?')) return;
      try{ await remove(ref(db, 'categories/' + category.key)); } 
      catch(e){ console.error(e); alert('‚ùå Fehler beim L√∂schen'); }
    };
    
    div.querySelector('[data-edit]').onclick = () => {
      const newName = prompt('Neuer Kategorie-Name', category.name);
      if(newName && newName.trim()){
        update(ref(db, 'categories/' + category.key), { name: newName.trim() })
          .catch(() => alert('‚ùå Fehler beim Umbenennen'));
      }
    };
  });
}

elements.addCategoryBtn.addEventListener('click', async () => {
  const name = (elements.newCategoryInput.value || '').trim();
  if(!name) return alert('‚ùå Bitte Namen eingeben');
  try{
    await push(categoriesRef, { name });
    elements.newCategoryInput.value = '';
  } catch(e){ console.error(e); alert('‚ùå Fehler beim Anlegen'); }
});

function populateCategorySelects(){
  elements.prodCategorySelect.innerHTML = '<option value="">‚Äî Keine Kategorie ‚Äî</option>';
  elements.shopCategoryFilter.innerHTML = '<option value="">‚Äî Alle Kategorien ‚Äî</option>';

  categories.forEach(category => {
    const option1 = document.createElement('option');
    option1.value = category.name;
    option1.textContent = category.name;
    option1.className = 'mobile-optimized-text';
    elements.prodCategorySelect.appendChild(option1);
    
    const option2 = document.createElement('option');
    option2.value = category.name;
    option2.textContent = category.name;
    option2.className = 'mobile-optimized-text';
    elements.shopCategoryFilter.appendChild(option2);
  });
}

onValue(productsRef, snapshot => {
  products = [];
  snapshot.forEach(child => {
    const data = child.val(); 
    data.key = child.key; 
    products.push(data);
  });
  products.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
  renderProductsTable();
  renderProductsGrid();
});

function escapeHtml(text) {
  if(!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

elements.shopCategoryFilter.addEventListener('change', renderProductsGrid);

function renderProductsGrid(){
  const filter = (elements.shopCategoryFilter.value || '').trim();
  elements.productsGrid.innerHTML = '';
  const visibleProducts = products.filter(p => !filter || (p.category || '') === filter);
  
  elements.productsCount.textContent = `${visibleProducts.length} Produkt${visibleProducts.length !== 1 ? 'e' : ''} angezeigt`;
  
  if(visibleProducts.length === 0){ 
    elements.productsGrid.innerHTML = '<div class="kv p-4 mobile-optimized-text">Keine Produkte verf√ºgbar.</div>'; 
    return; 
  }
  
  visibleProducts.forEach(product => {
    const card = document.createElement('div');
    card.className = 'card fade-in';
    
    const img = document.createElement('img');
    img.src = product.image || 'https://via.placeholder.com/300x120';
    img.className = 'product-image';
    img.alt = product.name || 'Produktbild';
    
    const title = document.createElement('div');
    title.className = 'mobile-optimized-text product-card-text';
    title.style.fontWeight = '700';
    title.style.fontSize = '1rem';
    title.style.marginTop = '8px';
    title.style.color = product.colorName || '#22c55e';
    title.textContent = product.name || '';
    
    const desc = document.createElement('div');
    desc.className = 'small-muted mobile-optimized-text product-card-text';
    desc.textContent = product.description || '';
    
    card.appendChild(img);
    card.appendChild(title);
    card.appendChild(desc);

    if(product.resources){
      const pairs = product.resources.split(';').map(x => x.trim()).filter(Boolean);
      if(pairs.length > 0){
        const table = document.createElement('table');
        table.className = 'table';
        table.style.marginTop = '8px';
        table.innerHTML = `
          <thead>
            <tr>
              <th class="mobile-optimized-text">Ressource</th>
              <th style="text-align:right" class="mobile-optimized-text">Anzahl</th>
            </tr>
          </thead>
          <tbody>
            ${pairs.map(resource => {
              const [name, value, color] = resource.split(':');
              return `
                <tr>
                  <td style="color:${color || '#facc15'}" class="mobile-optimized-text resource-text-fix">${escapeHtml(name)}</td>
                  <td style="text-align:right;color:${product.colorQuantity || '#3b82f6'}" class="mobile-optimized-text">
                    ${Number(value).toLocaleString('de-DE')}
                  </td>
                </tr>`;
            }).join('')}
          </tbody>`;
        card.appendChild(table);
      }
    }

    if(product.category) {
      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'kv mobile-optimized-text product-card-text';
      categoryDiv.style.marginTop = '8px';
      categoryDiv.textContent = 'Kategorie: ' + product.category;
      card.appendChild(categoryDiv);
    }

    const addButton = document.createElement('button');
    addButton.className = 'btn';
    addButton.style.background = '#10b981';
    addButton.style.marginTop = '8px';
    addButton.textContent = '‚úÖ In den Warenkorb';
    addButton.onclick = () => { 
      addToCartByProductKey(product.key); 
      alert(`‚úÖ "${product.name}" zum Warenkorb hinzugef√ºgt`); 
    };
    card.appendChild(addButton);

    elements.productsGrid.appendChild(card);
  });
}

function renderProductsTable(){
  elements.productsTableBody.innerHTML = '';
  products.forEach(product => {
    const resourcesText = product.resources ? 
      product.resources.split(';').map(resource => {
        const [name, value] = resource.split(':');
        return `${name}: ${value}`;
      }).join(', ') : '';
    
    const row = document.createElement('tr');
    row.className = 'fade-in';
    row.innerHTML = `
      <td style="padding:8px">
        <img src="${product.image || 'https://via.placeholder.com/80'}" 
             class="product-image-admin" 
             alt="${escapeHtml(product.name || '')}">
      </td>
      <td style="padding:8px" class="mobile-optimized-text table-text-fix">${escapeHtml(product.name || '')}</td>
      <td style="padding:8px" class="mobile-optimized-text table-text-fix">${escapeHtml(product.category || '')}</td>
      <td style="padding:8px" class="mobile-optimized-text table-text-fix">${escapeHtml(resourcesText)}</td>
      <td style="padding:8px">
        <button class="btn small-btn" data-edit="${product.key}" style="margin-right:6px">‚úèÔ∏è Bearbeiten</button>
        <button class="btn small-btn" data-del="${product.key}" style="background:#ef4444">üóëÔ∏è L√∂schen</button>
      </td>`;
    elements.productsTableBody.appendChild(row);
    
    row.querySelector('[data-edit]').onclick = () => openProductForm(product);
    row.querySelector('[data-del]').onclick = () => { 
      if(confirm('Produkt wirklich l√∂schen?')) {
        remove(ref(db, 'products/' + product.key))
          .catch(() => alert('‚ùå Fehler beim L√∂schen'));
      }
    };
  });
}

elements.btnNewProduct.addEventListener('click', () => openProductForm());

function openProductForm(product = null){
  elements.productFormCard.classList.remove('hidden-el');
  elements.resourceTable.innerHTML = '';
  
  if(product){
    elements.prodId.value = product.key || '';
    elements.prodName.value = product.name || '';
    elements.prodImg.value = product.image || '';
    elements.prodPreview.src = product.image || 'https://via.placeholder.com/150x100';
    elements.prodDesc.value = product.description || '';
    elements.prodCategorySelect.value = product.category || '';
    elements.colorNameInput.value = product.colorName || '#22c55e';
    elements.colorQuantityInput.value = product.colorQuantity || '#3b82f6';
    
    if(product.resources){
      const pairs = product.resources.split(';').map(x => x.trim()).filter(Boolean);
      pairs.forEach(resource => {
        const [name, value, color] = resource.split(':');
        addResourceRow(name, value, color || '#facc15');
      });
    }
  } else {
    elements.prodId.value = '';
    elements.productForm.reset();
    elements.prodPreview.src = 'https://via.placeholder.com/150x100';
    elements.colorNameInput.value = '#22c55e';
    elements.colorQuantityInput.value = '#3b82f6';
  }
}

function addResourceRow(name = '', value = '', color = '#facc15'){
  const row = document.createElement('tr');
  row.className = 'fade-in';
  row.innerHTML = `
    <td><input class="input mobile-optimized-text" value="${escapeHtml(name)}" placeholder="Ressourcenname" /></td>
    <td style="text-align:right"><input type="number" min="0" class="input mobile-optimized-text" value="${escapeHtml(value)}" placeholder="0" /></td>
    <td><input type="color" class="color-input" value="${escapeHtml(color)}" /></td>
    <td style="text-align:center"><button class="btn small-btn" type="button" style="background:#ef4444">‚ùå L√∂schen</button></td>`;
  
  const deleteButton = row.querySelector('button');
  deleteButton.onclick = () => row.remove();
  elements.resourceTable.appendChild(row);
}

elements.addResourceBtn.addEventListener('click', () => addResourceRow());
elements.prodImg.addEventListener('input', () => {
  elements.prodPreview.src = elements.prodImg.value || 'https://via.placeholder.com/150x100';
});
elements.cancelProductBtn.addEventListener('click', () => {
  elements.productFormCard.classList.add('hidden-el');
  elements.productForm.reset();
  elements.prodId.value = '';
});

elements.productForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const rows = Array.from(elements.resourceTable.querySelectorAll('tr'));
  const resources = rows.map(row => {
    const name = row.children[0].querySelector('input').value.trim();
    const quantity = row.children[1].querySelector('input').value.trim();
    const color = row.children[2].querySelector('input').value;
    return name && quantity ? `${name}:${quantity}:${color}` : '';
  }).filter(Boolean).join(';');

  const payload = {
    name: (elements.prodName.value || '').trim(),
    image: (elements.prodImg.value || '').trim(),
    description: (elements.prodDesc.value || '').trim(),
    category: (elements.prodCategorySelect.value || '').trim(),
    resources: resources,
    colorName: elements.colorNameInput.value || '#22c55e',
    colorQuantity: elements.colorQuantityInput.value || '#3b82f6',
    updatedAt: Date.now()
  };

  try{
    if(elements.prodId.value){
      await update(ref(db, 'products/' + elements.prodId.value), payload);
      alert('‚úÖ Produkt aktualisiert');
    } else {
      await push(productsRef, payload);
      alert('‚úÖ Produkt angelegt');
    }
    elements.productFormCard.classList.add('hidden-el');
    elements.productForm.reset();
    elements.prodId.value = '';
  } catch(error){ console.error(error); alert('‚ùå Fehler beim Speichern des Produkts'); }
});

elements.btnReloadProducts.addEventListener('click', () => {
  get(productsRef)
    .then(() => alert('‚úÖ Produkte neu geladen'))
    .catch(() => alert('‚ùå Laden fehlgeschlagen'));
});

elements.settingsUnlockBtn.addEventListener('click', () => {
  const password = (elements.settingsPassword.value || '').trim();
  if(password === ADMIN_PASSWORD){
    elements.settingsLoginError.style.display = 'none';
    elements.settingsLoginArea.style.display = 'none';
    elements.settingsEditor.classList.remove('hidden-el');
    elements.tabBtns.forEach(btn => btn.classList.remove('active'));
    elements.tabBtns[0].classList.add('active');
    elements.tabPanels.forEach(panel => panel.classList.add('hidden-el'));
    document.getElementById('tabProducts').classList.remove('hidden-el');
  } else {
    elements.settingsLoginError.style.display = '';
  }
});

function resourcesToMap(resourcesString){
  const map = {};
  if(!resourcesString) return map;
  const pairs = resourcesString.split(';').map(x => x.trim()).filter(Boolean);
  pairs.forEach(resource => {
    const [name, value] = resource.split(':');
    if(name && value) map[name] = (map[name] || 0) + Number(value);
  });
  return map;
}

function addToCartByProductKey(productKey){
  const product = products.find(p => p.key === productKey);
  if(!product) return;
  const resourceMap = resourcesToMap(product.resources);
  const existingIndex = cart.findIndex(item => item.key === productKey);
  if(existingIndex === -1){
    cart.push({ key: productKey, name: product.name, resources: {...resourceMap}, quantity: 1 });
  } else {
    cart[existingIndex].quantity += 1;
    for(const resource in resourceMap) {
      cart[existingIndex].resources[resource] = (cart[existingIndex].resources[resource] || 0) + resourceMap[resource];
    }
  }
  renderCartView();
}

function renderCartView(){
  elements.cartTableBody.innerHTML = '';
  const totalResources = {};
  cart.forEach(entry => {
    const tr = document.createElement('tr');
    const resText = Object.entries(entry.resources).map(([k,v])=>`${k}: ${v}`).join(', ');
    tr.innerHTML = `<td class="mobile-optimized-text">${escapeHtml(entry.name)}</td><td class="mobile-optimized-text resource-text-fix">${escapeHtml(resText)}</td><td style="text-align:right" class="mobile-optimized-text">${entry.quantity}</td>`;
    elements.cartTableBody.appendChild(tr);
    for(const k in entry.resources) totalResources[k] = (totalResources[k]||0) + entry.resources[k];
  });
  const summary = Object.entries(totalResources).map(([k,v])=>`${k}: ${v}`).join(', ') || 'keine';
  cartSummary.innerText = 'Gesamt Ressourcen: ' + summary;
  ensureOrderUiInCart();
  if(saveOrderBtnEl) saveOrderBtnEl.disabled = (cart.length === 0);
}

elements.btnShop.addEventListener('click', ()=>{ shopView.classList.remove('hidden-el'); cartView.classList.add('hidden-el'); });
elements.btnCart.addEventListener('click', ()=>{ shopView.classList.add('hidden-el'); cartView.classList.remove('hidden-el'); renderCartView(); });

function generate4DigitCode(){ return Math.floor(1000 + Math.random() * 9000).toString(); }

function ensureOrderUiInCart(){
  if(saveOrderBtnEl) return;
  const wrapper = document.createElement('div');
  wrapper.style.marginTop = '12px';
  saveOrderBtnEl = document.createElement('button');
  saveOrderBtnEl.className = 'btn';
  saveOrderBtnEl.style.background = '#10b981';
  saveOrderBtnEl.textContent = '‚úÖ Bestellung speichern (Code erzeugen)';
  saveOrderBtnEl.onclick = saveCartAsOrder;
  wrapper.appendChild(saveOrderBtnEl);
  orderCodeDisplayEl = document.createElement('div');
  orderCodeDisplayEl.style.marginTop = '8px';
  orderCodeDisplayEl.style.fontWeight = '700';
  orderCodeDisplayEl.style.fontSize = '1.05rem';
  orderCodeDisplayEl.className = 'success mobile-optimized-text';
  orderCodeDisplayEl.textContent = '';
  const copyBtn = document.createElement('button');
  copyBtn.className = 'btn small-btn';
  copyBtn.style.marginLeft = '8px';
  copyBtn.textContent = 'üìã Kopieren';
  copyBtn.onclick = ()=> {
    const txt = (orderCodeDisplayEl.textContent || '').replace('Bestellcode: ','').trim();
    if(!txt) return alert('Kein Bestellcode vorhanden');
    navigator.clipboard?.writeText(txt).then(()=> alert('Code kopiert')).catch(()=> alert('Kopieren nicht m√∂glich'));
  };
  const codeWrap = document.createElement('div');
  codeWrap.style.display = 'flex';
  codeWrap.style.alignItems = 'center';
  codeWrap.style.gap = '8px';
  codeWrap.appendChild(orderCodeDisplayEl);
  codeWrap.appendChild(copyBtn);
  wrapper.appendChild(codeWrap);
  cartView.appendChild(wrapper);
}

async function saveCartAsOrder(){
  if(cart.length === 0) return alert('‚ùå Warenkorb ist leer');
  const code = generate4DigitCode();
  const orderData = { code: code, createdAt: Date.now(), items: cart, status: 'offen', userName: '', phone: '' };
  try {
    await push(ordersRef, orderData);
    if(!orderCodeDisplayEl) ensureOrderUiInCart();
    orderCodeDisplayEl.textContent = 'Bestellcode: ' + code;
    cart = [];
    renderCartView();
  } catch (e) { console.error(e); alert('‚ùå Fehler beim Speichern der Bestellung'); }
}

onValue(ordersRef, snapshot => {
  allOrders = [];
  snapshot.forEach(child => { const o = child.val(); o.key = child.key; allOrders.push(o); });
  renderOrdersList();
});

function renderOrdersList() {
  elements.ordersList.innerHTML = '';
OrdersList() {
  elements.ordersList.innerHTML = '';
  if(allOrders.length === 0){ elements.ordersList.innerHTML = '<div class  if(allOrders.length === 0){ elements.ordersList.innerHTML = '<div class="kv mobile-optimized-text">Keine Bestell="kv mobile-optimized-text">Keine Bestellungen vorhanden.</div>'; return; }
  allungen vorhanden.</div>'; return; }
  allOrders.sort((a,b)=>Orders.sort((a,b)=> (b.createdAt||0) - (a.createdAt (b.createdAt||0) - (a.createdAt||0));
  allOrders||0));
  allOrders.forEach(o=>{
    const.forEach(o=>{
    const div = document.createElement div = document.createElement('div');
    div.className =('div');
    div.className = 'category-item fade 'category-item fade-in';
    const name = o.user-in';
    const name = o.userName || '‚Äî unbekannt ‚ÄîName || '‚Äî unbekannt ‚Äî';
    const phone = o.phone || '';
    const total = o.items';
    const phone = o.phone || '';
    const total = o.items?.length || 0;
    const date = o.created?.length || 0;
    const date = o.createdAt ? new DateAt ? new Date(o(o.created.createdAtAt).toLocale).toLocaleString('de-DE') : '-';
    div.innerHTMLString('de-DE') : '-';
    div.innerHTML = `
      <div class="mobile-optimized-text">
        < = `
      <div class="mobile-optimized-text">
        <strong class="${o.status === 'bearbeitet' ?strong class="${o.status === 'bearbeitet' ? 'success' : 'warning'}">${escape 'success' : 'warning'}">${escapeHtml(o.code)}</strong> (${escapeHtml(date)})Html(o.code)}</strong> (${escapeHtml(date)})<br>
        ${escapeHtml(name)} ${phone<br>
        ${escapeHtml(name)} ${phone ? ' ? 'üìû '+escapeHtml(phone) : ''üìû '+escapeHtml(phone) : ''} ‚Äî} ‚Äî ${total} Artikel
        ${o.status === ${total} Artikel
        ${o.status === 'bear 'bearbeitet' ? '<span class="success">beitet' ? '<span class="success">‚úì Bearbeitet</span>' :‚úì Bearbeitet</span>' : '<span class=" '<span class="warning">‚óè Offen</span>'}
      </div>
     warning">‚óè Offen</span>'}
      </div>
      <div style=" <div style="display:display:flex;gap:6px">
        <buttonflex;gap:6px">
        <button class="btn small-btn" data-view class="btn small-btn" data-view="${escapeHtml(o="${escapeHtml(o.code)}">üëÅÔ∏è Ansehen</button>
        <button.code)}">üëÅÔ∏è Ansehen</button>
        <button class="btn small class="btn small-btn" data-del="${escapeHtml(o-btn" data-del="${escapeHtml(o.key)}" style="background:#ef4444.key)}" style="background:#ef4444">üóëÔ∏è L√∂schen</button">üóëÔ∏è L√∂schen</button>
      </div>
      </div>`;
    elements.ordersList.appendChild>`;
    elements.orders(div);
    div.querySelector('[data-del]').onList.appendChild(div);
    div.querySelector('[data-del]').onclick = ()=> { ifclick = ()=> { if(confirm('Bestellung wirklich l√∂schen?')) remove(ref(confirm('Bestellung wirklich l√∂schen?')) remove(ref(db,'orders/'+o.key(db,'orders/'+o.key)); };
    div.querySelector)); };
    div.querySelector('[data-view]').onclick =('[data-view]').onclick = ()=> loadOrder ()=> loadOrderByCode(o.code);
  });
}

elements.loadOrderBtn.addEventListenerByCode(o.code);
  });
}

elements.loadOrderBtn.addEventListener('click', ()=> {
  const code('click', ()=> {
  const code = (orderCodeInput.value||'').trim = (orderCodeInput.value||'').trim();
  if(!();
  if(!code) returncode) return alert('‚ùå Code eingeben.');
  loadOrderByCode(code alert('‚ùå Code eingeben.');
  loadOrderByCode);
});

function loadOrderByCode(code){
  const order = allOrders.find(o=> (o.code||'').toString()(code);
});

function loadOrderByCode(code){
  const order = allOrders.find(o=> (o.code||'').toString() === code.toString());
  === code.toString());
  if(!order) return alert(' if(!order) return alert('‚ùå Keine Bestellung mit diesem Code gefunden‚ùå Keine Bestellung mit diesem Code gefunden.');
  orderDetails.style.display = '';
.');
  orderDetails.style.display =  orderItems.innerHTML = '';
  (order.items || '';
  orderItems.innerHTML = '';
  (order.items || []).forEach(i=> []).forEach(i=>{
    const div = document.createElement('div');
    const{
    const div = document.createElement('div');
    const resText = Object.entries(i resText = Object.entries(i.resources || {})..resources || {}).map(([k,v])=>map(([k,v])=>`${k}: ${v}`).join(', ');
    div.innerHTML = `<div style`${k}: ${v}`).join(', ');
    div.innerHTML = `<div="margin-bottom:6px" class="mobile-optimized style="margin-bottom:6px" class="mobile-optimized-text"><b>${escapeHtml(i.name)}-text"><b>${escapeHtml(i.name)}</b> ‚Äî ${escapeHtml</b> ‚Äî ${escapeHtml(String(i.quantity))}(String(i.quantity))}x</div><div class="x</div><div class="kv mobile-optimizedkv mobile-optimized-text-text">${escapeHtml">${escapeHtml(resText)}</div>`;
    orderItems.appendChild(div);
(resText)}</div>`;
    orderItems.appendChild(div);
  });
  orderUserName.value = order.userName  });
  orderUserName.value = order.userName || '';
  orderPhone.value = order || '';
  orderPhone.value.phone || '';
  save = order.phone || '';
  saveOrderUserBtn.onclick = async ()=>OrderUserBtn.onclick = async ()=> {
    try { await update(ref(db,'orders/'+order.key), { userName: {
    try { await update(ref(db,'orders/'+order.key), { userName: (orderUserName.value||'' (orderUserName.value||'').trim(), phone: ().trim(), phone: (orderPhone.value||'').orderPhone.value||'').trim() }); alert('trim() }); alert('‚úÖ Kundendaten gespeichert.'); }
‚úÖ Kundendaten gespeichert.'); }
    catch(e){ console.error(e); alert    catch(e){ console.error('‚ùå Fehler beim Speichern.'); }
 (e); alert('‚ùå Fehler beim Speichern.'); }
  };
  markOrderResetBtn.onclick = async ()=> {
    if(!confirm };
  markOrderResetBtn.onclick = async ()=> {
    if(!confirm('Bestellung als bearbeitet markieren('Bestellung als bearbeitet?')) return;
    try { await update(ref(db,' markieren?')) return;
    try { await update(ref(db,'orders/'+order.key), { status: 'orders/'+order.key), { status: 'bearbeitet' }); alert('bearbeitet' }); alert('‚úÖ Bestellung mark‚úÖ Bestellung markiert.'); }
    catch(e){iert.'); }
    catch(e){ console.error(e); alert('‚ùå Fehler console.error(e); alert('.'); }
  };
}

function renderUsersList()‚ùå Fehler.'); }
  };
}

function renderUsersList() {
  const usersMap = new Map();
 {
  const usersMap = new Map();
  allOrders.forEach(order => {
    if (  allOrders.forEach(order => {
    if (order.phone && order.userName)order.phone && order.user {
      const userKey = `${order.phoneName) {
      const userKey = `${order.phone}-${order.userName}`;
      if (!usersMap}-${order.userName}`;
     .has(userKey)) usersMap.set(userKey, { phone if (!usersMap.has(userKey)) usersMap.set(userKey, { phone: order: order.phone.phone, userName: order.userName, userName: order, orders: [] });
      usersMap.get(userKey).orders.push(order);
    }
  });
  const users =.userName, orders: [] });
      usersMap.get(userKey).orders.push(order);
    }
  });
  const users = Array.from(usersMap.values());
  elements.usersList.innerHTML = '';
 Array.from(usersMap.values());
  elements.usersList.innerHTML = '';
  if (users.length ===   if (users.length ===0) { elements.usersList.innerHTML 0) { elements.usersList.innerHTML = '<div class="kv mobile-optimized-text">Keine Nutzer = '<div class="kv mobile-optimized-text">Keine Nutzer mit Telefonnummer mit Telefonnummern gefunden.</div>'; returnn gefunden.</div>'; return; }
  users.forEach(user => {
    const; }
  users.forEach(user => {
    const userItem userItem = document.createElement('div');
    userItem.class = document.createElement('div');
    userItem.className =Name = 'user-order-item fade-in';
    if (selectedUserId === user.phone) userItem.classList.add 'user-order-item fade-in';
    if (selectedUserId === user.phone) userItem.classList.add('active');
    userItem.innerHTML('active');
    userItem.innerHTML = = `<div style="font-weight:700" class `<div style="font-weight:700" class="mobile-optimized-text">${escapeHtml="mobile-optimized-text">${escapeHtml(user.userName)}</div><div class="kv(user.userName)}</div><div class="kv mobile-optimized mobile-optimized-text">üìû ${escapeHtml(user.phone)}</div-text">üìû ${escapeHtml(user.phone)}</><div class="kv mobile-optimized-text">${user.orders.length} Bestellungdiv><div class="kv mobile-optimized-text">${user.orders.length} Bestellung${user.orders${user.orders.length !== 1 ? 'en'.length !== 1 ? 'en' : ''}</div>`;
    userItem.on : ''}</div>`;
    userItem.onclick = () => {
      document.querySelectorclick = () => {
     All('.user-order-item').forEach(item => item.classList.remove document.querySelectorAll('.user-order-item').forEach(item => item.classList.remove('active'));
      userItem.classList.add('('active'));
      userItem.classList.add('active');
      selectedUserId = user.active');
      selectedUserId = user.phone;
      renderUserOrders(user);
    };
phone;
      renderUserOrders(user);
    };
    elements.usersList.appendChild(userItem);
    elements.usersList.appendChild(userItem);
  });
}

function  });
}

function renderUserOrders(user) {
  elements renderUserOrders(user) {
  elements.userOrdersDetails.userOrdersDetails.innerHTML = '';
  if (!user || !user.orders.length.innerHTML = '';
  if (!user || !user.orders.length) { elements.userOrdersDetails) { elements.userOrdersDetails.innerHTML = '<div class="kv.innerHTML = '<div class="kv mobile-optimized-text">Keine Bestellungen mobile-optimized-text">Keine Bestellungen f√ºr diesen Nutzer gefunden.</ f√ºr diesen Nutzer gefunden.</div>'; returndiv>'; return; }
  const sortedOrders = user.orders.sort((a, b) => (b.createdAt || 0) - (; }
  const sortedOrders = user.orders.sort((a, b) => (b.createdAt || 0) - (a.createda.createdAt || 0));
  sortedOrders.forEachAt || 0));
  sortedOrders.forEach(order => {
    const orderCard = document.createElement('div');
    orderCard.className =(order => {
    const orderCard = document.createElement('div');
    orderCard.className = 'card fade-in 'card fade-in';
   ';
    orderCard.style.marginBottom = ' orderCard.style.marginBottom = '12px';
    const date = order.createdAt ? new12px';
    const date = order.createdAt ? new Date(order.createdAt).toLocaleString('de Date(order.createdAt).toLocaleString('de-DE-DE') : '-';
    const status = order.status === 'bearbeitet' ?') : '-';
    const status = order.status === 'bearbeitet' ? '<span class="success '<span class="success">‚úì">‚úì Bearbeitet</span>' : '<span class="warning">‚óè Offen Bearbeitet</span>' : '<span class="warning">‚óè Offen</span</span>';
    orderCard.innerHTML = `<div>';
    orderCard.innerHTML = `<div style="display:flex;justify-content:space-between;align style="display:flex;justify-content:space-between;align-items:start;-items:start;margin-bottom:8px"><margin-bottom:8px"><div class="mobile-optimized-text"><strong>Bestdiv class="mobile-optimized-text"><strong>Bestellcode: ${escapeHtml(order.codeellcode: ${escapeHtml(order.code)}</strong><br><div class="kv)}</strong><br><div class="kv">${escapeHtml(date)}</div">${escapeHtml(date)}</div></div><div></div><div class=" class="mobile-optimized-text">${status}</div></div>`;
    ifmobile-optimized-text">${status}</div></div>`;
    if (order.items && order.items.length > (order.items && order.items.length > 0) {
      const itemsList 0) {
      const = document.createElement('div');
      itemsList.style itemsList = document.createElement('div');
      itemsList.style.marginTop = '8px';
      order.items.marginTop = '8px';
      order.items.forEach(item => {
        const resourceText = Object..forEach(item => {
        const resourceText = Object.entries(item.resources || {}).entries(item.resources || {}).map(([name, value]) => `${name}:map(([name, value]) => `${name}: ${value}`).join(', ');
 ${value}`).join(', ');
        const itemDiv =        const itemDiv = document.createElement('div');
        itemDiv.style.m document.createElement('div');
        itemDiv.style.marginBottom = '6arginBottom = '6px';
        itemDiv.style.ppx';
        itemDiv.style.padding = '6px';
        itemadding = '6px';
        itemDiv.style.background = 'rgba(255Div.style.background = 'rgba(255,255,255,255,0.02)';
        itemDiv.style.borderRadius =,255,0.02)';
        itemDiv.style.borderRadius = '4px';
        itemDiv.innerHTML '4px';
        itemDiv.innerHTML = `<div class = `<div class="mobile="mobile-optimized-text"><b>${escapeHtml(item.name-optimized-text"><b>${escapeHtml(item.name)}</b> ‚Äî ${item.)}</b> ‚Äî ${item.quantity}x</div><div class="kv mobile-optimized-textquantity}x</div><div class="kv mobile-optimized-text">${escapeHtml(resourceText)}">${escapeHtml(resourceText)}</div>`;
</div>`;
        itemsList.appendChild(itemDiv);
             itemsList.appendChild(itemDiv);
      });
      orderCard });
      orderCard.appendChild(itemsList);
    }
    elements.userOrdersDetails.appendChild(orderCard);
  });
}

ensureOrderUi.appendChild(itemsList);
    }
    elements.userOrdersDetails.appendChild(orderCard);
  });
}

ensureOrderUiInCart();
renderCartView();
applySettings();

elementsInCart();
renderCartView();
applySettings();

elements.settingsPassword.addEventListener.settingsPassword.addEventListener('keypress', (e) => { if(e.key === '('keypress', (e) => { if(e.keyEnter') elements.settingsUnlockBtn.click(); });
elements === 'Enter') elements.settingsUnlockBtn.click(); });
elements.newCategoryInput.addEventListener('keypress', (e) =>.newCategoryInput.addEventListener('keypress', (e) => { if(e.key === ' { if(e.key === 'Enter') elements.addCategoryBtnEnter') elements.addCategoryBtn.click(); });

console.log('üöÄ Bullet Farm v.click(); });

console.log('üöÄ Bullet Farm v2 Shop initialisiert');
</2 Shop initialisiert');
</script>
</body>
</html>

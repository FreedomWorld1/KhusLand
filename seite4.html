<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bullet Farm v2 ‚Äî Shop</title>
<!-- Updated: Kategorien-Tab + Shop-Filter + Admin fixes (v2) -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#0f1724;--card:#0b1220;--muted:#9ca3af;--accent:#06b6d4}
body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:#071025;color:#e6eef8;margin:0}
.container{max-width:1100px;margin:0 auto;padding:20px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);border-radius:12px;padding:16px}
.shadow-soft{box-shadow:0 8px 30px rgba(2,6,23,0.6)}
.small-muted{color:var(--muted);font-size:0.85rem;margin-top:4px}
.btn{transition:all .12s ease;border-radius:8px;padding:.45rem .8rem;cursor:pointer;background:#111827;color:#e6eef8;border:1px solid rgba(255,255,255,0.03)}
.btn:hover{transform:translateY(-2px)}
.hidden-el{display:none !important}
.product-image{width:100%;height:130px;object-fit:cover;border-radius:8px}
.product-image-admin{width:80px;height:50px;object-fit:cover;border-radius:6px}
#productsGrid .card{max-width:220px;margin:0 auto}
.modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(4,6,11,0.6);opacity:0;pointer-events:none;transition:opacity .22s ease;z-index:80}
.modal-overlay.active{opacity:1;pointer-events:all}
.modal-box{width:96%;max-width:980px;background:linear-gradient(180deg,#0b1220,#0f1724);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 20px 60px rgba(2,6,23,0.7);transform:translateY(-8px);transition:transform .22s ease}
.modal-overlay.active .modal-box{transform:translateY(0)}
.tab-btn{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
.tab-btn.active{background:linear-gradient(90deg,#94a3b8,#06b6d4);color:#041628;font-weight:700}
.table {width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:0.92rem}
.kv{font-size:0.9rem;color:var(--muted)}
.category-item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:6px}
.input,textarea,select{background:#071224;border:1px solid rgba(255,255,255,0.04);color:#e6eef8;padding:.5rem;border-radius:8px;width:100%}
.color-input{width:48px;height:36px;padding:0;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#fff}
.small-btn{padding:.35rem .6rem;border-radius:6px}
.flex-row{display:flex;gap:8px;align-items:center}
.right{margin-left:auto}
</style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <header class="card shadow-soft mb-6 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img id="headerLogo" src="https://via.placeholder.com/48" alt="Logo" style="width:48px;height:48px;object-fit:cover;border-radius:8px">
        <div>
          <h1 id="pageTitle" style="font-size:1.4rem;font-weight:700;color:#22c55e;margin:0">Bullet Farm v2</h1>
          <div class="small-muted">Shop</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnShop" class="btn">Shop</button>
        <button id="btnCart" class="btn">Warenkorb</button>
        <button id="openSettingsBtn" class="btn">‚öôÔ∏è</button>
      </div>
    </header>

    <!-- MAIN: SHOP -->
    <main id="mainContent">
      <section id="shopView" class="card mb-6">
        <div class="flex items-center justify-between mb-4">
          <div style="display:flex;gap:10px;align-items:center">
            <h2 style="font-weight:700;color:#22c55e;margin:0">üõí Produkte</h2>
            <div class="kv">Filter:</div>
            <select id="shopCategoryFilter" class="input" style="width:200px">
              <option value="">‚Äî Alle Kategorien ‚Äî</option>
            </select>
          </div>
          <div class="kv">Produkte anzeigen</div>
        </div>

        <div id="productsGrid" class="grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px"></div>
      </section>

      <!-- CART VIEW -->
      <section id="cartView" class="card mb-6 hidden-el">
        <div class="flex items-center justify-between mb-4">
          <h2 style="font-weight:700;color:#22c55e">üõçÔ∏è Warenkorb</h2>
          <div class="kv">Ressourcen & Anzahl</div>
        </div>
        <table class="table" id="cartTable">
          <thead><tr><th>Produkt</th><th>Ressourcen</th><th style="text-align:right">Anzahl</th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:12px;font-weight:700" id="cartSummary">Gesamt Ressourcen: keine</div>
        <!-- Hier wird der Bestell-Button + Code-Anzeige eingef√ºgt -->
      </section>
    </main>
  </div>

  <!-- SETTINGS MODAL (Produkte / Kategorien / Allgemein / Bestellungen) -->
  <div id="settingsModal" class="modal-overlay hidden-el" aria-hidden="true">
    <div class="modal-box">
      <div class="flex items-start justify-between mb-4">
        <div>
          <h3 style="font-size:1.15rem;font-weight:700;color:#94a3b8;margin:0">‚öôÔ∏è Einstellungen</h3>
          <div class="kv">Passwortgesch√ºtzt ‚Äî Admin Funktionen</div>
        </div>
        <div class="flex gap-2 items-center">
          <button id="settingsCloseBtn" class="btn">‚úñ</button>
        </div>
      </div>

      <!-- LOGIN -->
      <div id="settingsLoginArea">
        <label class="kv mb-2">Admin Passwort</label>
        <div class="flex items-center gap-2 mb-3">
          <input id="settingsPassword" type="password" class="input" placeholder="Passwort (admin123)"/>
          <button id="settingsUnlockBtn" class="btn">Einloggen</button>
        </div>
        <div id="settingsLoginError" class="kv" style="color:#ff7b7b;display:none">‚ùå Falsches Passwort</div>
      </div>

      <!-- EDITOR -->
      <div id="settingsEditor" class="hidden-el">
        <div class="mb-4">
          <div class="flex gap-2">
            <button class="tab-btn active" data-tab="products">Produkte</button>
            <button class="tab-btn" data-tab="categories">Kategorien</button>
            <button class="tab-btn" data-tab="general">Allgemein</button>
            <button class="tab-btn" data-tab="orders">Bestellungen</button>
          </div>
        </div>

        <!-- PRODUCTS TAB -->
        <div id="tabProducts" class="tab-panel">
          <div class="flex items-center justify-between mb-3">
            <h4 style="font-weight:700">Produkte verwalten</h4>
            <div class="flex gap-2">
              <button id="btnNewProduct" class="btn">Neues Produkt</button>
              <button id="btnReloadProducts" class="btn">Neu laden</button>
            </div>
          </div>

          <!-- Produkt-Form (inkl. Ressourcen & Kategorie) -->
          <div id="productFormCard" class="card mb-3 hidden-el">
            <form id="productForm">
              <input id="prodId" type="hidden"/>
              <div style="display:grid;grid-template-columns:1fr 120px;gap:10px;margin-bottom:10px">
                <div>
                  <input id="prodName" class="input" placeholder="Name" required />
                  <input id="prodImg" class="input" placeholder="Bild-URL" style="margin-top:8px"/>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px">
                  <label class="kv">Vorschau</label>
                  <img id="prodPreview" src="https://via.placeholder.com/150x100" alt="Vorschau" style="width:100%;height:80px;object-fit:cover;border-radius:6px;border:1px solid rgba(255,255,255,0.03)">
                </div>
              </div>

              <textarea id="prodDesc" class="input" rows="2" placeholder="Beschreibung (optional)" style="margin-bottom:8px"></textarea>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px">
                <select id="prodCategorySelect" class="input">
                  <option value="">‚Äî Keine Kategorie ‚Äî</option>
                </select>
                <div style="display:flex;gap:8px;align-items:center">
                  <label class="kv">Name-Farbe</label>
                  <input id="colorNameInput" type="color" class="color-input" value="#22c55e">
                  <label class="kv" style="margin-left:8px">Anzahl-Farbe</label>
                  <input id="colorQuantityInput" type="color" class="color-input" value="#3b82f6">
                </div>
              </div>

              <!-- Ressourcen-Tabelle -->
              <div id="resourceTableContainer" style="margin-bottom:8px">
                <h5 style="margin:0 0 8px 0;font-weight:700">Ressourcen (Name:Anzahl:Farbe)</h5>
                <table class="table" id="resourceTable">
                  <thead>
                    <tr><th>Ressource</th><th style="width:120px;text-align:right">Anzahl</th><th style="width:120px">Farbe</th><th style="width:60px">Aktion</th></tr>
                  </thead>
                  <tbody style="background:transparent"></tbody>
                </table>
                <div style="margin-top:8px">
                  <button id="addResourceBtn" type="button" class="btn">Ressource hinzuf√ºgen</button>
                </div>
              </div>

              <div style="display:flex;gap:8px">
                <button type="submit" class="btn" style="background:#10b981">Speichern</button>
                <button id="cancelProductBtn" type="button" class="btn" style="background:#ef4444">Abbrechen</button>
              </div>
            </form>
          </div>

          <!-- Product list (Admin) -->
          <div class="card" style="max-height:46vh;overflow:auto">
            <table class="table" style="width:100%">
              <thead><tr><th>Vorschau</th><th>Name</th><th>Kategorie</th><th>Ressourcen</th><th style="width:140px">Aktionen</th></tr></thead>
              <tbody id="productsTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- CATEGORIES TAB -->
        <div id="tabCategories" class="tab-panel hidden-el">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <h4 style="font-weight:700">Kategorien verwalten</h4>
            <div style="display:flex;gap:8px;width:360px">
              <input id="newCategoryInput" class="input" placeholder="Neue Kategorie" />
              <button id="addCategoryBtn" class="btn">Hinzuf√ºgen</button>
            </div>
          </div>
          <div id="categoriesList" class="card" style="max-height:36vh;overflow:auto;padding:12px">
            <!-- Liste wird dynamisch gef√ºllt -->
          </div>
        </div>

        <!-- GENERAL TAB -->
        <div id="tabGeneral" class="tab-panel hidden-el">
          <h4 style="font-weight:700;margin-bottom:8px">Allgemein</h4>
          <label class="kv mb-2">Titel</label>
          <input id="settingTitle" class="input" placeholder="Seiten-Titel"/>
          <label class="kv mb-2" style="margin-top:8px">Header Bild URL (48x48 empfohlen)</label>
          <input id="settingHeaderImage" class="input" placeholder="Bild-URL"/>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="saveGeneralBtn" class="btn" style="background:#10b981">Speichern</button>
            <button id="resetGeneralBtn" class="btn" style="background:#ef4444">Zur√ºcksetzen</button>
          </div>
        </div>

        <!-- ORDERS TAB -->
        <div id="tabOrders" class="tab-panel hidden-el">
          <h4 style="font-weight:700;margin-bottom:8px">Bestellungen verwalten</h4>

          <div class="flex items-center gap-2 mb-3">
            <input id="orderCodeInput" class="input" placeholder="Bestellcode eingeben (z. B. 4272)" style="width:200px">
            <button id="loadOrderBtn" class="btn">Laden</button>
          </div>

          <div id="orderDetails" class="card" style="margin-bottom:12px;display:none">
            <h5 style="margin:0 0 8px 0">Bestelldetails</h5>
            <div id="orderItems" class="kv"></div>
            <div style="margin-top:8px">
              <input id="orderUserName" class="input" placeholder="Name des Kunden" style="margin-top:6px">
              <input id="orderPhone" class="input" placeholder="Telefonnummer" style="margin-top:6px">
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="saveOrderUserBtn" class="btn" style="background:#10b981">Daten speichern</button>
                <button id="markOrderResetBtn" class="btn" style="background:#ef4444">Als bearbeitet / zur√ºcksetzen</button>
              </div>
            </div>
          </div>

          <h5 style="margin-top:10px">Alle Bestellungen</h5>
          <div id="ordersList" class="card" style="max-height:40vh;overflow:auto;padding:12px"></div>
        </div>

      </div> <!-- end editor -->
    </div>
  </div>

<script type="module">
/* ---------- Firebase imports ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

/* ---------- Config (deine) ---------- */
const firebaseConfig = { apiKey:"AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo", authDomain:"khusland-b7d13.firebaseapp.com", databaseURL:"https://khusland-b7d13-default-rtdb.firebaseio.com", projectId:"khusland-b7d13", storageBucket:"khusland-b7d13.firebasestorage.app", messagingSenderId:"69573193613", appId:"1:69573193613:web:86c4d839281b1e343cd7c4", measurementId:"G-JSCWR4207G" };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productsRef = ref(db, 'products');
const settingsRef = ref(db, 'settings');
const categoriesRef = ref(db, 'categories');
// NEU: Orders Pfad
const ordersRef = ref(db, 'orders');

/* ---------- Globals & elements ---------- */
const ADMIN_PASSWORD = 'admin123';

const openSettingsBtn = document.getElementById('openSettingsBtn');
const settingsModal = document.getElementById('settingsModal');
const settingsCloseBtn = document.getElementById('settingsCloseBtn');
const settingsPassword = document.getElementById('settingsPassword');
const settingsUnlockBtn = document.getElementById('settingsUnlockBtn');
const settingsLoginError = document.getElementById('settingsLoginError');
const settingsLoginArea = document.getElementById('settingsLoginArea');
const settingsEditor = document.getElementById('settingsEditor');

const tabBtns = document.querySelectorAll('.tab-btn');
const tabPanels = document.querySelectorAll('.tab-panel');

const btnNewProduct = document.getElementById('btnNewProduct');
const productFormCard = document.getElementById('productFormCard');
const productForm = document.getElementById('productForm');
const cancelProductBtn = document.getElementById('cancelProductBtn');
const prodId = document.getElementById('prodId');
const prodName = document.getElementById('prodName');
const prodImg = document.getElementById('prodImg');
const prodPreview = document.getElementById('prodPreview');
const prodDesc = document.getElementById('prodDesc');
const prodCategorySelect = document.getElementById('prodCategorySelect');
const colorNameInput = document.getElementById('colorNameInput');
const colorQuantityInput = document.getElementById('colorQuantityInput');
const addResourceBtn = document.getElementById('addResourceBtn');
const resourceTable = document.querySelector('#resourceTable tbody');

const productsTableBody = document.getElementById('productsTableBody');
const btnReloadProducts = document.getElementById('btnReloadProducts');

const settingTitle = document.getElementById('settingTitle');
const settingHeaderImage = document.getElementById('settingHeaderImage');
const saveGeneralBtn = document.getElementById('saveGeneralBtn');
const resetGeneralBtn = document.getElementById('resetGeneralBtn');

const pageTitle = document.getElementById('pageTitle');
const headerLogo = document.getElementById('headerLogo');
const productsGrid = document.getElementById('productsGrid');

const shopView = document.getElementById('shopView');
const cartView = document.getElementById('cartView');
const btnShop = document.getElementById('btnShop');
const btnCart = document.getElementById('btnCart');
const cartTableBody = document.querySelector('#cartTable tbody');
const cartSummary = document.getElementById('cartSummary');

const shopCategoryFilter = document.getElementById('shopCategoryFilter');
const newCategoryInput = document.getElementById('newCategoryInput');
const addCategoryBtn = document.getElementById('addCategoryBtn');
const categoriesList = document.getElementById('categoriesList');

const orderCodeInput = document.getElementById('orderCodeInput');
const loadOrderBtn = document.getElementById('loadOrderBtn');
const orderDetails = document.getElementById('orderDetails');
const orderItems = document.getElementById('orderItems');
const orderUserName = document.getElementById('orderUserName');
const orderPhone = document.getElementById('orderPhone');
const saveOrderUserBtn = document.getElementById('saveOrderUserBtn');
const markOrderResetBtn = document.getElementById('markOrderResetBtn');
const ordersList = document.getElementById('ordersList');

let products = [];
let settings = { title: 'Bullet Farm', headerImage: 'https://via.placeholder.com/48', categories: [] };
let categories = [];
let cart = []; // array of {key, name, resourcesMap, qty}
let allOrders = []; // geladen aus Firebase

/* ---------- Modal helpers ---------- */
function showModal(){ settingsModal.classList.remove('hidden-el'); setTimeout(()=>settingsModal.classList.add('active'),10); document.body.style.overflow='hidden'; }
function hideModal(){ settingsModal.classList.remove('active'); document.body.style.overflow=''; setTimeout(()=>settingsModal.classList.add('hidden-el'),240); }

/* ---------- Modal & Tabs ---------- */
openSettingsBtn.addEventListener('click', ()=>{
  settingsPassword.value = '';
  settingsLoginError.style.display = 'none';
  settingsLoginArea.style.display = '';
  settingsEditor.classList.add('hidden-el');
  showModal();
});
settingsCloseBtn.addEventListener('click', hideModal);
settingsModal.addEventListener('click', (e)=> { if(e.target === settingsModal) hideModal(); });
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape' && !settingsModal.classList.contains('hidden-el')) hideModal(); });

tabBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.tab;
    tabPanels.forEach(p=>p.classList.add('hidden-el'));
    document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('hidden-el');
  });
});

/* ---------- Settings load/save ---------- */
onValue(settingsRef, snapshot=>{
  const val = snapshot.val();
  if(val){
    settings.title = val.title || settings.title;
    settings.headerImage = val.headerImage || settings.headerImage;
  }
  applySettings();
});
function applySettings(){
  pageTitle.innerText = settings.title || 'Bullet Farm';
  headerLogo.src = settings.headerImage || 'https://via.placeholder.com/48';
  if(settingTitle) settingTitle.value = settings.title || '';
  if(settingHeaderImage) settingHeaderImage.value = settings.headerImage || '';
}
saveGeneralBtn.addEventListener('click', async ()=>{
  const t = (settingTitle.value||'').trim() || 'Bullet Farm';
  const img = (settingHeaderImage.value||'').trim() || 'https://via.placeholder.com/48';
  try{ await update(settingsRef, { title: t, headerImage: img }); alert('Allgemeine Einstellungen gespeichert'); } catch(e){ console.error(e); alert('Fehler beim Speichern'); }
});
resetGeneralBtn.addEventListener('click', async ()=>{
  if(!confirm('Auf Standard zur√ºcksetzen?')) return;
  try{ await update(settingsRef, { title:'Bullet Farm', headerImage:'https://via.placeholder.com/48' }); alert('Zur√ºckgesetzt'); } catch(e){ console.error(e); alert('Fehler'); }
});

/* ---------- Categories: load / render / CRUD ---------- */
onValue(categoriesRef, snapshot=>{
  categories = [];
  snapshot.forEach(child=>{
    const data = child.val(); data.key = child.key; categories.push(data);
  });
  renderCategoriesList();
  populateCategorySelects();
});
function renderCategoriesList(){
  categoriesList.innerHTML = '';
  if(categories.length===0){ categoriesList.innerHTML = '<div class="kv">Keine Kategorien.</div>'; return; }
  categories.forEach(c=>{
    const div = document.createElement('div');
    div.className='category-item';
    div.innerHTML = `<div>${escapeHtml(c.name)}</div><div style="display:flex;gap:6px"><button class="btn" data-edit="${c.key}">‚úèÔ∏è</button><button class="btn" data-del="${c.key}" style="background:#ef4444">üóëÔ∏è</button></div>`;
    categoriesList.appendChild(div);
    div.querySelector('[data-del]').onclick = async ()=> {
      if(!confirm('Kategorie wirklich l√∂schen? Produkte bleiben unver√§ndert.')) return;
      try{ await remove(ref(db,'categories/'+c.key)); }catch(e){ console.error(e); alert('Fehler beim L√∂schen'); }
    };
    div.querySelector('[data-edit]').onclick = ()=> {
      const newName = prompt('Neuer Kategorie-Name', c.name);
      if(newName && newName.trim()){
        update(ref(db,'categories/'+c.key), { name: newName.trim() }).catch(()=>alert('Fehler beim Umbenennen'));
      }
    };
  });
}
addCategoryBtn.addEventListener('click', async ()=>{
  const name = (newCategoryInput.value||'').trim();
  if(!name) return alert('Name eingeben');
  try{
    await push(categoriesRef, { name });
    newCategoryInput.value = '';
  }catch(e){ console.error(e); alert('Fehler beim Anlegen'); }
});
function populateCategorySelects(){
  // product form select
  prodCategorySelect.innerHTML = '';
  const none = document.createElement('option'); none.value=''; none.textContent='‚Äî Keine Kategorie ‚Äî'; prodCategorySelect.appendChild(none);
  // shop filter
  shopCategoryFilter.innerHTML = '';
  const allOpt = document.createElement('option'); allOpt.value=''; allOpt.textContent='‚Äî Alle Kategorien ‚Äî'; shopCategoryFilter.appendChild(allOpt);

  categories.forEach(c=>{
    const o = document.createElement('option'); o.value = c.name; o.textContent = c.name; prodCategorySelect.appendChild(o);
    const f = document.createElement('option'); f.value = c.name; f.textContent = c.name; shopCategoryFilter.appendChild(f);
  });
}

/* ---------- Products load / render / CRUD ---------- */
onValue(productsRef, snapshot=>{
  products = [];
  snapshot.forEach(child=>{
    const data = child.val(); data.key = child.key; products.push(data);
  });
  products.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
  renderProductsTable();
  renderProductsGrid();
});

/* escape helper */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[c])); }

/* render shop grid with filter */
shopCategoryFilter.addEventListener('change', ()=> renderProductsGrid());
function renderProductsGrid(){
  const filter = (shopCategoryFilter.value||'').trim();
  productsGrid.innerHTML = '';
  const visible = products.filter(p => !filter || (p.category || '') === filter);
  if(visible.length===0){ productsGrid.innerHTML='<div class="kv p-4">Keine Produkte verf√ºgbar.</div>'; return; }
  visible.forEach(p=>{
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.src = p.image || 'https://via.placeholder.com/300x120'; img.className='product-image';
    const title = document.createElement('div'); title.style.fontWeight='700'; title.style.fontSize='1rem'; title.style.marginTop='8px'; title.style.color = p.colorName || '#22c55e'; title.textContent = p.name || '';
    const desc = document.createElement('div'); desc.className='small-muted'; desc.textContent = p.description || '';
    card.appendChild(img); card.appendChild(title); card.appendChild(desc);

    if(p.resources){
      const pairs = p.resources.split(';').map(x=>x.trim()).filter(Boolean);
      if(pairs.length){
        const tbl = document.createElement('table'); tbl.className='table'; tbl.style.marginTop='8px';
        const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Ressource</th><th style="text-align:right">Anzahl</th></tr>'; tbl.appendChild(thead);
        const tbody = document.createElement('tbody');
        pairs.forEach(r=>{
          const [k,v,c] = r.split(':');
          const tr = document.createElement('tr');
          tr.innerHTML = `<td style="color:${c||'#facc15'}">${escapeHtml(k)}</td><td style="text-align:right;color:${p.colorQuantity||'#3b82f6'}">${Number(v).toLocaleString('de-DE')}</td>`;
          tbody.appendChild(tr);
        });
        tbl.appendChild(tbody); card.appendChild(tbl);
      }
    }

    // category label
    if(p.category) {
      const catDiv = document.createElement('div'); catDiv.className='kv'; catDiv.style.marginTop='8px'; catDiv.textContent = 'Kategorie: ' + p.category;
      card.appendChild(catDiv);
    }

    // In den Warenkorb Button
    const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.style.marginTop='8px'; addBtn.textContent='In den Warenkorb';
    addBtn.onclick = ()=> { addToCartByProductKey(p.key); alert(`${p.name} hinzugef√ºgt`); };
    card.appendChild(addBtn);

    productsGrid.appendChild(card);
  });
}

/* render admin product table (with resources and category) */
function renderProductsTable(){
  productsTableBody.innerHTML = '';
  products.forEach(p=>{
    const resourcesText = p.resources ? p.resources.split(';').map(r=>{
      const [k,v] = r.split(':'); return `${k}: ${v}`;
    }).join(', ') : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding:8px"><img src="${p.image||'https://via.placeholder.com/80'}" class="product-image-admin"></td>
      <td style="padding:8px">${escapeHtml(p.name||'')}</td>
      <td style="padding:8px">${escapeHtml(p.category||'')}</td>
      <td style="padding:8px">${escapeHtml(resourcesText)}</td>
      <td style="padding:8px">
        <button class="btn" data-edit="${p.key}" style="margin-right:6px">Bearbeiten</button>
        <button class="btn" data-del="${p.key}" style="background:#ef4444">L√∂schen</button>
      </td>`;
    productsTableBody.appendChild(tr);
    tr.querySelector('[data-edit]').onclick = ()=> openProductForm(p);
    tr.querySelector('[data-del]').onclick = ()=> { if(confirm('Produkt wirklich l√∂schen?')) remove(ref(db, 'products/' + p.key)); };
  });
}

/* open product form (create/edit) */
btnNewProduct.addEventListener('click', ()=> openProductForm());
function openProductForm(product){
  productFormCard.classList.remove('hidden-el');
  resourceTable.innerHTML = '';
  // ensure category select populated (populateCategorySelects called by categories on load)
  if(product){
    prodId.value = product.key || '';
    prodName.value = product.name || '';
    prodImg.value = product.image || '';
    prodPreview.src = product.image || 'https://via.placeholder.com/150x100';
    prodDesc.value = product.description || '';
    prodCategorySelect.value = product.category || '';
    colorNameInput.value = product.colorName || '#22c55e';
    colorQuantityInput.value = product.colorQuantity || '#3b82f6';
    if(product.resources){
      const pairs = product.resources.split(';').map(x=>x.trim()).filter(Boolean);
      pairs.forEach(r=>{
        const [k,v,c] = r.split(':');
        addResourceRow(k,v,c||'#facc15');
      });
    }
  } else {
    prodId.value = '';
    productForm.reset();
    prodPreview.src = 'https://via.placeholder.com/150x100';
    colorNameInput.value = '#22c55e';
    colorQuantityInput.value = '#3b82f6';
  }
}

/* resource row helper */
function addResourceRow(name='', value='', color='#facc15'){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="input" value="${escapeHtml(name)}" /></td>
    <td style="text-align:right"><input type="number" min="0" class="input" value="${escapeHtml(value)}" /></td>
    <td><input type="color" class="color-input" value="${escapeHtml(color)}" /></td>
    <td style="text-align:center"><button class="btn" type="button">‚ùå</button></td>`;
  const btn = tr.querySelector('button');
  btn.onclick = ()=> tr.remove();
  resourceTable.appendChild(tr);
}
addResourceBtn.addEventListener('click', ()=> addResourceRow());

prodImg.addEventListener('input', ()=> { prodPreview.src = prodImg.value || 'https://via.placeholder.com/150x100'; });

cancelProductBtn.addEventListener('click', ()=> { productFormCard.classList.add('hidden-el'); productForm.reset(); prodId.value = ''; });

productForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const rows = Array.from(resourceTable.querySelectorAll('tr'));
  const resources = rows.map(r=>{
    const name = r.children[0].querySelector('input').value.trim();
    const qty = r.children[1].querySelector('input').value.trim();
    const col = r.children[2].querySelector('input').value;
    return name && qty ? `${name}:${qty}:${col}` : '';
  }).filter(Boolean).join(';');

  const payload = {
    name: (prodName.value||'').trim(),
    image: (prodImg.value||'').trim(),
    description: (prodDesc.value||'').trim(),
    category: (prodCategorySelect.value||'').trim(),
    resources: resources,
    colorName: colorNameInput.value || '#22c55e',
    colorQuantity: colorQuantityInput.value || '#3b82f6',
    updatedAt: Date.now()
  };

  try{
    if(prodId.value){
      await update(ref(db, 'products/' + prodId.value), payload);
      alert('Produkt aktualisiert');
    } else {
      await push(productsRef, payload);
      alert('Produkt angelegt');
    }
    productFormCard.classList.add('hidden-el');
    productForm.reset();
    prodId.value = '';
  }catch(err){ console.error(err); alert('Fehler beim Speichern des Produkts'); }
});

/* reload products */
btnReloadProducts.addEventListener('click', ()=> {
  get(productsRef).then(()=> alert('Produkte neu geladen.')).catch(()=> alert('Laden fehlgeschlagen.'));
});

/* login */
settingsUnlockBtn.addEventListener('click', ()=>{
  const pw = (settingsPassword.value||'').trim();
  if(pw === ADMIN_PASSWORD){
    settingsLoginError.style.display = 'none';
    settingsLoginArea.style.display = 'none';
    settingsEditor.classList.remove('hidden-el');
    // open Products tab by default
    tabBtns.forEach(b=>b.classList.remove('active'));
    tabBtns[0].classList.add('active');
    tabPanels.forEach(p=>p.classList.add('hidden-el'));
    document.getElementById('tabProducts').classList.remove('hidden-el');
  } else {
    settingsLoginError.style.display = '';
  }
});

/* helper: parse resource string into map {name:qty,...} */
function resourcesToMap(resourcesString){
  const map = {};
  if(!resourcesString) return map;
  const pairs = resourcesString.split(';').map(x=>x.trim()).filter(Boolean);
  pairs.forEach(r=>{
    const [k,v] = r.split(':');
    if(k && v) map[k] = (map[k] || 0) + Number(v);
  });
  return map;
}

/* ---------- WARENKORB ---------- */
/* add product to cart by key, merge resources */
function addToCartByProductKey(productKey){
  const p = products.find(x=>x.key===productKey);
  if(!p) return;
  const resMap = resourcesToMap(p.resources);
  const idx = cart.findIndex(c => c.key === productKey);
  if(idx === -1){
    cart.push({ key: productKey, name: p.name, resources: {...resMap}, qty: 1 });
  } else {
    cart[idx].qty += 1;
    for(const k in resMap) cart[idx].resources[k] = (cart[idx].resources[k] || 0) + resMap[k];
  }
  renderCartView();
}

/* render cart */
function renderCartView(){
  const tbody = document.querySelector('#cartTable tbody');
  tbody.innerHTML = '';
  const totalResources = {};
  cart.forEach(entry=>{
    const tr = document.createElement('tr');
    const resText = Object.entries(entry.resources).map(([k,v])=>`${k}: ${v}`).join(', ');
    tr.innerHTML = `<td>${escapeHtml(entry.name)}</td><td>${escapeHtml(resText)}</td><td style="text-align:right">${entry.qty}</td>`;
    tbody.appendChild(tr);
    for(const k in entry.resources) totalResources[k] = (totalResources[k]||0) + entry.resources[k];
  });
  const summary = Object.entries(totalResources).map(([k,v])=>`${k}: ${v}`).join(', ') || 'keine';
  cartSummary.innerText = 'Gesamt Ressourcen: ' + summary;

  // ensure UI (Button + Code display) vorhanden
  ensureOrderUiInCart();
  // update button state
  if(saveOrderBtnEl) saveOrderBtnEl.disabled = (cart.length === 0);
  // if no cart items, show hint; otherwise show code area as-is (keeps last code visible)
}

/* Shop/Cart toggle */
btnShop.addEventListener('click', ()=>{ shopView.classList.remove('hidden-el'); cartView.classList.add('hidden-el'); });
btnCart.addEventListener('click', ()=>{ shopView.classList.add('hidden-el'); cartView.classList.remove('hidden-el'); renderCartView(); });

/* ---------- BESTELLUNG (4-stelliger Code) ---------- */

// Hilfsfunktion: 4-stelliger numerischer Code
function generate4DigitCode(){
  return Math.floor(1000 + Math.random() * 9000).toString();
}

// Element-Refs f√ºr Bestell-UI (wird erzeugt)
let saveOrderBtnEl = null;
let orderCodeDisplayEl = null;

// Erstelle UI im Warenkorb (Button + Anzeige)
function ensureOrderUiInCart(){
  if(saveOrderBtnEl) return; // schon erzeugt

  // Container unter dem cartSummary
  const parent = cartView;

  // Wrapper Div
  const wrapper = document.createElement('div');
  wrapper.style.marginTop = '12px';

  // Save Button
  saveOrderBtnEl = document.createElement('button');
  saveOrderBtnEl.className = 'btn';
  saveOrderBtnEl.textContent = 'Bestellung speichern (Code erzeugen)';
  saveOrderBtnEl.onclick = saveCartAsOrder;
  wrapper.appendChild(saveOrderBtnEl);

  // Anzeige des Codes
  orderCodeDisplayEl = document.createElement('div');
  orderCodeDisplayEl.style.marginTop = '8px';
  orderCodeDisplayEl.style.fontWeight = '700';
  orderCodeDisplayEl.style.fontSize = '1.05rem';
  orderCodeDisplayEl.className = 'kv';
  orderCodeDisplayEl.textContent = ''; // leer bis gespeichert
  wrapper.appendChild(orderCodeDisplayEl);

  // Copy-Button
  const copyBtn = document.createElement('button');
  copyBtn.className = 'btn small-btn';
  copyBtn.style.marginLeft = '8px';
  copyBtn.textContent = 'Kopieren';
  copyBtn.onclick = ()=> {
    const txt = orderCodeDisplayEl.textContent.replace('Bestellcode: ','').trim();
    if(!txt) return alert('Kein Bestellcode vorhanden');
    navigator.clipboard?.writeText(txt).then(()=> alert('Code kopiert')).catch(()=> alert('Kopieren nicht m√∂glich'));
  };

  // kleines flex f√ºr code + copy
  const codeWrap = document.createElement('div');
  codeWrap.style.display = 'flex';
  codeWrap.style.alignItems = 'center';
  codeWrap.style.gap = '8px';
  codeWrap.appendChild(orderCodeDisplayEl);
  codeWrap.appendChild(copyBtn);

  // replace wrapper's last child with codeWrap instead of raw display
  wrapper.removeChild(orderCodeDisplayEl);
  wrapper.appendChild(codeWrap);

  parent.appendChild(wrapper);
}

// Speichere Warenkorb als Bestellung (Firebase) und zeige Code in Warenkorb (keine Popup)
async function saveCartAsOrder(){
  if(cart.length === 0) return alert('Warenkorb ist leer.');

  // Generiere 4-stelligen Code
  const code = generate4DigitCode();

  // Struktur der Bestellung (du kannst hier beliebig Felder erg√§nzen)
  const orderData = {
    code: code,
    createdAt: Date.now(),
    items: cart,
    status: 'offen',
    userName: '',
    phone: ''
  };

  try {
    const pushed = await push(ordersRef, orderData);
    // code nur im Warenkorb anzeigen (nicht als Popup)
    if(!orderCodeDisplayEl) ensureOrderUiInCart();
    orderCodeDisplayEl.textContent = 'Bestellcode: ' + code;
    // Warenkorb leeren
    cart = [];
    renderCartView();
  } catch (e) {
    console.error(e);
    alert('Fehler beim Speichern der Bestellung.');
  }
}

/* ---------- BESTELLUNGEN ADMIN-LOGIK ---------- */

// Lade alle Bestellungen und render Liste
onValue(ordersRef, snapshot => {
  allOrders = [];
  snapshot.forEach(child => {
    const o = child.val(); o.key = child.key;
    allOrders.push(o);
  });
  renderOrdersList();
});

// Rendern der Bestellungenliste im Admin-Tab
function renderOrdersList() {
  ordersList.innerHTML = '';
  if(allOrders.length === 0){
    ordersList.innerHTML = '<div class="kv">Keine Bestellungen vorhanden.</div>';
    return;
  }

  allOrders.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));

  allOrders.forEach(o=>{
    const div = document.createElement('div');
    div.className = 'category-item';
    const name = o.userName || '‚Äî unbekannt ‚Äî';
    const phone = o.phone || '';
    const total = o.items?.length || 0;
    const date = o.createdAt ? new Date(o.createdAt).toLocaleString('de-DE') : '-';
    div.innerHTML = `
      <div>
        <strong>${o.code}</strong> (${date})<br>
        ${escapeHtml(name)} ${phone ? 'üìû '+escapeHtml(phone) : ''} ‚Äî ${total} Artikel
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn small-btn" data-view="${o.code}">üëÅÔ∏è</button>
        <button class="btn small-btn" data-del="${o.key}" style="background:#ef4444">üóëÔ∏è</button>
      </div>`;
    ordersList.appendChild(div);

    div.querySelector('[data-del]').onclick = ()=> {
      if(confirm('Bestellung wirklich l√∂schen?')) remove(ref(db,'orders/'+o.key));
    };
    div.querySelector('[data-view]').onclick = ()=> loadOrderByCode(o.code);
  });
}

// Suche/Lade Bestellung per Code (Input in Admin-Tab)
loadOrderBtn.addEventListener('click', ()=> {
  const code = (orderCodeInput.value||'').trim().toUpperCase();
  if(!code) return alert('Code eingeben.');
  loadOrderByCode(code);
});

  /* ---------- BESTELLUNG (4-stelliger Code) ---------- */
// Hilfsfunktion: 4-stelliger numerischer Code
function generate4DigitCode() {
  return Math.floor(1000 + Math.random() * 9000).toString();
}

// Referenzen f√ºr UI-Elemente im Warenkorb
let saveOrderBtnEl = null;
let orderCodeDisplayEl = null;

// Erstellt den "Bestellung speichern"-Button + Codeanzeige
function ensureOrderUiInCart() {
  if (saveOrderBtnEl) return; // bereits vorhanden

  const wrapper = document.createElement('div');
  wrapper.style.marginTop = '16px';
  wrapper.style.textAlign = 'center';

  // Button
  saveOrderBtnEl = document.createElement('button');
  saveOrderBtnEl.className = 'btn';
  saveOrderBtnEl.textContent = 'üßæ Bestellung speichern (Code erzeugen)';
  saveOrderBtnEl.onclick = saveCartAsOrder;
  wrapper.appendChild(saveOrderBtnEl);

  // Codeanzeige
  orderCodeDisplayEl = document.createElement('div');
  orderCodeDisplayEl.style.marginTop = '8px';
  orderCodeDisplayEl.style.fontWeight = '700';
  orderCodeDisplayEl.style.fontSize = '1.1rem';
  wrapper.appendChild(orderCodeDisplayEl);

  cartView.appendChild(wrapper);
}

// Speichert Bestellung in Firebase mit Code
async function saveCartAsOrder() {
  if (cart.length === 0) return alert('Warenkorb ist leer.');

  const code = generate4DigitCode();

  const orderData = {
    code,
    createdAt: Date.now(),
    items: cart,
    status: 'offen',
    userName: '',
    phone: ''
  };

  try {
    await push(ordersRef, orderData);

    // Zeige Code im Warenkorb
    if (!orderCodeDisplayEl) ensureOrderUiInCart();
    orderCodeDisplayEl.textContent = '‚úÖ Bestellcode: ' + code;

    // Warenkorb leeren
    cart = [];
    renderCartView();
  } catch (e) {
    console.error(e);
    alert('Fehler beim Speichern der Bestellung.');
  }
}
function loadOrderByCode(code){
  const order = allOrders.find(o=> (o.code||'').toString().toUpperCase() === code.toString().toUpperCase());
  if(!order) return alert('Keine Bestellung mit diesem Code gefunden.');

  orderDetails.style.display = '';
  orderItems.innerHTML = '';
  (order.items || []).forEach(i=>{
    const div = document.createElement('div');
    const resText = Object.entries(i.resources || {}).map(([k,v])=>`${k}: ${v}`).join(', ');
    div.innerHTML = `<div style="margin-bottom:6px"><b>${escapeHtml(i.name)}</b> ‚Äî ${i.qty}x</div><div class="kv">${escapeHtml(resText)}</div>`;
    orderItems.appendChild(div);
  });

  orderUserName.value = order.userName || '';
  orderPhone.value = order.phone || '';

  // Speichern der Kundendaten f√ºr diese Bestellung
  saveOrderUserBtn.onclick = async ()=> {
    try {
      await update(ref(db,'orders/'+order.key), {
        userName: (orderUserName.value||'').trim(),
        phone: (orderPhone.value||'').trim()
      });
      alert('Kundendaten gespeichert.');
    } catch(e){ console.error(e); alert('Fehler beim Speichern.'); }
  };

  // Markieren / Reset (z.B. Zustand √§ndern oder l√∂schen)
  markOrderResetBtn.onclick = async ()=> {
    if(!confirm('Bestellung als bearbeitet markieren und Eintr√§ge zur√ºcksetzen?')) return;
    try {
      await update(ref(db,'orders/'+order.key), { status: 'bearbeitet' });
      alert('Bestellung markiert.');
    } catch(e){ console.error(e); alert('Fehler.'); }
  };
}

/* ---------- INIT ---------- */
// ensure UI im Warenkorb vorbereitet
ensureOrderUiInCart();

// initial render
renderCartView();

</script>
</body>
</html>

<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bullet Farm ‚Äî Shop</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#0f1724;--card:#0b1220;--muted:#9ca3af;--accent:#06b6d4}
body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:#071025;color:#e6eef8;margin:0}
.container{max-width:1100px;margin:0 auto;padding:20px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);border-radius:12px;padding:16px}
.shadow-soft{box-shadow:0 8px 30px rgba(2,6,23,0.6)}
.small-muted{color:var(--muted);font-size:0.85rem;margin-top:4px}
.btn{transition:all .12s ease;border-radius:8px;padding:.45rem .8rem;cursor:pointer;background:#111827;color:#e6eef8;border:1px solid rgba(255,255,255,0.03)}
.btn:hover{transform:translateY(-2px)}
.hidden-el{display:none !important}
.product-image{width:100%;height:130px;object-fit:cover;border-radius:8px}
.product-image-admin{width:80px;height:50px;object-fit:cover;border-radius:6px}
#productsGrid .card{max-width:220px;margin:0 auto}
.modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(4,6,11,0.6);opacity:0;pointer-events:none;transition:opacity .22s ease;z-index:80}
.modal-overlay.active{opacity:1;pointer-events:all}
.modal-box{width:96%;max-width:980px;background:linear-gradient(180deg,#0b1220,#0f1724);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 20px 60px rgba(2,6,23,0.7);transform:translateY(-8px);transition:transform .22s ease}
.modal-overlay.active .modal-box{transform:translateY(0)}
.tab-btn{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
.tab-btn.active{background:linear-gradient(90deg,#94a3b8,#06b6d4);color:#041628;font-weight:700}
.table {width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:0.92rem}
.kv{font-size:0.9rem;color:var(--muted)}
.category-item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:6px}
.input,textarea,select{background:#071224;border:1px solid rgba(255,255,255,0.04);color:#e6eef8;padding:.5rem;border-radius:8px;width:100%}
.color-input{width:48px;height:36px;padding:0;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#fff}
.small-btn{padding:.35rem .6rem;border-radius:6px}
.flex-row{display:flex;gap:8px;align-items:center}
.right{margin-left:auto}
</style>
</head>
<body>
<div class="container">
  <!-- HEADER -->
  <header class="card shadow-soft mb-6 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <img id="headerLogo" src="https://via.placeholder.com/48" alt="Logo" style="width:48px;height:48px;object-fit:cover;border-radius:8px">
      <div>
        <h1 id="pageTitle" style="font-size:1.4rem;font-weight:700;color:#22c55e;margin:0">Bullet Farm</h1>
        <div class="small-muted">Shop</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnShop" class="btn">Shop</button>
      <button id="btnCart" class="btn">Warenkorb</button>
      <button id="openSettingsBtn" class="btn">‚öôÔ∏è</button>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main id="mainContent">
    <!-- SHOP VIEW -->
    <section id="shopView" class="card mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 style="font-weight:700;color:#22c55e">üõí Produkte</h2>
      </div>
      <div id="productsGrid" class="grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px"></div>
    </section>

    <!-- CART VIEW -->
    <section id="cartView" class="card mb-6 hidden-el">
      <h2 style="font-weight:700;color:#22c55e">üõçÔ∏è Warenkorb</h2>
      <table class="table" id="cartTable">
        <thead><tr><th>Produkt</th><th>Ressourcen</th><th style="text-align:right">Anzahl</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:10px;font-weight:700" id="cartTotal">Gesamt: 0</div>
    </section>
  </main>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal-overlay hidden-el" aria-hidden="true">
  <div class="modal-box">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h3 style="font-size:1.15rem;font-weight:700;color:#94a3b8;margin:0">‚öôÔ∏è Einstellungen</h3>
        <div class="kv">Passwortgesch√ºtzt ‚Äî Admin Funktionen</div>
      </div>
      <div class="flex gap-2 items-center">
        <button id="settingsCloseBtn" class="btn">‚úñ</button>
      </div>
    </div>
    <!-- LOGIN -->
    <div id="settingsLoginArea">
      <label class="kv mb-2">Admin Passwort</label>
      <div class="flex items-center gap-2 mb-3">
        <input id="settingsPassword" type="password" class="input" placeholder="Passwort (admin123)"/>
        <button id="settingsUnlockBtn" class="btn">Einloggen</button>
      </div>
      <div id="settingsLoginError" class="kv" style="color:#ff7b7b;display:none">‚ùå Falsches Passwort</div>
    </div>

    <!-- EDITOR -->
    <div id="settingsEditor" class="hidden-el">
      <div class="mb-4">
        <div class="flex gap-2">
          <button class="tab-btn active" data-tab="products">Produkte</button>
          <button class="tab-btn" data-tab="general">Allgemein</button>
        </div>
      </div>
      <div id="tabProducts" class="tab-panel">
        <div class="flex items-center justify-between mb-3">
          <h4 style="font-weight:700">Produkte verwalten</h4>
          <div class="flex gap-2">
            <button id="btnNewProduct" class="btn">Neues Produkt</button>
            <button id="btnReloadProducts" class="btn">Neu laden</button>
          </div>
        </div>
        <!-- Produkt-Form -->
        <div id="productFormCard" class="card mb-3 hidden-el">
          <form id="productForm">
            <input id="prodId" type="hidden"/>
            <div style="display:grid;grid-template-columns:1fr 120px;gap:10px;margin-bottom:10px">
              <div>
                <input id="prodName" class="input" placeholder="Name" required />
                <input id="prodImg" class="input" placeholder="Bild-URL" style="margin-top:8px"/>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px">
                <label class="kv">Vorschau</label>
                <img id="prodPreview" src="https://via.placeholder.com/150x100" alt="Vorschau" style="width:100%;height:80px;object-fit:cover;border-radius:6px;border:1px solid rgba(255,255,255,0.03)">
              </div>
            </div>
            <textarea id="prodDesc" class="input" rows="2" placeholder="Beschreibung" style="margin-bottom:8px"></textarea>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px">
              <div><label class="kv">Kategorie</label><input id="prodCategorySelect" class="input"/></div>
              <div style="display:flex;gap:8px;align-items:center">
                <label class="kv">Name-Farbe</label>
                <input id="colorNameInput" type="color" class="color-input" value="#22c55e">
                <label class="kv" style="margin-left:8px">Anzahl-Farbe</label>
                <input id="colorQuantityInput" type="color" class="color-input" value="#3b82f6">
              </div>
            </div>
            <div id="resourceTableContainer" style="margin-bottom:8px">
              <h5 style="margin:0 0 8px 0;font-weight:700">Ressourcen (Name:Anzahl:Farbe)</h5>
              <table class="table" id="resourceTable">
                <thead>
                  <tr><th>Ressource</th><th style="width:120px;text-align:right">Anzahl</th><th style="width:120px">Farbe</th><th style="width:60px">Aktion</th></tr>
                </thead>
                <tbody style="background:transparent"></tbody>
              </table>
              <div style="margin-top:8px"><button id="addResourceBtn" type="button" class="btn">Ressource hinzuf√ºgen</button></div>
            </div>
            <div style="display:flex;gap:8px">
              <button type="submit" class="btn" style="background:#10b981">Speichern</button>
              <button id="cancelProductBtn" type="button" class="btn" style="background:#ef4444">Abbrechen</button>
            </div>
          </form>
        </div>
        <div class="card" style="max-height:46vh;overflow:auto">
          <table class="table" style="width:100%">
            <thead><tr><th>Vorschau</th><th>Name</th><th>Kategorie</th><th style="width:140px">Aktionen</th></tr></thead>
            <tbody id="productsTableBody"></tbody>
          </table>
        </div>
      </div>

      <div id="tabGeneral" class="tab-panel hidden-el">
        <h4 style="font-weight:700;margin-bottom:8px">Allgemein</h4>
        <label class="kv mb-2">Titel</label>
        <input id="settingTitle" class="input" placeholder="Seiten-Titel"/>
        <label class="kv mb-2" style="margin-top:8px">Header Bild URL (48x48 empfohlen)</label>
        <input id="settingHeaderImage" class="input" placeholder="Bild-URL"/>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="saveGeneralBtn" class="btn" style="background:#10b981">Speichern</button>
          <button id="resetGeneralBtn" class="btn" style="background:#ef4444">Zur√ºcksetzen</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = { apiKey:"DEIN_API_KEY", authDomain:"PROJECT.firebaseapp.com", databaseURL:"https://PROJECT.firebaseio.com", projectId:"PROJECT", storageBucket:"PROJECT.appspot.com", messagingSenderId:"ID", appId:"APPID" };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productsRef = ref(db, 'products');
const settingsRef = ref(db, 'settings');

const ADMIN_PASSWORD = 'admin123';
const openSettingsBtn = document.getElementById('openSettingsBtn');
const settingsModal = document.getElementById('settingsModal');
const settingsCloseBtn = document.getElementById('settingsCloseBtn');
const settingsPassword = document.getElementById('settingsPassword');
const settingsUnlockBtn = document.getElementById('settingsUnlockBtn');
const settingsLoginError = document.getElementById('settingsLoginError');
const settingsLoginArea = document.getElementById('settingsLoginArea');
const settingsEditor = document.getElementById('settingsEditor');

const tabBtns = document.querySelectorAll('.tab-btn');
const tabPanels = document.querySelectorAll('.tab-panel');

const btnNewProduct = document.getElementById('btnNewProduct');
const productFormCard = document.getElementById('productFormCard');
const productForm = document.getElementById('productForm');
const cancelProductBtn = document.getElementById('cancelProductBtn');
const prodId = document.getElementById('prodId');
const prodName = document.getElementById('prodName');
const prodImg = document.getElementById('prodImg');
const prodPreview = document.getElementById('prodPreview');
const prodDesc = document.getElementById('prodDesc');
const prodCategorySelect = document.getElementById('prodCategorySelect');
const colorNameInput = document.getElementById('colorNameInput');
const colorQuantityInput = document.getElementById('colorQuantityInput');
const addResourceBtn = document.getElementById('addResourceBtn');
const resourceTable = document.querySelector('#resourceTable tbody');

const productsTableBody = document.getElementById('productsTableBody');
const btnReloadProducts = document.getElementById('btnReloadProducts');

const settingTitle = document.getElementById('settingTitle');
const settingHeaderImage = document.getElementById('settingHeaderImage');
const saveGeneralBtn = document.getElementById('saveGeneralBtn');
const resetGeneralBtn = document.getElementById('resetGeneralBtn');

const pageTitle = document.getElementById('pageTitle');
const headerLogo = document.getElementById('headerLogo');
const productsGrid = document.getElementById('productsGrid');

const shopView = document.getElementById('shopView');
const cartView = document.getElementById('cartView');
const btnShop = document.getElementById('btnShop');
const btnCart = document.getElementById('btnCart');
const cartTableBody = document.querySelector('#cartTable tbody');
const cartTotal = document.getElementById('cartTotal');

let products = [];
let settings = { title: 'Bullet Farm', headerImage: 'https://via.placeholder.com/48' };
let cart = [];

function showModal(){ settingsModal.classList.remove('hidden-el'); setTimeout(()=>settingsModal.classList.add('active'),10); document.body.style.overflow='hidden'; }
function hideModal(){ settingsModal.classList.remove('active'); document.body.style.overflow=''; setTimeout(()=>settingsModal.classList.add('hidden-el'),240); }

openSettingsBtn.addEventListener('click', ()=>{
  settingsPassword.value = '';
  settingsLoginError.style.display = 'none';
  settingsLoginArea.style.display = '';
  settingsEditor.classList.add('hidden-el');
  showModal();
});
settingsCloseBtn.addEventListener('click', hideModal);
settingsModal.addEventListener('click', (e)=> { if(e.target === settingsModal) hideModal(); });
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape' && !settingsModal.classList.contains('hidden-el')) hideModal(); });

tabBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.tab;
    tabPanels.forEach(p=>p.classList.add('hidden-el'));
    document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('hidden-el');
  });
});

/* Load Settings */
onValue(settingsRef, snapshot=>{
  const val = snapshot.val();
  if(val){ settings = {...settings, ...val}; }
  applySettings();
});
function applySettings(){
  pageTitle.innerText = settings.title || 'Bullet Farm';
  headerLogo.src = settings.headerImage || 'https://via.placeholder.com/48';
  settingTitle.value = settings.title || '';
  settingHeaderImage.value = settings.headerImage || '';
}

/* Save Settings */
saveGeneralBtn.addEventListener('click', async ()=>{
  try{ await update(settingsRef, { title: settingTitle.value, headerImage: settingHeaderImage.value }); alert('Gespeichert'); }catch(e){alert('Fehler');}
});
resetGeneralBtn.addEventListener('click', async ()=>{
  if(!confirm('Zur√ºcksetzen?')) return;
  try{ await update(settingsRef, { title:'Bullet Farm', headerImage:'https://via.placeholder.com/48' }); alert('Zur√ºckgesetzt');}catch(e){alert('Fehler');}
});

/* Products */
onValue(productsRef, snapshot=>{
  products = [];
  snapshot.forEach(child=>{ const data = child.val(); data.key = child.key; products.push(data); });
  products.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
  renderProductsGrid();
  renderProductsTable();
});

function renderProductsGrid(){
  productsGrid.innerHTML = '';
  if(products.length===0){ productsGrid.innerHTML='<div class="kv p-4">Keine Produkte verf√ºgbar.</div>'; return; }
  products.forEach(p=>{
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.src = p.image || 'https://via.placeholder.com/300x120'; img.className='product-image';
    const title = document.createElement('div'); title.style.fontWeight='700'; title.style.fontSize='1rem'; title.style.marginTop='8px'; title.style.color = p.colorName || '#22c55e'; title.textContent = p.name || '';
    const desc = document.createElement('div'); desc.className='small-muted'; desc.textContent = p.description || '';
    card.appendChild(img); card.appendChild(title); card.appendChild(desc);
    // Ressourcen Tabelle
    if(p.resources){
      const tbl = document.createElement('table'); tbl.className='table'; tbl.style.marginTop='8px';
      const thead = document.createElement('thead'); thead.innerHTML='<tr><th>Ressource</th><th style="text-align:right">Anzahl</th></tr>'; tbl.appendChild(thead);
      const tbody = document.createElement('tbody');
      p.resources.split(';').forEach(r=>{
        const [k,v,c]=r.split(':'); const tr=document.createElement('tr');
        tr.innerHTML=`<td style="color:${c||'#facc15'}">${k}</td><td style="text-align:right;color:${p.colorQuantity||'#3b82f6'}">${v}</td>`;
        tbody.appendChild(tr);
      });
      tbl.appendChild(tbody); card.appendChild(tbl);
    }
    const btnAdd = document.createElement('button'); btnAdd.className='btn'; btnAdd.textContent='In den Warenkorb'; btnAdd.onclick=()=> addToCart(p);
    card.appendChild(btnAdd);
    productsGrid.appendChild(card);
  });
}

function renderProductsTable(){
  productsTableBody.innerHTML = '';
  products.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${p.image||'https://via.placeholder.com/80'}" class="product-image-admin"></td>
      <td>${p.name||''}</td>
      <td>${p.category||''}</td>
      <td>
        <button class="btn" data-edit="${p.key}">Bearbeiten</button>
        <button class="btn" data-del="${p.key}" style="background:#ef4444">L√∂schen</button>
      </td>`;
    productsTableBody.appendChild(tr);
    tr.querySelector('[data-edit]').onclick=()=> openProductForm(p);
    tr.querySelector('[data-del]').onclick=()=>{ if(confirm('L√∂schen?')) remove(ref(db,'products/'+p.key)); };
  });
}

/* Product Form */
btnNewProduct.addEventListener('click', ()=> openProductForm());
function openProductForm(p=null){
  productFormCard.classList.remove('hidden-el');
  resourceTable.innerHTML='';
  if(p){ prodId.value=p.key; prodName.value=p.name; prodImg.value=p.image; prodPreview.src=p.image; prodDesc.value=p.description; prodCategorySelect.value=p.category; colorNameInput.value=p.colorName||'#22c55e'; colorQuantityInput.value=p.colorQuantity||'#3b82f6';
    if(p.resources) p.resources.split(';').forEach(r=>{ const [k,v,c]=r.split(':'); addResourceRow(k,v,c||'#facc15'); });
  } else { productForm.reset(); prodPreview.src='https://via.placeholder.com/150x100'; prodId.value=''; colorNameInput.value='#22c55e'; colorQuantityInput.value='#3b82f6'; }
}
cancelProductBtn.addEventListener('click', ()=>{ productFormCard.classList.add('hidden-el'); productForm.reset(); prodId.value=''; });
prodImg.addEventListener('input', ()=>{ prodPreview.src = prodImg.value||'https://via.placeholder.com/150x100'; });

addResourceBtn.addEventListener('click', ()=> addResourceRow());
function addResourceRow(name='',value='',color='#facc15'){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input class="input" value="${name}"/></td><td style="text-align:right"><input type="number" class="input" value="${value}"/></td><td><input type="color" class="color-input" value="${color}"/></td><td style="text-align:center"><button class="btn" type="button">‚ùå</button></td>`;
  tr.querySelector('button').onclick=()=> tr.remove();
  resourceTable.appendChild(tr);
}

productForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const rows=Array.from(resourceTable.querySelectorAll('tr'));
  const resources=rows.map(r=>{ const name=r.children[0].querySelector('input').value.trim(); const qty=r.children[1].querySelector('input').value.trim(); const col=r.children[2].querySelector('input').value; return name && qty ? `${name}:${qty}:${col}` : ''; }).filter(Boolean).join(';');
  const payload={ name:prodName.value.trim(), image:prodImg.value.trim(), description:prodDesc.value.trim(), category:prodCategorySelect.value.trim(), resources, colorName:colorNameInput.value, colorQuantity:colorQuantityInput.value, updatedAt:Date.now() };
  try{ if(prodId.value) await update(ref(db,'products/'+prodId.value),payload); else await push(productsRef,payload); productFormCard.classList.add('hidden-el'); productForm.reset(); prodId.value=''; }catch(e){alert('Fehler');}
});

btnReloadProducts.addEventListener('click', ()=>{ get(productsRef).then(()=>alert('Neu geladen')).catch(()=>alert('Fehler')); });

settingsUnlockBtn.addEventListener('click', ()=>{
  if(settingsPassword.value===ADMIN_PASSWORD){ settingsLoginError.style.display='none'; settingsLoginArea.style.display='none'; settingsEditor.classList.remove('hidden-el'); }else{ settingsLoginError.style.display=''; }
});

/* CART */
function addToCart(p){
  cart.push(p);
  renderCart();
}
function renderCart(){
  cartTableBody.innerHTML='';
  let total=0;
  cart.forEach(item=>{
    const tr=document.createElement('tr');
    const resStr=item.resources ? item.resources.split(';').map(r=>{ const [k,v]=r.split(':'); return `${k}: ${v}`; }).join(', ') : '';
    tr.innerHTML=`<td>${item.name}</td><td>${resStr}</td><td style="text-align:right">${item.resources ? item.resources.split(';').reduce((a,b)=>a+Number(b.split(':')[1]),0):0}</td>`;
    cartTableBody.appendChild(tr);
  });
  cartTotal.innerText='Gesamt: '+cart.reduce((a,b)=>a.resources? a+Number(b.resources.split(';').reduce((x,y)=>x+Number(y.split(':')[1]),0)):a,0);
}

/* SHOP / CART TOGGLE */
btnShop.addEventListener('click', ()=>{ shopView.classList.remove('hidden-el'); cartView.classList.add('hidden-el'); });
btnCart.addEventListener('click', ()=>{ shopView.classList.add('hidden-el'); cartView.classList.remove('hidden-el'); });
</script>
</body>
</html>

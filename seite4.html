<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Materialrecycler - KhusLand</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ALLE CSS-STYLES VON DER WERKBANK-MANAGER SEITE */
    body { 
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
    }
    .card { 
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%); 
      border: 1px solid rgba(220, 38, 38, 0.2); 
      border-radius: 16px; 
      backdrop-filter: blur(10px);
    }
    .shadow-soft { 
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 
                  0 5px 10px rgba(0, 0, 0, 0.3),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1); 
    }
    .small-muted { 
      color: #94a3b8; 
      font-size: 0.85rem; 
    }
    .btn { 
      transition: all 0.2s ease; 
      font-size: 0.9rem; 
      font-weight: 500;
    }
    .btn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .hidden { 
      display: none !important; 
    }
    input, select, textarea { 
      transition: all 0.2s ease; 
      font-size: 0.95rem; 
    }
    input:focus, select:focus, textarea:focus { 
      outline: none; 
      border-color: #dc2626; 
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3); 
    }
    .active-link { 
      background-color: #dc2626 !important; 
      color: #fff !important; 
      font-weight: 600; 
    }
    .gradient-text {
      background: linear-gradient(90deg, #dc2626 0%, #ea580c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .glass-effect {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(220, 38, 38, 0.1);
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .pulse-glow {
      animation: pulseGlow 2s infinite;
    }
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 5px rgba(220, 38, 38, 0.5); }
      50% { box-shadow: 0 0 20px rgba(220, 38, 38, 0.8); }
      100% { box-shadow: 0 0 5px rgba(220, 38, 38, 0.5); }
    }
    .scrollbar-custom::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-custom::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
    }
    .scrollbar-custom::-webkit-scrollbar-thumb {
      background: #dc2626;
      border-radius: 10px;
    }
    .hamburger-container {
      position: relative;
      z-index: 1000;
    }
    .hamburger-menu {
      z-index: 1001;
    }
    .category-btn {
      transition: all 0.3s ease;
    }
    .category-btn.active {
      background-color: #dc2626;
      color: white;
    }
    .resource-item {
      transition: all 0.2s ease;
    }
    .resource-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateX(150%);
      transition: transform 0.3s ease;
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.success {
      background-color: #10b981;
    }
    .notification.error {
      background-color: #ef4444;
    }
    .notification.info {
      background-color: #3b82f6;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .search-box {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(220, 38, 38, 0.2);
      border-radius: 10px;
      padding: 10px 15px;
      margin-bottom: 15px;
    }
    .search-box input {
      background: transparent;
      border: none;
      width: 100%;
      color: white;
      font-size: 0.95rem;
    }
    .search-box input::placeholder {
      color: #94a3b8;
    }
    .search-box input:focus {
      outline: none;
      box-shadow: none;
    }
    .access-badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 8px;
    }
    .access-permanent {
      background-color: #10b981;
      color: white;
    }
    .access-temporary {
      background-color: #f59e0b;
      color: black;
    }
    .access-expired {
      background-color: #ef4444;
      color: white;
    }
    .force-check-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: #ef4444;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      z-index: 1000;
      opacity: 0.5;
      transition: opacity 0.3s;
    }
    .force-check-btn:hover {
      opacity: 1;
    }
    .resource-tag {
      display: inline-flex;
      align-items: center;
      background: rgba(147, 51, 234, 0.2);
      color: #a855f7;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin: 2px;
    }
    .resource-input-container {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .resource-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
    }
    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 12px 0;
    }
    .quantity-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: rgba(220, 38, 38, 0.2);
      border: 1px solid rgba(220, 38, 38, 0.3);
      color: #dc2626;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .quantity-btn:hover {
      background: rgba(220, 38, 38, 0.3);
      transform: scale(1.05);
    }
    .quantity-input {
      width: 80px;
      text-align: center;
      padding: 6px 8px;
      border-radius: 6px;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(220, 38, 38, 0.3);
      color: #dc2626;
      font-weight: 600;
    }
    .result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(220, 38, 38, 0.1);
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }
    .result-range {
      color: #dc2626;
      font-weight: 600;
    }
    .calculator-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(220, 38, 38, 0.2);
    }
    .calculator-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #dc2626;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .image-preview {
      max-width: 100px;
      max-height: 100px;
      border-radius: 8px;
      margin-top: 8px;
      border: 1px solid rgba(220, 38, 38, 0.3);
    }
    .scrollable-modal {
      max-height: 90vh;
      overflow-y: auto;
      width: 100%;
      max-width: 600px;
    }
    .modal-scrollbar::-webkit-scrollbar {
      width: 8px;
    }
    .modal-scrollbar::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
      margin: 5px;
    }
    .modal-scrollbar::-webkit-scrollbar-thumb {
      background: #dc2626;
      border-radius: 10px;
    }
    .modal-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #b91c1c;
    }

    /* Materialrecycler spezifische Styles */
    .product-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
    @media (min-width: 768px) {
      .product-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    .product-item {
      background: rgba(30, 41, 59, 0.6);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid rgba(220, 38, 38, 0.2);
      transition: all 0.3s;
    }
    .product-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .product-card {
      display: grid;
      grid-template-columns: 100px 1fr;
      gap: 1rem;
      align-items: start;
    }
    .product-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid rgba(220, 38, 38, 0.3);
    }
    
    /* Loading Animation */
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #dc2626;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
  </style>
</head>
<body class="text-gray-100 antialiased min-h-screen">
  
  <!-- Notification System -->
  <div id="notification" class="notification hidden"></div>
  
  <!-- Force Check Button -->
  <div id="forceCheckBtn" class="force-check-btn hidden" title="Sofort-√úberpr√ºfung">
    <i class="fas fa-shield-alt"></i>
  </div>
  
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="card p-8 shadow-soft max-w-md w-full text-center">
      <div class="w-20 h-20 rounded-full bg-gradient-to-r from-red-600 to-orange-500 flex items-center justify-center mx-auto mb-6">
        <span class="text-white text-2xl">‚ôªÔ∏è</span>
      </div>
      <h1 class="text-3xl font-bold gradient-text mb-2">Materialrecycler</h1>
      <p class="text-gray-400 mb-6">Bitte mit Discord einloggen um fortzufahren</p>
      
      <button id="discordLogin" class="w-full py-3 bg-[#5865F2] hover:bg-[#4752c4] rounded-lg btn font-medium flex items-center justify-center gap-3 transition-all duration-200">
        <i class="fab fa-discord text-xl"></i>
        Mit Discord anmelden
      </button>
      
      <!-- Loading Indicator -->
      <div id="loginLoading" class="mt-4 hidden">
        <div class="loading-spinner"></div>
        <p class="text-gray-400 mt-2">Anmeldung l√§uft...</p>
      </div>
      
      <div id="loginError" class="mt-4 p-3 bg-red-900/20 border border-red-700 rounded-lg text-red-400 hidden">
        <p id="errorMessage">Zugriff verweigert. Du bist nicht autorisiert.</p>
      </div>

      <!-- Debug Info -->
      <div id="debugInfo" class="mt-4 p-3 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-400 text-xs hidden">
        <p id="debugMessage"></p>
      </div>
      
      <!-- Manueller Login Fallback -->
      <div id="manualLogin" class="mt-4 p-4 bg-gray-800/30 rounded-lg border border-gray-700 hidden">
        <h3 class="text-lg font-semibold text-white mb-2">Manuelle Anmeldung</h3>
        <p class="text-gray-400 text-sm mb-3">Falls Discord Login nicht funktioniert:</p>
        <input type="text" id="manualUsername" placeholder="Benutzername" class="w-full p-2 rounded bg-gray-700 border border-gray-600 mb-2">
        <button onclick="manualLogin()" class="w-full py-2 bg-green-600 hover:bg-green-500 rounded btn">
          Manuell anmelden
        </button>
      </div>
    </div>
  </div>

  <!-- ACCESS RESTRICTED SCREEN -->
  <div id="accessRestricted" class="min-h-screen flex items-center justify-center p-4 hidden">
    <div class="card p-8 shadow-soft max-w-md w-full text-center">
      <div class="w-20 h-20 rounded-full bg-gradient-to-r from-red-600 to-orange-500 flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-ban text-white text-2xl"></i>
      </div>
      <h1 class="text-3xl font-bold gradient-text mb-2">Zugriff verweigert</h1>
      <p class="text-gray-400 mb-4">Hallo <span id="restrictedUserName" class="text-white">Benutzer</span>,</p>
      <p class="text-gray-400 mb-6">Du hast keinen Zugriff auf das <span id="restrictedPageName" class="text-white">Materialrecycler System</span>.</p>
      <button onclick="logout()" class="w-full py-3 bg-red-600 hover:bg-red-500 rounded-lg btn font-medium">
        <i class="fas fa-sign-out-alt mr-2"></i>
        Abmelden
      </button>
    </div>
  </div>

  <!-- MAIN CONTENT (Versteckt bis Login) -->
  <div id="mainContent" class="hidden">
    <div class="max-w-6xl mx-auto p-4 md:p-6">

      <!-- HEADER -->
      <header class="glass-effect rounded-2xl shadow-soft mb-6 p-4 md:p-6 flex justify-between items-center relative z-10">
        <div class="flex items-center gap-3">
          <div id="headerLogo" class="w-10 h-10 rounded-full bg-gradient-to-r from-red-600 to-orange-500 flex items-center justify-center">
            <span class="text-white font-bold">‚ôªÔ∏è</span>
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold gradient-text tracking-tight">Materialrecycler</h1>
            <p id="userInfo" class="text-sm text-gray-400">
              Eingeloggt als: <span id="username">Unbekannt</span>
              <span id="accessBadge" class="access-badge access-permanent hidden">Permanent</span>
            </p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnDashboard" class="btn px-3 py-2 bg-red-600 hover:bg-red-500 rounded-lg shadow-sm pulse-glow">
            <i class="fas fa-tachometer-alt mr-1"></i> Dashboard
          </button>
          <button id="btnRecycler" class="btn px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg shadow-sm">
            <i class="fas fa-recycle mr-1"></i> Recycler
          </button>
          <div class="hamburger-container">
            <button id="hamburgerBtn" class="p-2 flex flex-col justify-between h-6 w-8 focus:outline-none ml-1 rounded-md bg-gray-800 hover:bg-gray-700">
              <span class="block h-0.5 bg-gray-100 rounded-full"></span>
              <span class="block h-0.5 bg-gray-100 rounded-full"></span>
              <span class="block h-0.5 bg-gray-100 rounded-full"></span>
            </button>
            <div id="hamburgerMenu" class="hamburger-menu hidden absolute right-0 mt-2 w-44 glass-effect border border-gray-700 rounded-lg shadow-lg overflow-hidden">
              <a href="index.html" class="block px-4 py-3 hover:bg-gray-700 transition-colors">
                <i class="fas fa-cannabis mr-2"></i> Weed System
              </a>
              <a href="seite1.html" class="block px-4 py-3 hover:bg-gray-700 active-link transition-colors">
                <i class="fas fa-recycle mr-2"></i> Materialrecycler
              </a>
              <a href="seite4.html" class="block px-4 py-3 hover:bg-gray-700 transition-colors">
                <i class="fas fa-tools mr-2"></i> Werkbank Manager
              </a>
            </div>
          </div>
          <button id="logoutBtn" class="btn px-3 py-2 bg-red-600 hover:bg-red-500 rounded-lg shadow-sm ml-2">
            <i class="fas fa-sign-out-alt mr-1"></i> Logout
          </button>
        </div>
      </header>

      <div id="mainContainer" class="space-y-6 relative z-0">

        <!-- DASHBOARD TAB -->
        <div id="dashboardSection" class="card p-6 shadow-soft fade-in">
          <h2 class="text-xl font-semibold mb-4 text-red-400 flex items-center gap-2">
            <i class="fas fa-tachometer-alt"></i>
            System Dashboard
          </h2>
          
          <!-- System Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="card p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" data-page="index.html">
              <div class="w-16 h-16 rounded-full bg-gradient-to-r from-green-600 to-emerald-500 flex items-center justify-center mx-auto mb-4">
                <span class="text-white text-2xl">üåø</span>
              </div>
              <h3 class="text-lg font-semibold text-white mb-2">Weed Ankauf</h3>
              <p class="text-gray-400 text-sm mb-4">Koordinieren Sie Wareneingang und Ankaufkonditionen.</p>
              <div class="flex items-center justify-center text-green-400 text-sm">
                <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                System online
              </div>
            </div>

            <div class="card p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" data-page="seite2.html">
              <div class="w-16 h-16 rounded-full bg-gradient-to-r from-purple-600 to-pink-500 flex items-center justify-center mx-auto mb-4">
                <span class="text-white text-2xl">üíä</span>
              </div>
              <h3 class="text-lg font-semibold text-white mb-2">Kokain Ankauf</h3>
              <p class="text-gray-400 text-sm mb-4">Kontrollieren Sie Kokain-Operationen und Lieferungen.</p>
              <div class="flex items-center justify-center text-green-400 text-sm">
                <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                System online
              </div>
            </div>

            <div class="card p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" data-page="seite4.html">
              <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-600 to-cyan-500 flex items-center justify-center mx-auto mb-4">
                <span class="text-white text-2xl">üîß</span>
              </div>
              <h3 class="text-lg font-semibold text-white mb-2">Werkbank Manager</h3>
              <p class="text-gray-400 text-sm mb-4">√úberwachen Sie Werkstattaktivit√§ten und Produktionsauftr√§ge.</p>
              <div class="flex items-center justify-center text-green-400 text-sm">
                <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                System online
              </div>
            </div>
          </div>
        </div>

        <!-- RECYCLER SYSTEM TAB -->
        <div id="recyclerSection" class="card p-6 shadow-soft hidden fade-in">
          <h2 class="text-xl font-semibold mb-4 text-blue-400 flex items-center gap-2">
            <i class="fas fa-recycle"></i>
            Recycler System
          </h2>
          
          <!-- Suchleiste -->
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="Ressourcen suchen...">
          </div>

          <!-- Produkte Grid -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4 text-blue-400 flex items-center gap-2">
              <i class="fas fa-box"></i> Produkte
            </h3>
            
            <div id="productsGrid" class="product-grid">
              <!-- Produkte werden hier dynamisch geladen -->
              <div class="text-center py-8 text-gray-500">
                <i class="fas fa-box-open text-4xl mb-2"></i>
                <p>Keine Produkte gefunden</p>
              </div>
            </div>
          </div>

          <!-- Admin Panel -->
          <div class="card p-5 shadow-soft">
            <h3 class="text-lg font-semibold mb-4 text-blue-400 flex items-center gap-2">
              <i class="fas fa-cog"></i> Adminbereich
            </h3>
            
            <div id="adminLoginSection">
              <div class="mb-4">
                <label for="adminPass" class="block text-sm font-medium text-gray-300 mb-1">
                  <i class="fas fa-key mr-1"></i> Admin-Passwort
                </label>
                <input id="adminPass" type="password" placeholder="Geben Sie das Passwort ein" class="w-full p-3 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-blue-500"/>
              </div>
              <button id="adminLoginBtn" class="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-lg btn font-medium flex items-center justify-center gap-2">
                <i class="fas fa-sign-in-alt"></i>
                Einloggen
              </button>
              <span id="adminError" class="text-red-400 mt-3 block hidden text-center text-sm py-2 bg-red-900/20 rounded-lg">
                <i class="fas fa-exclamation-triangle mr-1"></i> Falsches Passwort
              </span>
            </div>
            
            <div id="adminContent" class="hidden">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 p-3 rounded-lg bg-gray-800/30">
                <div class="small-muted">Produkte: <span id="totalProducts" class="font-bold text-white">0</span></div>
                <div class="flex gap-2">
                  <button id="addProductBtn" class="px-4 py-3 bg-green-600 hover:bg-green-500 rounded-lg btn font-medium flex items-center justify-center gap-2">
                    <i class="fas fa-plus mr-1"></i>
                    Produkt
                  </button>
                  <button id="exportCsv" class="px-4 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg btn font-medium flex items-center justify-center gap-2">
                    <i class="fas fa-file-export mr-1"></i>
                    CSV Export
                  </button>
                </div>
              </div>
              
              <!-- Admin-Suchleiste -->
              <div class="search-box mb-4">
                <input type="text" id="adminSearchInput" placeholder="Produkt in Adminbereich suchen...">
              </div>
              
              <div class="overflow-auto max-h-[50vh] rounded-lg border border-gray-800 scrollbar-custom">
                <table class="w-full text-left text-sm">
                  <thead class="text-gray-400 bg-gray-800/70 sticky top-0">
                    <tr>
                      <th class="p-3 font-medium">Name</th>
                      <th class="p-3 font-medium">Ressourcen</th>
                      <th class="p-3 font-medium">Aktion</th>
                    </tr>
                  </thead>
                  <tbody id="adminTableBody" class="divide-y divide-gray-800">
                    <tr>
                      <td colspan="3" class="p-4 text-center text-gray-500">Keine Produkte vorhanden</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal f√ºr Produkt hinzuf√ºgen -->
  <div id="productModal" class="modal-overlay hidden">
    <div class="scrollable-modal modal-scrollbar">
      <div class="card p-6 shadow-soft">
        <h3 class="text-lg font-semibold mb-4 text-red-400" id="productModalTitle">
          <i class="fas fa-plus mr-2"></i> Produkt hinzuf√ºgen
        </h3>
        <form id="productForm" class="space-y-4">
          <input type="hidden" id="productKey">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">
              <i class="fas fa-tag mr-1"></i> Name
            </label>
            <input type="text" id="productName" class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 w-full focus:border-red-500" placeholder="z.B.: Aluminium-Dose" required/>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">
              <i class="fas fa-boxes mr-1"></i> Ressourcen
            </label>
            <div class="resource-input-container">
              <input type="text" id="newResourceName" placeholder="Ressourcenname" style="flex: 1;" class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-red-500">
              <input type="number" id="newResourceMin" placeholder="Min" min="1" style="width: 80px;" class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-red-500">
              <input type="number" id="newResourceMax" placeholder="Max" min="1" style="width: 80px;" class="p-3 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-red-500">
              <button type="button" id="addResourceBtn" class="px-4 py-3 bg-red-600 hover:bg-red-500 rounded-lg btn font-medium">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div id="resourcesList" class="resource-list">
              <!-- Ressourcen werden hier dynamisch hinzugef√ºgt -->
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">
              <i class="fas fa-image mr-1"></i> Bild hochladen
            </label>
            <div class="flex gap-2">
              <input type="file" id="productImageFile" accept="image/*" class="flex-1 p-3 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-red-500">
            </div>
            <div class="text-xs text-gray-400 mt-1">
              Unterst√ºtzte Formate: JPG, PNG, GIF (max. 5MB)
            </div>
            <img id="imagePreview" class="image-preview" alt="Vorschau">
            <input type="hidden" id="productImageData">
          </div>
          
          <div class="flex gap-3 pt-2">
            <button type="submit" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-500 rounded-lg btn font-medium flex items-center justify-center gap-2">
              <i class="fas fa-save"></i>
              Speichern
            </button>
            <button type="button" id="cancelProduct" class="px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg btn font-medium flex items-center justify-center gap-2">
              <i class="fas fa-times"></i>
              Abbrechen
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    // Discord OAuth Konfiguration
    const DISCORD_CLIENT_ID = '1432942180770644079';
    const DISCORD_REDIRECT_URI = window.location.origin + window.location.pathname;
    const BACKEND_URL = 'https://discord-oauth.ehrlichcolin2.workers.dev';

    // Firebase Import und Konfiguration
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import { getDatabase, ref, push, onValue, remove, set, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
      authDomain: "khusland-b7d13.firebaseapp.com",
      databaseURL: "https://khusland-b7d13-default-rtdb.firebaseio.com",
      projectId: "khusland-b7d13",
      storageBucket: "khusland-b7d13.firebasestorage.app",
      messagingSenderId: "69573193613",
      appId: "1:69573193613:web:86c4d839281b1e343cd7c4",
      measurementId: "G-JSCWR4207G"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    const storage = getStorage(app);
    
    // Firebase Referenzen
    const productsRef = ref(db, 'materialrecycler/products');
    const logoSettingsRef = ref(db, 'materialrecycler_logo_settings');
    const logoImageRef = storageRef(storage, 'materialrecycler_logo.png');

    // DOM Elemente
    const loginScreen = document.getElementById('loginScreen');
    const mainContent = document.getElementById('mainContent');
    const accessRestricted = document.getElementById('accessRestricted');
    const discordLoginBtn = document.getElementById('discordLogin');
    const loginError = document.getElementById('loginError');
    const errorMessage = document.getElementById('errorMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const debugInfo = document.getElementById('debugInfo');
    const debugMessage = document.getElementById('debugMessage');
    const usernameElement = document.getElementById('username');
    const notification = document.getElementById('notification');
    const accessBadge = document.getElementById('accessBadge');
    const forceCheckBtn = document.getElementById('forceCheckBtn');
    const loginLoading = document.getElementById('loginLoading');
    const manualLoginSection = document.getElementById('manualLogin');

    // System Variablen
    const ADMIN_PASSWORD = '1101';
    let products = [];
    let filteredProducts = [];
    let currentResources = [];
    let currentUser = null;
    let userAccessInfo = null;

    // ========== HELPER FUNCTIONS ==========

    // Notification System
    function showNotification(message, type = 'info', duration = 5000) {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.remove('hidden');
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          notification.classList.add('hidden');
        }, 300);
      }, duration);
    }

    // Debug-Funktion
    function showDebugInfo(message) {
      debugMessage.textContent = message;
      debugInfo.classList.remove('hidden');
    }

    // Manueller Login Fallback
    function manualLogin() {
      const username = document.getElementById('manualUsername').value.trim();
      if (username) {
        currentUser = {
          id: 'manual_' + Date.now(),
          username: username,
          isManual: true
        };
        
        localStorage.setItem('manual_user', JSON.stringify(currentUser));
        showAuthorizedContent(currentUser);
        showNotification(`Manuell angemeldet als ${username}`, 'success');
      } else {
        showNotification('Bitte Benutzername eingeben', 'error');
      }
    }

    // ========== ZUGRIFFSKONTROLLE ==========

    // Zugriff auf Seite pr√ºfen
    async function hasAccess(pageKey) {
      if (!currentUser) return false;
      
      // F√ºr manuelle Benutzer immer Zugriff gew√§hren
      if (currentUser.isManual) return true;
      
      const token = localStorage.getItem('discord_access_token');
      if (!token) return false;

      try {
        const response = await fetch(`${BACKEND_URL}/verify-user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            accessToken: token,
            currentPage: pageKey
          })
        });

        if (!response.ok) return false;

        const data = await response.json();
        return data.hasPageAccess;
        
      } catch (error) {
        console.error('Fehler bei Zugriffspr√ºfung:', error);
        return false;
      }
    }

    // Benutzer existenz pr√ºfen
    async function checkUserExists() {
      if (!currentUser) return false;
      
      // F√ºr manuelle Benutzer immer true zur√ºckgeben
      if (currentUser.isManual) return true;
      
      const token = localStorage.getItem('discord_access_token');
      if (!token) return false;

      try {
        const response = await fetch(`${BACKEND_URL}/verify-user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            accessToken: token
          })
        });

        if (!response.ok) return false;

        const data = await response.json();
        return data.isAuthorized;
        
      } catch (error) {
        console.error('Fehler bei Benutzerpr√ºfung:', error);
        return false;
      }
    }

    // Navigation zu anderen Seiten mit Zugriffspr√ºfung
    async function navigateToWithAccessCheck(page) {
      if (!currentUser) {
        showNotification('Bitte zuerst anmelden', 'error');
        return;
      }
      
      // F√ºr manuelle Benutzer Navigation erlauben
      if (currentUser.isManual) {
        window.location.href = page;
        return;
      }
      
      // Pr√ºfen ob Benutzer noch existiert
      const userExists = await checkUserExists();
      if (!userExists) {
        showNotification('Dein Account wurde aus der Benutzerliste entfernt', 'error');
        logout();
        return;
      }
      
      const pageKey = getPageKeyFromUrl(page);
      if (!pageKey) {
        showNotification('Ung√ºltige Seite', 'error');
        return;
      }
      
      const hasAccessToPage = await hasAccess(pageKey);
      if (!hasAccessToPage) {
        showNotification(`Zugriff verweigert - Keine Berechtigung f√ºr ${getPageDisplayName(pageKey)}`, 'error');
        return;
      }
      
      showNotification(`Weiterleitung zu ${getPageDisplayName(pageKey)}...`, 'info', 1500);
      setTimeout(() => {
        window.location.href = page;
      }, 1500);
    }

    function getPageKeyFromUrl(page) {
      const pageMap = {
        'index.html': 'weed',
        'seite2.html': 'kokain', 
        'seite4.html': 'werkbank',
        'seite1.html': 'materialrecycler'
      };
      return pageMap[page] || page;
    }

    function getPageDisplayName(pageKey) {
      const names = {
        'weed': 'Weed System',
        'kokain': 'Kokain System', 
        'werkbank': 'Werkbank Manager',
        'materialrecycler': 'Materialrecycler'
      };
      return names[pageKey] || pageKey;
    }

    // ========== LOGIN & AUTHENTIFIZIERUNG ==========

    // Discord OAuth Login
    function startDiscordOAuth() {
      console.log('Starte Discord OAuth...');
      
      discordLoginBtn.style.display = 'none';
      loginLoading.classList.remove('hidden');
      loginError.classList.add('hidden');
      manualLoginSection.classList.add('hidden');
      
      const scope = 'identify';
      const state = generateRandomState();
      
      const authUrl = new URL('https://discord.com/api/oauth2/authorize');
      authUrl.searchParams.set('client_id', DISCORD_CLIENT_ID);
      authUrl.searchParams.set('redirect_uri', DISCORD_REDIRECT_URI);
      authUrl.searchParams.set('response_type', 'code');
      authUrl.searchParams.set('scope', scope);
      authUrl.searchParams.set('state', state);
      
      localStorage.setItem('oauth_state', state);
      
      setTimeout(() => {
        window.location.href = authUrl.toString();
      }, 500);
    }

    function generateRandomState() {
      return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    }

    function resetLoginUI() {
      loginLoading.classList.add('hidden');
      discordLoginBtn.style.display = 'flex';
      manualLoginSection.classList.remove('hidden');
    }

    // OAuth Callback verarbeiten
    async function handleOAuthCallback() {
      console.log('Verarbeite OAuth Callback...');
      
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      const storedState = localStorage.getItem('oauth_state');
      const error = urlParams.get('error');
      
      console.log('URL Parameters:', { code: !!code, state, storedState, error });
      
      if (error) {
        console.error('Discord OAuth Error:', error);
        resetLoginUI();
        showError('Anmeldung abgebrochen: ' + error);
        return;
      }
      
      if (code && state && state === storedState) {
        try {
          console.log('Valider OAuth Callback gefunden');
          loginLoading.classList.remove('hidden');
          discordLoginBtn.style.display = 'none';
          
          const tokenResponse = await fetch(`${BACKEND_URL}/token`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              code: code,
              redirect_uri: DISCORD_REDIRECT_URI
            })
          });
          
          if (!tokenResponse.ok) {
            const errorText = await tokenResponse.text();
            console.error('Token Request failed:', tokenResponse.status, errorText);
            throw new Error(`Token request failed: ${tokenResponse.status}`);
          }
          
          const tokenData = await tokenResponse.json();
          console.log('Token Response:', tokenData);
          
          if (tokenData.error) {
            throw new Error(tokenData.error);
          }
          
          if (!tokenData.access_token) {
            throw new Error('Kein Access Token erhalten');
          }
          
          await verifyUser(tokenData.access_token);
          
        } catch (error) {
          console.error('OAuth Error:', error);
          resetLoginUI();
          showError('Fehler bei der Anmeldung: ' + error.message);
        } finally {
          localStorage.removeItem('oauth_state');
          const cleanUrl = window.location.origin + window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);
          console.log('URL bereinigt');
        }
      } else {
        console.log('Kein valider OAuth Callback');
        resetLoginUI();
        
        if (state && state !== storedState) {
          showError('Sicherheitsfehler: State-Parameter stimmt nicht √ºberein');
        }
      }
    }

    // User verifizieren
    async function verifyUser(accessToken) {
      try {
        console.log('Verifiziere Benutzer...');
        const currentPage = 'materialrecycler';
        
        const response = await fetch(`${BACKEND_URL}/verify-user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            accessToken,
            currentPage
          })
        });

        if (!response.ok) {
          throw new Error('Verification failed with status: ' + response.status);
        }

        const data = await response.json();
        console.log('Verification Response:', data);

        if (data.isAuthorized) {
          console.log('Benutzer autorisiert!');
          localStorage.setItem('discord_user', JSON.stringify(data.user));
          localStorage.setItem('discord_access_token', accessToken);
          localStorage.setItem('user_access_info', JSON.stringify(data.accessInfo || {}));
          
          const user = data.user;
          userAccessInfo = data.accessInfo;
          
          currentUser = {
            id: user.id,
            username: user.username,
            ...userAccessInfo
          };
          
          await loadDiscordAvatar(user);
          
          if (data.hasPageAccess) {
            showAuthorizedContent(currentUser);
            showNotification(`Erfolgreich als ${user.username} angemeldet`, 'success');
          } else {
            showAccessRestricted(currentUser, currentPage);
          }
        } else {
          let errorMsg = 'Zugriff verweigert. ';
          if (data.accessInfo && data.accessInfo.message === 'access expired') {
            errorMsg += 'Dein Zugang ist abgelaufen.';
          } else if (data.accessInfo && data.accessInfo.message === 'not in authorized list') {
            errorMsg += 'Du bist nicht in der Liste der autorisierten Benutzer.';
          } else {
            errorMsg += 'Du bist nicht autorisiert.';
          }
          resetLoginUI();
          showError(errorMsg);
        }
      } catch (error) {
        console.error('Fehler bei der Benutzer√ºberpr√ºfung:', error);
        resetLoginUI();
        showError('Fehler bei der Berechtigungspr√ºfung: ' + error.message);
        
        // Fallback: Manuellen Login anbieten
        manualLoginSection.classList.remove('hidden');
      }
    }

    // Discord Avatar laden
    async function loadDiscordAvatar(userData) {
      if (userData.avatar) {
        const avatarUrl = `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png?size=256`;
        
        const userAvatar = document.getElementById('userAvatar');
        if (userAvatar) {
          userAvatar.style.backgroundImage = `url('${avatarUrl}')`;
          userAvatar.innerHTML = '';
        }
      } else {
        const userAvatar = document.getElementById('userAvatar');
        if (userAvatar) {
          const firstLetter = userData.username.charAt(0).toUpperCase();
          userAvatar.innerHTML = `<span>${firstLetter}</span>`;
        }
      }
    }

    // Zugriff verweigert anzeigen
    function showAccessRestricted(user, pageKey) {
      loginScreen.classList.add('hidden');
      mainContent.classList.add('hidden');
      accessRestricted.classList.remove('hidden');
      
      document.getElementById('restrictedUserName').textContent = user.username;
      document.getElementById('restrictedPageName').textContent = getPageDisplayName(pageKey);
      showNotification(`Zugriff verweigert - ${user.username} hat keinen Zugriff auf diese Seite`, 'error');
    }

    // Login-Seite anzeigen
    function showLoginPage() {
      loginScreen.classList.remove('hidden');
      mainContent.classList.add('hidden');
      accessRestricted.classList.add('hidden');
    }

    // Autorisierten Inhalt anzeigen
    function showAuthorizedContent(user) {
      loginScreen.classList.add('hidden');
      mainContent.classList.remove('hidden');
      accessRestricted.classList.add('hidden');
      
      usernameElement.textContent = user.username;
      
      if (userAccessInfo && userAccessInfo.message && !user.isManual) {
        accessBadge.classList.remove('hidden');
        if (userAccessInfo.isPermanent) {
          accessBadge.textContent = 'Permanent';
          accessBadge.className = 'access-badge access-permanent';
        } else {
          accessBadge.textContent = userAccessInfo.message || 'Temporary';
          accessBadge.className = 'access-badge access-temporary';
        }
      } else if (user.isManual) {
        accessBadge.classList.remove('hidden');
        accessBadge.textContent = 'Manuell';
        accessBadge.className = 'access-badge access-temporary';
      } else {
        accessBadge.classList.add('hidden');
      }
      
      // Setze URL zur√ºck ohne Code-Parameter
      const cleanUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
      
      loadProducts();
      loadGlobalLogo();
    }

    // Logout
    function logout() {
      currentUser = null;
      userAccessInfo = null;
      localStorage.removeItem('discord_user');
      localStorage.removeItem('discord_access_token');
      localStorage.removeItem('user_access_info');
      localStorage.removeItem('manual_user');
      
      const userAvatar = document.getElementById('userAvatar');
      if (userAvatar) {
        userAvatar.style.backgroundImage = '';
        userAvatar.innerHTML = '<i class="fas fa-user"></i>';
      }
      
      showLoginPage();
      accessBadge.classList.add('hidden');
      
      showNotification('Erfolgreich ausgeloggt', 'info');
    }

    // Session pr√ºfen
    async function checkExistingLogin() {
      // Zuerst manuellen Benutzer pr√ºfen
      const manualUser = localStorage.getItem('manual_user');
      if (manualUser) {
        try {
          const userData = JSON.parse(manualUser);
          currentUser = userData;
          showAuthorizedContent(currentUser);
          showNotification(`Willkommen zur√ºck, ${userData.username}`, 'info');
          return;
        } catch (e) {
          console.error('Fehler beim Laden manueller Benutzerdaten:', e);
        }
      }
      
      // Dann Discord Benutzer pr√ºfen
      const user = localStorage.getItem('discord_user');
      const token = localStorage.getItem('discord_access_token');
      const accessInfo = localStorage.getItem('user_access_info');
      
      console.log('Check existing login:', { user: !!user, token: !!token });
      
      if (user && token) {
        try {
          console.log('Bereits eingeloggt');
          const userData = JSON.parse(user);
          userAccessInfo = accessInfo ? JSON.parse(accessInfo) : null;
          
          const currentPage = 'materialrecycler';
          const response = await fetch(`${BACKEND_URL}/verify-user`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
              accessToken: token,
              currentPage
            })
          });

          if (response.ok) {
            const data = await response.json();
            
            if (data.isAuthorized) {
              currentUser = {
                id: userData.id,
                username: userData.username,
                ...userAccessInfo
              };
              
              await loadDiscordAvatar(userData);
              
              if (data.hasPageAccess) {
                showAuthorizedContent(currentUser);
                showNotification(`Willkommen zur√ºck, ${userData.username}`, 'info');
              } else {
                showAccessRestricted(currentUser, currentPage);
              }
              return;
            }
          }
        } catch (e) {
          console.error('Fehler beim Laden der Discord Benutzerdaten:', e);
        }
      }
      
      showLoginPage();
      manualLoginSection.classList.remove('hidden');
    }

    function showError(message) {
      errorMessage.textContent = message;
      loginError.classList.remove('hidden');
    }

    // ========== EVENT LISTENER ==========

    function initializeEventListeners() {
      // Login Button
      discordLoginBtn.addEventListener('click', startDiscordOAuth);
      
      // Logout Button
      logoutBtn.addEventListener('click', logout);
      
      // Tab Navigation
      document.getElementById('btnDashboard').addEventListener('click', () => switchTab('dashboard'));
      document.getElementById('btnRecycler').addEventListener('click', () => switchTab('recycler'));
      
      // Hamburger Menu
      document.getElementById('hamburgerBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('hamburgerMenu').classList.toggle('hidden');
      });

      // Close hamburger menu when clicking outside
      document.addEventListener('click', (e) => {
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        
        if (hamburgerMenu && hamburgerBtn && !hamburgerMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
          hamburgerMenu.classList.add('hidden');
        }
      });

      // Navigation zu anderen Seiten
      document.querySelectorAll('.card[data-page]').forEach(card => {
        card.addEventListener('click', function() {
          const page = this.getAttribute('data-page');
          navigateToWithAccessCheck(page);
        });
      });

      // Materialrecycler Event Listeners
      initializeRecyclerListeners();
    }

    // Tab wechseln Funktion
    function switchTab(tabName) {
      // Tabs deaktivieren
      document.querySelectorAll('[id$="Section"]').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      // Gew√§hlten Tab aktivieren
      document.getElementById(`${tabName}Section`).classList.remove('hidden');
      
      // Button States aktualisieren
      updateButtonStates(tabName);
    }

    function updateButtonStates(activeButton) {
      const buttons = {
        dashboard: document.getElementById('btnDashboard'),
        recycler: document.getElementById('btnRecycler')
      };
      
      Object.values(buttons).forEach(btn => {
        if (btn) {
          btn.classList.remove('pulse-glow', 'bg-red-600', 'bg-blue-600');
          btn.classList.add('bg-gray-700');
        }
      });
      
      if (buttons[activeButton]) {
        buttons[activeButton].classList.remove('bg-gray-700');
        if (activeButton === 'dashboard') {
          buttons[activeButton].classList.add('bg-red-600', 'pulse-glow');
        } else if (activeButton === 'recycler') {
          buttons[activeButton].classList.add('bg-blue-600');
        }
      }
    }

    // ========== RECYCLER FUNKTIONEN ==========

    function initializeRecyclerListeners() {
      // Admin Login
      const adminLoginBtn = document.getElementById('adminLoginBtn');
      const adminPassInput = document.getElementById('adminPass');
      const adminError = document.getElementById('adminError');
      
      if (adminLoginBtn) {
        adminLoginBtn.addEventListener('click', function() {
          const password = adminPassInput.value;
          if (password === ADMIN_PASSWORD) {
            document.getElementById('adminContent').classList.remove('hidden');
            document.getElementById('adminLoginSection').classList.add('hidden');
            showNotification('Admin-Bereich erfolgreich betreten', 'success');
          } else {
            adminError.classList.remove('hidden');
          }
        });
      }

      // Produkt hinzuf√ºgen Button
      const addProductBtn = document.getElementById('addProductBtn');
      if (addProductBtn) {
        addProductBtn.addEventListener('click', function() {
          openProductModal();
        });
      }

      // Ressource hinzuf√ºgen
      const addResourceBtn = document.getElementById('addResourceBtn');
      if (addResourceBtn) {
        addResourceBtn.addEventListener('click', function() {
          addResource();
        });
      }

      // Produkt Formular
      const productForm = document.getElementById('productForm');
      if (productForm) {
        productForm.addEventListener('submit', function(e) {
          e.preventDefault();
          saveProduct();
        });
      }

      // Produkt Bild Upload
      const productImageFile = document.getElementById('productImageFile');
      if (productImageFile) {
        productImageFile.addEventListener('change', function(e) {
          handleImageUpload(e);
        });
      }

      // Modal schlie√üen
      const cancelProduct = document.getElementById('cancelProduct');
      if (cancelProduct) {
        cancelProduct.addEventListener('click', function() {
          document.getElementById('productModal').classList.add('hidden');
        });
      }

      // Suche
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', function(e) {
          filterProducts(e.target.value);
        });
      }

      const adminSearchInput = document.getElementById('adminSearchInput');
      if (adminSearchInput) {
        adminSearchInput.addEventListener('input', function(e) {
          filterAdminProducts(e.target.value);
        });
      }
    }

    // Produkte laden
    function loadProducts() {
      onValue(productsRef, (snapshot) => {
        products = [];
        snapshot.forEach((childSnapshot) => {
          const product = childSnapshot.val();
          product.key = childSnapshot.key;
          products.push(product);
        });
        filteredProducts = [...products];
        renderProducts();
        renderAdminTable();
      });
    }

    // Produkte rendern
    function renderProducts() {
      const productsGrid = document.getElementById('productsGrid');
      if (!productsGrid) return;
      
      productsGrid.innerHTML = '';
      
      if (filteredProducts.length === 0) {
        productsGrid.innerHTML = `
          <div class="text-center py-8 text-gray-500 col-span-full">
            <i class="fas fa-box-open text-4xl mb-2"></i>
            <p>Keine Produkte gefunden</p>
          </div>
        `;
        return;
      }
      
      filteredProducts.forEach(product => {
        const productElement = createProductElement(product);
        productsGrid.appendChild(productElement);
      });
    }

    // Produkt-Element erstellen
    function createProductElement(product) {
      const div = document.createElement('div');
      div.className = 'product-item';
      div.innerHTML = `
        <div class="product-card">
          ${product.image ? 
            `<img src="${product.image}" alt="${product.name}" class="product-image">` : 
            `<div style="width: 100px; height: 100px; background: rgba(220, 38, 38, 0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #dc2626;">
              <i class="fas fa-box" style="font-size: 2rem;"></i>
            </div>`
          }
          <div>
            <h4 style="color: #fbbf24; margin-bottom: 0.5rem; font-size: 1.2rem;">${product.name}</h4>
            <div class="resource-list">
              ${product.resources ? Object.entries(product.resources).map(([name, range]) => 
                `<span class="resource-tag">${name}: ${range.min}-${range.max}</span>`
              ).join('') : ''}
            </div>
            <div class="calculator-section">
              <div class="calculator-title">
                <i class="fas fa-calculator"></i> Rechner
              </div>
              <div class="quantity-controls">
                <button class="quantity-btn" onclick="changeQuantity(this, -1)">-</button>
                <input type="number" class="quantity-input" value="1" min="1" onchange="calculateResources(this, '${product.key}')">
                <button class="quantity-btn" onclick="changeQuantity(this, 1)">+</button>
              </div>
              <div id="results-${product.key}" class="results-container">
                <!-- Ergebnisse werden hier dynamisch eingef√ºgt -->
              </div>
            </div>
          </div>
        </div>
      `;
      return div;
    }

    // Admin-Tabelle rendern
    function renderAdminTable() {
      const adminTableBody = document.getElementById('adminTableBody');
      const totalProducts = document.getElementById('totalProducts');
      
      if (!adminTableBody) return;
      
      adminTableBody.innerHTML = '';
      if (totalProducts) {
        totalProducts.textContent = products.length;
      }
      
      if (filteredProducts.length === 0) {
        adminTableBody.innerHTML = `
          <tr>
            <td colspan="3" class="p-4 text-center text-gray-500">Keine Produkte vorhanden</td>
          </tr>
        `;
        return;
      }
      
      filteredProducts.forEach(product => {
        const row = document.createElement('tr');
        row.className = 'border-t border-gray-800 hover:bg-gray-800/30 transition-colors';
        row.innerHTML = `
          <td class="p-3">${product.name}</td>
          <td class="p-3">
            ${product.resources ? Object.entries(product.resources).map(([name, range]) => 
              `${name}: ${range.min}-${range.max}`
            ).join(', ') : 'Keine Ressourcen'}
          </td>
          <td class="p-3">
            <div class="flex gap-2">
              <button class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-sm rounded-lg btn flex items-center gap-1 edit-product" data-key="${product.key}">
                <i class="fas fa-edit mr-1"></i>
                Bearbeiten
              </button>
              <button class="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-sm rounded-lg btn flex items-center gap-1 delete-product" data-key="${product.key}">
                <i class="fas fa-trash mr-1"></i>
                L√∂schen
              </button>
            </div>
          </td>`;
        adminTableBody.appendChild(row);
      });
      
      // Event Listener f√ºr Bearbeiten-Buttons
      document.querySelectorAll('.edit-product').forEach(btn => {
        btn.addEventListener('click', function() {
          const key = this.getAttribute('data-key');
          editProduct(key);
        });
      });
      
      // Event Listener f√ºr L√∂schen-Buttons
      document.querySelectorAll('.delete-product').forEach(btn => {
        btn.addEventListener('click', function() {
          const key = this.getAttribute('data-key');
          deleteProduct(key);
        });
      });
    }

    // Globales Logo laden
    function loadGlobalLogo() {
      getDownloadURL(logoImageRef)
        .then((url) => {
          const headerLogo = document.getElementById('headerLogo');
          if (headerLogo) {
            headerLogo.style.backgroundImage = `url('${url}')`;
            headerLogo.innerHTML = '';
          }
        })
        .catch((error) => {
          console.log('Kein custom Logo gefunden, verwende Standard-Logo');
        });
    }

    // Produkt Modal √∂ffnen
    function openProductModal() {
      const productKeyInput = document.getElementById('productKey');
      const productName = document.getElementById('productName');
      const productImageData = document.getElementById('productImageData');
      const imagePreview = document.getElementById('imagePreview');
      const resourcesList = document.getElementById('resourcesList');
      const productModalTitle = document.getElementById('productModalTitle');
      
      if (productKeyInput) productKeyInput.value = '';
      if (productName) productName.value = '';
      if (productImageData) productImageData.value = '';
      if (imagePreview) imagePreview.style.display = 'none';
      
      currentResources = [];
      if (resourcesList) resourcesList.innerHTML = '';
      
      if (productModalTitle) {
        productModalTitle.innerHTML = '<i class="fas fa-plus mr-2"></i> Produkt hinzuf√ºgen';
      }
      
      document.getElementById('productModal').classList.remove('hidden');
    }

    // Ressource hinzuf√ºgen
    function addResource() {
      const newResourceName = document.getElementById('newResourceName');
      const newResourceMin = document.getElementById('newResourceMin');
      const newResourceMax = document.getElementById('newResourceMax');
      
      if (!newResourceName || !newResourceMin || !newResourceMax) return;
      
      const name = newResourceName.value.trim();
      const min = parseInt(newResourceMin.value);
      const max = parseInt(newResourceMax.value);
      
      if (name && min && max && min > 0 && max >= min) {
        currentResources.push({ name, min, max });
        renderResourcesList();
        newResourceName.value = '';
        newResourceMin.value = '';
        newResourceMax.value = '';
      }
    }

    // Ressourcen Liste rendern
    function renderResourcesList() {
      const resourcesList = document.getElementById('resourcesList');
      if (!resourcesList) return;
      
      resourcesList.innerHTML = '';
      currentResources.forEach((resource, index) => {
        const resourceElement = document.createElement('div');
        resourceElement.className = 'resource-tag';
        resourceElement.innerHTML = `
          ${resource.name}: ${resource.min}-${resource.max}
          <button type="button" onclick="removeResource(${index})" style="background: none; border: none; color: #f56565; margin-left: 5px; cursor: pointer;">
            <i class="fas fa-times"></i>
          </button>
        `;
        resourcesList.appendChild(resourceElement);
      });
    }

    // Ressource entfernen
    function removeResource(index) {
      currentResources.splice(index, 1);
      renderResourcesList();
    }

    // Bild Upload behandeln
    function handleImageUpload(e) {
      const file = e.target.files[0];
      const imagePreview = document.getElementById('imagePreview');
      const productImageData = document.getElementById('productImageData');
      
      if (!file || !imagePreview || !productImageData) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreview.style.display = 'block';
        productImageData.value = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Produkt speichern
    async function saveProduct() {
      const productName = document.getElementById('productName');
      const productKeyInput = document.getElementById('productKey');
      const productImageData = document.getElementById('productImageData');
      
      if (!productName || !productKeyInput) return;
      
      const productData = {
        name: productName.value,
        resources: {},
        image: productImageData ? productImageData.value : ''
      };
      
      currentResources.forEach(resource => {
        productData.resources[resource.name] = {
          min: resource.min,
          max: resource.max
        };
      });
      
      const productKey = productKeyInput.value;
      
      try {
        if (productKey) {
          // Produkt aktualisieren
          const productRef = ref(db, `materialrecycler/products/${productKey}`);
          await update(productRef, productData);
        } else {
          // Neues Produkt hinzuf√ºgen
          await push(productsRef, productData);
        }
        
        document.getElementById('productModal').classList.add('hidden');
        showNotification(`Produkt erfolgreich ${productKey ? 'aktualisiert' : 'hinzugef√ºgt'}`, 'success');
      } catch (error) {
        console.error('Fehler beim Speichern:', error);
        showNotification(`Fehler beim ${productKey ? 'Aktualisieren' : 'Speichern'} des Produkts!`, 'error');
      }
    }

    // Produkt bearbeiten
    function editProduct(productKey) {
      const product = products.find(p => p.key === productKey);
      if (!product) return;
      
      const productKeyInput = document.getElementById('productKey');
      const productName = document.getElementById('productName');
      const productImageData = document.getElementById('productImageData');
      const imagePreview = document.getElementById('imagePreview');
      
      if (productKeyInput) productKeyInput.value = productKey;
      if (productName) productName.value = product.name;
      if (productImageData) productImageData.value = product.image || '';
      
      // Bild-Vorschau
      if (product.image && imagePreview) {
        imagePreview.src = product.image;
        imagePreview.style.display = 'block';
      } else if (imagePreview) {
        imagePreview.style.display = 'none';
      }
      
      // Ressourcen zur√ºcksetzen und neu laden
      currentResources = [];
      if (product.resources) {
        Object.entries(product.resources).forEach(([name, range]) => {
          currentResources.push({ name, min: range.min, max: range.max });
        });
      }
      renderResourcesList();
      
      const productModalTitle = document.getElementById('productModalTitle');
      if (productModalTitle) {
        productModalTitle.innerHTML = '<i class="fas fa-edit mr-2"></i> Produkt bearbeiten';
      }
      
      document.getElementById('productModal').classList.remove('hidden');
    }

    // Produkt l√∂schen
    async function deleteProduct(productKey) {
      if (confirm('Sind Sie sicher, dass Sie dieses Produkt l√∂schen m√∂chten?')) {
        try {
          const productRef = ref(db, `materialrecycler/products/${productKey}`);
          await remove(productRef);
          showNotification('Produkt erfolgreich gel√∂scht', 'success');
        } catch (error) {
          console.error('Fehler beim L√∂schen:', error);
          showNotification('Fehler beim L√∂schen des Produkts', 'error');
        }
      }
    }

    // Produkte filtern
    function filterProducts(searchTerm) {
      searchTerm = searchTerm.toLowerCase();
      filteredProducts = products.filter(product => 
        product.name.toLowerCase().includes(searchTerm) ||
        (product.resources && Object.keys(product.resources).some(resource => 
          resource.toLowerCase().includes(searchTerm)
        ))
      );
      renderProducts();
    }

    // Admin Produkte filtern
    function filterAdminProducts(searchTerm) {
      searchTerm = searchTerm.toLowerCase();
      filteredProducts = products.filter(product => 
        product.name.toLowerCase().includes(searchTerm) ||
        (product.resources && Object.keys(product.resources).some(resource => 
          resource.toLowerCase().includes(searchTerm)
        ))
      );
      renderAdminTable();
    }

    // Rechner Funktionen
    function changeQuantity(button, change) {
      const input = button.parentElement.querySelector('.quantity-input');
      let value = parseInt(input.value) + change;
      if (value < 1) value = 1;
      input.value = value;
      
      const productKey = input.getAttribute('onchange').split("'")[1];
      calculateResources(input, productKey);
    }

    function calculateResources(input, productKey) {
      const quantity = parseInt(input.value);
      const product = products.find(p => p.key === productKey);
      if (!product || !product.resources) return;
      
      const resultsContainer = document.getElementById(`results-${productKey}`);
      if (!resultsContainer) return;
      
      resultsContainer.innerHTML = '';
      
      Object.entries(product.resources).forEach(([resourceName, range]) => {
        const minTotal = range.min * quantity;
        const maxTotal = range.max * quantity;
        
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.innerHTML = `
          <span>${resourceName}</span>
          <span class="result-range">${minTotal} - ${maxTotal}</span>
        `;
        resultsContainer.appendChild(resultItem);
      });
    }

    // ========== INITIALISIERUNG ==========

    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM geladen - Initialisiere App...');
      initializeEventListeners();
      
      // Zuerst OAuth Callback pr√ºfen
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('code') || urlParams.get('error')) {
        console.log('OAuth Callback gefunden, verarbeite...');
        handleOAuthCallback();
      } else {
        // Dann bestehende Session pr√ºfen
        console.log('Kein OAuth Callback, pr√ºfe bestehende Session...');
        checkExistingLogin();
      }
    });

    // Globale Funktionen f√ºr onclick Events
    window.changeQuantity = changeQuantity;
    window.calculateResources = calculateResources;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.removeResource = removeResource;
    window.manualLogin = manualLogin;
    window.logout = logout;

    console.log('Materialrecycler Panel - Mit verbessertem Login-System!');
  </script>
</body>
</html>

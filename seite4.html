<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bullet Farm v2 ‚Äî Shop</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root {
  --bg: #0f1724;
  --card: #0b1220;
  --muted: #9ca3af;
  --accent: #06b6d4;
}

body {
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
  background: #071025;
  color: #e6eef8;
  margin: 0;
  line-height: 1.5;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 12px;
}

.card {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: 12px;
  padding: 16px;
}

.shadow-soft {
  box-shadow: 0 8px 30px rgba(2,6,23,0.6);
}

.small-muted {
  color: var(--muted);
  font-size: 0.85rem;
  margin-top: 4px;
}

.btn {
  transition: all 0.12s ease;
  border-radius: 8px;
  padding: 0.45rem 0.8rem;
  cursor: pointer;
  background: #111827;
  color: #e6eef8;
  border: 1px solid rgba(255,255,255,0.03);
  font-size: 0.9rem;
  white-space: nowrap;
}

.btn:hover {
  transform: translateY(-2px);
  background: #1f2937;
}

.hidden-el {
  display: none !important;
}

.product-image {
  width: 100%;
  height: 130px;
  object-fit: cover;
  border-radius: 8px;
}

.product-image-admin {
  width: 80px;
  height: 50px;
  object-fit: cover;
  border-radius: 6px;
}

#productsGrid .card {
  margin: 0 auto;
  transition: transform 0.2s ease;
}

#productsGrid .card:hover {
  transform: translateY(-4px);
}

.modal-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(4,6,11,0.6);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.22s ease;
  z-index: 80;
  backdrop-filter: blur(4px);
  padding: 12px;
}

.modal-overlay.active {
  opacity: 1;
  pointer-events: all;
}

.modal-box {
  width: 100%;
  max-width: 980px;
  background: linear-gradient(180deg, #0b1220, #0f1724);
  border-radius: 12px;
  padding: 16px;
  border: 1px solid rgba(255,255,255,0.04);
  box-shadow: 0 20px 60px rgba(2,6,23,0.7);
  transform: translateY(-8px);
  transition: transform 0.22s ease;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-overlay.active .modal-box {
  transform: translateY(0);
}

.tab-btn {
  padding: 8px 12px;
  border-radius: 8px;
  background: rgba(255,255,255,0.02);
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid transparent;
  font-size: 0.85rem;
  white-space: nowrap;
}

.tab-btn.active {
  background: linear-gradient(90deg, #94a3b8, #06b6d4);
  color: #041628;
  font-weight: 700;
}

.tab-btn:hover:not(.active) {
  background: rgba(255,255,255,0.05);
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table th, .table td {
  padding: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  text-align: left;
  font-size: 0.92rem;
}

.kv {
  font-size: 0.9rem;
  color: var(--muted);
}

.category-item {
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: space-between;
  padding: 8px;
  background: rgba(255,255,255,0.02);
  border-radius: 8px;
  margin-bottom: 6px;
  transition: background 0.2s ease;
}

.category-item:hover {
  background: rgba(255,255,255,0.04);
}

.input, textarea, select {
  background: #071224;
  border: 1px solid rgba(255,255,255,0.04);
  color: #e6eef8;
  padding: 0.5rem;
  border-radius: 8px;
  width: 100%;
  transition: border-color 0.2s ease;
  font-size: 16px; /* Verhindert Zoom auf iOS */
}

.input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: rgba(6, 182, 212, 0.3);
}

.color-input {
  width: 48px;
  height: 36px;
  padding: 0;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.04);
  background: #fff;
  cursor: pointer;
}

.small-btn {
  padding: 0.35rem 0.6rem;
  border-radius: 6px;
  font-size: 0.8rem;
}

.flex-row {
  display: flex;
  gap: 8px;
  align-items: center;
}

.right {
  margin-left: auto;
}

.success { color: #10b981; }
.warning { color: #f59e0b; }
.error { color: #ef4444; }

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

.fade-in {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Neue Styles f√ºr die zweispaltige Bestellungsansicht */
.orders-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-top: 16px;
}

.orders-column {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.orders-column h5 {
  margin: 0 0 8px 0;
  font-weight: 700;
  color: #94a3b8;
}

.user-order-item {
  background: rgba(255,255,255,0.02);
  border-radius: 8px;
  padding: 12px;
  border: 1px solid rgba(255,255,255,0.03);
  cursor: pointer;
  transition: all 0.2s ease;
}

.user-order-item:hover {
  background: rgba(255,255,255,0.04);
  transform: translateY(-2px);
}

.user-order-item.active {
  background: rgba(6, 182, 212, 0.1);
  border-color: rgba(6, 182, 212, 0.3);
}

.user-orders-list {
  max-height: 50vh;
  overflow-y: auto;
}

.order-details-container {
  max-height: 50vh;
  overflow-y: auto;
}

/* Mobile Styles */
@media (max-width: 768px) {
  .container {
    padding: 8px;
  }
  
  .card {
    padding: 12px;
  }
  
  .modal-box {
    padding: 12px;
    margin: 8px;
  }
  
  /* Header mobile optimieren */
  header.card {
    flex-direction: column;
    gap: 12px;
    text-align: center;
  }
  
  header .flex.items-center.gap-4 {
    justify-content: center;
  }
  
  /* Produkt Grid f√ºr Mobile - WICHTIG: Einspaltig f√ºr bessere Lesbarkeit */
  .grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  #productsGrid .card {
    max-width: none;
    margin: 0;
  }
  
  .product-image {
    height: 120px;
  }
  
  /* Produktkarten-Inhalt f√ºr Mobile optimieren */
  .product-card-content {
    padding: 8px 0;
  }
  
  .product-title {
    font-size: 1.1rem;
    line-height: 1.3;
    margin-bottom: 6px;
  }
  
  .product-description {
    font-size: 0.85rem;
    line-height: 1.4;
    margin-bottom: 8px;
  }
  
  /* Ressourcen-Tabelle f√ºr Mobile optimieren */
  .resource-table {
    font-size: 0.8rem;
  }
  
  .resource-table td {
    padding: 4px 6px;
  }
  
  /* Tabs f√ºr Mobile */
  .flex.gap-2 {
    flex-wrap: wrap;
    gap: 6px;
  }
  
  .tab-btn {
    padding: 6px 10px;
    font-size: 0.8rem;
    flex: 1;
    min-width: 0;
    text-align: center;
  }
  
  /* Tabellen f√ºr Mobile */
  .table-container {
    overflow-x: auto;
  }
  
  .table {
    font-size: 0.8rem;
    min-width: 500px;
  }
  
  .table th, .table td {
    padding: 6px 4px;
  }
  
  /* Formulare f√ºr Mobile */
  .flex.items-center.gap-2 {
    flex-wrap: wrap;
  }
  
  .btn {
    padding: 0.4rem 0.7rem;
    font-size: 0.85rem;
  }
  
  /* Bestellungen Layout f√ºr Mobile */
  .orders-layout {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .orders-column {
    gap: 8px;
  }
  
  /* Produkt Formular f√ºr Mobile */
  .product-form-grid {
    grid-template-columns: 1fr !important;
    gap: 8px !important;
  }
  
  .color-inputs {
    flex-wrap: wrap;
    gap: 6px !important;
  }
  
  .color-inputs label {
    min-width: 80px;
  }
  
  /* Shop Filter f√ºr Mobile */
  .shop-header {
    flex-direction: column;
    gap: 10px;
    align-items: flex-start !important;
  }
  
  .shop-filter {
    width: 100% !important;
  }
  
  /* Warenkorb f√ºr Mobile */
  #cartTable {
    min-width: 400px;
  }
  
  /* Admin Buttons f√ºr Mobile */
  .admin-actions {
    flex-direction: column;
    gap: 8px;
  }
  
  .admin-actions .btn {
    width: 100%;
  }
  
  /* Produkt-Text f√ºr Mobile optimieren */
  .product-text-content {
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  
  .product-name {
    font-size: 1.1rem;
    line-height: 1.3;
    word-break: break-word;
  }
  
  .product-category {
    font-size: 0.8rem;
    margin-top: 6px;
  }
}

@media (max-width: 480px) {
  .grid {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  .product-image {
    height: 100px;
  }
  
  .btn {
    padding: 0.35rem 0.6rem;
    font-size: 0.8rem;
  }
  
  .tab-btn {
    padding: 5px 8px;
    font-size: 0.75rem;
  }
  
  .container {
    padding: 6px;
  }
  
  .card {
    padding: 10px;
  }
  
  .product-title {
    font-size: 1rem;
  }
  
  .product-description {
    font-size: 0.8rem;
  }
}

/* Gr√∂√üere Screens */
@media (min-width: 769px) {
  .grid {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
  }
  
  #productsGrid .card:hover {
    transform: translateY(-4px);
  }
  
  .category-item:hover {
    background: rgba(255,255,255,0.04);
  }
  
  .user-order-item:hover {
    background: rgba(255,255,255,0.04);
    transform: translateY(-2px);
  }
}

/* Touch Device Optimierungen */
@media (hover: none) {
  .btn:hover {
    transform: none;
    background: #111827;
  }
  
  #productsGrid .card:hover {
    transform: none;
  }
  
  .category-item:hover {
    background: rgba(255,255,255,0.02);
  }
  
  .user-order-item:hover {
    background: rgba(255,255,255,0.02);
    transform: none;
  }
}

/* Zus√§tzliche Mobile-Optimierungen f√ºr Produktkarten */
.product-card {
  display: flex;
  flex-direction: column;
  height: auto;
  min-height: 0;
}

.product-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.product-resources {
  flex-shrink: 0;
  margin-top: auto;
}

.mobile-optimized-text {
  word-break: break-word;
  overflow-wrap: break-word;
  hyphens: auto;
}
</style>
</head>
<body>
  <div class="container">
    <header class="card shadow-soft mb-6 flex items-center justify-between fade-in">
      <div class="flex items-center gap-4">
        <img id="headerLogo" src="https://via.placeholder.com/48" alt="Logo" style="width:48px;height:48px;object-fit:cover;border-radius:8px">
        <div>
          <h1 id="pageTitle" style="font-size:1.4rem;font-weight:700;color:#22c55e;margin:0" class="mobile-optimized-text">Bullet Farm v2</h1>
          <div class="small-muted">Shop</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnShop" class="btn">Shop</button>
        <button id="btnCart" class="btn">Warenkorb</button>
        <button id="openSettingsBtn" class="btn">‚öôÔ∏è</button>
      </div>
    </header>

    <main id="mainContent">
      <section id="shopView" class="card mb-6 fade-in">
        <div class="shop-header flex items-center justify-between mb-4">
          <div class="flex items-center gap-3" style="flex-wrap: wrap;">
            <h2 style="font-weight:700;color:#22c55e;margin:0" class="mobile-optimized-text">üõí Produkte</h2>
            <div class="kv" style="white-space: nowrap;">Filter:</div>
            <select id="shopCategoryFilter" class="input shop-filter" style="width:200px; min-width: 150px;">
              <option value="">‚Äî Alle Kategorien ‚Äî</option>
            </select>
          </div>
          <div class="kv" id="productsCount" style="white-space: nowrap;">Produkte anzeigen</div>
        </div>
        <div id="productsGrid" class="grid"></div>
      </section>

      <section id="cartView" class="card mb-6 hidden-el fade-in">
        <div class="flex items-center justify-between mb-4">
          <h2 style="font-weight:700;color:#22c55e" class="mobile-optimized-text">üõçÔ∏è Warenkorb</h2>
          <div class="kv">Ressourcen & Anzahl</div>
        </div>
        <div class="table-container">
          <table class="table" id="cartTable">
            <thead>
              <tr>
                <th>Produkt</th>
                <th>Ressourcen</th>
                <th style="text-align:right">Anzahl</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:12px;font-weight:700" id="cartSummary">Gesamt Ressourcen: keine</div>
      </section>
    </main>
  </div>

  <!-- Der Rest des Modal-Codes bleibt gleich wie vorher -->
  <div id="settingsModal" class="modal-overlay hidden-el" aria-hidden="true">
    <div class="modal-box">
      <!-- ... Modal Inhalt unver√§ndert ... -->
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

/* ---------- Firebase Config ---------- */
const firebaseConfig = { 
  apiKey: "AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
  authDomain: "khusland-b7d13.firebaseapp.com",
  databaseURL: "https://khusland-b7d13-default-rtdb.firebaseio.com",
  projectId: "khusland-b7d13",
  storageBucket: "khusland-b7d13.firebasestorage.app",
  messagingSenderId: "69573193613",
  appId: "1:69573193613:web:86c4d839281b1e343cd7c4",
  measurementId: "G-JSCWR4207G"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productsRef = ref(db, 'products');
const settingsRef = ref(db, 'settings');
const categoriesRef = ref(db, 'categories');
const ordersRef = ref(db, 'orders');

/* ---------- Globale Variablen ---------- */
const ADMIN_PASSWORD = 'admin123';

// DOM Elemente
const elements = {
  openSettingsBtn: document.getElementById('openSettingsBtn'),
  settingsModal: document.getElementById('settingsModal'),
  settingsCloseBtn: document.getElementById('settingsCloseBtn'),
  settingsPassword: document.getElementById('settingsPassword'),
  settingsUnlockBtn: document.getElementById('settingsUnlockBtn'),
  settingsLoginError: document.getElementById('settingsLoginError'),
  settingsLoginArea: document.getElementById('settingsLoginArea'),
  settingsEditor: document.getElementById('settingsEditor'),
  tabBtns: document.querySelectorAll('.tab-btn'),
  tabPanels: document.querySelectorAll('.tab-panel'),
  btnNewProduct: document.getElementById('btnNewProduct'),
  productFormCard: document.getElementById('productFormCard'),
  productForm: document.getElementById('productForm'),
  cancelProductBtn: document.getElementById('cancelProductBtn'),
  prodId: document.getElementById('prodId'),
  prodName: document.getElementById('prodName'),
  prodImg: document.getElementById('prodImg'),
  prodPreview: document.getElementById('prodPreview'),
  prodDesc: document.getElementById('prodDesc'),
  prodCategorySelect: document.getElementById('prodCategorySelect'),
  colorNameInput: document.getElementById('colorNameInput'),
  colorQuantityInput: document.getElementById('colorQuantityInput'),
  addResourceBtn: document.getElementById('addResourceBtn'),
  resourceTable: document.querySelector('#resourceTable tbody'),
  productsTableBody: document.getElementById('productsTableBody'),
  btnReloadProducts: document.getElementById('btnReloadProducts'),
  settingTitle: document.getElementById('settingTitle'),
  settingHeaderImage: document.getElementById('settingHeaderImage'),
  saveGeneralBtn: document.getElementById('saveGeneralBtn'),
  resetGeneralBtn: document.getElementById('resetGeneralBtn'),
  pageTitle: document.getElementById('pageTitle'),
  headerLogo: document.getElementById('headerLogo'),
  productsGrid: document.getElementById('productsGrid'),
  shopView: document.getElementById('shopView'),
  cartView: document.getElementById('cartView'),
  btnShop: document.getElementById('btnShop'),
  btnCart: document.getElementById('btnCart'),
  cartTableBody: document.querySelector('#cartTable tbody'),
  cartSummary: document.getElementById('cartSummary'),
  shopCategoryFilter: document.getElementById('shopCategoryFilter'),
  newCategoryInput: document.getElementById('newCategoryInput'),
  addCategoryBtn: document.getElementById('addCategoryBtn'),
  categoriesList: document.getElementById('categoriesList'),
  orderCodeInput: document.getElementById('orderCodeInput'),
  loadOrderBtn: document.getElementById('loadOrderBtn'),
  orderDetails: document.getElementById('orderDetails'),
  orderItems: document.getElementById('orderItems'),
  orderUserName: document.getElementById('orderUserName'),
  orderPhone: document.getElementById('orderPhone'),
  saveOrderUserBtn: document.getElementById('saveOrderUserBtn'),
  markOrderResetBtn: document.getElementById('markOrderResetBtn'),
  ordersList: document.getElementById('ordersList'),
  productsCount: document.getElementById('productsCount'),
  usersList: document.getElementById('usersList'),
  userOrdersDetails: document.getElementById('userOrdersDetails')
};

let products = [];
let settings = { title: 'Bullet Farm', headerImage: 'https://via.placeholder.com/48', categories: [] };
let categories = [];
let cart = [];
let allOrders = [];
let saveOrderBtnEl = null;
let orderCodeDisplayEl = null;
let selectedUserId = null;

/* ---------- Modal Funktionen ---------- */
function showModal() { 
  elements.settingsModal.classList.remove('hidden-el'); 
  setTimeout(() => elements.settingsModal.classList.add('active'), 10); 
  document.body.style.overflow = 'hidden'; 
}

function hideModal() { 
  elements.settingsModal.classList.remove('active'); 
  document.body.style.overflow = ''; 
  setTimeout(() => elements.settingsModal.classList.add('hidden-el'), 240); 
}

/* ---------- Event Listener ---------- */
elements.openSettingsBtn.addEventListener('click', () => {
  elements.settingsPassword.value = '';
  elements.settingsLoginError.style.display = 'none';
  elements.settingsLoginArea.style.display = '';
  elements.settingsEditor.classList.add('hidden-el');
  showModal();
});

elements.settingsCloseBtn.addEventListener('click', hideModal);
elements.settingsModal.addEventListener('click', (e) => { 
  if(e.target === elements.settingsModal) hideModal(); 
});

document.addEventListener('keydown', (e) => { 
  if(e.key === 'Escape' && !elements.settingsModal.classList.contains('hidden-el')) hideModal(); 
});

// Tab Navigation
elements.tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    elements.tabBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const tabName = btn.dataset.tab;
    elements.tabPanels.forEach(p => p.classList.add('hidden-el'));
    document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.remove('hidden-el');
    
    // Wenn Nutzer-Tab ausgew√§hlt wird, Nutzerliste aktualisieren
    if (tabName === 'users') {
      renderUsersList();
    }
  });
});

/* ---------- Einstellungen ---------- */
onValue(settingsRef, snapshot => {
  const val = snapshot.val();
  if(val){
    settings.title = val.title || settings.title;
    settings.headerImage = val.headerImage || settings.headerImage;
  }
  applySettings();
});

function applySettings(){
  elements.pageTitle.innerText = settings.title || 'Bullet Farm';
  elements.headerLogo.src = settings.headerImage || 'https://via.placeholder.com/48';
  if(elements.settingTitle) elements.settingTitle.value = settings.title || '';
  if(elements.settingHeaderImage) elements.settingHeaderImage.value = settings.headerImage || '';
}

elements.saveGeneralBtn.addEventListener('click', async () => {
  const title = (elements.settingTitle.value || '').trim() || 'Bullet Farm';
  const image = (elements.settingHeaderImage.value || '').trim() || 'https://via.placeholder.com/48';
  try{ 
    await update(settingsRef, { title, headerImage: image }); 
    alert('‚úÖ Allgemeine Einstellungen gespeichert'); 
  } catch(e){ 
    console.error(e); 
    alert('‚ùå Fehler beim Speichern'); 
  }
});

elements.resetGeneralBtn.addEventListener('click', async () => {
  if(!confirm('Auf Standard zur√ºcksetzen?')) return;
  try{ 
    await update(settingsRef, { title: 'Bullet Farm', headerImage: 'https://via.placeholder.com/48' }); 
    alert('‚úÖ Zur√ºckgesetzt'); 
  } catch(e){ 
    console.error(e); 
    alert('‚ùå Fehler'); 
  }
});

/* ---------- Kategorien ---------- */
onValue(categoriesRef, snapshot => {
  categories = [];
  snapshot.forEach(child => {
    const data = child.val(); 
    data.key = child.key; 
    categories.push(data);
  });
  renderCategoriesList();
  populateCategorySelects();
});

function renderCategoriesList(){
  elements.categoriesList.innerHTML = '';
  if(categories.length === 0){ 
    elements.categoriesList.innerHTML = '<div class="kv">Keine Kategorien vorhanden.</div>'; 
    return; 
  }
  
  categories.forEach(category => {
    const div = document.createElement('div');
    div.className = 'category-item fade-in';
    div.innerHTML = `
      <div class="mobile-optimized-text">${escapeHtml(category.name)}</div>
      <div style="display:flex;gap:6px">
        <button class="btn small-btn" data-edit="${category.key}">‚úèÔ∏è</button>
        <button class="btn small-btn" data-del="${category.key}" style="background:#ef4444">üóëÔ∏è L√∂schen</button>
      </div>`;
    elements.categoriesList.appendChild(div);
    
    div.querySelector('[data-del]').onclick = async () => {
      if(!confirm('Kategorie wirklich l√∂schen? Produkte bleiben unver√§ndert.')) return;
      try{ 
        await remove(ref(db, 'categories/' + category.key)); 
      } catch(e){ 
        console.error(e); 
        alert('‚ùå Fehler beim L√∂schen'); 
      }
    };
    
    div.querySelector('[data-edit]').onclick = () => {
      const newName = prompt('Neuer Kategorie-Name', category.name);
      if(newName && newName.trim()){
        update(ref(db, 'categories/' + category.key), { name: newName.trim() })
          .catch(() => alert('‚ùå Fehler beim Umbenennen'));
      }
    };
  });
}

elements.addCategoryBtn.addEventListener('click', async () => {
  const name = (elements.newCategoryInput.value || '').trim();
  if(!name) return alert('‚ùå Bitte Namen eingeben');
  try{
    await push(categoriesRef, { name });
    elements.newCategoryInput.value = '';
  } catch(e){ 
    console.error(e); 
    alert('‚ùå Fehler beim Anlegen'); 
  }
});

function populateCategorySelects(){
  elements.prodCategorySelect.innerHTML = '';
  elements.shopCategoryFilter.innerHTML = '';
  
  const noneOption = document.createElement('option');
  noneOption.value = '';
  noneOption.textContent = '‚Äî Keine Kategorie ‚Äî';
  elements.prodCategorySelect.appendChild(noneOption);
  
  const allOption = document.createElement('option');
  allOption.value = '';
  allOption.textContent = '‚Äî Alle Kategorien ‚Äî';
  elements.shopCategoryFilter.appendChild(allOption);

  categories.forEach(category => {
    const option1 = document.createElement('option');
    option1.value = category.name;
    option1.textContent = category.name;
    elements.prodCategorySelect.appendChild(option1);
    
    const option2 = document.createElement('option');
    option2.value = category.name;
    option2.textContent = category.name;
    elements.shopCategoryFilter.appendChild(option2);
  });
}

/* ---------- Produkte ---------- */
onValue(productsRef, snapshot => {
  products = [];
  snapshot.forEach(child => {
    const data = child.val(); 
    data.key = child.key; 
    products.push(data);
  });
  products.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
  renderProductsTable();
  renderProductsGrid();
});

function escapeHtml(text) {
  if(!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

elements.shopCategoryFilter.addEventListener('change', renderProductsGrid);

function renderProductsGrid(){
  const filter = (elements.shopCategoryFilter.value || '').trim();
  elements.productsGrid.innerHTML = '';
  const visibleProducts = products.filter(p => !filter || (p.category || '') === filter);
  
  // Produktanzahl anzeigen
  elements.productsCount.textContent = `${visibleProducts.length} Produkt${visibleProducts.length !== 1 ? 'e' : ''} angezeigt`;
  
  if(visibleProducts.length === 0){ 
    elements.productsGrid.innerHTML = '<div class="kv p-4">Keine Produkte verf√ºgbar.</div>'; 
    return; 
  }
  
  visibleProducts.forEach(product => {
    const card = document.createElement('div');
    card.className = 'card fade-in product-card';
    
    const img = document.createElement('img');
    img.src = product.image || 'https://via.placeholder.com/300x120';
    img.className = 'product-image';
    img.alt = product.name || 'Produktbild';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'product-content';
    
    const title = document.createElement('div');
    title.className = 'product-name mobile-optimized-text';
    title.style.fontWeight = '700';
    title.style.fontSize = '1rem';
    title.style.marginTop = '8px';
    title.style.color = product.colorName || '#22c55e';
    title.textContent = product.name || '';
    
    const desc = document.createElement('div');
    desc.className = 'product-description small-muted mobile-optimized-text';
    desc.textContent = product.description || '';
    
    contentDiv.appendChild(title);
    contentDiv.appendChild(desc);

    // Ressourcen Tabelle
    if(product.resources){
      const pairs = product.resources.split(';').map(x => x.trim()).filter(Boolean);
      if(pairs.length > 0){
        const tableContainer = document.createElement('div');
        tableContainer.className = 'product-resources';
        tableContainer.style.marginTop = '8px';
        
        const table = document.createElement('table');
        table.className = 'table resource-table';
        table.innerHTML = `
          <thead>
            <tr>
              <th>Ressource</th>
              <th style="text-align:right">Anzahl</th>
            </tr>
          </thead>
          <tbody>
            ${pairs.map(resource => {
              const [name, value, color] = resource.split(':');
              return `
                <tr>
                  <td style="color:${color || '#facc15'}" class="mobile-optimized-text">${escapeHtml(name)}</td>
                  <td style="text-align:right;color:${product.colorQuantity || '#3b82f6'}">
                    ${Number(value).toLocaleString('de-DE')}
                  </td>
                </tr>`;
            }).join('')}
          </tbody>`;
        tableContainer.appendChild(table);
        contentDiv.appendChild(tableContainer);
      }
    }

    // Kategorie anzeigen
    if(product.category) {
      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'product-category kv mobile-optimized-text';
      categoryDiv.style.marginTop = '8px';
      categoryDiv.textContent = 'Kategorie: ' + product.category;
      contentDiv.appendChild(categoryDiv);
    }

    // In den Warenkorb Button
    const addButton = document.createElement('button');
    addButton.className = 'btn';
    addButton.style.background = '#10b981';
    addButton.style.marginTop = '12px';
    addButton.textContent = '‚úÖ In den Warenkorb';
    addButton.onclick = () => { 
      addToCartByProductKey(product.key); 
      alert(`‚úÖ "${product.name}" zum Warenkorb hinzugef√ºgt`); 
    };
    contentDiv.appendChild(addButton);

    card.appendChild(img);
    card.appendChild(contentDiv);
    elements.productsGrid.appendChild(card);
  });
}

// Der Rest des JavaScript-Codes bleibt gleich wie vorher...
// [Hier w√ºrde der restliche JavaScript-Code folgen, der identisch mit dem vorherigen ist]

// Initialisierung
ensureOrderUiInCart();
renderCartView();
applySettings();

// Enter-Taste f√ºr Admin Login
elements.settingsPassword.addEventListener('keypress', (e) => {
  if(e.key === 'Enter') {
    elements.settingsUnlockBtn.click();
  }
});

// Enter-Taste f√ºr Kategorie hinzuf√ºgen
elements.newCategoryInput.addEventListener('keypress', (e) => {
  if(e.key === 'Enter') {
    elements.addCategoryBtn.click();
  }
});

console.log('üöÄ Bullet Farm v2 Shop initialisiert');
</script>
</body>
</html>

<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Weed Ankauf ‚Äî Shop + Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto; }
.card { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.05); border-radius: 12px; }
.shadow-soft { box-shadow: 0 6px 18px rgba(0,0,0,0.45); }
.small-muted { color: #9ca3af; font-size: 0.8rem; margin-top:2px; display:block; }
.btn { transition: all .15s ease; font-size: 0.9rem; cursor:pointer; }
.btn:hover { transform: translateY(-2px); }
.hidden-el { display: none; }
input, textarea, select { transition: all 0.15s ease; font-size: 0.95rem; }
input:focus, textarea:focus, select:focus { outline: none; border-color: #7e22ce; box-shadow: 0 0 0 2px #7e22ce55; }
.product-image { width:100%; height:120px; object-fit:cover; border-radius:8px; }
.product-image-admin { width:80px; height:50px; object-fit:cover; border-radius:4px; }

/* Modal (Settings) */
.modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:50; }
.modal-content { width: 96%; max-width: 900px; border-radius:10px; padding:16px; background: linear-gradient(180deg,#0f1724,#111827); color: #e5e7eb; border:1px solid rgba(255,255,255,0.04); }
.tabs { display:flex; gap:8px; margin-bottom:12px; }
.tab-btn { padding:8px 12px; border-radius:8px; background: rgba(255,255,255,0.02); cursor:pointer; }
.tab-btn.active { background: linear-gradient(90deg,#4f46e5,#06b6d4); color:white; }

/* small helpers */
.kv { font-size:0.9rem; color:#9ca3af; }
.category-item { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; background: rgba(255,255,255,0.02); border-radius:8px; margin-bottom:6px; }
</style>
</head>

<body class="bg-gray-900 text-gray-100 antialiased min-h-screen">

<div class="max-w-6xl mx-auto p-6">
  <!-- HEADER -->
  <header class="bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-800 rounded-lg shadow-soft mb-6 p-4 flex justify-between items-center">
    <div class="flex items-center gap-4">
      <img id="headerLogo" src="https://via.placeholder.com/48" alt="Logo" class="rounded-lg" style="width:48px;height:48px;object-fit:cover;">
      <h1 id="pageTitle" class="text-2xl font-bold text-green-400 tracking-tight">üåø Weed Ankauf ‚Äî Shop & Admin</h1>
    </div>

    <div class="flex items-center gap-2">
      <button id="btnShop" class="btn px-3 py-1.5 bg-gray-800 rounded-md hover:bg-gray-700 shadow-sm">Shop</button>
      <button id="btnAdmin" class="btn px-3 py-1.5 bg-blue-600 rounded-md hover:bg-blue-500 shadow-sm">Admin</button>
      <button id="openSettingsBtn" title="Einstellungen" class="btn px-3 py-1.5 bg-gray-700 rounded-md hover:bg-gray-600 shadow-sm">‚öôÔ∏è</button>
    </div>
  </header>

  <div id="mainContainer" class="space-y-5">
    <!-- SHOP -->
    <section id="shopView" class="card p-6 shadow-soft">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-green-400">üõí Produkte</h2>
        <div class="small-muted">Hier kannst du Produkte kaufen</div>
      </div>
      <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- ADMIN -->
    <section id="adminPanel" class="card p-5 shadow-soft hidden-el">
      <h2 class="text-lg font-semibold mb-3">üîß Adminbereich ‚Äî Produkte verwalten</h2>
      <div id="adminLoginSection" class="mb-4">
        <input id="adminPass" type="password" placeholder="Admin-Passwort" class="w-full p-2 rounded-md bg-gray-800 border border-gray-700 mb-3"/>
        <button id="adminLoginBtn" class="w-full py-2 bg-blue-600 hover:bg-blue-500 rounded-md">Einloggen</button>
        <span id="adminError" class="text-red-400 mt-3 block hidden-el text-center text-sm">‚ùå Falsches Passwort</span>
      </div>

      <div id="adminContent" class="hidden-el">
        <div class="flex gap-3 flex-wrap mb-4">
          <button id="btnNewProduct" class="px-3 py-2 bg-green-600 rounded-md">Neues Produkt</button>
        </div>

        <!-- Product Form -->
        <div id="productFormCard" class="p-4 rounded-md bg-gray-800 border border-gray-700 mb-4 hidden-el">
          <h3 class="font-semibold mb-2">Produkt erstellen / bearbeiten</h3>
          <form id="productForm" class="space-y-3">
            <input id="prodId" type="hidden" />
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input id="prodName" placeholder="Name" class="p-2 rounded-md bg-gray-900 border border-gray-700 w-full" required />
              <input id="prodImg" placeholder="Bild-URL" class="p-2 rounded-md bg-gray-900 border border-gray-700 w-full" />
            </div>
            <textarea id="prodDesc" rows="2" placeholder="Beschreibung (optional)" class="p-2 rounded-md bg-gray-900 border border-gray-700 w-full"></textarea>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="flex flex-col">Name-Farbe
                <input type="color" id="colorNameInput" value="#22c55e"/>
              </label>
              <label class="flex flex-col">Anzahl-Farbe (Ressourcen)
                <input type="color" id="colorQuantityInput" value="#3b82f6"/>
              </label>
            </div>

            <div id="resourceTableContainer" class="mb-3 hidden-el">
              <h4 class="font-medium mb-1">Ressourcen bearbeiten</h4>
              <table id="resourceTable" class="w-full text-sm border border-gray-700 rounded-md">
                <thead class="bg-gray-700 text-yellow-400">
                  <tr>
                    <th class="px-3 py-1 text-left">Ressource</th>
                    <th class="px-3 py-1 text-right">Anzahl</th>
                    <th class="px-3 py-1">Farbe</th>
                    <th class="px-3 py-1">Aktion</th>
                  </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700"></tbody>
              </table>
              <button type="button" id="addResourceBtn" class="mt-2 px-3 py-1 bg-green-600 rounded-md">Ressource hinzuf√ºgen</button>
            </div>

            <input id="prodResources" class="hidden-el" />
            <input id="prodCategory" class="hidden-el" />

            <div class="flex gap-2">
              <button class="px-4 py-2 bg-green-600 rounded-md" type="submit">Speichern</button>
              <button id="cancelProduct" type="button" class="px-4 py-2 bg-red-600 rounded-md">Abbrechen</button>
            </div>
          </form>
        </div>

        <!-- Product List -->
        <div class="overflow-auto max-h-[50vh] rounded-md border border-gray-800">
          <table class="w-full text-left text-sm">
            <thead class="text-gray-400 bg-gray-800">
              <tr>
                <th class="p-2">Vorschau</th>
                <th class="p-2">Name</th>
                <th class="p-2">Aktion</th>
              </tr>
            </thead>
            <tbody id="productsTableBody" class="divide-y divide-gray-800"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal-overlay hidden-el" aria-hidden="true">
  <div class="modal-content">
    <div class="flex justify-between items-start">
      <h3 class="text-xl font-bold">Einstellungen</h3>
      <button id="closeSettings" class="px-3 py-1 bg-red-600 rounded-md">Schlie√üen</button>
    </div>

    <div id="settingsBody" class="mt-4">
      <!-- Passwort -->
      <div id="settingsLogin">
        <label class="block mb-1">Admin-Passwort</label>
        <input id="settingsPassword" type="password" class="w-full p-2 rounded-md bg-gray-800 border border-gray-700" placeholder="Passwort"/>
        <div class="mt-3 flex gap-2">
          <button id="unlockSettingsBtn" class="px-4 py-2 bg-blue-600 rounded-md">Anmelden</button>
          <span id="settingsLoginError" class="kv hidden-el">‚ùå Falsches Passwort</span>
        </div>
      </div>

      <!-- Editor -->
      <div id="settingsEditor" class="hidden-el">
        <div class="tabs mt-3">
          <button class="tab-btn active" data-tab="general">Allgemein</button>
          <button class="tab-btn" data-tab="categories">Kategorien</button>
        </div>

        <div id="tabContent">
          <!-- GENERAL -->
          <div class="tab-panel" data-panel="general">
            <div class="mb-3">
              <label class="block kv mb-1">Titel</label>
              <input id="settingTitle" type="text" class="w-full p-2 rounded-md bg-gray-800 border border-gray-700" />
            </div>
            <div class="mb-3">
              <label class="block kv mb-1">Header Bild URL (48x48 empfohlen)</label>
              <input id="settingHeaderImage" type="text" class="w-full p-2 rounded-md bg-gray-800 border border-gray-700" />
            </div>
            <div class="flex gap-2">
              <button id="saveGeneralSettings" class="px-4 py-2 bg-green-600 rounded-md">Speichern</button>
              <button id="resetGeneralSettings" class="px-4 py-2 bg-red-600 rounded-md">Zur√ºcksetzen</button>
            </div>
          </div>

          <!-- CATEGORIES -->
          <div class="tab-panel hidden-el" data-panel="categories">
            <div id="categoriesList" class="mt-2 mb-3"></div>

            <div class="mb-3">
              <input id="newCategoryInput" type="text" placeholder="Neue Kategorie" class="w-full p-2 rounded-md bg-gray-800 border border-gray-700" />
              <div class="mt-2 flex gap-2">
                <button id="addCategoryBtn" class="px-4 py-2 bg-green-600 rounded-md">Hinzuf√ºgen</button>
                <button id="saveCategoriesBtn" class="px-4 py-2 bg-blue-600 rounded-md">Speichern</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script type="module">
/* Firebase imports (wie zuvor) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, set } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

/* Deine Firebase-Config (bleibt unver√§ndert) */
const firebaseConfig = { apiKey:"AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo", authDomain:"khusland-b7d13.firebaseapp.com", databaseURL:"https://khusland-b7d13-default-rtdb.firebaseio.com", projectId:"khusland-b7d13", storageBucket:"khusland-b7d13.firebasestorage.app", messagingSenderId:"69573193613", appId:"1:69573193613:web:86c4d839281b1e343cd7c4", measurementId:"G-JSCWR4207G" };

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productsRef = ref(db, 'products');
const settingsRef = ref(db, 'settings');

/* Admin Passwort f√ºr Admin-Panel (wie vorher) */
const ADMIN_PASSWORD = 'admin123';

/* --- Elemente --- */
const btnShop = document.getElementById('btnShop');
const btnAdmin = document.getElementById('btnAdmin');
const shopView = document.getElementById('shopView');
const adminPanel = document.getElementById('adminPanel');
const productsGrid = document.getElementById('productsGrid');
const productsTableBody = document.getElementById('productsTableBody');

const adminLoginBtn = document.getElementById('adminLoginBtn');
const adminPassInput = document.getElementById('adminPass');
const adminError = document.getElementById('adminError');
const adminContent = document.getElementById('adminContent');
const btnNewProduct = document.getElementById('btnNewProduct');
const productFormCard = document.getElementById('productFormCard');
const productForm = document.getElementById('productForm');
const prodId = document.getElementById('prodId');
const prodName = document.getElementById('prodName');
const prodDesc = document.getElementById('prodDesc');
const prodImg = document.getElementById('prodImg');
const prodCategory = document.getElementById('prodCategory');
const prodResources = document.getElementById('prodResources');
const cancelProduct = document.getElementById('cancelProduct');

const colorNameInput = document.getElementById('colorNameInput');
const colorQuantityInput = document.getElementById('colorQuantityInput');

const openSettingsBtn = document.getElementById('openSettingsBtn');
const settingsModal = document.getElementById('settingsModal');
const closeSettings = document.getElementById('closeSettings');
const unlockSettingsBtn = document.getElementById('unlockSettingsBtn');
const settingsPassword = document.getElementById('settingsPassword');
const settingsLoginError = document.getElementById('settingsLoginError');
const settingsEditor = document.getElementById('settingsEditor');

const settingTitle = document.getElementById('settingTitle');
const settingHeaderImage = document.getElementById('settingHeaderImage');
const saveGeneralSettings = document.getElementById('saveGeneralSettings');
const resetGeneralSettings = document.getElementById('resetGeneralSettings');

const categoriesList = document.getElementById('categoriesList');
const newCategoryInput = document.getElementById('newCategoryInput');
const addCategoryBtn = document.getElementById('addCategoryBtn');
const saveCategoriesBtn = document.getElementById('saveCategoriesBtn');

const pageTitle = document.getElementById('pageTitle');
const headerLogo = document.getElementById('headerLogo');

/* state */
let colorName = colorNameInput.value;
let colorQuantity = colorQuantityInput.value;
let products = [];
let settings = { title: 'üåø Weed Ankauf ‚Äî Shop & Admin', headerImage: 'https://via.placeholder.com/48', categories: [] };

/* UI toggles */
btnShop.onclick = ()=>{ shopView.classList.remove('hidden-el'); adminPanel.classList.add('hidden-el'); };
btnAdmin.onclick = ()=>{ shopView.classList.add('hidden-el'); adminPanel.classList.remove('hidden-el'); };

adminLoginBtn.onclick = ()=>{
  if(adminPassInput.value === ADMIN_PASSWORD){ adminError.classList.add('hidden-el'); adminContent.classList.remove('hidden-el'); } 
  else { adminError.classList.remove('hidden-el'); }
};

/* OPEN SETTINGS MODAL */
openSettingsBtn.onclick = ()=> {
  settingsModal.classList.remove('hidden-el');
  document.body.style.overflow = "hidden"; // verhindert Scrollen im Hintergrund
  document.getElementById('settingsLogin').classList.remove('hidden-el');
  settingsEditor.classList.add('hidden-el');
  settingsPassword.value = '';
  settingsLoginError.classList.add('hidden-el');
};

/* CLOSE SETTINGS MODAL (by Button or Overlay Click) */
function closeSettingsModal(){
  settingsModal.classList.add('hidden-el');
  document.body.style.overflow = ""; // Scrollen wieder erlauben
}

/* Button schlie√üen */
closeSettings.onclick = closeSettingsModal;

/* Klick au√üerhalb des Modalfensters schlie√üt es */
settingsModal.addEventListener('click', (e)=>{
  if(e.target === settingsModal){
    closeSettingsModal();
  }
});

/* unlock settings (password) */
unlockSettingsBtn.onclick = ()=> {
  if(settingsPassword.value === ADMIN_PASSWORD){
    settingsLoginError.classList.add('hidden-el');
    document.getElementById('settingsLogin').classList.add('hidden-el');
    settingsEditor.classList.remove('hidden-el');
    showSettingsTab('general');
    renderCategoriesEditor();
  } else {
    settingsLoginError.classList.remove('hidden-el');
  }
};

/* tab switching inside settings */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    showSettingsTab(btn.dataset.tab);
  });
});

function showSettingsTab(name){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.add('hidden-el'));
  const panel = document.querySelector(`.tab-panel[data-panel="${name}"]`);
  if(panel) panel.classList.remove('hidden-el');
}

/* resource UI handlers */
colorNameInput.oninput = ()=> { colorName = colorNameInput.value; renderProducts(); };
colorQuantityInput.oninput = ()=> { colorQuantity = colorQuantityInput.value; renderProducts(); };

/* product form open/close */
btnNewProduct.onclick = ()=> openProductForm();
cancelProduct.onclick = ()=> closeProductForm();

function openProductForm(product){
  productFormCard.classList.remove('hidden-el');
  const resourceTableContainer = document.getElementById('resourceTableContainer');
  const resourceTableBody = document.querySelector('#resourceTable tbody');
  resourceTableBody.innerHTML = '';
  resourceTableContainer.classList.add('hidden-el');

  if(product){
    prodId.value = product.key || '';
    prodName.value = product.name || '';
    prodDesc.value = product.description || '';
    prodImg.value = product.image || '';
    prodResources.value = product.resources || '';
    prodCategory.value = product.category || '';
    colorNameInput.value = product.colorName || '#22c55e';
    colorQuantityInput.value = product.colorQuantity || '#3b82f6';
    colorName = colorNameInput.value;
    colorQuantity = colorQuantityInput.value;

    if(product.resources){
      const pairs = product.resources.split(';').map(x=>x.trim()).filter(Boolean);
      pairs.forEach(p=>{
        const [k,v,c] = p.split(':');
        addResourceRow(k,v,c||'#facc15');
      });
      resourceTableContainer.classList.remove('hidden-el');
    }
  } else { productForm.reset(); prodId.value=''; }
}

function closeProductForm(){ productFormCard.classList.add('hidden-el'); productForm.reset(); prodId.value=''; }

function addResourceRow(name='', value='', color='#facc15'){
  const tbody = document.querySelector('#resourceTable tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="w-full p-1 rounded-md bg-gray-900 border border-gray-700 text-sm" value="${name}" /></td>
    <td><input type="number" class="w-full p-1 rounded-md bg-gray-900 border border-gray-700 text-sm" value="${value}" /></td>
    <td><input type="color" class="w-full p-1 rounded-md border border-gray-700 text-sm" value="${color}" /></td>
    <td><button type="button" class="px-2 py-1 bg-red-600 rounded text-sm">‚ùå</button></td>`;
  tr.querySelector('button').onclick = ()=> tr.remove();
  tbody.appendChild(tr);
}
document.getElementById('addResourceBtn').onclick = ()=> addResourceRow();

/* product form submit */
productForm.onsubmit = async e=>{
  e.preventDefault();
  const resourceRows = document.querySelectorAll('#resourceTable tbody tr');
  const resources = Array.from(resourceRows).map(r=>{
    const name = r.children[0].querySelector('input').value.trim();
    const qty = r.children[1].querySelector('input').value.trim();
    const color = r.children[2].querySelector('input').value;
    return name && qty ? `${name}:${qty}:${color}` : '';
  }).filter(Boolean);

  const payload = {
    name: prodName.value.trim(),
    description: prodDesc.value.trim(),
    image: prodImg.value.trim(),
    category: '',
    resources: resources.join(';'),
    colorName: colorNameInput.value,
    colorQuantity: colorQuantityInput.value,
    updatedAt: Date.now()
  };

  if(prodId.value){ await update(ref(db, 'products/' + prodId.value), payload); } 
  else{ await push(productsRef, payload); }
  closeProductForm();
};

/* PRODUCTS: realtime load */
onValue(productsRef, snapshot=>{
  products = [];
  snapshot.forEach(child=>{ const data = child.val(); data.key = child.key; products.push(data); });
  products.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
  renderProducts(); renderProductsTable();
});

/* RENDER products (grid) */
function renderProducts(){
  productsGrid.innerHTML='';
  if(products.length===0){ productsGrid.innerHTML = '<div class="text-gray-400">Keine Produkte verf√ºgbar.</div>'; return; }
  products.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'p-4 rounded-md bg-gray-800 border border-gray-700 shadow-sm text-center';

    let resourcesHTML = '';
    if(p.resources){
      const pairs = p.resources.split(';').map(x=>x.trim()).filter(Boolean);
      if(pairs.length > 0){
        resourcesHTML = `<table class="w-full text-sm border border-gray-700 rounded-md mt-2">
          <thead class="bg-gray-700">
            <tr><th class="px-3 py-1 text-left">Ressource</th><th class="px-3 py-1 text-right">Anzahl</th></tr>
          </thead>
          <tbody class="bg-gray-800 divide-y divide-gray-700">
            ${pairs.map(r=>{
              const [k,v,c] = r.split(':');
              return `<tr>
                <td class="px-3 py-1 text-left" style="color:${c||'#facc15'}">${k}</td>
                <td class="px-3 py-1 text-right" style="color:${p.colorQuantity||'#3b82f6'}">${Number(v).toLocaleString('de-DE')}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>`;
      }
    }

    card.innerHTML = `
      <img src="${p.image||'https://via.placeholder.com/300x120'}" alt="Produktbild" class="product-image mb-2"/>
      <div class="font-semibold text-lg" style="color:${p.colorName||'#22c55e'}">${escapeHtml(p.name)}</div>
      <span class="small-muted">${escapeHtml(p.description||'')}</span>
      ${resourcesHTML}
    `;
    productsGrid.appendChild(card);
  });
}

/* products table in admin */
function renderProductsTable(){
  productsTableBody.innerHTML='';
  products.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2"><img src="${p.image||'https://via.placeholder.com/80'}" class="product-image-admin"/></td>
      <td class="p-2">${escapeHtml(p.name)}</td>
      <td class="p-2">
        <button class="px-2 py-1 bg-yellow-600 rounded mr-1" onclick="editProduct('${p.key}')">Bearbeiten</button>
        <button class="px-2 py-1 bg-red-600 rounded" onclick="deleteProduct('${p.key}')">L√∂schen</button>
      </td>`;
    productsTableBody.appendChild(tr);
  });
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
window.editProduct = key => { const p = products.find(x=>x.key===key); if(p) openProductForm(p); window.scrollTo({top:0,behavior:'smooth'}); };
window.deleteProduct = key => { if(confirm('Produkt wirklich l√∂schen?')) remove(ref(db, 'products/'+key)); };

/* -------------------------
   SETTINGS (Firebase / UI)
   ------------------------- */

/* listen to settings in realtime */
onValue(settingsRef, snapshot=>{
  const val = snapshot.val();
  if(val){
    settings = {
      title: val.title || settings.title,
      headerImage: val.headerImage || settings.headerImage,
      categories: Array.isArray(val.categories) ? val.categories : (val.categories ? Object.values(val.categories) : [])
    };
    applySettingsToUI();
    renderCategoriesEditor();
  }
});

/* apply settings to page */
function applySettingsToUI(){
  if(settings.title) pageTitle.innerText = settings.title;
  if(settings.headerImage) headerLogo.src = settings.headerImage;
}

/* save general settings */
saveGeneralSettings.onclick = async ()=>{
  const newTitle = settingTitle.value.trim();
  const newHeader = settingHeaderImage.value.trim();
  const payload = {};
  if(newTitle) payload.title = newTitle;
  else payload.title = 'üåø Weed Ankauf ‚Äî Shop & Admin';
  if(newHeader) payload.headerImage = newHeader;
  else payload.headerImage = 'https://via.placeholder.com/48';

  try {
    await update(ref(db, 'settings'), payload);
    alert('Einstellungen gespeichert');
  } catch (err) {
    console.error('Fehler beim Speichern der Einstellungen', err);
    alert('Speichern fehlgeschlagen');
  }
};

/* reset general settings */
resetGeneralSettings.onclick = async ()=>{
  if(!confirm('Einstellungen auf Standard zur√ºcksetzen?')) return;
  try {
    await update(ref(db, 'settings'), { title:'üåø Weed Ankauf ‚Äî Shop & Admin', headerImage:'https://via.placeholder.com/48' });
    alert('Zur√ºckgesetzt');
  } catch(err){
    console.error(err);
    alert('Fehler beim Zur√ºcksetzen');
  }
};

/* categories editor rendering */
function renderCategoriesEditor(){
  categoriesList.innerHTML = '';
  const cats = Array.isArray(settings.categories) ? settings.categories : [];
  if(cats.length === 0){
    categoriesList.innerHTML = '<div class="kv">Keine Kategorien vorhanden.</div>';
    settingTitle.value = settings.title || '';
    settingHeaderImage.value = settings.headerImage || '';
    return;
  }
  cats.forEach((cat, idx)=>{
    const div = document.createElement('div');
    div.className = 'category-item';
    div.innerHTML = `
      <input data-idx="${idx}" class="p-2 bg-gray-800 border border-gray-700 rounded-md" value="${escapeHtml(cat)}" />
      <div style="display:flex;gap:8px;">
        <button data-edit="${idx}" class="px-2 py-1 bg-yellow-600 rounded-md">‚úîÔ∏è</button>
        <button data-del="${idx}" class="px-2 py-1 bg-red-600 rounded-md">üóëÔ∏è</button>
      </div>
    `;
    categoriesList.appendChild(div);
    div.querySelector(`[data-edit]`).onclick = ()=> {
      const input = div.querySelector('input');
      const val = input.value.trim();
      if(val===''){ alert('Leer nicht erlaubt'); return; }
      settings.categories[idx] = val;
      alert('√Ñnderung vorgenommen (noch nicht gespeichert). Klicke "Speichern".');
    };
    div.querySelector(`[data-del]`).onclick = ()=> {
      if(!confirm(`Kategorie "${settings.categories[idx]}" wirklich l√∂schen?`)) return;
      settings.categories.splice(idx,1);
      renderCategoriesEditor();
      alert('Kategorie entfernt (noch nicht gespeichert). Klicke "Speichern".');
    };
  });

  settingTitle.value = settings.title || '';
  settingHeaderImage.value = settings.headerImage || '';
}

/* add new category locally */
addCategoryBtn.onclick = ()=> {
  const v = newCategoryInput.value.trim();
  if(!v){ alert('Bitte Namen eingeben'); return; }
  settings.categories.push(v);
  newCategoryInput.value = '';
  renderCategoriesEditor();
};

/* save categories to firebase */
saveCategoriesBtn.onclick = async ()=> {
  try {
    // save as array
    await update(ref(db, 'settings'), { categories: settings.categories || [] });
    alert('Kategorien gespeichert');
  } catch(err){
    console.error(err);
    alert('Fehler beim Speichern');
  }
};

/* initial apply */
applySettingsToUI();
shopView.classList.remove('hidden-el');

</script>
</body>
</html>

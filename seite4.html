<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bullet Farm v2 ‚Äî Shop</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#0f1724;--card:#0b1220;--muted:#9ca3af;--accent:#06b6d4}
body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:#071025;color:#e6eef8;margin:0}
.container{max-width:1100px;margin:0 auto;padding:20px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);border-radius:12px;padding:16px}
.shadow-soft{box-shadow:0 8px 30px rgba(2,6,23,0.6)}
.small-muted{color:var(--muted);font-size:0.85rem;margin-top:4px}
.btn{transition:all .12s ease;border-radius:8px;padding:.45rem .8rem;cursor:pointer;background:#111827;color:#e6eef8;border:1px solid rgba(255,255,255,0.03)}
.btn:hover{transform:translateY(-2px)}
.hidden-el{display:none !important}
.product-image{width:100%;height:130px;object-fit:cover;border-radius:8px}
.product-image-admin{width:80px;height:50px;object-fit:cover;border-radius:6px}
#productsGrid .card{max-width:220px;margin:0 auto}
.modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(4,6,11,0.6);opacity:0;pointer-events:none;transition:opacity .22s ease;z-index:80}
.modal-overlay.active{opacity:1;pointer-events:all}
.modal-box{width:96%;max-width:980px;background:linear-gradient(180deg,#0b1220,#0f1724);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 20px 60px rgba(2,6,23,0.7);transform:translateY(-8px);transition:transform .22s ease}
.modal-overlay.active .modal-box{transform:translateY(0)}
.tab-btn{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
.tab-btn.active{background:linear-gradient(90deg,#94a3b8,#06b6d4);color:#041628;font-weight:700}
.table {width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:0.92rem}
.kv{font-size:0.9rem;color:var(--muted)}
.category-item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:6px}
.input,textarea,select{background:#071224;border:1px solid rgba(255,255,255,0.04);color:#e6eef8;padding:.5rem;border-radius:8px;width:100%}
.color-input{width:48px;height:36px;padding:0;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#fff}
.small-btn{padding:.35rem .6rem;border-radius:6px}
.flex-row{display:flex;gap:8px;align-items:center}
.right{margin-left:auto}
</style>
</head>
<body>
<div class="container">
  <header class="card shadow-soft mb-6 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <img id="headerLogo" src="https://via.placeholder.com/48" alt="Logo" style="width:48px;height:48px;object-fit:cover;border-radius:8px">
      <div>
        <h1 id="pageTitle" style="font-size:1.4rem;font-weight:700;color:#22c55e;margin:0">Bullet Farm v2</h1>
        <div class="small-muted">Shop</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnShop" class="btn">Shop</button>
      <button id="btnCart" class="btn">Warenkorb</button>
      <button id="openSettingsBtn" class="btn">‚öôÔ∏è</button>
    </div>
  </header>

  <main id="mainContent">
    <section id="shopView" class="card mb-6">
      <div class="flex items-center justify-between mb-4">
        <div style="display:flex;gap:10px;align-items:center">
          <h2 style="font-weight:700;color:#22c55e;margin:0">üõí Produkte</h2>
          <div class="kv">Filter:</div>
          <select id="shopCategoryFilter" class="input" style="width:200px">
            <option value="">‚Äî Alle Kategorien ‚Äî</option>
          </select>
        </div>
        <div class="kv">Produkte anzeigen</div>
      </div>
      <div id="productsGrid" class="grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px"></div>
    </section>

    <section id="cartView" class="card mb-6 hidden-el">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 style="font-weight:700;color:#22c55e">üõçÔ∏è Warenkorb</h2>
          <div class="kv">Ressourcen & Anzahl</div>
        </div>
        <div style="text-align:right">
          <div id="orderCodeDisplay" class="kv" style="font-weight:700">Code: ‚Äî</div>
        </div>
      </div>
      <table class="table" id="cartTable">
        <thead><tr><th>Produkt</th><th>Ressourcen</th><th style="text-align:right">Anzahl</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:12px;font-weight:700" id="cartSummary">Gesamt Ressourcen: keine</div>
    </section>
  </main>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal-overlay hidden-el" aria-hidden="true">
  <div class="modal-box">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h3 style="font-size:1.15rem;font-weight:700;color:#94a3b8;margin:0">‚öôÔ∏è Einstellungen</h3>
        <div class="kv">Passwortgesch√ºtzt ‚Äî Admin Funktionen</div>
      </div>
      <div class="flex gap-2 items-center">
        <button id="settingsCloseBtn" class="btn">‚úñ</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="settingsLoginArea">
      <label class="kv mb-2">Admin Passwort</label>
      <div class="flex items-center gap-2 mb-3">
        <input id="settingsPassword" type="password" class="input" placeholder="Passwort (admin123)"/>
        <button id="settingsUnlockBtn" class="btn">Einloggen</button>
      </div>
      <div id="settingsLoginError" class="kv" style="color:#ff7b7b;display:none">‚ùå Falsches Passwort</div>
    </div>

    <!-- EDITOR -->
    <div id="settingsEditor" class="hidden-el">
      <div class="mb-4">
        <div class="flex gap-2">
          <button class="tab-btn active" data-tab="products">Produkte</button>
          <button class="tab-btn" data-tab="categories">Kategorien</button>
          <button class="tab-btn" data-tab="general">Allgemein</button>
          <button class="tab-btn" data-tab="orders">Bestellungen</button>
          <button class="tab-btn" data-tab="users">Nutzer</button>
        </div>
      </div>

      <!-- TAB PANELS -->
      <div id="tabProducts" class="tab-panel">Produkte ‚Ä¶</div>
      <div id="tabCategories" class="tab-panel hidden-el">Kategorien ‚Ä¶</div>
      <div id="tabGeneral" class="tab-panel hidden-el">Allgemein ‚Ä¶</div>
      <div id="tabOrders" class="tab-panel hidden-el">Bestellungen ‚Ä¶</div>
      <div id="tabUsers" class="tab-panel hidden-el">Nutzer ‚Ä¶</div>
    </div>
  </div>
</div>

<script type="module">
/* ---------- Firebase Setup ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, set, get, update } 
  from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "DEIN-API-KEY",
  authDomain: "DEIN-PROJEKT.firebaseapp.com",
  databaseURL: "https://DEIN-PROJEKT-default-rtdb.firebaseio.com",
  projectId: "DEIN-PROJEKT",
  storageBucket: "DEIN-PROJEKT.appspot.com",
  messagingSenderId: "1234567890",
  appId: "1:1234567890:web:abc123"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------- State ---------- */
let products = [];
let categories = [];
let cart = [];
let orderCode = null;

/* ---------- Utility ---------- */
function escapeHtml(text){return text.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));}
function generateOrderCode(){return Math.floor(1000+Math.random()*9000).toString();}

/* ---------- SHOP ---------- */
const productsGrid = document.getElementById('productsGrid');
const cartView = document.getElementById('cartView');
const shopView = document.getElementById('shopView');
const orderCodeDisplay = document.getElementById('orderCodeDisplay');
const cartTable = document.getElementById('cartTable').querySelector('tbody');
const cartSummary = document.getElementById('cartSummary');

function renderProducts(){
  productsGrid.innerHTML='';
  products.forEach(p=>{
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <img src="${escapeHtml(p.img||'https://via.placeholder.com/150')}" class="product-image">
      <div style="font-weight:700;margin-top:6px;color:${p.colorName||'#22c55e'}">${escapeHtml(p.name)}</div>
      <div class="small-muted">${p.category||''}</div>
      <button class="btn addCartBtn" data-id="${p.id}" style="margin-top:6px;width:100%">Hinzuf√ºgen</button>`;
    productsGrid.appendChild(card);
  });
  document.querySelectorAll('.addCartBtn').forEach(b=>b.addEventListener('click',()=>addToCart(b.dataset.id)));
}

function addToCart(id){
  const prod = products.find(p=>p.id===id);
  if(!prod) return;
  const item = cart.find(c=>c.id===id);
  if(item) item.qty++; else cart.push({...prod, qty:1});
  renderCartView();
}

function renderCartView(){
  if(cart.length===0){cartView.classList.remove('hidden-el'); cartTable.innerHTML='<tr><td colspan="3" class="kv">Warenkorb leer</td></tr>'; cartSummary.textContent=''; return;}
  cartView.classList.remove('hidden-el');
  if(!orderCode){orderCode=generateOrderCode(); orderCodeDisplay.textContent='Code: '+orderCode;}
  cartTable.innerHTML='';
  const total = {};
  cart.forEach(it=>{
    const tr=document.createElement('tr');
    const resNames=Object.keys(it.resources||{}).map(r=>`${r}: ${it.resources[r]}`).join(', ');
    tr.innerHTML=`<td>${escapeHtml(it.name)}</td><td>${escapeHtml(resNames)}</td><td style="text-align:right">${it.qty}</td>`;
    cartTable.appendChild(tr);
    for(const [r,val] of Object.entries(it.resources||{})) total[r]=(total[r]||0)+val*it.qty;
  });
  cartSummary.textContent='Gesamt Ressourcen: '+Object.entries(total).map(([k,v])=>`${k}: ${v}`).join(', ');
  set(ref(db,'orders/'+orderCode),{
    code: orderCode,
    cart: cart,
    totalResources: total,
    createdAt: Date.now(),
    status: 'pending'
  });
}

/* ---------- ADMIN ---------- */
const tabBtns=document.querySelectorAll('.tab-btn');
const tabPanels=document.querySelectorAll('.tab-panel');
const ADMIN_PASSWORD='admin123';
const openSettingsBtn=document.getElementById('openSettingsBtn');
const settingsModal=document.getElementById('settingsModal');
const settingsCloseBtn=document.getElementById('settingsCloseBtn');
const settingsPassword=document.getElementById('settingsPassword');
const settingsUnlockBtn=document.getElementById('settingsUnlockBtn');
const settingsLoginArea=document.getElementById('settingsLoginArea');
const settingsEditor=document.getElementById('settingsEditor');

openSettingsBtn.addEventListener('click',()=>{
  settingsPassword.value='';
  settingsLoginArea.style.display='';
  settingsEditor.classList.add('hidden-el');
  settingsModal.classList.remove('hidden-el');
  setTimeout(()=>settingsModal.classList.add('active'),10);
  document.body.style.overflow='hidden';
});
settingsCloseBtn.addEventListener('click',()=>{settingsModal.classList.remove('active');document.body.style.overflow='';setTimeout(()=>settingsModal.classList.add('hidden-el'),220);});
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&!settingsModal.classList.contains('hidden-el')){settingsModal.classList.remove('active');document.body.style.overflow='';setTimeout(()=>settingsModal.classList.add('hidden-el'),220);}});

tabBtns.forEach(btn=>{
  btn.addEventListener('click',()=>{
    tabBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t=btn.dataset.tab;
    tabPanels.forEach(p=>p.classList.add('hidden-el'));
    document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden-el');
  });
});

settingsUnlockBtn.addEventListener('click',()=>{
  const pw=settingsPassword.value.trim();
  if(pw===ADMIN_PASSWORD){
    settingsLoginArea.style.display='none';
    settingsEditor.classList.remove('hidden-el');
    tabBtns.forEach(b=>b.classList.remove('active'));
    tabPanels.forEach(p=>p.classList.add('hidden-el'));
    document.getElementById('tabOrders').classList.remove('hidden-el');
    tabBtns[3].classList.add('active'); // Bestellungen Tab
    loadOrdersList();
    loadUsersList();
  } else {alert('Falsches Passwort');}
});

/* ---------- ADMIN: Orders & Users ---------- */
const orderCodeInput=document.getElementById('orderCodeInput');
const btnLoadOrder=document.getElementById('btnLoadOrder');
const orderDetails=document.getElementById('orderDetails');
const orderProducts=document.getElementById('orderProducts');
const orderICName=document.getElementById('orderICName');
const orderPhone=document.getElementById('orderPhone');
const btnSaveOrderUser=document.getElementById('btnSaveOrderUser');
const usersList=document.getElementById('usersList');

btnLoadOrder.addEventListener('click',async()=>{
  const code=(orderCodeInput.value||'').trim();
  if(!code) return alert('Code eingeben');
  const snap=await get(ref(db,'orders/'+code));
  if(!snap.exists()) return alert('Bestellung nicht gefunden');
  const data=snap.val();
  orderDetails.classList.remove('hidden-el');
  orderProducts.innerHTML='<strong>Produkte:</strong><br>'+data.cart.map(c=>`${c.name} x${c.qty}`).join('<br>');
  orderICName.value=data.ICName||'';
  orderPhone.value=data.phone||'';
  orderCode=code;
});

btnSaveOrderUser.addEventListener('click',async()=>{
  if(!orderCode) return alert('Keine Bestellung geladen');
  const IC=orderICName.value.trim(), phone=orderPhone.value.trim();
  if(!IC||!phone) return alert('IC-Name und Telefonnummer erforderlich');
  try{
    await update(ref(db,'orders/'+orderCode),{ICName:IC,phone:phone});
    const userRef=ref(db,'users/'+IC.replace(/\s+/g,'_'));
    const snap=await get(userRef);
    const existing=snap.exists()?snap.val():{orders:[]};
    existing.orders.push(orderCode);
    await set(userRef,{...existing,ICName:IC,phone});
    alert('Bestellung & Nutzer gespeichert');
  } catch(e){console.error(e);alert('Fehler beim Speichern');}
});

async function loadUsersList(){
  const snap=await get(ref(db,'users'));
  usersList.innerHTML='';
  if(!snap.exists()){usersList.innerHTML='<div class="kv">Keine Nutzer vorhanden</div>';return;}
  const data=snap.val();
  Object.values(data).forEach(u=>{
    const div=document.createElement('div');
    div.className='card mb-2';
    div.innerHTML=`<strong>${escapeHtml(u.ICName)}</strong> ‚Äî ${escapeHtml(u.phone)}<br>
      Bestellungen: ${u.orders?u.orders.join(', '):'keine'}`;
    usersList.appendChild(div);
  });
}

/* ---------- Load Products & Categories ---------- */
async function loadProducts(){const snap=await get(ref(db,'products'));products=[];snap.forEach(c=>products.push({...c.val(),id:c.key}));renderProducts();}
async function loadCategories(){const snap=await get(ref(db,'categories'));categories=[];snap.forEach(c=>categories.push({...c.val(),id:c.key}));}
async function loadOrdersList(){/* optional */}

/* ---------- Initial ---------- */
loadProducts();
loadCategories();
</script>
</body>
</html>

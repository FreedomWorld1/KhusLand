<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bullet Farm v3 ‚Äî Shop & Orders</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#0f1724;--card:#0b1220;--muted:#9ca3af;--accent:#06b6d4}
body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:#071025;color:#e6eef8;margin:0}
.container{max-width:1100px;margin:0 auto;padding:20px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);border-radius:12px;padding:16px}
.shadow-soft{box-shadow:0 8px 30px rgba(2,6,23,0.6)}
.small-muted{color:var(--muted);font-size:0.85rem;margin-top:4px}
.btn{transition:all .12s ease;border-radius:8px;padding:.45rem .8rem;cursor:pointer;background:#111827;color:#e6eef8;border:1px solid rgba(255,255,255,0.03)}
.btn:hover{transform:translateY(-2px)}
.hidden-el{display:none !important}
.product-image{width:100%;height:130px;object-fit:cover;border-radius:8px}
.product-image-admin{width:80px;height:50px;object-fit:cover;border-radius:6px}
#productsGrid .card{max-width:220px;margin:0 auto}
.modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(4,6,11,0.6);opacity:0;pointer-events:none;transition:opacity .22s ease;z-index:80}
.modal-overlay.active{opacity:1;pointer-events:all}
.modal-box{width:96%;max-width:980px;background:linear-gradient(180deg,#0b1220,#0f1724);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 20px 60px rgba(2,6,23,0.7);transform:translateY(-8px);transition:transform .22s ease}
.modal-overlay.active .modal-box{transform:translateY(0)}
.tab-btn{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
.tab-btn.active{background:linear-gradient(90deg,#94a3b8,#06b6d4);color:#041628;font-weight:700}
.table {width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:0.92rem}
.kv{font-size:0.9rem;color:var(--muted)}
.category-item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:6px}
.input,textarea,select{background:#071224;border:1px solid rgba(255,255,255,0.04);color:#e6eef8;padding:.5rem;border-radius:8px;width:100%}
.color-input{width:48px;height:36px;padding:0;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#fff}
.small-btn{padding:.35rem .6rem;border-radius:6px}
.flex-row{display:flex;gap:8px;align-items:center}
.right{margin-left:auto}
</style>
</head>
<body>
<div class="container">
  <!-- HEADER -->
  <header class="card shadow-soft mb-6 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <img id="headerLogo" src="https://via.placeholder.com/48" alt="Logo" style="width:48px;height:48px;object-fit:cover;border-radius:8px">
      <div>
        <h1 id="pageTitle" style="font-size:1.4rem;font-weight:700;color:#22c55e;margin:0">Bullet Farm v3</h1>
        <div class="small-muted">Shop</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnShop" class="btn">Shop</button>
      <button id="btnCart" class="btn">Warenkorb</button>
      <button id="openSettingsBtn" class="btn">‚öôÔ∏è</button>
    </div>
  </header>

  <!-- MAIN -->
  <main id="mainContent">
    <!-- SHOP VIEW -->
    <section id="shopView" class="card mb-6">
      <div class="flex items-center justify-between mb-4">
        <div style="display:flex;gap:10px;align-items:center">
          <h2 style="font-weight:700;color:#22c55e;margin:0">üõí Produkte</h2>
          <div class="kv">Filter:</div>
          <select id="shopCategoryFilter" class="input" style="width:200px">
            <option value="">‚Äî Alle Kategorien ‚Äî</option>
          </select>
        </div>
      </div>
      <div id="productsGrid" class="grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px"></div>
    </section>

    <!-- CART VIEW -->
    <section id="cartView" class="card mb-6 hidden-el">
      <div class="flex items-center justify-between mb-4">
        <h2 style="font-weight:700;color:#22c55e">üõçÔ∏è Warenkorb</h2>
        <div class="kv">Ressourcen & Anzahl</div>
      </div>
      <div style="margin-bottom:8px; font-weight:700;">
        Dein Code: <span id="cartCode"></span>
      </div>
      <table class="table" id="cartTable">
        <thead><tr><th>Produkt</th><th>Ressourcen</th><th style="text-align:right">Anzahl</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:12px;font-weight:700" id="cartSummary">Gesamt Ressourcen: keine</div>
    </section>
  </main>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal-overlay hidden-el" aria-hidden="true">
  <div class="modal-box">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h3 style="font-size:1.15rem;font-weight:700;color:#94a3b8;margin:0">‚öôÔ∏è Einstellungen</h3>
        <div class="kv">Passwortgesch√ºtzt ‚Äî Admin Funktionen</div>
      </div>
      <div class="flex gap-2 items-center">
        <button id="settingsCloseBtn" class="btn">‚úñ</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="settingsLoginArea">
      <label class="kv mb-2">Admin Passwort</label>
      <div class="flex items-center gap-2 mb-3">
        <input id="settingsPassword" type="password" class="input" placeholder="Passwort (admin123)"/>
        <button id="settingsUnlockBtn" class="btn">Einloggen</button>
      </div>
      <div id="settingsLoginError" class="kv" style="color:#ff7b7b;display:none">‚ùå Falsches Passwort</div>
    </div>

    <!-- EDITOR -->
    <div id="settingsEditor" class="hidden-el">
      <div class="mb-4">
        <div class="flex gap-2 flex-wrap">
          <button class="tab-btn active" data-tab="products">Produkte</button>
          <button class="tab-btn" data-tab="categories">Kategorien</button>
          <button class="tab-btn" data-tab="general">Allgemein</button>
          <button class="tab-btn" data-tab="orders">Bestellungen</button>
          <button class="tab-btn" data-tab="users">Nutzer</button>
        </div>
      </div>

      <!-- TAB PANELS -->
      <div id="tabProducts" class="tab-panel">
        <h4>Produkte verwalten</h4>
        <!-- Produktformular etc. kommt hier (wie vorher) -->
      </div>
      <div id="tabCategories" class="tab-panel hidden-el">
        <h4>Kategorien verwalten</h4>
      </div>
      <div id="tabGeneral" class="tab-panel hidden-el">
        <h4>Allgemein</h4>
      </div>
      <div id="tabOrders" class="tab-panel hidden-el">
        <h4>Bestellungen ansehen</h4>
        <label class="kv">Code eingeben</label>
        <input id="orderCodeInput" class="input" placeholder="Code"/>
        <button id="loadOrderBtn" class="btn">Laden</button>
        <div id="orderDetails" class="card mt-2 hidden-el"></div>
      </div>
      <div id="tabUsers" class="tab-panel hidden-el">
        <h4>Nutzer</h4>
        <div id="usersList" class="card mt-2" style="max-height:36vh;overflow:auto;padding:12px"></div>
      </div>

    </div>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

/* ---------- Firebase Config ---------- */
const firebaseConfig = {
  apiKey:"AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
  authDomain:"khusland-b7d13.firebaseapp.com",
  databaseURL:"https://khusland-b7d13-default-rtdb.firebaseio.com",
  projectId:"khusland-b7d13",
  storageBucket:"khusland-b7d13.firebasestorage.app",
  messagingSenderId:"69573193613",
  appId:"1:69573193613:web:86c4d839281b1e343cd7c4",
  measurementId:"G-JSCWR4207G"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productsRef = ref(db,'products');
const categoriesRef = ref(db,'categories');
const ordersRef = ref(db,'orders');
const usersRef = ref(db,'users');
const settingsRef = ref(db,'settings');

/* ---------- Globals ---------- */
const ADMIN_PASSWORD = 'admin123';
const openSettingsBtn = document.getElementById('openSettingsBtn');
const settingsModal = document.getElementById('settingsModal');
const settingsCloseBtn = document.getElementById('settingsCloseBtn');
const settingsPassword = document.getElementById('settingsPassword');
const settingsUnlockBtn = document.getElementById('settingsUnlockBtn');
const settingsLoginArea = document.getElementById('settingsLoginArea');
const settingsEditor = document.getElementById('settingsEditor');
const tabBtns = document.querySelectorAll('.tab-btn');
const tabPanels = document.querySelectorAll('.tab-panel');
const productsGrid = document.getElementById('productsGrid');
const shopCategoryFilter = document.getElementById('shopCategoryFilter');
const cartView = document.getElementById('cartView');
const shopView = document.getElementById('shopView');
const btnShop = document.getElementById('btnShop');
const btnCart = document.getElementById('btnCart');
const cartTableBody = document.querySelector('#cartTable tbody');
const cartSummary = document.getElementById('cartSummary');
const cartCodeSpan = document.getElementById('cartCode');
const orderCodeInput = document.getElementById('orderCodeInput');
const loadOrderBtn = document.getElementById('loadOrderBtn');
const orderDetails = document.getElementById('orderDetails');
const usersList = document.getElementById('usersList');

let products = [];
let categories = [];
let cart = [];
let currentCartCode = '';

// ---------- Helpers ----------
function escapeHtml(s){ return s?String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])):''; }
function generateCode(){ return Math.floor(1000 + Math.random()*9000).toString(); }
function showModal(){ settingsModal.classList.remove('hidden-el'); setTimeout(()=>settingsModal.classList.add('active'),10); document.body.style.overflow='hidden'; }
function hideModal(){ settingsModal.classList.remove('active'); document.body.style.overflow=''; setTimeout(()=>settingsModal.classList.add('hidden-el'),240); }
function resourcesToMap(resourcesString){ const map={}; if(!resourcesString) return map; resourcesString.split(';').forEach(r=>{ const [k,v]=r.split(':'); if(k&&v) map[k]=Number(v); }); return map; }

// ---------- Modal & Tabs ----------
openSettingsBtn.addEventListener('click',()=>{
  settingsPassword.value=''; settingsLoginArea.style.display=''; settingsEditor.classList.add('hidden-el'); showModal();
});
settingsCloseBtn.addEventListener('click',hideModal);
settingsModal.addEventListener('click',e=>{ if(e.target===settingsModal) hideModal(); });
document.addEventListener('keydown',e=>{ if(e.key==='Escape' && !settingsModal.classList.contains('hidden-el')) hideModal(); });
tabBtns.forEach(btn=>{
  btn.addEventListener('click',()=>{
    tabBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.tab;
    tabPanels.forEach(p=>p.classList.add('hidden-el'));
    document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('hidden-el');
  });
});

// ---------- Load Firebase Data ----------
onValue(productsRef, snapshot=>{ products=[]; snapshot.forEach(child=>{ const d=child.val(); d.key=child.key; products.push(d); }); renderProductsGrid(); });
onValue(categoriesRef, snapshot=>{ categories=[]; snapshot.forEach(c=>{ const d=c.val(); d.key=c.key; categories.push(d); }); populateCategoryFilter(); });
onValue(usersRef, snapshot=>{ renderUsers(); });

// ---------- Populate Shop Filter ----------
function populateCategoryFilter(){
  shopCategoryFilter.innerHTML=''; const allOpt=document.createElement('option'); allOpt.value=''; allOpt.textContent='‚Äî Alle Kategorien ‚Äî'; shopCategoryFilter.appendChild(allOpt);
  categories.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; o.textContent=c.name; shopCategoryFilter.appendChild(o); });
}

// ---------- Render Shop Grid ----------
shopCategoryFilter.addEventListener('change',renderProductsGrid);
function renderProductsGrid(){
  const filter = (shopCategoryFilter.value||'').trim();
  productsGrid.innerHTML='';
  const visible = products.filter(p=>!filter || (p.category||'')===filter);
  if(!visible.length){ productsGrid.innerHTML='<div class="kv p-4">Keine Produkte verf√ºgbar.</div>'; return; }
  visible.forEach(p=>{
    const card=document.createElement('div'); card.className='card';
    const img=document.createElement('img'); img.src=p.image||'https://via.placeholder.com/300x120'; img.className='product-image';
    const title=document.createElement('div'); title.style.fontWeight='700'; title.style.marginTop='8px'; title.style.color=p.colorName||'#22c55e'; title.textContent=p.name||'';
    card.appendChild(img); card.appendChild(title);
    if(p.resources){ const pairs=p.resources.split(';').filter(Boolean); if(pairs.length){ const tbl=document.createElement('table'); tbl.className='table'; tbl.style.marginTop='8px'; const thead=document.createElement('thead'); thead.innerHTML='<tr><th>Ressource</th><th style="text-align:right">Anzahl</th></tr>'; tbl.appendChild(thead); const tbody=document.createElement('tbody'); pairs.forEach(r=>{ const [k,v]=r.split(':'); const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(k)}</td><td style="text-align:right">${Number(v).toLocaleString('de-DE')}</td>`; tbody.appendChild(tr); }); tbl.appendChild(tbody); card.appendChild(tbl); } }
    if(p.category){ const catDiv=document.createElement('div'); catDiv.className='kv'; catDiv.style.marginTop='8px'; catDiv.textContent='Kategorie: '+p.category; card.appendChild(catDiv); }
    const addBtn=document.createElement('button'); addBtn.className='btn'; addBtn.style.marginTop='8px'; addBtn.textContent='In den Warenkorb';
    addBtn.onclick=()=>{ addToCartByProductKey(p.key); alert(`${p.name} hinzugef√ºgt`); };
    card.appendChild(addBtn); productsGrid.appendChild(card);
  });
}

// ---------- WARENKORB ----------
function addToCartByProductKey(productKey){
  const p=products.find(x=>x.key===productKey); if(!p) return;
  const resMap=resourcesToMap(p.resources);
  const idx=cart.findIndex(c=>c.key===productKey);
  if(idx===-1){ cart.push({ key:productKey, name:p.name, resources:{...resMap}, qty:1 }); } 
  else { cart[idx].qty+=1; for(const k in resMap) cart[idx].resources[k]=(cart[idx].resources[k]||0)+resMap[k]; }
  if(!currentCartCode) currentCartCode=generateCode(); cartCodeSpan.textContent=currentCartCode;
  renderCartView();
}

function renderCartView(){
  cartTableBody.innerHTML=''; const total={};
  cart.forEach(c=>{
    const tr=document.createElement('tr');
    const resText=Object.entries(c.resources).map(([k,v])=>`${k}: ${v}`).join(', ');
    tr.innerHTML=`<td>${escapeHtml(c.name)}</td><td>${escapeHtml(resText)}</td><td style="text-align:right">${c.qty}</td>`;
    cartTableBody.appendChild(tr);
    for(const k in c.resources) total[k]=(total[k]||0)+c.resources[k];
  });
  cartSummary.innerText='Gesamt Ressourcen: '+(Object.entries(total).map(([k,v])=>`${k}: ${v}`).join(', ')||'keine');
}

// ---------- Shop / Cart Toggle ----------
btnShop.addEventListener('click',()=>{ shopView.classList.remove('hidden-el'); cartView.classList.add('hidden-el'); });
btnCart.addEventListener('click',()=>{ shopView.classList.add('hidden-el'); cartView.classList.remove('hidden-el'); renderCartView(); });

// ---------- Admin Login ----------
settingsUnlockBtn.addEventListener('click',()=>{
  const pw=(settingsPassword.value||'').trim();
  if(pw===ADMIN_PASSWORD){ settingsLoginError.style.display='none'; settingsLoginArea.style.display='none'; settingsEditor.classList.remove('hidden-el'); tabBtns.forEach(b=>b.classList.remove('active')); tabBtns[0].classList.add('active'); tabPanels.forEach(p=>p.classList.add('hidden-el')); document.getElementById('tabProducts').classList.remove('hidden-el'); }
  else{ settingsLoginError.style.display=''; }
});

// ---------- Bestellungen ----------
loadOrderBtn.addEventListener('click',async ()=>{
  const code=(orderCodeInput.value||'').trim(); if(!code) return alert('Code eingeben');
  const snap=await get(ref(db,'orders/'+code));
  if(!snap.exists()){ alert('Keine Bestellung gefunden'); orderDetails.classList.add('hidden-el'); return; }
  const order=snap.val();
  orderDetails.innerHTML=`<div style="font-weight:700">IC-Name: ${escapeHtml(order.icName||'')}</div>
    <div style="font-weight:700">Telefon: ${escapeHtml(order.phone||'')}</div>
    <div>Produkte: ${escapeHtml(order.products||'')}</div>
    <div>Datum: ${new Date(order.date).toLocaleString()}</div>`;
  orderDetails.classList.remove('hidden-el');
});

// ---------- Users List ----------
async function renderUsers(){
  const snap=await get(usersRef);
  usersList.innerHTML='';
  if(!snap.exists()){ usersList.innerHTML='<div class="kv">Keine Nutzer</div>'; return; }
  snap.forEach(s=>{
    const u=s.val(); const div=document.createElement('div'); div.style.padding='6px'; div.style.borderBottom='1px solid rgba(255,255,255,0.04)';
    div.innerHTML=`<div><b>${escapeHtml(u.icName||'')}</b> ‚Äî Bestellungen: ${u.orders?Object.keys(u.orders).length:0}</div>`;
    usersList.appendChild(div);
  });
}

</script>
</body>
</html>

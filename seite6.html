<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KhusLand Panel</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css?family=inter:400,500,600,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --darker: #0a0f1c;
            --text: #f1f5f9;
            --text-light: #cbd5e1;
            --text-lighter: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(99, 102, 241, 0.2);
            --sidebar-width: 260px;
            --header-height: 70px;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }
        
        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(99, 102, 241, 0.1);
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 0 0.5rem;
        }
        
        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .sidebar-title {
            font-weight: 700;
            font-size: 1.25rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1rem;
            border-radius: 10px;
            color: var(--text-light);
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text);
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
        }
        
        .sidebar-footer {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0.5rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            background-size: cover;
            background-position: center;
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .user-role {
            font-size: 0.75rem;
            color: var(--text-lighter);
        }
        
        .logout-btn {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.8rem;
            width: 100%;
            margin-top: 0.5rem;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
            background: var(--dark);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        /* Cards - VERBESSERT mit gr√∂√üeren Buttons */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2.2rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }
        
        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .card.disabled:hover {
            transform: none;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: var(--card-border);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .card-icon {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }
        
        .card-title {
            font-size: 1.6rem;
            margin-bottom: 1.2rem;
            color: var(--text);
        }
        
        .card-content {
            color: var(--text-light);
            line-height: 1.7;
            margin-bottom: 1.5rem;
            flex-grow: 1;
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }
        
        .card-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-lighter);
        }
        
        /* STATUS INDICATOR STYLES - VERBESSERT */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-online {
            background: var(--secondary);
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }
        
        .status-offline {
            background: var(--danger);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }
        
        .status-warning {
            background: var(--warning);
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
        }
        
        .status-maintenance {
            background: var(--primary);
            box-shadow: 0 0 8px rgba(99, 102, 241, 0.5);
        }
        
        .access-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .access-allowed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--secondary);
        }
        
        .access-denied {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        /* Tables */
        .table-container {
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--card-border);
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 2rem;
        }
        
        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .table-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--secondary) 0%, #0d966c 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            text-align: left;
            padding: 1rem 1.5rem;
            background: rgba(15, 23, 42, 0.5);
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
            color: var(--text-light);
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .table tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }
        
        .user-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .user-info-small {
            display: flex;
            flex-direction: column;
        }
        
        .user-name-small {
            font-weight: 600;
            color: var(--text);
        }
        
        .user-id {
            font-size: 0.75rem;
            color: var(--text-lighter);
        }
        
        .role-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .role-admin {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }
        
        .role-moderator {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
        }
        
        .role-developer {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }
        
        .role-supporter {
            background: linear-gradient(135deg, var(--secondary) 0%, #0d966c 100%);
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            color: white;
            font-size: 0.9rem;
        }
        
        .btn-promote {
            background: rgba(16, 185, 129, 0.2);
            color: var(--secondary);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .btn-promote:hover {
            background: rgba(16, 185, 129, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-demote {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .btn-demote:hover {
            background: rgba(245, 158, 11, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-terminate {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .btn-terminate:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-2px);
        }
        
        /* Login Page */
        .login-container {
            background: rgba(15, 23, 42, 0.95);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 440px;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid rgba(99, 102, 241, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.8rem;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }
        
        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .login-subtitle {
            color: var(--text-light);
            margin-bottom: 2rem;
        }
        
        .discord-login-btn {
            background: #5865F2;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);
        }
        
        .discord-login-btn:hover {
            background: #4752c4;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(88, 101, 242, 0.4);
        }
        
        .loading {
            display: none;
            margin-top: 1.5rem;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 1rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            display: none;
            border-left: 4px solid var(--danger);
        }
        
        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: rgba(15, 23, 42, 0.95);
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(99, 102, 241, 0.2);
            backdrop-filter: blur(10px);
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .modal-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.85rem 1rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            font-size: 1rem;
            color: var(--text);
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        /* Settings */
        .settings-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 2rem;
        }
        
        .settings-section h3 {
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .settings-section h3 i {
            color: var(--primary);
        }
        
        .webhook-container {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        .webhook-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .webhook-title {
            font-weight: 600;
            color: var(--text);
        }
        
        .webhook-input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .webhook-input {
            flex: 1;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            color: var(--text);
            font-size: 0.9rem;
        }
        
        .role-management {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .role-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
        }
        
        .role-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }
        
        .role-emoji {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        
        .role-input-group {
            margin-bottom: 1rem;
        }
        
        .role-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .role-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }
        
        .role-id {
            font-size: 0.8rem;
            color: var(--text-lighter);
            margin-bottom: 1rem;
        }
        
        .add-role-btn {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .add-role-btn:hover {
            background: rgba(16, 185, 129, 0.2);
        }
        
        .remove-role-btn {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .remove-role-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        .history-item {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .history-action {
            font-weight: 600;
            color: var(--text);
        }
        
        .history-date {
            font-size: 0.8rem;
            color: var(--text-lighter);
        }
        
        .history-details {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 1100;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            max-width: 400px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--secondary) 0%, #0d966c 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }
        
        /* Warnungs-Badge */
        .warning-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .nav-item {
            position: relative;
        }
        
        /* Warning Button */
        .btn-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .btn-warning:hover {
            background: rgba(245, 158, 11, 0.3);
            transform: translateY(-2px);
        }
        
        /* Hidden utility */
        .hidden {
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 70px;
                padding: 1.5rem 0.5rem;
            }
            
            .sidebar-title, .user-details, .nav-item span {
                display: none;
            }
            
            .sidebar-header {
                justify-content: center;
            }
            
            .user-info {
                justify-content: center;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage">
        <div class="login-container">
            <div class="login-logo">KL</div>
            <h1 class="login-title">KhusLand Panel</h1>
            <p class="login-subtitle">Bitte mit Discord anmelden um fortzufahren</p>
            
            <div class="error-message" id="errorMessage"></div>
            
            <button id="discordLogin" class="discord-login-btn">
                <i class="fab fa-discord"></i> Mit Discord anmelden
            </button>
            
            <div class="loading" id="loginLoading">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: var(--text-light);">Anmeldung l√§uft...</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainContent" class="app-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">KL</div>
                <div class="sidebar-title">KhusLand</div>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-tab="users">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                    <div class="warning-badge hidden" id="userWarningBadge">!</div>
                </a>
                <a href="#" class="nav-item" data-tab="settings">
                    <i class="fas fa-cog"></i>
                    <span>Einstellungen</span>
                </a>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Benutzer</div>
                        <div class="user-role" id="userRole">Administrator</div>
                    </div>
                </div>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Abmelden
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <div class="header">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="header-actions">
                        <div class="status-badge">
                            <i class="fas fa-circle"></i>
                            <span>Alle Systeme Online</span>
                        </div>
                        <button class="btn btn-primary" id="addUserBtn">
                            <i class="fas fa-user-plus"></i>
                            Spieler einstellen
                        </button>
                    </div>
                </div>
                
                <div class="cards-grid">
                    <div class="card" data-page="index.html">
                        <div class="card-icon">üåø</div>
                        <h3 class="card-title">Weed Ankauf</h3>
                        <div class="card-content">
                            Den Weed-Einkauf auf korrekte Abl√§ufe und Vollst√§ndigkeit √ºberpr√ºfen.
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <div class="status-indicator status-offline"></div>
                                <span>System offline</span>
                            </div>
                            <div class="access-badge access-allowed">Zugriff</div>
                        </div>
                    </div>
                    
                    <div class="card" data-page="seite2.html">
                        <div class="card-icon">‚ùÑÔ∏è</div>
                        <h3 class="card-title">Kokain Ankauf</h3>
                        <div class="card-content">
                            Den Kokain-Einkauf auf korrekte Abl√§ufe und Vollst√§ndigkeit √ºberpr√ºfen.
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <div class="status-indicator status-online"></div>
                                <span>System online</span>
                            </div>
                            <div class="access-badge access-allowed">Zugriff</div>
                        </div>
                    </div>
                    
                    <div class="card" data-page="seite3.html">
                        <div class="card-icon">‚ôªÔ∏è</div>
                        <h3 class="card-title">Materialrecycler - Produkte</h3>
                        <div class="card-content">
                            Recyclingprozesse sowie die daraus entstandenen Materialien verwalten.
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <div class="status-indicator status-online"></div>
                                <span>System online</span>
                            </div>
                            <div class="access-badge access-allowed">Zugriff</div>
                        </div>
                    </div>
                    
                    <div class="card" data-page="seite4.html">
                        <div class="card-icon">üîß</div>
                        <h3 class="card-title">Werkbank Manager</h3>
                        <div class="card-content">
                            √úberpr√ºfe, dass alle Rohstoffe f√ºr die Werkstatt vorhanden sind.
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <div class="status-indicator status-online"></div>
                                <span>System online</span>
                            </div>
                            <div class="access-badge access-allowed">Zugriff</div>
                        </div>
                    </div>
                    
                    <div class="card" data-page="seite5.html">
                        <div class="card-icon">üõ£Ô∏è</div>
                        <h3 class="card-title">Drogenrouten</h3>
                        <div class="card-content">
                            Behalte die Drogenrouten im Blick.
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <div class="status-indicator status-online"></div>
                                <span>System online</span>
                            </div>
                            <div class="access-badge access-allowed">Zugriff</div>
                        </div>
                    </div>
                    
                    <div class="card" data-page="management">
                        <div class="card-icon">üèûÔ∏è</div>
                        <h3 class="card-title">KhusLand Management</h3>
                        <div class="card-content">
                            Verwalten Sie Mitarbeiter.
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <div class="status-indicator status-online"></div>
                                <span>System online</span>
                            </div>
                            <div class="access-badge access-allowed">Zugriff</div>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h2 class="table-title">Aktive Benutzer</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="refreshUsers">
                                <i class="fas fa-sync-alt"></i>
                                Aktualisieren
                            </button>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Benutzer</th>
                                <th>Rolle</th>
                                <th>Eingestellt am</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Users Tab -->
            <div id="users" class="tab-content hidden">
                <div class="header">
                    <h1 class="page-title">User Management</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="addUserBtn2">
                            <i class="fas fa-user-plus"></i>
                            Spieler einstellen
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h2 class="table-title">Eingestellte Spieler</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="exportUsers">
                                <i class="fas fa-download"></i>
                                Exportieren
                            </button>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Benutzer</th>
                                <th>Rolle</th>
                                <th>Eingestellt am</th>
                                <th>Eingestellt von</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="userManagementTableBody">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content hidden">
                <div class="header">
                    <h1 class="page-title">Einstellungen</h1>
                </div>
                
                <!-- Discord Webhooks Konfiguration -->
                <div class="settings-section">
                    <h3><i class="fab fa-discord"></i> Discord Webhooks Konfiguration</h3>
                    
                    <div class="webhook-container">
                        <div class="webhook-header">
                            <div class="webhook-title">üéÆ Spieler Einstellungen</div>
                        </div>
                        <div class="webhook-input-group">
                            <input type="text" id="webhookHiring" class="webhook-input" placeholder="Webhook URL f√ºr Spieler-Einstellungen">
                            <button class="btn btn-primary test-webhook" data-type="hiring">
                                <i class="fas fa-bell"></i> Testen
                            </button>
                            <button class="btn btn-success save-webhook" data-type="hiring">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </div>
                    </div>
                    
                    <div class="webhook-container">
                        <div class="webhook-header">
                            <div class="webhook-title">üéñÔ∏è Bef√∂rderungen</div>
                        </div>
                        <div class="webhook-input-group">
                            <input type="text" id="webhookPromotions" class="webhook-input" placeholder="Webhook URL f√ºr Bef√∂rderungen">
                            <button class="btn btn-primary test-webhook" data-type="promotions">
                                <i class="fas fa-bell"></i> Testen
                            </button>
                            <button class="btn btn-success save-webhook" data-type="promotions">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </div>
                    </div>
                    
                    <div class="webhook-container">
                        <div class="webhook-header">
                            <div class="webhook-title">üìâ Degradierungen</div>
                        </div>
                        <div class="webhook-input-group">
                            <input type="text" id="webhookDemotions" class="webhook-input" placeholder="Webhook URL f√ºr Degradierungen">
                            <button class="btn btn-primary test-webhook" data-type="demotions">
                                <i class="fas fa-bell"></i> Testen
                            </button>
                            <button class="btn btn-success save-webhook" data-type="demotions">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </div>
                    </div>
                    
                    <div class="webhook-container">
                        <div class="webhook-header">
                            <div class="webhook-title">üö™ K√ºndigungen</div>
                        </div>
                        <div class="webhook-input-group">
                            <input type="text" id="webhookTerminations" class="webhook-input" placeholder="Webhook URL f√ºr K√ºndigungen">
                            <button class="btn btn-primary test-webhook" data-type="terminations">
                                <i class="fas fa-bell"></i> Testen
                            </button>
                            <button class="btn btn-success save-webhook" data-type="terminations">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </div>
                    </div>
                    
                    <!-- NEUER WEBHOOK F√úR TEAM VERWARNUNG -->
                    <div class="webhook-container">
                        <div class="webhook-header">
                            <div class="webhook-title">‚ö†Ô∏è Team Verwarnungen</div>
                        </div>
                        <div class="webhook-input-group">
                            <input type="text" id="webhookWarnings" class="webhook-input" placeholder="Webhook URL f√ºr Team Verwarnungen">
                            <button class="btn btn-primary test-webhook" data-type="warnings">
                                <i class="fas fa-bell"></i> Testen
                            </button>
                            <button class="btn btn-success save-webhook" data-type="warnings">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Rollenverwaltung -->
                <div class="settings-section">
                    <h3><i class="fas fa-user-shield"></i> Rollenverwaltung</h3>
                    <div class="role-management" id="roleManagement">
                        <!-- Roles will be populated here -->
                    </div>
                    <button class="add-role-btn" id="addRoleBtn">
                        <i class="fas fa-plus"></i> Neue Rolle hinzuf√ºgen
                    </button>
                </div>
                
                <!-- Aktionshistorie -->
                <div class="settings-section">
                    <h3><i class="fas fa-history"></i> Aktionshistorie</h3>
                    <div id="actionHistory">
                        <!-- History will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <h2 class="modal-title">Spieler einstellen</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="discordUserId">Discord User ID</label>
                <input type="text" id="discordUserId" class="form-input" placeholder="123456789012345678">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="playerName">Spieler Name</label>
                <input type="text" id="playerName" class="form-input" placeholder="Name des Spielers">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="userRoleSelect">Rolle</label>
                <select id="userRoleSelect" class="form-input">
                    <!-- Roles will be populated here -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="hiringReason">Grund</label>
                <textarea id="hiringReason" class="form-input form-textarea" placeholder="Grund f√ºr die Einstellung..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn" id="cancelAddUser">Abbrechen</button>
                <button class="btn btn-primary" id="saveUser">Spieler einstellen</button>
            </div>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div id="promotionModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <h2 class="modal-title">Spieler bef√∂rdern</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="promotionUserId">User ID</label>
                <input type="text" id="promotionUserId" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="promotionRoleSelect">Neue Rolle</label>
                <select id="promotionRoleSelect" class="form-input">
                    <!-- Roles will be populated here -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="promotionReason">Grund</label>
                <textarea id="promotionReason" class="form-input form-textarea" placeholder="Grund f√ºr die Bef√∂rderung..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn" id="cancelPromotion">Abbrechen</button>
                <button class="btn btn-primary" id="savePromotion">Bef√∂rderung best√§tigen</button>
            </div>
        </div>
    </div>

    <!-- Demotion Modal -->
    <div id="demotionModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <h2 class="modal-title">Spieler degradieren</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="demotionUserId">User ID</label>
                <input type="text" id="demotionUserId" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="demotionRoleSelect">Neue Rolle</label>
                <select id="demotionRoleSelect" class="form-input">
                    <!-- Roles will be populated here -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="demotionReason">Grund</label>
                <textarea id="demotionReason" class="form-input form-textarea" placeholder="Grund f√ºr die Degradierung..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn" id="cancelDemotion">Abbrechen</button>
                <button class="btn btn-warning" id="saveDemotion">Degradierung best√§tigen</button>
            </div>
        </div>
    </div>

    <!-- Termination Modal -->
    <div id="terminationModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-times"></i>
                </div>
                <h2 class="modal-title">Spieler k√ºndigen</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="terminationUserId">User ID</label>
                <input type="text" id="terminationUserId" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="terminationReason">Grund</label>
                <textarea id="terminationReason" class="form-input form-textarea" placeholder="Grund f√ºr die K√ºndigung..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn" id="cancelTermination">Abbrechen</button>
                <button class="btn btn-danger" id="saveTermination">K√ºndigung best√§tigen</button>
            </div>
        </div>
    </div>

    <!-- Warning Modal -->
    <div id="warningModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon" style="background: var(--danger);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2 class="modal-title">Team Verwarnung</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="warningUserId">User ID</label>
                <input type="text" id="warningUserId" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="warningReason">Verwarnungsgrund</label>
                <textarea id="warningReason" class="form-input form-textarea" placeholder="Grund f√ºr die Verwarnung..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn" id="cancelWarning">Abbrechen</button>
                <button class="btn btn-danger" id="saveWarning">Verwarnung senden</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification hidden"></div>

    <script type="module">
        // Firebase Import und Konfiguration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, push, onValue, remove, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
            authDomain: "khusland-b7d13.firebaseapp.com",
            databaseURL: "https://khusland-b7d13-default-rtdb.firebaseio.com",
            projectId: "khusland-b7d13",
            storageBucket: "khusland-b7d13.firebasestorage.app",
            messagingSenderId: "69573193613",
            appId: "1:69573193613:web:86c4d839281b1e343cd7c4",
            measurementId: "G-JSCWR4207G"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Discord OAuth Konfiguration - KORRIGIERT
        const DISCORD_CLIENT_ID = '1432942180770644079';
        const DISCORD_REDIRECT_URI = 'https://freedomworld1.github.io/KhusLand/';
        const BACKEND_URL = 'https://discord-oauth.ehrlichcolin2.workers.dev';

        // Seiten-URLs f√ºr Weiterleitungen - KORRIGIERT: Management bleibt auf der Seite
        const PAGE_URLS = {
            'index.html': 'https://freedomworld1.github.io/KhusLand/index.html',
            'seite2.html': 'https://freedomworld1.github.io/KhusLand/seite2.html',
            'seite3.html': 'https://freedomworld1.github.io/KhusLand/seite3.html',
            'seite4.html': 'https://freedomworld1.github.io/KhusLand/seite4.html',
            'seite5.html': 'https://freedomworld1.github.io/KhusLand/seite5.html',
            'management': '#' // Management bleibt auf der aktuellen Seite
        };

        // System Variablen
        let currentUser = null;
        let userRoles = [];
        let customRoles = [];
        let actionHistory = [];
        let webhooks = {
            hiring: '',
            promotions: '',
            demotions: '',
            terminations: '',
            warnings: ''
        };

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const mainContent = document.getElementById('mainContent');
        const errorMessage = document.getElementById('errorMessage');
        const discordLoginBtn = document.getElementById('discordLogin');
        const loginLoading = document.getElementById('loginLoading');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userAvatar = document.getElementById('userAvatar');
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const userTableBody = document.getElementById('userTableBody');
        const userManagementTableBody = document.getElementById('userManagementTableBody');
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserBtn2 = document.getElementById('addUserBtn2');
        const addUserModal = document.getElementById('addUserModal');
        const cancelAddUser = document.getElementById('cancelAddUser');
        const saveUser = document.getElementById('saveUser');
        const promotionModal = document.getElementById('promotionModal');
        const cancelPromotion = document.getElementById('cancelPromotion');
        const savePromotion = document.getElementById('savePromotion');
        const demotionModal = document.getElementById('demotionModal');
        const cancelDemotion = document.getElementById('cancelDemotion');
        const saveDemotion = document.getElementById('saveDemotion');
        const terminationModal = document.getElementById('terminationModal');
        const cancelTermination = document.getElementById('cancelTermination');
        const saveTermination = document.getElementById('saveTermination');
        const warningModal = document.getElementById('warningModal');
        const cancelWarning = document.getElementById('cancelWarning');
        const saveWarning = document.getElementById('saveWarning');
        const refreshUsers = document.getElementById('refreshUsers');
        const exportUsers = document.getElementById('exportUsers');
        const roleManagement = document.getElementById('roleManagement');
        const addRoleBtn = document.getElementById('addRoleBtn');
        const actionHistoryContainer = document.getElementById('actionHistory');
        const notification = document.getElementById('notification');
        const userWarningBadge = document.getElementById('userWarningBadge');

        // Firebase Referenzen
        const usersRef = ref(db, 'users');
        const rolesRef = ref(db, 'roles');
        const historyRef = ref(db, 'history');
        const webhooksRef = ref(db, 'webhooks');
        const warningsRef = ref(db, 'warnings');

        // Debug-Funktion f√ºr OAuth
        function debugOAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            
            console.log('üîç OAuth Debug Information:');
            console.log('URL Parameters:', {
                code: code ? code.substring(0, 10) + '...' : 'none',
                error: error || 'none',
                errorDescription: errorDescription || 'none',
                fullURL: window.location.href
            });
            
            if (error) {
                console.error('‚ùå Discord OAuth Error:', error, errorDescription);
                showError(`Discord Fehler: ${error} - ${errorDescription}`);
            }
            
            // Teste Backend-Verbindung
            testBackendConnection();
        }

        async function testBackendConnection() {
            try {
                console.log('üîß Testing backend connection...');
                const response = await fetch(`${BACKEND_URL}/health`);
                console.log('Backend Status:', response.status, response.ok ? 'OK' : 'ERROR');
            } catch (error) {
                console.error('‚ùå Backend nicht erreichbar:', error);
            }
        }

        // Initialisiere Standardrollen, falls keine vorhanden sind
        async function initializeDefaultRoles() {
            const rolesSnapshot = await get(rolesRef);
            if (!rolesSnapshot.exists() || rolesSnapshot.numChildren() === 0) {
                const defaultRoles = [
                    {
                        id: 'role_admin',
                        name: 'Administrator',
                        discordRoleId: '',
                        emoji: 'üëë',
                        color: 'role-admin'
                    },
                    {
                        id: 'role_moderator',
                        name: 'Moderator',
                        discordRoleId: '',
                        emoji: 'üõ°Ô∏è',
                        color: 'role-moderator'
                    },
                    {
                        id: 'role_developer',
                        name: 'Developer',
                        discordRoleId: '',
                        emoji: 'üíª',
                        color: 'role-developer'
                    },
                    {
                        id: 'role_supporter',
                        name: 'Supporter',
                        discordRoleId: '',
                        emoji: 'üîß',
                        color: 'role-supporter'
                    }
                ];
                
                for (const role of defaultRoles) {
                    await push(rolesRef, role);
                }
                console.log('‚úÖ Standardrollen initialisiert');
            }
        }

        // Discord OAuth Funktionen - VERBESSERT
        function startDiscordOAuth() {
            const scope = 'identify';
            const state = generateRandomState();
            
            sessionStorage.setItem('oauth_state', state);
            
            const authUrl = new URL('https://discord.com/api/oauth2/authorize');
            authUrl.searchParams.set('client_id', DISCORD_CLIENT_ID);
            authUrl.searchParams.set('redirect_uri', DISCORD_REDIRECT_URI);
            authUrl.searchParams.set('response_type', 'code');
            authUrl.searchParams.set('scope', scope);
            authUrl.searchParams.set('state', state);
            authUrl.searchParams.set('prompt', 'none');
            
            console.log('üöÄ Starting OAuth with URL:', authUrl.toString());
            window.location.href = authUrl.toString();
        }

        function generateRandomState() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        async function exchangeCodeForToken(code) {
            try {
                loginLoading.style.display = 'block';
                discordLoginBtn.disabled = true;
                errorMessage.style.display = 'none';
                
                console.log('üîÑ Starte Token-Austausch mit Code:', code.substring(0, 10) + '...');
                
                const response = await fetch(`${BACKEND_URL}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        code: code, 
                        redirect_uri: DISCORD_REDIRECT_URI
                    })
                });

                console.log('üì® Token Response Status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Worker Error Response:', errorText);
                    throw new Error(`Worker responded with status ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Token Response Data received');

                if (data.access_token) {
                    await verifyUser(data.access_token);
                } else {
                    throw new Error('Kein Access Token erhalten: ' + JSON.stringify(data));
                }
            } catch (error) {
                console.error('‚ùå Fehler beim Token-Austausch:', error);
                showError('Fehler bei der Anmeldung: ' + error.message);
                loginLoading.style.display = 'none';
                discordLoginBtn.disabled = false;
            }
        }

        async function verifyUser(accessToken) {
            try {
                console.log('üë§ Verifiziere Benutzer mit Token');
                
                const response = await fetch(`${BACKEND_URL}/verify-user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        accessToken: accessToken
                    })
                });

                console.log('üì® Verify Response Status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Verify Error Response:', errorText);
                    throw new Error(`Verify failed with status ${response.status}: ${errorText}`);
                }

                const userData = await response.json();
                console.log('‚úÖ User Data received:', userData);

                if (userData.id) {
                    currentUser = userData;
                    await initializeDefaultRoles();
                    await loadRoles();
                    await loadWebhooks();
                    await loadHistory();
                    await loadWarnings();
                    showMainApp();
                } else {
                    throw new Error('Ung√ºltige Benutzerdaten erhalten: ' + JSON.stringify(userData));
                }
            } catch (error) {
                console.error('‚ùå Fehler bei der Benutzerverifikation:', error);
                showError('Fehler bei der Benutzerverifikation: ' + error.message);
                loginLoading.style.display = 'none';
                discordLoginBtn.disabled = false;
            }
        }

        // Alternative OAuth Implementierung (falls Backend nicht funktioniert)
        function startDirectDiscordOAuth() {
            const authUrl = new URL('https://discord.com/api/oauth2/authorize');
            authUrl.searchParams.set('client_id', DISCORD_CLIENT_ID);
            authUrl.searchParams.set('redirect_uri', DISCORD_REDIRECT_URI);
            authUrl.searchParams.set('response_type', 'token'); // implicit grant
            authUrl.searchParams.set('scope', 'identify');
            authUrl.searchParams.set('state', generateRandomState());
            
            console.log('üöÄ Starting Direct OAuth with URL:', authUrl.toString());
            window.location.href = authUrl.toString();
        }

        function handleImplicitGrant() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            
            if (accessToken) {
                console.log('‚úÖ Implicit grant access token received');
                verifyUserDirect(accessToken);
                // Entferne Token aus URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function verifyUserDirect(accessToken) {
            try {
                console.log('üë§ Verifiziere Benutzer direkt mit Token');
                const response = await fetch('https://discord.com/api/users/@me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData;
                    console.log('‚úÖ User verified directly:', userData);
                    await initializeDefaultRoles();
                    await loadRoles();
                    await loadWebhooks();
                    await loadHistory();
                    await loadWarnings();
                    showMainApp();
                } else {
                    throw new Error('Failed to fetch user data: ' + response.status);
                }
            } catch (error) {
                console.error('‚ùå Fehler bei direkter Benutzerverifikation:', error);
                showError('Anmeldung fehlgeschlagen: ' + error.message);
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function showMainApp() {
            loginPage.style.display = 'none';
            mainContent.classList.remove('hidden');
            
            // Benutzerdaten anzeigen
            userName.textContent = currentUser.username;
            userRole.textContent = 'Administrator';
            
            if (currentUser.avatar) {
                userAvatar.style.backgroundImage = `url(https://cdn.discordapp.com/avatars/${currentUser.id}/${currentUser.avatar}.png)`;
                userAvatar.innerHTML = '';
            }
            
            // Event Listener initialisieren
            initializeEventListeners();
            
            // Standardm√§√üig zum Dashboard-Tab wechseln
            switchTab('dashboard');
            
            // Daten laden
            loadUsers();
            
            console.log('‚úÖ Main App erfolgreich geladen');
        }

        function initializeEventListeners() {
            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = item.dataset.tab;
                    switchTab(tab);
                });
            });

            // Logout
            logoutBtn.addEventListener('click', () => {
                sessionStorage.clear();
                window.location.href = window.location.origin + window.location.pathname;
            });

            // Modals
            addUserBtn.addEventListener('click', () => addUserModal.classList.add('active'));
            addUserBtn2.addEventListener('click', () => addUserModal.classList.add('active'));
            cancelAddUser.addEventListener('click', () => addUserModal.classList.remove('active'));
            
            // User Management
            refreshUsers.addEventListener('click', loadUsers);
            exportUsers.addEventListener('click', exportUsersToCSV);
            
            // Rollenverwaltung
            addRoleBtn.addEventListener('click', addNewRole);
            
            // Webhook Event Listener
            document.querySelectorAll('.save-webhook').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.target.closest('button').dataset.type;
                    saveWebhook(type);
                });
            });
            
            document.querySelectorAll('.test-webhook').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.target.closest('button').dataset.type;
                    testDiscordWebhook(type);
                });
            });

            // Card Klicks - KORRIGIERT: Management bleibt auf der Seite
            document.querySelectorAll('.card').forEach(card => {
                card.addEventListener('click', () => {
                    const page = card.dataset.page;
                    
                    // √úberspringe Weiterleitung f√ºr Management
                    if (page === 'management') {
                        // Wechsle zum User Management Tab statt weiterzuleiten
                        switchTab('users');
                        showNotification('User Management wurde geladen', 'success');
                        return;
                    }
                    
                    // F√ºr andere Seiten normale Weiterleitung
                    if (page && PAGE_URLS[page] && page !== 'management') {
                        window.open(PAGE_URLS[page], '_blank');
                    }
                });
            });

            // Modal Event Listener
            cancelPromotion.addEventListener('click', () => promotionModal.classList.remove('active'));
            cancelDemotion.addEventListener('click', () => demotionModal.classList.remove('active'));
            cancelTermination.addEventListener('click', () => terminationModal.classList.remove('active'));
            cancelWarning.addEventListener('click', () => warningModal.classList.remove('active'));
            
            // User Action Event Listener
            saveUser.addEventListener('click', addNewUser);
            savePromotion.addEventListener('click', promoteUser);
            saveDemotion.addEventListener('click', demoteUser);
            saveTermination.addEventListener('click', terminateUser);
            saveWarning.addEventListener('click', warnUser);
        }

        function switchTab(tabName) {
            // Navigation aktualisieren
            navItems.forEach(item => {
                item.classList.toggle('active', item.dataset.tab === tabName);
            });
            
            // Tab Inhalte anzeigen/verstecken
            tabContents.forEach(tab => {
                tab.classList.toggle('hidden', tab.id !== tabName);
            });
        }

        // Rollen Management
        async function loadRoles() {
            try {
                const snapshot = await get(rolesRef);
                if (snapshot.exists()) {
                    customRoles = [];
                    snapshot.forEach((childSnapshot) => {
                        customRoles.push(childSnapshot.val());
                    });
                    updateRoleSelects();
                    updateRoleManagement();
                }
            } catch (error) {
                console.error('Fehler beim Laden der Rollen:', error);
            }
        }

        async function saveRoles() {
            try {
                // L√∂sche alle vorhandenen Rollen
                await remove(rolesRef);
                
                // Speichere alle Rollen neu
                for (const role of customRoles) {
                    await push(rolesRef, role);
                }
                
                showNotification('Rollen erfolgreich gespeichert', 'success');
            } catch (error) {
                console.error('Fehler beim Speichern der Rollen:', error);
                showNotification('Fehler beim Speichern der Rollen', 'error');
            }
        }

        function updateRoleSelects() {
            const roleSelects = [
                document.getElementById('userRoleSelect'),
                document.getElementById('promotionRoleSelect'),
                document.getElementById('demotionRoleSelect')
            ];

            roleSelects.forEach(select => {
                if (select) {
                    select.innerHTML = '';
                    customRoles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = `${role.emoji || 'üéØ'} ${role.name}`;
                        option.dataset.discordRoleId = role.discordRoleId || '';
                        select.appendChild(option);
                    });
                }
            });
        }

        function updateRoleManagement() {
            roleManagement.innerHTML = '';
            
            customRoles.forEach((role, index) => {
                const roleCard = document.createElement('div');
                roleCard.className = 'role-card';
                roleCard.innerHTML = `
                    <div class="role-emoji">${role.emoji || 'üéØ'}</div>
                    <div class="role-input-group">
                        <input type="text" class="role-input role-name-input" 
                               value="${role.name}" placeholder="Rollenname"
                               data-index="${index}">
                        <input type="text" class="role-input role-id-input" 
                               value="${role.discordRoleId || ''}" placeholder="Discord Role ID"
                               data-index="${index}">
                    </div>
                    <div class="role-name">${role.name}</div>
                    <div class="role-id">ID: ${role.discordRoleId || 'Nicht gesetzt'}</div>
                    <button class="remove-role-btn" data-index="${index}">
                        <i class="fas fa-trash"></i> Rolle entfernen
                    </button>
                `;
                roleManagement.appendChild(roleCard);
            });

            // Event-Listener f√ºr Rollen-Inputs
            document.querySelectorAll('.role-name-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    customRoles[index].name = e.target.value;
                    saveRoles();
                });
            });

            document.querySelectorAll('.role-id-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    customRoles[index].discordRoleId = e.target.value;
                    saveRoles();
                });
            });

            document.querySelectorAll('.remove-role-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('button').dataset.index;
                    customRoles.splice(index, 1);
                    updateRoleManagement();
                    saveRoles();
                });
            });
        }

        function addNewRole() {
            const newRole = {
                id: 'role_' + Date.now(),
                name: 'Neue Rolle',
                discordRoleId: '',
                emoji: 'üéØ',
                color: 'role-supporter'
            };
            
            customRoles.push(newRole);
            updateRoleManagement();
            saveRoles();
        }

        // User Management
        async function loadUsers() {
            try {
                const snapshot = await get(usersRef);
                userTableBody.innerHTML = '';
                userManagementTableBody.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        if (user.status !== 'terminated') {
                            addUserToTable(user, userTableBody);
                        }
                        addUserToManagementTable(user, userManagementTableBody);
                    });
                }
            } catch (error) {
                console.error('Fehler beim Laden der Benutzer:', error);
            }
        }

        function addUserToTable(user, tableBody) {
            const row = document.createElement('tr');
            
            const roleInfo = customRoles.find(role => role.id === user.role) || { name: 'Unbekannt', color: 'role-supporter' };
            
            row.innerHTML = `
                <td>
                    <div class="user-cell">
                        <div class="user-avatar-small">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-info-small">
                            <div class="user-name-small">${user.name}</div>
                            <div class="user-id">ID: ${user.id}</div>
                        </div>
                    </div>
                </td>
                <td><span class="role-badge ${roleInfo.color}">${roleInfo.name}</span></td>
                <td>${new Date(user.hiredAt).toLocaleDateString('de-DE')}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon btn-promote promote-user" data-userid="${user.id}">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="btn-icon btn-demote demote-user" data-userid="${user.id}">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="btn-icon btn-terminate terminate-user" data-userid="${user.id}">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="btn-icon btn-warning warn-user" data-userid="${user.id}">
                            <i class="fas fa-exclamation-triangle"></i>
                        </button>
                    </div>
                </td>
            `;
            
            tableBody.appendChild(row);
            
            // Event Listener f√ºr Aktionen
            row.querySelector('.promote-user').addEventListener('click', () => openPromotionModal(user));
            row.querySelector('.demote-user').addEventListener('click', () => openDemotionModal(user));
            row.querySelector('.terminate-user').addEventListener('click', () => openTerminationModal(user));
            row.querySelector('.warn-user').addEventListener('click', () => openWarningModal(user));
        }

        function addUserToManagementTable(user, tableBody) {
            const row = document.createElement('tr');
            
            const roleInfo = customRoles.find(role => role.id === user.role) || { name: 'Unbekannt', color: 'role-supporter' };
            
            row.innerHTML = `
                <td>
                    <div class="user-cell">
                        <div class="user-avatar-small">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-info-small">
                            <div class="user-name-small">${user.name}</div>
                            <div class="user-id">ID: ${user.id}</div>
                        </div>
                    </div>
                </td>
                <td><span class="role-badge ${roleInfo.color}">${roleInfo.name}</span></td>
                <td>${new Date(user.hiredAt).toLocaleDateString('de-DE')}</td>
                <td>${user.hiredByName || 'Unbekannt'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon btn-promote promote-user" data-userid="${user.id}">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="btn-icon btn-demote demote-user" data-userid="${user.id}">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="btn-icon btn-terminate terminate-user" data-userid="${user.id}">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="btn-icon btn-warning warn-user" data-userid="${user.id}">
                            <i class="fas fa-exclamation-triangle"></i>
                        </button>
                    </div>
                </td>
            `;
            
            tableBody.appendChild(row);
            
            // Event Listener f√ºr Aktionen
            row.querySelector('.promote-user').addEventListener('click', () => openPromotionModal(user));
            row.querySelector('.demote-user').addEventListener('click', () => openDemotionModal(user));
            row.querySelector('.terminate-user').addEventListener('click', () => openTerminationModal(user));
            row.querySelector('.warn-user').addEventListener('click', () => openWarningModal(user));
        }

        // Modal Functions
        function openPromotionModal(user) {
            document.getElementById('promotionUserId').value = user.id;
            promotionModal.classList.add('active');
        }

        function openDemotionModal(user) {
            document.getElementById('demotionUserId').value = user.id;
            demotionModal.classList.add('active');
        }

        function openTerminationModal(user) {
            document.getElementById('terminationUserId').value = user.id;
            terminationModal.classList.add('active');
        }

        function openWarningModal(user) {
            document.getElementById('warningUserId').value = user.id;
            warningModal.classList.add('active');
        }

        // User Actions
        async function addNewUser() {
            const discordUserId = document.getElementById('discordUserId').value;
            const playerName = document.getElementById('playerName').value;
            const roleSelect = document.getElementById('userRoleSelect');
            const selectedOption = roleSelect.options[roleSelect.selectedIndex];
            const roleId = roleSelect.value;
            const discordRoleId = selectedOption.dataset.discordRoleId;
            const reason = document.getElementById('hiringReason').value;

            if (!discordUserId || !playerName || !roleId) {
                showNotification('Bitte f√ºlle alle erforderlichen Felder aus', 'warning');
                return;
            }

            try {
                const userData = {
                    id: discordUserId,
                    name: playerName,
                    role: roleId,
                    discordRoleId: discordRoleId,
                    hiredBy: currentUser.id,
                    hiredByName: currentUser.username,
                    hiredAt: new Date().toISOString(),
                    status: 'active'
                };

                await set(child(usersRef, discordUserId), userData);
                
                // Sende Discord Webhook
                await sendDiscordWebhook('hiring', {
                    discordUserId: discordUserId,
                    playerName: playerName,
                    roleId: discordRoleId,
                    roleName: selectedOption.textContent,
                    reason: reason
                });

                // F√ºge zur Historie hinzu
                await addToHistory('hiring', {
                    targetUser: discordUserId,
                    targetName: playerName,
                    role: roleId,
                    reason: reason
                });

                showNotification('Spieler erfolgreich eingestellt', 'success');
                addUserModal.classList.remove('active');
                resetAddUserForm();
                loadUsers();

            } catch (error) {
                console.error('Fehler beim Einstellen des Spielers:', error);
                showNotification('Fehler beim Einstellen des Spielers', 'error');
            }
        }

        async function promoteUser() {
            const userId = document.getElementById('promotionUserId').value;
            const roleSelect = document.getElementById('promotionRoleSelect');
            const selectedOption = roleSelect.options[roleSelect.selectedIndex];
            const newRoleId = roleSelect.value;
            const discordRoleId = selectedOption.dataset.discordRoleId;
            const reason = document.getElementById('promotionReason').value;

            if (!userId || !newRoleId) {
                showNotification('Bitte f√ºlle alle erforderlichen Felder aus', 'warning');
                return;
            }

            try {
                const userRef = child(usersRef, userId);
                const userSnapshot = await get(userRef);
                
                if (userSnapshot.exists()) {
                    const user = userSnapshot.val();
                    const oldRole = user.role;
                    
                    await set(userRef, {
                        ...user,
                        role: newRoleId,
                        discordRoleId: discordRoleId
                    });

                    // Sende Discord Webhook
                    await sendDiscordWebhook('promotions', {
                        discordUserId: userId,
                        playerName: user.name,
                        roleId: discordRoleId,
                        roleName: selectedOption.textContent,
                        reason: reason
                    });

                    // F√ºge zur Historie hinzu
                    await addToHistory('promotion', {
                        targetUser: userId,
                        targetName: user.name,
                        oldRole: oldRole,
                        newRole: newRoleId,
                        reason: reason
                    });

                    showNotification('Spieler erfolgreich bef√∂rdert', 'success');
                    promotionModal.classList.remove('active');
                    loadUsers();
                }
            } catch (error) {
                console.error('Fehler beim Bef√∂rdern des Spielers:', error);
                showNotification('Fehler beim Bef√∂rdern des Spielers', 'error');
            }
        }

        async function demoteUser() {
            const userId = document.getElementById('demotionUserId').value;
            const roleSelect = document.getElementById('demotionRoleSelect');
            const selectedOption = roleSelect.options[roleSelect.selectedIndex];
            const newRoleId = roleSelect.value;
            const discordRoleId = selectedOption.dataset.discordRoleId;
            const reason = document.getElementById('demotionReason').value;

            if (!userId || !newRoleId) {
                showNotification('Bitte f√ºlle alle erforderlichen Felder aus', 'warning');
                return;
            }

            try {
                const userRef = child(usersRef, userId);
                const userSnapshot = await get(userRef);
                
                if (userSnapshot.exists()) {
                    const user = userSnapshot.val();
                    const oldRole = user.role;
                    
                    await set(userRef, {
                        ...user,
                        role: newRoleId,
                        discordRoleId: discordRoleId
                    });

                    // Sende Discord Webhook
                    await sendDiscordWebhook('demotions', {
                        discordUserId: userId,
                        playerName: user.name,
                        roleId: discordRoleId,
                        roleName: selectedOption.textContent,
                        reason: reason
                    });

                    // F√ºge zur Historie hinzu
                    await addToHistory('demotion', {
                        targetUser: userId,
                        targetName: user.name,
                        oldRole: oldRole,
                        newRole: newRoleId,
                        reason: reason
                    });

                    showNotification('Spieler erfolgreich degradiert', 'success');
                    demotionModal.classList.remove('active');
                    loadUsers();
                }
            } catch (error) {
                console.error('Fehler beim Degradieren des Spielers:', error);
                showNotification('Fehler beim Degradieren des Spielers', 'error');
            }
        }

        async function terminateUser() {
            const userId = document.getElementById('terminationUserId').value;
            const reason = document.getElementById('terminationReason').value;

            if (!userId) {
                showNotification('Bitte f√ºlle alle erforderlichen Felder aus', 'warning');
                return;
            }

            try {
                const userRef = child(usersRef, userId);
                const userSnapshot = await get(userRef);
                
                if (userSnapshot.exists()) {
                    const user = userSnapshot.val();
                    
                    await set(userRef, {
                        ...user,
                        status: 'terminated',
                        terminatedAt: new Date().toISOString(),
                        terminatedBy: currentUser.id,
                        terminationReason: reason
                    });

                    // Sende Discord Webhook
                    await sendDiscordWebhook('terminations', {
                        discordUserId: userId,
                        playerName: user.name,
                        roleId: user.discordRoleId,
                        roleName: customRoles.find(r => r.id === user.role)?.name || 'Unbekannt',
                        reason: reason
                    });

                    // F√ºge zur Historie hinzu
                    await addToHistory('termination', {
                        targetUser: userId,
                        targetName: user.name,
                        role: user.role,
                        reason: reason
                    });

                    showNotification('Spieler erfolgreich gek√ºndigt', 'success');
                    terminationModal.classList.remove('active');
                    loadUsers();
                }
            } catch (error) {
                console.error('Fehler beim K√ºndigen des Spielers:', error);
                showNotification('Fehler beim K√ºndigen des Spielers', 'error');
            }
        }

        async function warnUser() {
            const userId = document.getElementById('warningUserId').value;
            const reason = document.getElementById('warningReason').value;

            if (!userId || !reason) {
                showNotification('Bitte f√ºlle alle erforderlichen Felder aus', 'warning');
                return;
            }

            try {
                const userRef = child(usersRef, userId);
                const userSnapshot = await get(userRef);
                
                if (userSnapshot.exists()) {
                    const user = userSnapshot.val();
                    
                    // Speichere Verwarnung
                    const warningData = {
                        userId: userId,
                        userName: user.name,
                        reason: reason,
                        warnedBy: currentUser.id,
                        warnedByName: currentUser.username,
                        warnedAt: new Date().toISOString()
                    };

                    await push(warningsRef, warningData);

                    // Sende Discord Webhook
                    await sendDiscordWebhook('warnings', {
                        discordUserId: userId,
                        playerName: user.name,
                        roleId: user.discordRoleId,
                        roleName: customRoles.find(r => r.id === user.role)?.name || 'Unbekannt',
                        reason: reason
                    });

                    // F√ºge zur Historie hinzu
                    await addToHistory('warning', {
                        targetUser: userId,
                        targetName: user.name,
                        reason: reason
                    });

                    showNotification('Verwarnung erfolgreich gesendet', 'success');
                    warningModal.classList.remove('active');
                    await loadWarnings();
                }
            } catch (error) {
                console.error('Fehler beim Senden der Verwarnung:', error);
                showNotification('Fehler beim Senden der Verwarnung', 'error');
            }
        }

        function resetAddUserForm() {
            document.getElementById('discordUserId').value = '';
            document.getElementById('playerName').value = '';
            document.getElementById('userRoleSelect').selectedIndex = 0;
            document.getElementById('hiringReason').value = '';
        }

        // Webhook Functions
        async function loadWebhooks() {
            try {
                const snapshot = await get(webhooksRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    webhooks = { ...webhooks, ...data };
                    
                    // Webhook Inputs aktualisieren
                    document.getElementById('webhookHiring').value = webhooks.hiring || '';
                    document.getElementById('webhookPromotions').value = webhooks.promotions || '';
                    document.getElementById('webhookDemotions').value = webhooks.demotions || '';
                    document.getElementById('webhookTerminations').value = webhooks.terminations || '';
                    document.getElementById('webhookWarnings').value = webhooks.warnings || '';
                }
            } catch (error) {
                console.error('Fehler beim Laden der Webhooks:', error);
            }
        }

        async function saveWebhook(type) {
            const input = document.getElementById(`webhook${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const url = input.value.trim();
            
            if (url && !url.startsWith('https://discord.com/api/webhooks/')) {
                showNotification('Ung√ºltige Webhook URL', 'error');
                return;
            }

            try {
                webhooks[type] = url;
                await set(child(webhooksRef, type), url);
                showNotification(`Webhook f√ºr ${type} gespeichert`, 'success');
            } catch (error) {
                console.error('Fehler beim Speichern des Webhooks:', error);
                showNotification('Fehler beim Speichern des Webhooks', 'error');
            }
        }

        // Funktion zum Senden von Discord Webhook-Nachrichten
        async function sendDiscordWebhook(type, data) {
            const webhookUrl = webhooks[type];
            if (!webhookUrl) {
                console.warn(`Keine Webhook-URL f√ºr ${type} konfiguriert`);
                return;
            }

            try {
                // Hole die Rolleninformationen
                const roleId = data.roleId || data.discordRoleId;
                const roleName = data.roleName || 'Unbekannte Rolle';
                
                // Erstelle die Embed-Nachricht
                const embed = {
                    title: getWebhookTitle(type),
                    color: getWebhookColor(type),
                    timestamp: new Date().toISOString(),
                    fields: [],
                    footer: {
                        text: `KhusLand Panel ‚Ä¢ ${new Date().toLocaleDateString('de-DE')}`,
                        icon_url: "https://cdn.discordapp.com/embed/avatars/0.png"
                    }
                };

                // F√ºge Felder basierend auf dem Typ hinzu
                switch (type) {
                    case 'hiring':
                        embed.description = `üéâ **Neuer Spieler eingestellt**`;
                        embed.fields.push(
                            { name: "üë§ Spieler", value: data.playerName || 'Unbekannt', inline: true },
                            { name: "üÜî Discord ID", value: data.discordUserId || 'Unbekannt', inline: true },
                            { name: "üéñÔ∏è Rolle", value: roleId ? `<@&${roleId}>` : roleName, inline: true },
                            { name: "üìù Grund", value: data.reason || 'Nicht angegeben', inline: false },
                            { name: "üë®‚Äçüíº Eingestellt von", value: `<@${currentUser.id}>`, inline: true }
                        );
                        break;

                    case 'promotions':
                        embed.description = `üìà **Spieler bef√∂rdert**`;
                        embed.fields.push(
                            { name: "üë§ Spieler", value: data.playerName || 'Unbekannt', inline: true },
                            { name: "üÜî Discord ID", value: data.discordUserId || 'Unbekannt', inline: true },
                            { name: "üéñÔ∏è Neue Rolle", value: roleId ? `<@&${roleId}>` : roleName, inline: true },
                            { name: "üìù Grund", value: data.reason || 'Nicht angegeben', inline: false },
                            { name: "üë®‚Äçüíº Bef√∂rdert von", value: `<@${currentUser.id}>`, inline: true }
                        );
                        break;

                    case 'demotions':
                        embed.description = `üìâ **Spieler degradiert**`;
                        embed.fields.push(
                            { name: "üë§ Spieler", value: data.playerName || 'Unbekannt', inline: true },
                            { name: "üÜî Discord ID", value: data.discordUserId || 'Unbekannt', inline: true },
                            { name: "üéñÔ∏è Neue Rolle", value: roleId ? `<@&${roleId}>` : roleName, inline: true },
                            { name: "üìù Grund", value: data.reason || 'Nicht angegeben', inline: false },
                            { name: "üë®‚Äçüíº Degradiert von", value: `<@${currentUser.id}>`, inline: true }
                        );
                        break;

                    case 'terminations':
                        embed.description = `üö™ **Spieler gek√ºndigt**`;
                        embed.fields.push(
                            { name: "üë§ Spieler", value: data.playerName || 'Unbekannt', inline: true },
                            { name: "üÜî Discord ID", value: data.discordUserId || 'Unbekannt', inline: true },
                            { name: "üéñÔ∏è Letzte Rolle", value: roleId ? `<@&${roleId}>` : roleName, inline: true },
                            { name: "üìù Grund", value: data.reason || 'Nicht angegeben', inline: false },
                            { name: "üë®‚Äçüíº Gek√ºndigt von", value: `<@${currentUser.id}>`, inline: true }
                        );
                        break;

                    case 'warnings':
                        embed.description = `‚ö†Ô∏è **Team Verwarnung**`;
                        embed.fields.push(
                            { name: "üë§ Spieler", value: data.playerName || 'Unbekannt', inline: true },
                            { name: "üÜî Discord ID", value: data.discordUserId || 'Unbekannt', inline: true },
                            { name: "üéñÔ∏è Aktuelle Rolle", value: roleId ? `<@&${roleId}>` : roleName, inline: true },
                            { name: "üìù Verwarnungsgrund", value: data.reason || 'Nicht angegeben', inline: false },
                            { name: "üë®‚Äçüíº Verwarnung von", value: `<@${currentUser.id}>`, inline: true }
                        );
                        break;
                }

                // Sende die Webhook-Nachricht
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        embeds: [embed]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Webhook fehlgeschlagen: ${response.status}`);
                }

                console.log(`Webhook ${type} erfolgreich gesendet`);
            } catch (error) {
                console.error(`Fehler beim Senden des Webhooks ${type}:`, error);
                showNotification(`Fehler beim Senden der Discord-Benachrichtigung`, 'error');
            }
        }

        // Hilfsfunktion f√ºr Webhook-Titel
        function getWebhookTitle(type) {
            const titles = {
                'hiring': 'Spieler Einstellung',
                'promotions': 'Bef√∂rderung',
                'demotions': 'Degradierung',
                'terminations': 'K√ºndigung',
                'warnings': 'Team Verwarnung'
            };
            return titles[type] || 'System Benachrichtigung';
        }

        // Hilfsfunktion f√ºr Webhook-Farben
        function getWebhookColor(type) {
            const colors = {
                'hiring': 0x10B981,    // Gr√ºn
                'promotions': 0x3B82F6, // Blau
                'demotions': 0xF59E0B,  // Orange
                'terminations': 0xEF4444, // Rot
                'warnings': 0xDC2626    // Dunkelrot
            };
            return colors[type] || 0x6366F1;
        }

        // Funktion zum Testen von Webhooks
        async function testDiscordWebhook(type) {
            const webhookUrl = webhooks[type];
            if (!webhookUrl) {
                showNotification(`Keine Webhook-URL f√ºr ${type} konfiguriert`, 'warning');
                return;
            }

            try {
                // Test-Daten f√ºr die Webhook-Nachricht
                const testData = {
                    playerName: 'Test Spieler',
                    discordUserId: '123456789012345678',
                    roleId: '123456789012345679', // Beispiel-Role-ID
                    roleName: 'Test Rolle',
                    reason: 'Dies ist ein Test der Webhook-Funktionalit√§t'
                };

                await sendDiscordWebhook(type, testData);
                showNotification(`Webhook ${type} erfolgreich getestet`, 'success');
            } catch (error) {
                console.error(`Fehler beim Testen des Webhooks ${type}:`, error);
                showNotification(`Fehler beim Testen des Webhooks`, 'error');
            }
        }

        // History Management
        async function loadHistory() {
            try {
                const snapshot = await get(historyRef);
                actionHistoryContainer.innerHTML = '';
                
                if (snapshot.exists()) {
                    const history = [];
                    snapshot.forEach((childSnapshot) => {
                        history.push(childSnapshot.val());
                    });
                    
                    // Sortiere nach Datum (neueste zuerst)
                    history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // Zeige die letzten 20 Eintr√§ge
                    history.slice(0, 20).forEach(entry => {
                        addHistoryItem(entry);
                    });
                }
            } catch (error) {
                console.error('Fehler beim Laden der Historie:', error);
            }
        }

        async function addToHistory(action, details) {
            try {
                const historyEntry = {
                    action: action,
                    details: details,
                    user: currentUser.id,
                    userName: currentUser.username,
                    timestamp: new Date().toISOString()
                };

                await push(historyRef, historyEntry);
                await loadHistory(); // Aktualisiere die Anzeige
            } catch (error) {
                console.error('Fehler beim Hinzuf√ºgen zur Historie:', error);
            }
        }

        function addHistoryItem(entry) {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            const actionText = getActionText(entry.action, entry.details);
            
            historyItem.innerHTML = `
                <div class="history-header">
                    <div class="history-action">${actionText}</div>
                    <div class="history-date">${new Date(entry.timestamp).toLocaleString('de-DE')}</div>
                </div>
                <div class="history-details">
                    Durchgef√ºhrt von: ${entry.userName} (${entry.user})
                </div>
            `;
            
            actionHistoryContainer.appendChild(historyItem);
        }

        function getActionText(action, details) {
            const actions = {
                'hiring': `Spieler eingestellt: ${details.targetName} (${details.targetUser})`,
                'promotion': `Bef√∂rderung: ${details.targetName} zu ${details.newRole}`,
                'demotion': `Degradierung: ${details.targetName} zu ${details.newRole}`,
                'termination': `K√ºndigung: ${details.targetName}`,
                'warning': `Verwarnung: ${details.targetName}`
            };
            return actions[action] || `Unbekannte Aktion: ${action}`;
        }

        // Warnings Management
        async function loadWarnings() {
            try {
                const snapshot = await get(warningsRef);
                let warningCount = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach(() => {
                        warningCount++;
                    });
                }
                
                // Zeige Warnungs-Badge an, wenn Verwarnungen vorhanden sind
                if (warningCount > 0) {
                    userWarningBadge.textContent = warningCount;
                    userWarningBadge.classList.remove('hidden');
                } else {
                    userWarningBadge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Fehler beim Laden der Verwarnungen:', error);
            }
        }

        // Export Funktion
        function exportUsersToCSV() {
            const rows = [['Name', 'Discord ID', 'Rolle', 'Eingestellt am', 'Eingestellt von', 'Status']];
            
            // Sammle alle Benutzer
            const users = [];
            userManagementTableBody.querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const name = cells[0].querySelector('.user-name-small').textContent;
                    const id = cells[0].querySelector('.user-id').textContent.replace('ID: ', '');
                    const role = cells[1].querySelector('.role-badge').textContent;
                    const hiredDate = cells[2].textContent;
                    const hiredBy = cells[3].textContent;
                    const status = 'Aktiv'; // Vereinfachte Annahme
                    
                    rows.push([name, id, role, hiredDate, hiredBy, status]);
                }
            });
            
            // Erstelle CSV Inhalt
            const csvContent = rows.map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            
            // Erstelle Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `khusland_users_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Benutzerliste erfolgreich exportiert', 'success');
        }

        // Notification System
        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 300);
            }, 5000);
        }

        // URL Parameter verarbeiten (f√ºr OAuth Callback)
        function handleUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            
            console.log('üîÑ Handling URL parameters...');
            
            if (error) {
                showError('Anmeldung fehlgeschlagen: ' + error);
                return;
            }
            
            if (code && state) {
                const savedState = sessionStorage.getItem('oauth_state');
                if (state === savedState) {
                    console.log('‚úÖ State validation successful, exchanging code for token');
                    exchangeCodeForToken(code);
                } else {
                    console.error('‚ùå State validation failed');
                    showError('Ung√ºltiger State-Parameter');
                }
            } else {
                console.log('‚ÑπÔ∏è No OAuth code found in URL, checking for implicit grant...');
                handleImplicitGrant();
            }
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ KhusLand Panel initializing...');
            
            // Debug-Informationen anzeigen
            debugOAuth();
            
            // Discord Login Event Listener
            discordLoginBtn.addEventListener('click', startDiscordOAuth);
            
            // URL Parameter verarbeiten
            handleUrlParameters();
            
            console.log('‚úÖ KhusLand Panel initialized successfully');
        });
    </script>
</body>
</html>

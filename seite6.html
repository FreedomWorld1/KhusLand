<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Text Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
    // Firebase Konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
      authDomain: "khusland-b7d13.firebaseapp.com",
      databaseURL: "https://khusland-b7d13-default-rtdb.firebaseio.com",
      projectId: "khusland-b7d13",
      storageBucket: "khusland-b7d13.firebasestorage.app",
      messagingSenderId: "69573193613",
      appId: "1:69573193613:web:86c4d839281b1e343cd7c4",
      measurementId: "G-JSCWR4207G"
    };

    // Firebase initialisieren
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // Globale Firebase-Referenzen verf√ºgbar machen
    window.firebaseDb = db;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseOnValue = onValue;
    window.firebasePush = push;
    window.firebaseRemove = remove;
  </script>
  <style>
    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
    }
    .card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
      border: 1px solid rgba(168, 85, 247, 0.2);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    .shadow-soft {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5),
                  0 4px 8px rgba(0, 0, 0, 0.3),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    .hidden {
      display: none !important;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .notification {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 10000;
      padding: 10px 16px;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      font-size: 0.8rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateX(150%);
      transition: transform 0.3s ease;
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.success {
      background-color: #10b981;
    }
    .notification.error {
      background-color: #ef4444;
    }
    .notification.info {
      background-color: #3b82f6;
    }
    .gradient-text {
      background: linear-gradient(90deg, #a855f7 0%, #ec4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .glass-effect {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(168, 85, 247, 0.1);
    }
    .text-item {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .text-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .active-link {
      background-color: #7e22ce !important;
      color: #fff !important;
      font-weight: 600;
    }
    .hamburger-container {
      position: relative;
      z-index: 1000;
    }
    .hamburger-menu {
      z-index: 1001;
    }
    .color-preview {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      display: inline-block;
      margin-right: 8px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="text-gray-100 antialiased min-h-screen">
  
  <!-- Notification System -->
  <div id="notification" class="notification hidden"></div>
  
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="card p-6 shadow-soft max-w-md w-full text-center">
      <div class="w-16 h-16 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center mx-auto mb-4">
        <span class="text-white text-xl">üí¨</span>
      </div>
      <h1 class="text-2xl font-bold gradient-text mb-2">Text Manager</h1>
      <p class="text-gray-400 text-sm mb-4">Bitte mit Discord einloggen um fortzufahren</p>
      
      <button id="discordLogin" class="w-full py-2.5 bg-[#5865F2] hover:bg-[#4752c4] rounded-lg font-medium flex items-center justify-center gap-2 transition-all duration-200">
        <i class="fab fa-discord text-lg"></i>
        Mit Discord anmelden
      </button>
      
      <div id="loginError" class="mt-3 p-2 bg-red-900/20 border border-red-700 rounded-lg text-red-400 text-sm hidden">
        <p id="errorMessage">Zugriff verweigert. Du bist nicht autorisiert.</p>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT (Versteckt bis Login) -->
  <div id="mainContent" class="hidden">
    <div class="max-w-6xl mx-auto p-3 md:p-4">

      <!-- HEADER -->
      <header class="glass-effect rounded-xl shadow-soft mb-4 p-3 md:p-4 flex justify-between items-center relative z-10">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center">
            <span class="text-white font-bold text-sm">üí¨</span>
          </div>
          <div>
            <h1 class="text-xl md:text-2xl font-bold gradient-text tracking-tight">Text Manager</h1>
            <p id="userInfo" class="text-xs text-gray-400">
              Eingeloggt als: <span id="username">Unbekannt</span>
            </p>
          </div>
        </div>
        <div class="flex items-center gap-1">
          <button id="btnMain" class="px-2.5 py-1.5 bg-purple-600 hover:bg-purple-500 rounded-lg shadow-sm font-medium flex items-center gap-1">
            <i class="fas fa-home text-xs"></i>
            Hauptbereich
          </button>
          <button id="btnSettings" class="px-2.5 py-1.5 bg-blue-600 hover:bg-blue-500 rounded-lg shadow-sm font-medium flex items-center gap-1">
            <i class="fas fa-cog text-xs"></i>
            Einstellungen
          </button>
          <div class="hamburger-container">
            <button id="hamburgerBtn" class="p-1.5 flex flex-col justify-between h-5 w-7 focus:outline-none ml-1 rounded-md bg-gray-800 hover:bg-gray-700">
              <span class="block h-0.5 bg-gray-100 rounded-full"></span>
              <span class="block h-0.5 bg-gray-100 rounded-full"></span>
              <span class="block h-0.5 bg-gray-100 rounded-full"></span>
            </button>
            <div id="hamburgerMenu" class="hamburger-menu hidden absolute right-0 mt-1.5 w-40 glass-effect border border-gray-700 rounded-lg shadow-lg overflow-hidden">
              <a href="./" class="block px-3 py-2 hover:bg-gray-700 transition-colors text-sm">
                <i class="fas fa-cannabis mr-2 text-xs"></i> Weed
              </a>
              <a href="seite2.html" class="block px-3 py-2 hover:bg-gray-700 active-link transition-colors text-sm">
                <i class="fas fa-pills mr-2 text-xs"></i> Kokain
              </a>
              <a href="https://khusland.github.io/KhusLand2/" class="block px-3 py-2 hover:bg-gray-700 transition-colors text-sm">
                <i class="fas fa-calculator mr-2 text-xs"></i> 30% Rechner
              </a>
              <a href="seite4.html" class="block px-3 py-2 hover:bg-gray-700 transition-colors text-sm">
                <i class="fas fa-industry mr-2 text-xs"></i> Herstellung
              </a>
              <a href="seite3.html" class="block px-3 py-2 hover:bg-gray-700 transition-colors text-sm">
                <i class="fas fa-recycle mr-2 text-xs"></i> Materialrecycler
              </a>
              <a href="seite5.html" class="block px-3 py-2 hover:bg-gray-700 transition-colors text-sm">
                <i class="fas fa-route mr-2 text-xs"></i> Routen
              </a>
            </div>
          </div>
          <button id="logoutBtn" class="px-2.5 py-1.5 bg-red-600 hover:bg-red-500 rounded-lg shadow-sm font-medium flex items-center gap-1">
            <i class="fas fa-sign-out-alt text-xs"></i>
            Logout
          </button>
        </div>
      </header>

      <div id="mainContainer" class="space-y-4">
        <!-- HAUPTBEREICH -->
        <div id="mainArea" class="card p-4 shadow-soft fade-in">
          <h2 class="text-lg font-semibold mb-3 text-purple-400 flex items-center gap-1">
            <i class="fas fa-home text-sm"></i>
            Hauptbereich
          </h2>
          
          <div class="mb-4 p-3 bg-gray-800/30 rounded-lg border border-gray-700">
            <p class="text-sm text-gray-300 mb-2">W√§hle einen Text aus und klicke darauf, um ihn zu verwenden:</p>
            <div id="textList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              <!-- Text-Elemente werden hier dynamisch geladen -->
            </div>
          </div>
          
          <div id="textInputSection" class="hidden p-4 bg-gray-800/30 rounded-lg border border-gray-700">
            <h3 class="text-base font-medium mb-2 text-blue-400">Text senden</h3>
            <div class="mb-3">
              <label for="textId" class="block text-xs font-medium text-gray-300 mb-1">
                <i class="fas fa-id-card mr-1 text-xs"></i> ID eingeben
              </label>
              <input id="textId" type="text" placeholder="ID f√ºr den Text" class="w-full p-2 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-purple-500 text-sm"/>
            </div>
            <div class="flex gap-2">
              <button id="sendTextBtn" class="flex-1 px-3 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-medium flex items-center justify-center gap-1">
                <i class="fas fa-paper-plane text-xs"></i>
                An Discord senden
              </button>
              <button id="cancelSendBtn" class="px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg font-medium flex items-center justify-center gap-1">
                <i class="fas fa-times text-xs"></i>
                Abbrechen
              </button>
            </div>
          </div>

          <!-- Text bearbeiten Bereich -->
          <div id="textEditSection" class="hidden p-4 bg-gray-800/30 rounded-lg border border-gray-700 mt-4">
            <h3 class="text-base font-medium mb-2 text-yellow-400">Text bearbeiten</h3>
            <div class="mb-3">
              <label for="editTextTitle" class="block text-xs font-medium text-gray-300 mb-1">
                <i class="fas fa-heading mr-1 text-xs"></i> Titel
              </label>
              <input id="editTextTitle" type="text" class="w-full p-2 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-purple-500 text-sm"/>
            </div>
            <div class="mb-3">
              <label for="editTextContent" class="block text-xs font-medium text-gray-300 mb-1">
                <i class="fas fa-align-left mr-1 text-xs"></i> Inhalt
              </label>
              <textarea id="editTextContent" rows="4" class="w-full p-2 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-purple-500 text-sm"></textarea>
            </div>
            <div class="flex gap-2">
              <button id="saveEditBtn" class="flex-1 px-3 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-medium flex items-center justify-center gap-1">
                <i class="fas fa-save text-xs"></i>
                Speichern
              </button>
              <button id="cancelEditBtn" class="px-3 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg font-medium flex items-center justify-center gap-1">
                <i class="fas fa-times text-xs"></i>
                Abbrechen
              </button>
            </div>
          </div>
        </div>

        <!-- EINSTELLUNGEN -->
        <div id="settingsArea" class="card p-4 shadow-soft hidden fade-in">
          <h2 class="text-lg font-semibold mb-3 text-blue-400 flex items-center gap-1">
            <i class="fas fa-cog text-sm"></i>
            Einstellungen
          </h2>
          
          <div id="adminLoginSection" class="mb-4 p-4 bg-gray-800/30 rounded-lg border border-gray-700">
            <div class="mb-3">
              <label for="adminPass" class="block text-xs font-medium text-gray-300 mb-1">
                <i class="fas fa-key mr-1 text-xs"></i> Admin-Passwort
              </label>
              <input id="adminPass" type="password" placeholder="Passwort eingeben" class="w-full p-2 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-blue-500 text-sm"/>
            </div>
            <button id="adminLoginBtn" class="w-full py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium flex items-center justify-center gap-1">
              <i class="fas fa-sign-in-alt text-xs"></i>
              Einloggen
            </button>
            <span id="adminError" class="text-red-400 mt-2 block hidden text-center text-xs py-1.5 bg-red-900/20 rounded-lg">
              <i class="fas fa-exclamation-triangle mr-1 text-xs"></i> Falsches Passwort
            </span>
          </div>
          
          <div id="adminContent" class="hidden">
            <!-- Text hinzuf√ºgen -->
            <div class="mb-4 p-4 bg-gray-800/30 rounded-lg border border-gray-700">
              <h3 class="text-base font-medium mb-2 text-green-400">Text hinzuf√ºgen</h3>
              <div class="mb-3">
                <label for="newTextTitle" class="block text-xs font-medium text-gray-300 mb-1">
                  <i class="fas fa-heading mr-1 text-xs"></i> Titel
                </label>
                <input id="newTextTitle" type="text" placeholder="Titel des Texts" class="w-full p-2 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-purple-500 text-sm"/>
              </div>
              <div class="mb-3">
                <label for="newTextContent" class="block text-xs font-medium text-gray-300 mb-1">
                  <i class="fas fa-align-left mr-1 text-xs"></i> Inhalt
                </label>
                <textarea id="newTextContent" rows="4" placeholder="Inhalt des Texts" class="w-full p-2 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-purple-500 text-sm"></textarea>
              </div>
              <div class="mb-3">
                <label for="newTextWebhook" class="block text-xs font-medium text-gray-300 mb-1">
                  <i class="fas fa-link mr-1 text-xs"></i> Webhook URL
                </label>
                <input id="newTextWebhook" type="text" placeholder="Discord Webhook URL" class="w-full p-2 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-purple-500 text-sm"/>
              </div>
              <div class="mb-3">
                <label for="newTextColor" class="block text-xs font-medium text-gray-300 mb-1">
                  <i class="fas fa-palette mr-1 text-xs"></i> Farbe
                </label>
                <div class="flex items-center gap-2">
                  <input id="newTextColor" type="color" value="#a855f7" class="w-10 h-10 rounded-lg cursor-pointer">
                  <span id="newTextColorValue" class="text-xs text-gray-300">#a855f7</span>
                </div>
              </div>
              <button id="addTextBtn" class="w-full py-2 bg-green-600 hover:bg-green-500 rounded-lg font-medium flex items-center justify-center gap-1">
                <i class="fas fa-plus text-xs"></i>
                Text hinzuf√ºgen
              </button>
            </div>
            
            <!-- Text bearbeiten/l√∂schen -->
            <div class="p-4 bg-gray-800/30 rounded-lg border border-gray-700">
              <h3 class="text-base font-medium mb-2 text-yellow-400">Texte verwalten</h3>
              <div id="textManagementList" class="space-y-3">
                <!-- Verwaltete Texte werden hier geladen -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Discord OAuth Konfiguration
    const DISCORD_CLIENT_ID = '1432942180770644079';
    const DISCORD_REDIRECT_URI = window.location.origin + window.location.pathname;
    const BACKEND_URL = 'https://discord-oauth.ehrlichcolin2.workers.dev';
    const ADMIN_PASSWORD = '1101';

    // Firebase Referenzen
    const db = window.firebaseDb;
    const firebaseRef = window.firebaseRef;
    const firebaseSet = window.firebaseSet;
    const firebaseOnValue = window.firebaseOnValue;
    const firebasePush = window.firebasePush;
    const firebaseRemove = window.firebaseRemove;

    // Firebase Referenz f√ºr Texte
    const textsRef = firebaseRef(db, 'text_manager/texts');

    // DOM Elemente
    const loginScreen = document.getElementById('loginScreen');
    const mainContent = document.getElementById('mainContent');
    const discordLoginBtn = document.getElementById('discordLogin');
    const loginError = document.getElementById('loginError');
    const errorMessage = document.getElementById('errorMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const usernameElement = document.getElementById('username');
    const notification = document.getElementById('notification');
    const btnMain = document.getElementById('btnMain');
    const btnSettings = document.getElementById('btnSettings');
    const mainArea = document.getElementById('mainArea');
    const settingsArea = document.getElementById('settingsArea');
    const textList = document.getElementById('textList');
    const textInputSection = document.getElementById('textInputSection');
    const sendTextBtn = document.getElementById('sendTextBtn');
    const cancelSendBtn = document.getElementById('cancelSendBtn');
    const textIdInput = document.getElementById('textId');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminPassInput = document.getElementById('adminPass');
    const adminError = document.getElementById('adminError');
    const adminContent = document.getElementById('adminContent');
    const addTextBtn = document.getElementById('addTextBtn');
    const newTextTitle = document.getElementById('newTextTitle');
    const newTextContent = document.getElementById('newTextContent');
    const newTextWebhook = document.getElementById('newTextWebhook');
    const newTextColor = document.getElementById('newTextColor');
    const newTextColorValue = document.getElementById('newTextColorValue');
    const textManagementList = document.getElementById('textManagementList');
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const hamburgerMenu = document.getElementById('hamburgerMenu');
    const textEditSection = document.getElementById('textEditSection');
    const editTextTitle = document.getElementById('editTextTitle');
    const editTextContent = document.getElementById('editTextContent');
    const saveEditBtn = document.getElementById('saveEditBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    // Text-Daten (werden von Firebase geladen)
    let texts = [];
    let textKeys = {}; // Mapping von IDs zu Firebase Keys

    // Aktuell ausgew√§hlter Text
    let selectedText = null;
    let textToEdit = null;

    // Notification System
    function showNotification(message, type = 'info', duration = 4000) {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.remove('hidden');
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          notification.classList.add('hidden');
        }, 300);
      }, duration);
    }

    // Firebase: Texte laden
    function loadTextsFromFirebase() {
      firebaseOnValue(textsRef, (snapshot) => {
        const data = snapshot.val();
        texts = [];
        textKeys = {};
        
        if (data) {
          Object.keys(data).forEach(key => {
            const text = data[key];
            text.firebaseKey = key; // Firebase Key speichern
            texts.push(text);
            textKeys[text.id] = key;
          });
          
          // Nach ID sortieren
          texts.sort((a, b) => a.id - b.id);
        } else {
          // Standard-Texte erstellen, falls keine Daten vorhanden
          createDefaultTexts();
        }
        
        renderTextList();
        if (document.getElementById('adminContent').classList.contains('hidden') === false) {
          renderTextManagementList();
        }
      });
    }

    // Standard-Texte erstellen
    function createDefaultTexts() {
      const defaultTexts = [
        { 
          id: 1, 
          title: "Willkommen", 
          content: "Willkommen auf unserer Plattform!", 
          webhook: "",
          color: "#a855f7"
        },
        { 
          id: 2, 
          title: "Information", 
          content: "Hier finden Sie wichtige Informationen.", 
          webhook: "",
          color: "#3b82f6"
        },
        { 
          id: 3, 
          title: "Angebot", 
          content: "Spezielles Angebot nur f√ºr Sie!", 
          webhook: "",
          color: "#10b981"
        }
      ];
      
      defaultTexts.forEach(text => {
        addTextToFirebase(text);
      });
    }

    // Text zu Firebase hinzuf√ºgen
    function addTextToFirebase(text) {
      const newTextRef = firebasePush(textsRef);
      firebaseSet(newTextRef, text)
        .then(() => {
          console.log('Text erfolgreich zu Firebase hinzugef√ºgt');
        })
        .catch((error) => {
          console.error('Fehler beim Hinzuf√ºgen zu Firebase:', error);
          showNotification('Fehler beim Speichern in Firebase', 'error');
        });
    }

    // Text in Firebase aktualisieren
    function updateTextInFirebase(firebaseKey, updatedText) {
      const textRef = firebaseRef(db, `text_manager/texts/${firebaseKey}`);
      firebaseSet(textRef, updatedText)
        .then(() => {
          console.log('Text erfolgreich in Firebase aktualisiert');
        })
        .catch((error) => {
          console.error('Fehler beim Aktualisieren in Firebase:', error);
          showNotification('Fehler beim Aktualisieren in Firebase', 'error');
        });
    }

    // Text aus Firebase l√∂schen
    function deleteTextFromFirebase(firebaseKey) {
      const textRef = firebaseRef(db, `text_manager/texts/${firebaseKey}`);
      firebaseRemove(textRef)
        .then(() => {
          console.log('Text erfolgreich aus Firebase gel√∂scht');
        })
        .catch((error) => {
          console.error('Fehler beim L√∂schen aus Firebase:', error);
          showNotification('Fehler beim L√∂schen aus Firebase', 'error');
        });
    }

    // Discord OAuth Login
    function startDiscordOAuth() {
      const scope = 'identify';
      const state = generateRandomState();
      
      const authUrl = new URL('https://discord.com/api/oauth2/authorize');
      authUrl.searchParams.set('client_id', DISCORD_CLIENT_ID);
      authUrl.searchParams.set('redirect_uri', DISCORD_REDIRECT_URI);
      authUrl.searchParams.set('response_type', 'code');
      authUrl.searchParams.set('scope', scope);
      authUrl.searchParams.set('state', state);
      
      window.location.href = authUrl.toString();
    }

    function generateRandomState() {
      return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    }

    async function exchangeCodeForToken(code) {
      try {
        const response = await fetch(`${BACKEND_URL}/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            code, 
            redirect_uri: DISCORD_REDIRECT_URI
          })
        });

        if (!response.ok) {
          throw new Error(`Worker responded with status ${response.status}`);
        }

        const data = await response.json();

        if (data.access_token) {
          await verifyUser(data.access_token);
        } else {
          throw new Error('Kein Access Token erhalten');
        }
      } catch (error) {
        console.error('Fehler beim Token-Austausch:', error);
        showError('Fehler bei der Anmeldung. Bitte versuche es sp√§ter erneut.');
      }
    }

    async function verifyUser(accessToken) {
      try {
        const response = await fetch(`${BACKEND_URL}/verify-user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            accessToken
          })
        });

        if (!response.ok) {
          throw new Error('Verification failed');
        }

        const data = await response.json();

        if (data.isAuthorized) {
          localStorage.setItem('discord_user', JSON.stringify(data.user));
          localStorage.setItem('discord_access_token', accessToken);
          showMainContent();
          showNotification(`Eingeloggt als ${data.user.username}`, 'success');
        } else {
          let errorMsg = 'Zugriff verweigert. ';
          if (data.accessInfo && data.accessInfo.message === 'access expired') {
            errorMsg += 'Dein Zugang ist abgelaufen.';
          } else if (data.accessInfo && data.accessInfo.message === 'not in authorized list') {
            errorMsg += 'Du bist nicht in der Liste der autorisierten Benutzer.';
          } else {
            errorMsg += 'Du bist nicht autorisiert.';
          }
          showError(errorMsg);
        }
      } catch (error) {
        console.error('Fehler bei der Benutzer√ºberpr√ºfung:', error);
        showError('Fehler bei der Berechtigungspr√ºfung');
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      loginError.classList.remove('hidden');
    }

    function showMainContent() {
      loginScreen.classList.add('hidden');
      mainContent.classList.remove('hidden');
      
      const user = JSON.parse(localStorage.getItem('discord_user'));
      if (user) {
        usernameElement.textContent = user.username;
      }
      
      // Texte von Firebase laden
      loadTextsFromFirebase();
      
      // Bereiche zur√ºcksetzen
      showMainArea();
      
      const cleanUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
    }

    function logout() {
      localStorage.removeItem('discord_user');
      localStorage.removeItem('discord_access_token');
      
      mainContent.classList.add('hidden');
      loginScreen.classList.remove('hidden');
      loginError.classList.add('hidden');
      
      showNotification('Ausgeloggt', 'info');
    }

    function checkExistingLogin() {
      const user = localStorage.getItem('discord_user');
      const token = localStorage.getItem('discord_access_token');
      
      if (user && token) {
        showMainContent();
      } else {
        localStorage.removeItem('discord_user');
        localStorage.removeItem('discord_access_token');
      }
    }

    // Event Listeners
    discordLoginBtn.addEventListener('click', startDiscordOAuth);
    logoutBtn.addEventListener('click', logout);

    // Navigation
    btnMain.addEventListener('click', showMainArea);
    btnSettings.addEventListener('click', showSettingsArea);

    function showMainArea() {
      mainArea.classList.remove('hidden');
      settingsArea.classList.add('hidden');
      btnMain.classList.add('active-link');
      btnSettings.classList.remove('active-link');
    }

    function showSettingsArea() {
      mainArea.classList.add('hidden');
      settingsArea.classList.remove('hidden');
      btnMain.classList.remove('active-link');
      btnSettings.classList.add('active-link');
    }

    // Hamburger Menu
    hamburgerBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      hamburgerMenu.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!hamburgerMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
        hamburgerMenu.classList.add('hidden');
      }
    });

    // Text-Liste rendern
    function renderTextList() {
      textList.innerHTML = '';
      
      if (texts.length === 0) {
        textList.innerHTML = '<div class="col-span-full text-center py-6 text-gray-400 text-sm"><p>Keine Texte vorhanden.</p></div>';
        return;
      }
      
      texts.forEach(text => {
        const textElement = document.createElement('div');
        textElement.className = 'text-item p-3 rounded-lg bg-gray-800/50 border border-gray-700 hover:border-purple-500/30';
        textElement.innerHTML = `
          <div class="flex items-center mb-1">
            <span class="color-preview" style="background-color: ${text.color}"></span>
            <h3 class="font-semibold text-sm text-white">${text.title}</h3>
          </div>
          <p class="text-xs text-gray-300 truncate">${text.content}</p>
          <div class="mt-2 flex justify-between items-center">
            <button class="edit-self-btn px-2 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs" data-id="${text.id}">
              <i class="fas fa-edit text-xs"></i> Bearbeiten
            </button>
            <button class="use-text-btn px-2 py-1 bg-green-600 hover:bg-green-500 rounded text-xs" data-id="${text.id}">
              <i class="fas fa-paper-plane text-xs"></i> Verwenden
            </button>
          </div>
        `;
        
        textList.appendChild(textElement);
      });
      
      // Event-Listener f√ºr Bearbeiten-Buttons
      document.querySelectorAll('.edit-self-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const id = parseInt(e.target.closest('button').getAttribute('data-id'));
          editTextSelf(id);
        });
      });
      
      // Event-Listener f√ºr Verwenden-Buttons
      document.querySelectorAll('.use-text-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const id = parseInt(e.target.closest('button').getAttribute('data-id'));
          useText(id);
        });
      });
    }

    // Text bearbeiten (im Hauptbereich)
    function editTextSelf(id) {
      textToEdit = texts.find(t => t.id === id);
      if (!textToEdit) return;
      
      editTextTitle.value = textToEdit.title;
      editTextContent.value = textToEdit.content;
      
      textEditSection.classList.remove('hidden');
      showNotification(`Bearbeite Text "${textToEdit.title}"`, 'info');
    }

    // Text verwenden
    function useText(id) {
      selectedText = texts.find(t => t.id === id);
      if (!selectedText) return;
      
      textInputSection.classList.remove('hidden');
      showNotification(`Text "${selectedText.title}" ausgew√§hlt`, 'info');
    }

    // Text an Discord senden
    sendTextBtn.addEventListener('click', async () => {
      if (!selectedText) {
        showNotification('Bitte w√§hle zuerst einen Text aus', 'error');
        return;
      }
      
      const textId = textIdInput.value.trim();
      if (!textId) {
        showNotification('Bitte eine ID eingeben', 'error');
        return;
      }
      
      try {
        // Lade-Animation starten
        const originalText = sendTextBtn.innerHTML;
        sendTextBtn.innerHTML = '<div class="loading mr-1"></div> Sende...';
        sendTextBtn.disabled = true;
        
        // Hier w√ºrde der Webhook-Call stattfinden
        if (selectedText.webhook) {
          await sendToDiscordWebhook(selectedText, textId);
          showNotification(`Text "${selectedText.title}" mit ID "${textId}" wurde an Discord gesendet`, 'success');
        } else {
          showNotification(`Text "${selectedText.title}" mit ID "${textId}" bereit (kein Webhook konfiguriert)`, 'info');
        }
        
        // Zur√ºcksetzen
        textIdInput.value = '';
        textInputSection.classList.add('hidden');
        selectedText = null;
        
        // Button zur√ºcksetzen
        sendTextBtn.innerHTML = originalText;
        sendTextBtn.disabled = false;
      } catch (error) {
        console.error('Fehler beim Senden an Discord:', error);
        showNotification('Fehler beim Senden an Discord', 'error');
        
        // Button zur√ºcksetzen auch bei Fehler
        const originalText = '<i class="fas fa-paper-plane text-xs"></i> An Discord senden';
        sendTextBtn.innerHTML = originalText;
        sendTextBtn.disabled = false;
      }
    });

    // Abbrechen
    cancelSendBtn.addEventListener('click', () => {
      textIdInput.value = '';
      textInputSection.classList.add('hidden');
      selectedText = null;
      showNotification('Vorgang abgebrochen', 'info');
    });

    // Text bearbeiten speichern
    saveEditBtn.addEventListener('click', () => {
      if (!textToEdit) return;
      
      const title = editTextTitle.value.trim();
      const content = editTextContent.value.trim();
      
      if (!title || !content) {
        showNotification('Bitte Titel und Inhalt ausf√ºllen', 'error');
        return;
      }
      
      // Text in Firebase aktualisieren
      const updatedText = {
        ...textToEdit,
        title: title,
        content: content
      };
      
      updateTextInFirebase(textToEdit.firebaseKey, updatedText);
      
      // Bearbeitungsbereich ausblenden
      textEditSection.classList.add('hidden');
      textToEdit = null;
      
      showNotification('Text erfolgreich bearbeitet', 'success');
    });

    // Bearbeiten abbrechen
    cancelEditBtn.addEventListener('click', () => {
      textEditSection.classList.add('hidden');
      textToEdit = null;
      showNotification('Bearbeitung abgebrochen', 'info');
    });

    // Admin-Login
    adminLoginBtn.addEventListener('click', () => {
      if (adminPassInput.value === ADMIN_PASSWORD) {
        adminError.classList.add('hidden');
        adminContent.classList.remove('hidden');
        renderTextManagementList();
        adminPassInput.value = '';
        showNotification('Admin-Bereich betreten', 'success');
      } else {
        adminError.classList.remove('hidden');
        adminPassInput.value = '';
        adminPassInput.focus();
        showNotification('Falsches Passwort', 'error');
      }
    });

    adminPassInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        adminLoginBtn.click();
      }
    });

    // Farbe √§ndern Event
    newTextColor.addEventListener('input', (e) => {
      newTextColorValue.textContent = e.target.value;
    });

    // Text hinzuf√ºgen
    addTextBtn.addEventListener('click', () => {
      const title = newTextTitle.value.trim();
      const content = newTextContent.value.trim();
      const webhook = newTextWebhook.value.trim();
      const color = newTextColor.value;
      
      if (!title || !content) {
        showNotification('Bitte Titel und Inhalt ausf√ºllen', 'error');
        return;
      }
      
      // Neue ID generieren
      const newId = texts.length > 0 ? Math.max(...texts.map(t => t.id)) + 1 : 1;
      
      // Neuen Text erstellen
      const newText = {
        id: newId,
        title,
        content,
        webhook,
        color
      };
      
      // Text zu Firebase hinzuf√ºgen
      addTextToFirebase(newText);
      
      // Formular zur√ºcksetzen
      newTextTitle.value = '';
      newTextContent.value = '';
      newTextWebhook.value = '';
      newTextColor.value = '#a855f7';
      newTextColorValue.textContent = '#a855f7';
      
      showNotification(`Text "${title}" hinzugef√ºgt`, 'success');
    });

    // Text-Verwaltungsliste rendern
    function renderTextManagementList() {
      textManagementList.innerHTML = '';
      
      if (texts.length === 0) {
        textManagementList.innerHTML = '<div class="text-center py-4 text-gray-400 text-sm"><p>Keine Texte vorhanden.</p></div>';
        return;
      }
      
      texts.forEach(text => {
        const textElement = document.createElement('div');
        textElement.className = 'p-3 rounded-lg bg-gray-800/50 border border-gray-700';
        textElement.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="flex items-center">
              <span class="color-preview" style="background-color: ${text.color}"></span>
              <h3 class="font-semibold text-sm text-white">${text.title}</h3>
            </div>
            <div class="flex gap-1">
              <button class="edit-text-btn px-2 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs" data-id="${text.id}">
                <i class="fas fa-edit text-xs"></i> Bearbeiten
              </button>
              <button class="delete-text-btn px-2 py-1 bg-red-600 hover:bg-red-500 rounded text-xs" data-id="${text.id}">
                <i class="fas fa-trash text-xs"></i> L√∂schen
              </button>
            </div>
          </div>
          <p class="text-xs text-gray-300 mb-2">${text.content}</p>
          <div class="text-xs text-gray-400">
            <div class="truncate"><span class="font-medium">Webhook:</span> ${text.webhook || 'Nicht konfiguriert'}</div>
            <div><span class="font-medium">Farbe:</span> ${text.color}</div>
          </div>
        `;
        
        textManagementList.appendChild(textElement);
      });
      
      // Event-Listener f√ºr Bearbeiten-Buttons
      document.querySelectorAll('.edit-text-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const id = parseInt(e.target.closest('button').getAttribute('data-id'));
          editTextAdmin(id);
        });
      });
      
      // Event-Listener f√ºr L√∂schen-Buttons
      document.querySelectorAll('.delete-text-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const id = parseInt(e.target.closest('button').getAttribute('data-id'));
          deleteText(id);
        });
      });
    }

    // Text bearbeiten (Admin)
    function editTextAdmin(id) {
      const text = texts.find(t => t.id === id);
      if (!text) return;
      
      const newTitle = prompt('Neuen Titel eingeben:', text.title);
      if (newTitle === null) return; // Benutzer hat abgebrochen
      
      const newContent = prompt('Neuen Inhalt eingeben:', text.content);
      if (newContent === null) return; // Benutzer hat abgebrochen
      
      const newWebhook = prompt('Neue Webhook URL eingeben:', text.webhook);
      if (newWebhook === null) return; // Benutzer hat abgebrochen
      
      const newColor = prompt('Neue Farbe eingeben (Hex-Code):', text.color);
      if (newColor === null) return; // Benutzer hat abgebrochen
      
      // Text in Firebase aktualisieren
      const updatedText = {
        id: text.id,
        title: newTitle.trim(),
        content: newContent.trim(),
        webhook: newWebhook.trim(),
        color: newColor.trim()
      };
      
      updateTextInFirebase(text.firebaseKey, updatedText);
      
      showNotification(`Text "${text.title}" bearbeitet`, 'success');
    }

    // Text l√∂schen
    function deleteText(id) {
      const text = texts.find(t => t.id === id);
      if (!text) return;
      
      if (confirm(`Text "${text.title}" wirklich l√∂schen?`)) {
        // Text aus Firebase l√∂schen
        deleteTextFromFirebase(text.firebaseKey);
        
        showNotification(`Text "${text.title}" gel√∂scht`, 'success');
      }
    }

    // Initialisierung
    checkExistingLogin();

    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    if (code) {
      exchangeCodeForToken(code);
    }

    // Webhook-Funktion (Beispiel)
    async function sendToDiscordWebhook(text, id) {
      // Diese Funktion w√ºrde den Text √ºber einen Discord Webhook senden
      // Hier ist ein Beispiel, wie das aussehen k√∂nnte:
      
      /*
      const response = await fetch(text.webhook, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          content: `**ID: ${id}**\n\n${text.content}`,
          username: 'Text Manager',
          embeds: [
            {
              title: text.title,
              color: parseInt(text.color.replace('#', ''), 16),
              timestamp: new Date().toISOString()
            }
          ]
        })
      });
      
      if (!response.ok) {
        throw new Error('Webhook request failed');
      }
      */
      
      // F√ºr Demo-Zwecke simulieren wir eine erfolgreiche Antwort
      return new Promise(resolve => setTimeout(resolve, 1000));
    }
  </script>
</body>
</html>

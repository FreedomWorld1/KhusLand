<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bullet Farm v3 ‚Äî Shop</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ... (CSS bleibt gleich wie vorher) ... */
</style>
</head>
<body>
  <!-- ... (HTML bleibt gleich wie vorher) ... -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = { 
  apiKey: "AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
  authDomain: "khusland-b7d13.firebaseapp.com",
  databaseURL: "https://khusland-b7d13-default-rtdb.firebaseio.com",
  projectId: "khusland-b7d13",
  storageBucket: "khusland-b7d13.firebasestorage.app",
  messagingSenderId: "69573193613",
  appId: "1:69573193613:web:86c4d839281b1e343cd7c4",
  measurementId: "G-JSCWR4207G"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productsRef = ref(db, 'products');
const settingsRef = ref(db, 'settings');
const categoriesRef = ref(db, 'categories');
const ordersRef = ref(db, 'orders');
const userStatsRef = ref(db, 'userStats');
const colorsRef = ref(db, 'colors');
const discordRef = ref(db, 'discord');

const ADMIN_PASSWORD = '1101';

let products = [];
let settings = { title: 'Bullet Farm v3', headerImage: 'https://via.placeholder.com/48' };
let categories = [];
let cart = [];
let allOrders = [];
let saveOrderBtnEl = null;
let orderCodeDisplayEl = null;
let selectedUserId = null;
let selectedOrder = null;
let discordSettings = {};

// Standard Farben
const defaultColors = {
  primary: '#22c55e',
  secondary: '#3b82f6',
  success: '#10b981',
  warning: '#f59e0b',
  error: '#ef4444',
  background: '#0f1724',
  card: '#0b1220'
};

// Toast Funktionen
function showToast(message, type = 'info', duration = 4000) {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  
  const container = document.getElementById('toastContainer');
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideInRight 0.3s ease reverse';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, duration);
}

// Funktion zur Behandlung von Bildfehlern
function handleImageError(img) {
  img.onerror = null;
  img.src = 'https://via.placeholder.com/300x120?text=Bild+nicht+verf√ºgbar';
  img.style.opacity = '0.7';
}

// NEUE FUNKTION: Discord Webhook senden
async function sendDiscordWebhook(order) {
  if (!discordSettings.webhookUrl) {
    console.log('Keine Discord Webhook URL konfiguriert');
    return;
  }

  try {
    const itemsText = order.items.map(item => 
      `‚Ä¢ ${item.quantity}x **${item.name}**\n  ${Object.entries(item.resources || {}).map(([k, v]) => `${k}: ${v}`).join(', ')}`
    ).join('\n');

    const embed = {
      title: 'üõí Neue Bestellung eingegangen!',
      color: 0x00ff00,
      fields: [
        {
          name: 'üìã Bestellcode',
          value: `**${order.code}**`,
          inline: true
        },
        {
          name: 'üë§ Kunde',
          value: order.userName || 'Unbekannt',
          inline: true
        },
        {
          name: 'üìû Telefon',
          value: order.phone || 'Nicht angegeben',
          inline: true
        },
        {
          name: 'üõçÔ∏è Bestellte Artikel',
          value: itemsText || 'Keine Artikel',
          inline: false
        },
        {
          name: '‚è∞ Bestelldatum',
          value: new Date(order.createdAt).toLocaleString('de-DE'),
          inline: true
        },
        {
          name: 'üìä Artikel gesamt',
          value: order.items.reduce((sum, item) => sum + item.quantity, 0).toString(),
          inline: true
        }
      ],
      timestamp: new Date().toISOString(),
      footer: {
        text: 'Bullet Farm v3 Shop System'
      }
    };

    const payload = {
      embeds: [embed],
      username: discordSettings.botName || 'Bullet Farm Bot',
      avatar_url: discordSettings.botAvatar || ''
    };

    if (discordSettings.channelName) {
      payload.content = `Neue Bestellung in ${discordSettings.channelName}`;
    }

    const response = await fetch(discordSettings.webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error(`Discord API error: ${response.status}`);
    }

    console.log('Discord Webhook erfolgreich gesendet');
    return true;
  } catch (error) {
    console.error('Fehler beim Senden des Discord Webhooks:', error);
    return false;
  }
}

// NEUE FUNKTION: Discord Webhook testen
async function testDiscordWebhook() {
  const webhookUrl = document.getElementById('discordWebhookUrl').value.trim();
  
  if (!webhookUrl) {
    document.getElementById('discordTestResult').innerHTML = '<span class="error">‚ùå Bitte gib eine Webhook URL ein</span>';
    return;
  }

  document.getElementById('discordTestResult').innerHTML = '<span class="info">‚è≥ Sende Testnachricht...</span>';
  document.getElementById('testDiscordBtn').disabled = true;

  try {
    const testPayload = {
      content: 'üîî **Testnachricht von Bullet Farm v3**\nDein Discord Webhook funktioniert einwandfrei! ‚úÖ',
      username: document.getElementById('discordBotName').value.trim() || 'Bullet Farm Bot',
      avatar_url: document.getElementById('discordBotAvatar').value.trim() || ''
    };

    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(testPayload)
    });

    if (response.ok) {
      document.getElementById('discordTestResult').innerHTML = '<span class="success">‚úÖ Testnachricht erfolgreich gesendet!</span>';
    } else {
      throw new Error(`HTTP ${response.status}`);
    }
  } catch (error) {
    document.getElementById('discordTestResult').innerHTML = `<span class="error">‚ùå Fehler: ${error.message}</span>`;
  } finally {
    document.getElementById('testDiscordBtn').disabled = false;
  }
}

// NEUE FUNKTION: Discord Einstellungen laden
onValue(discordRef, snapshot => {
  const data = snapshot.val();
  if (data) {
    discordSettings = data;
    document.getElementById('discordWebhookUrl').value = data.webhookUrl || '';
    document.getElementById('discordChannelName').value = data.channelName || '';
    document.getElementById('discordBotName').value = data.botName || '';
    document.getElementById('discordBotAvatar').value = data.botAvatar || '';
  }
});

// NEUE FUNKTION: Discord Einstellungen speichern
async function saveDiscordSettings() {
  const settings = {
    webhookUrl: document.getElementById('discordWebhookUrl').value.trim(),
    channelName: document.getElementById('discordChannelName').value.trim(),
    botName: document.getElementById('discordBotName').value.trim(),
    botAvatar: document.getElementById('discordBotAvatar').value.trim()
  };

  try {
    await update(discordRef, settings);
    discordSettings = settings;
    showToast('Discord Einstellungen gespeichert', 'success');
  } catch (error) {
    console.error('Fehler beim Speichern der Discord Einstellungen:', error);
    showToast('Fehler beim Speichern der Discord Einstellungen', 'error');
  }
}

// NEUE FUNKTION: Bild-Upload Handler
function setupImageUpload() {
  document.getElementById('prodImgFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('prodImg').value = e.target.result;
          document.getElementById('prodPreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
      } else {
        showToast('Bitte w√§hle eine Bilddatei aus', 'error');
      }
    }
  });
}

// Globale Farben anwenden
function applyColors(colors = null) {
  const colorSettings = colors || defaultColors;
  
  document.documentElement.style.setProperty('--primary-color', colorSettings.primary);
  document.documentElement.style.setProperty('--secondary-color', colorSettings.secondary);
  document.documentElement.style.setProperty('--success-color', colorSettings.success);
  document.documentElement.style.setProperty('--warning-color', colorSettings.warning);
  document.documentElement.style.setProperty('--error-color', colorSettings.error);
  document.documentElement.style.setProperty('--background-color', colorSettings.background);
  document.documentElement.style.setProperty('--card', colorSettings.card);
  
  if (document.getElementById('primaryColorInput')) {
    document.getElementById('primaryColorInput').value = colorSettings.primary;
    document.getElementById('primaryColorPreview').style.background = colorSettings.primary;
  }
  if (document.getElementById('secondaryColorInput')) {
    document.getElementById('secondaryColorInput').value = colorSettings.secondary;
    document.getElementById('secondaryColorPreview').style.background = colorSettings.secondary;
  }
  if (document.getElementById('successColorInput')) {
    document.getElementById('successColorInput').value = colorSettings.success;
    document.getElementById('successColorPreview').style.background = colorSettings.success;
  }
  if (document.getElementById('warningColorInput')) {
    document.getElementById('warningColorInput').value = colorSettings.warning;
    document.getElementById('warningColorPreview').style.background = colorSettings.warning;
  }
  if (document.getElementById('errorColorInput')) {
    document.getElementById('errorColorInput').value = colorSettings.error;
    document.getElementById('errorColorPreview').style.background = colorSettings.error;
  }
  if (document.getElementById('backgroundColorInput')) {
    document.getElementById('backgroundColorInput').value = colorSettings.background;
    document.getElementById('backgroundColorPreview').style.background = colorSettings.background;
  }
  if (document.getElementById('cardColorInput')) {
    document.getElementById('cardColorInput').value = colorSettings.card;
    document.getElementById('cardColorPreview').style.background = colorSettings.card;
  }
}

// User-Stats bei "Als bearbeitet" erh√∂hen
async function incrementUserStatsOnProcessed(order) {
  try {
    const userPhone = order.phone;
    const userName = order.userName;
    
    if (!userPhone) {
      console.error('Keine Telefonnummer in der Bestellung gefunden');
      return;
    }

    const userStatsRef = ref(db, `userStats/${userPhone}`);
    const snapshot = await get(userStatsRef);
    
    let currentStats = {};
    if (snapshot.exists()) {
      currentStats = snapshot.val();
    }
    
    const currentResetTime = currentStats.resetTime || 0;
    const currentLifeTime = currentStats.lifeTime || 0;
    
    const newStats = {
      userName: userName,
      phone: userPhone,
      lifeTime: currentLifeTime + 1,
      resetTime: currentResetTime + 1,
      lastReset: currentStats.lastReset || null
    };
    
    await update(userStatsRef, newStats);
    console.log(`User Stats erh√∂ht f√ºr ${userName}: LifeTime ${currentLifeTime} ‚Üí ${currentLifeTime + 1}, ResetTime ${currentResetTime} ‚Üí ${currentResetTime + 1}`);
    
  } catch (error) {
    console.error('Fehler beim Erh√∂hen der User-Stats:', error);
  }
}

// NEUE FUNKTION: User-Stats laden
async function loadUserStats(user) {
  try {
    const userStatsRef = ref(db, `userStats/${user.phone}`);
    const snapshot = await get(userStatsRef);
    
    const lifeTime = user.orders.length;
    
    if (snapshot.exists()) {
      const stats = snapshot.val();
      
      let resetTime = stats.resetTime;
      
      // Sicherstellen, dass resetTime nicht gr√∂√üer als lifeTime ist
      if (resetTime === undefined || resetTime === null || resetTime > lifeTime) {
        resetTime = lifeTime;
        await update(userStatsRef, {
          ...stats,
          resetTime: lifeTime
        });
      }
      
      return {
        lifeTime: lifeTime,
        resetTime: resetTime,
        lastReset: stats.lastReset || null
      };
    } else {
      // Neue Stats erstellen
      const initialStats = {
        lifeTime: lifeTime,
        resetTime: lifeTime,
        lastReset: null
      };
      
      await update(userStatsRef, initialStats);
      return initialStats;
    }
  } catch (error) {
    console.error('Fehler beim Laden der User-Stats:', error);
    return {
      lifeTime: user.orders.length,
      resetTime: user.orders.length,
      lastReset: null
    };
  }
}

// NEUE FUNKTION: ResetTime zur√ºcksetzen
async function resetUserTime(user) {
  if (!confirm(`ResetTime f√ºr ${user.userName} wirklich auf 0 zur√ºcksetzen?\n\nAktuell: ${user.resetTime} Bestellungen\nNach Reset: 0 Bestellungen`)) return;
  
  try {
    const userStatsRef = ref(db, `userStats/${user.phone}`);
    
    const currentSnapshot = await get(userStatsRef);
    const currentStats = currentSnapshot.exists() ? currentSnapshot.val() : {};
    
    await update(userStatsRef, {
      ...currentStats,
      userName: user.userName,
      phone: user.phone,
      lastReset: Date.now(),
      resetTime: 0
    });
    
    showToast(`ResetTime f√ºr ${user.userName} wurde auf 0 zur√ºckgesetzt`, 'success');
    
    // UI aktualisieren
    setTimeout(() => {
      renderUsersList();
      if (selectedUserId === user.phone) {
        renderUserOrders({
          ...user,
          resetTime: 0,
          lastReset: Date.now()
        });
      }
    }, 500);
    
  } catch (error) {
    console.error('Fehler beim Zur√ºcksetzen:', error);
    showToast('Fehler beim Zur√ºcksetzen der ResetTime', 'error');
  }
}

function showModal() { 
  document.getElementById('settingsModal').classList.remove('hidden-el'); 
  setTimeout(() => document.getElementById('settingsModal').classList.add('active'), 10); 
  document.body.style.overflow = 'hidden'; 
}

function hideModal() { 
  document.getElementById('settingsModal').classList.remove('active'); 
  document.body.style.overflow = ''; 
  setTimeout(() => document.getElementById('settingsModal').classList.add('hidden-el'), 240); 
}

// Event Listeners f√ºr Discord
document.getElementById('testDiscordBtn').addEventListener('click', testDiscordWebhook);
document.getElementById('saveDiscordBtn').addEventListener('click', saveDiscordSettings);
document.getElementById('resetDiscordBtn').addEventListener('click', async () => {
  if (!confirm('Discord Einstellungen zur√ºcksetzen?')) return;
  try {
    await update(discordRef, {
      webhookUrl: '',
      channelName: '',
      botName: '',
      botAvatar: ''
    });
    document.getElementById('discordWebhookUrl').value = '';
    document.getElementById('discordChannelName').value = '';
    document.getElementById('discordBotName').value = '';
    document.getElementById('discordBotAvatar').value = '';
    showToast('Discord Einstellungen zur√ºckgesetzt', 'success');
  } catch (error) {
    console.error('Fehler beim Zur√ºcksetzen der Discord Einstellungen:', error);
    showToast('Fehler beim Zur√ºcksetzen der Discord Einstellungen', 'error');
  }
});

// Basis Event Listeners
document.getElementById('openSettingsBtn').addEventListener('click', () => {
  document.getElementById('settingsPassword').value = '';
  document.getElementById('settingsLoginError').style.display = 'none';
  document.getElementById('settingsLoginArea').style.display = '';
  document.getElementById('settingsEditor').classList.add('hidden-el');
  showModal();
});

document.getElementById('settingsCloseBtn').addEventListener('click', hideModal);
document.getElementById('settingsModal').addEventListener('click', (e) => { 
  if(e.target === document.getElementById('settingsModal')) hideModal(); 
});

document.addEventListener('keydown', (e) => { 
  if(e.key === 'Escape' && !document.getElementById('settingsModal').classList.contains('hidden-el')) hideModal(); 
});

document.getElementById('settingsUnlockBtn').addEventListener('click', () => {
  const password = (document.getElementById('settingsPassword').value || '').trim();
  if(password === ADMIN_PASSWORD){
    document.getElementById('settingsLoginError').style.display = 'none';
    document.getElementById('settingsLoginArea').style.display = 'none';
    document.getElementById('settingsEditor').classList.remove('hidden-el');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden-el'));
    document.getElementById('tabProducts').classList.remove('hidden-el');
  } else {
    document.getElementById('settingsLoginError').style.display = '';
  }
});

// Tab Navigation
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const tabName = btn.dataset.tab;
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden-el'));
    document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.remove('hidden-el');
    if (tabName === 'users') renderUsersList();
    if (tabName === 'orders') renderOrdersList();
  });
});

// Shop/Warenkorb Navigation
document.getElementById('btnShop').addEventListener('click', () => {
  document.getElementById('shopView').classList.remove('hidden-el');
  document.getElementById('cartView').classList.add('hidden-el');
});

document.getElementById('btnCart').addEventListener('click', () => {
  document.getElementById('shopView').classList.add('hidden-el');
  document.getElementById('cartView').classList.remove('hidden-el');
  renderCartView();
});

// PRODUKTE mit RESSOURCEN laden und anzeigen
onValue(productsRef, snapshot => {
  products = [];
  snapshot.forEach(child => {
    const data = child.val(); 
    data.key = child.key; 
    products.push(data);
  });
  renderProductsGrid();
  renderProductsTable();
  populateCategorySelects();
});

function renderProductsGrid() {
  const productsGrid = document.getElementById('productsGrid');
  productsGrid.innerHTML = '';
  
  products.forEach(product => {
    const card = document.createElement('div');
    card.className = 'card fade-in';
    
    const img = document.createElement('img');
    img.src = product.image || 'https://via.placeholder.com/300x120';
    img.className = 'product-image';
    img.alt = product.name || 'Produktbild';
    img.onerror = () => handleImageError(img);
    
    const title = document.createElement('div');
    title.className = 'mobile-optimized-text product-card-text';
    title.style.fontWeight = '700';
    title.style.fontSize = '1rem';
    title.style.marginTop = '8px';
    title.style.color = product.colorName || 'var(--primary-color)';
    title.textContent = product.name || '';
    
    const desc = document.createElement('div');
    desc.className = 'small-muted mobile-optimized-text product-card-text';
    desc.textContent = product.description || '';
    
    card.appendChild(img);
    card.appendChild(title);
    card.appendChild(desc);

    // RESSOURCEN anzeigen
    if(product.resources){
      const pairs = product.resources.split(';').map(x => x.trim()).filter(Boolean);
      if(pairs.length > 0){
        const table = document.createElement('table');
        table.className = 'table';
        table.style.marginTop = '8px';
        table.innerHTML = `
          <thead>
            <tr>
              <th class="mobile-optimized-text">Ressource</th>
              <th style="text-align:right" class="mobile-optimized-text">Anzahl</th>
            </tr>
          </thead>
          <tbody>
            ${pairs.map(resource => {
              const [name, value, color] = resource.split(':');
              return `
                <tr>
                  <td style="color:${color || '#facc15'}" class="mobile-optimized-text resource-text-fix">${escapeHtml(name)}</td>
                  <td style="text-align:right;color:${product.colorQuantity || 'var(--secondary-color)'}" class="mobile-optimized-text">
                    ${Number(value).toLocaleString('de-DE')}
                  </td>
                </tr>`;
            }).join('')}
          </tbody>`;
        card.appendChild(table);
      }
    }

    if(product.category) {
      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'kv mobile-optimized-text product-card-text';
      categoryDiv.style.marginTop = '8px';
      categoryDiv.textContent = 'Kategorie: ' + product.category;
      card.appendChild(categoryDiv);
    }

    const addButton = document.createElement('button');
    addButton.className = 'btn';
    addButton.style.background = 'var(--success-color)';
    addButton.style.marginTop = '8px';
    addButton.textContent = '‚úÖ In den Warenkorb';
    addButton.onclick = () => { 
      addToCartByProductKey(product.key); 
      showToast(`"${product.name}" zum Warenkorb hinzugef√ºgt`, 'success'); 
    };
    card.appendChild(addButton);

    productsGrid.appendChild(card);
  });
}

function renderProductsTable() {
  const productsTableBody = document.getElementById('productsTableBody');
  productsTableBody.innerHTML = '';
  
  products.forEach(product => {
    const resourcesText = product.resources ? 
      product.resources.split(';').map(resource => {
        const [name, value] = resource.split(':');
        return `${name}: ${value}`;
      }).join(', ') : '';
    
    const row = document.createElement('tr');
    row.className = 'fade-in';
    row.innerHTML = `
      <td style="padding:8px">
        <img src="${product.image || 'https://via.placeholder.com/80'}" 
             class="product-image-admin" 
             alt="${escapeHtml(product.name || '')}">
      </td>
      <td style="padding:8px" class="mobile-optimized-text table-text-fix">${escapeHtml(product.name || '')}</td>
      <td style="padding:8px" class="mobile-optimized-text table-text-fix">${escapeHtml(product.category || '')}</td>
      <td style="padding:8px" class="mobile-optimized-text table-text-fix">${escapeHtml(resourcesText)}</td>
      <td style="padding:8px">
        <button class="btn small-btn edit-product" data-key="${product.key}" style="margin-right:6px">‚úèÔ∏è Bearbeiten</button>
        <button class="btn small-btn delete-product" data-key="${product.key}" style="background:var(--error-color)">üóëÔ∏è L√∂schen</button>
      </td>`;
    productsTableBody.appendChild(row);
    
    row.querySelector('.edit-product').addEventListener('click', () => openProductForm(product));
    row.querySelector('.delete-product').addEventListener('click', () => { 
      if(confirm('Produkt wirklich l√∂schen?')) {
        remove(ref(db, 'products/' + product.key))
          .then(() => showToast('Produkt gel√∂scht', 'success'))
          .catch(() => showToast('Fehler beim L√∂schen', 'error'));
      }
    });
  });
}

function openProductForm(product = null) {
  document.getElementById('productFormCard').classList.remove('hidden-el');
  document.querySelector('#resourceTable tbody').innerHTML = '';
  
  if(product){
    document.getElementById('prodId').value = product.key || '';
    document.getElementById('prodName').value = product.name || '';
    document.getElementById('prodImg').value = product.image || '';
    document.getElementById('prodPreview').src = product.image || 'https://via.placeholder.com/150x100';
    document.getElementById('prodDesc').value = product.description || '';
    document.getElementById('prodCategorySelect').value = product.category || '';
    document.getElementById('colorNameInput').value = product.colorName || '#22c55e';
    document.getElementById('colorQuantityInput').value = product.colorQuantity || '#3b82f6';
    
    if(product.resources){
      const pairs = product.resources.split(';').map(x => x.trim()).filter(Boolean);
      pairs.forEach(resource => {
        const [name, value, color] = resource.split(':');
        addResourceRow(name, value, color || '#facc15');
      });
    }
  } else {
    document.getElementById('prodId').value = '';
    document.getElementById('productForm').reset();
    document.getElementById('prodPreview').src = 'https://via.placeholder.com/150x100';
    document.getElementById('colorNameInput').value = '#22c55e';
    document.getElementById('colorQuantityInput').value = '#3b82f6';
  }
}

function addResourceRow(name = '', value = '', color = '#facc15') {
  const row = document.createElement('tr');
  row.className = 'fade-in';
  row.innerHTML = `
    <td><input class="input mobile-optimized-text" value="${escapeHtml(name)}" placeholder="Ressourcenname" /></td>
    <td style="text-align:right"><input type="number" min="0" class="input mobile-optimized-text" value="${escapeHtml(value)}" placeholder="0" /></td>
    <td><input type="color" class="color-input" value="${escapeHtml(color)}" /></td>
    <td style="text-align:center"><button class="btn small-btn" type="button" style="background:var(--error-color)">‚ùå L√∂schen</button></td>`;
  
  const deleteButton = row.querySelector('button');
  deleteButton.addEventListener('click', () => row.remove());
  document.querySelector('#resourceTable tbody').appendChild(row);
}

function addToCartByProductKey(productKey) {
  const product = products.find(p => p.key === productKey);
  if (!product) return;
  
  const resourceMap = resourcesToMap(product.resources);
  const existingIndex = cart.findIndex(item => item.key === productKey);
  
  if (existingIndex === -1) {
    cart.push({ 
      key: productKey, 
      name: product.name, 
      resources: {...resourceMap}, 
      quantity: 1 
    });
  } else {
    cart[existingIndex].quantity += 1;
    for(const resource in resourceMap) {
      cart[existingIndex].resources[resource] = (cart[existingIndex].resources[resource] || 0) + resourceMap[resource];
    }
  }
  
  renderCartView();
}

function resourcesToMap(resourcesString) {
  const map = {};
  if(!resourcesString) return map;
  const pairs = resourcesString.split(';').map(x => x.trim()).filter(Boolean);
  pairs.forEach(resource => {
    const [name, value] = resource.split(':');
    if(name && value) map[name] = (map[name] || 0) + Number(value);
  });
  return map;
}

function renderCartView() {
  const cartTableBody = document.querySelector('#cartTable tbody');
  cartTableBody.innerHTML = '';
  const totalResources = {};
  
  if (cart.length === 0) {
    cartTableBody.innerHTML = '<tr><td colspan="4" class="kv mobile-optimized-text" style="text-align:center;padding:20px">Warenkorb ist leer</td></tr>';
  } else {
    cart.forEach(entry => {
      const resText = Object.entries(entry.resources).map(([k,v])=>`${k}: ${v}`).join(', ');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mobile-optimized-text">${escapeHtml(entry.name)}</td>
        <td class="mobile-optimized-text resource-text-fix">${escapeHtml(resText)}</td>
        <td style="text-align:right" class="mobile-optimized-text">
          <div style="display:flex;align-items:center;justify-content:flex-end;gap:8px">
            <button class="btn small-btn" onclick="updateCartQuantity('${entry.key}', ${entry.quantity - 1})">-</button>
            <span>${entry.quantity}</span>
            <button class="btn small-btn" onclick="updateCartQuantity('${entry.key}', ${entry.quantity + 1})">+</button>
          </div>
        </td>
        <td style="text-align:center">
          <button class="btn small-btn" style="background:var(--error-color)" onclick="removeFromCart('${entry.key}')">üóëÔ∏è</button>
        </td>`;
      cartTableBody.appendChild(tr);
      
      for(const k in entry.resources) {
        totalResources[k] = (totalResources[k] || 0) + entry.resources[k];
      }
    });
  }
  
  const summary = Object.entries(totalResources).map(([k,v])=>`${k}: ${v}`).join(', ') || 'keine';
  document.getElementById('cartSummary').innerText = 'Gesamt Ressourcen: ' + summary;
  
  const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
  document.getElementById('cartCount').textContent = totalItems > 0 ? totalItems : '';
  document.getElementById('cartCount').style.display = totalItems > 0 ? 'flex' : 'none';
  
  ensureOrderUiInCart();
}

// BESTELLUNGEN laden und anzeigen
onValue(ordersRef, snapshot => {
  allOrders = [];
  snapshot.forEach(child => { 
    const o = child.val(); 
    o.key = child.key; 
    allOrders.push(o); 
  });
  renderOrdersList();
});

function renderOrdersList() {
  const ordersList = document.getElementById('ordersList');
  ordersList.innerHTML = '';
  
  const visibleOrders = allOrders.filter(o => o.status !== 'bearbeitet' && !o.removedFromOrders);
  
  if(visibleOrders.length === 0){ 
    ordersList.innerHTML = '<div class="kv mobile-optimized-text">Keine offenen Bestellungen vorhanden.</div>'; 
    return; 
  }
  
  visibleOrders.sort((a,b)=> {
    const statusOrder = { 'offen': 0, 'bearbeitet': 1, 'storniert': 2 };
    const statusA = statusOrder[a.status] || 0;
    const statusB = statusOrder[b.status] || 0;
    
    if (statusA !== statusB) {
      return statusA - statusB;
    }
    
    return (b.createdAt||0) - (a.createdAt||0);
  });
  
  visibleOrders.forEach(o => {
    const div = document.createElement('div');
    div.className = 'order-card fade-in';
    const name = o.userName || '‚Äî unbekannt ‚Äî';
    const phone = o.phone || '';
    const total = o.items?.length || 0;
    const date = o.createdAt ? new Date(o.createdAt).toLocaleString('de-DE') : '-';
    
    let statusClass = 'status-open';
    let statusText = '‚óè Offen';
    if (o.status === 'bearbeitet') {
      statusClass = 'status-processed';
      statusText = '‚úì Bearbeitet';
    } else if (o.status === 'storniert') {
      statusClass = 'status-cancelled';
      statusText = '‚úó Storniert';
    }
    
    div.innerHTML = `
      <div class="order-card-header">
        <div class="mobile-optimized-text">
          <strong>${escapeHtml(o.code)}</strong><br>
          <div class="kv">${escapeHtml(date)}</div>
          ${escapeHtml(name)} ${phone ? 'üìû '+escapeHtml(phone) : ''}
        </div>
        <div>
          <span class="status-badge ${statusClass}">${statusText}</span>
          <div class="kv mobile-optimized-text" style="text-align:right;margin-top:4px">${total} Artikel</div>
        </div>
      </div>
      <div class="order-card-actions">
        <button class="btn small-btn view-order" data-code="${escapeHtml(o.code)}">üëÅÔ∏è Ansehen</button>
        <button class="btn small-btn delete-order" data-key="${escapeHtml(o.key)}" style="background:var(--error-color)">üóëÔ∏è L√∂schen</button>
      </div>`;
    ordersList.appendChild(div);
    
    div.querySelector('.delete-order').addEventListener('click', () => { 
      if(confirm('Bestellung wirklich l√∂schen?')) 
        remove(ref(db,'orders/'+o.key))
          .then(() => showToast('Bestellung gel√∂scht', 'success'))
          .catch(() => showToast('Fehler beim L√∂schen', 'error')); 
    });
    
    div.querySelector('.view-order').addEventListener('click', () => loadOrderByCode(o.code));
  });
}

function loadOrderByCode(code) {
  const order = allOrders.find(o => (o.code||'').toString() === code.toString());
  if(!order) return showToast('Keine Bestellung mit diesem Code gefunden', 'error');
  
  selectedOrder = order;
  document.getElementById('orderDetails').style.display = '';
  document.getElementById('orderCodeDisplay').textContent = `Bestellcode: ${order.code}`;
  document.getElementById('orderItems').innerHTML = '';
  
  (order.items || []).forEach(item => {
    const div = document.createElement('div');
    const resText = Object.entries(item.resources || {}).map(([k,v])=>`${k}: ${v}`).join(', ');
    div.innerHTML = `<div style="margin-bottom:6px" class="mobile-optimized-text"><b>${escapeHtml(item.name)}</b> ‚Äî ${escapeHtml(String(item.quantity))}x</div><div class="kv mobile-optimized-text">${escapeHtml(resText)}</div>`;
    document.getElementById('orderItems').appendChild(div);
  });
  
  document.getElementById('orderUserName').value = order.userName || '';
  document.getElementById('orderPhone').value = order.phone || '';
  
  document.getElementById('markOrderProcessedBtn').disabled = order.status === 'bearbeitet';
  document.getElementById('markOrderOpenBtn').disabled = order.status === 'offen';
  document.getElementById('markOrderCancelledBtn').disabled = order.status === 'storniert';
}

// NUTZER mit LIFETIME/RESETTIME STATISTIKEN laden und anzeigen
async function renderUsersList() {
  const usersMap = new Map();
  
  allOrders.forEach(order => {
    if (order.phone && order.userName) {
      const userKey = `${order.phone}-${order.userName}`;
      if (!usersMap.has(userKey)) {
        usersMap.set(userKey, { 
          phone: order.phone, 
          userName: order.userName, 
          orders: []
        });
      }
      usersMap.get(userKey).orders.push(order);
    }
  });
  
  const users = Array.from(usersMap.values());
  const usersList = document.getElementById('usersList');
  usersList.innerHTML = '';
  
  if (users.length === 0) { 
    usersList.innerHTML = '<div class="kv mobile-optimized-text">Keine Nutzer mit Telefonnummern gefunden.</div>'; 
    return; 
  }
  
  users.sort((a, b) => a.userName.localeCompare(b.userName));
  
  // F√ºr jeden Nutzer die Stats laden
  for (const user of users) {
    const stats = await loadUserStats(user);
    user.lifeTime = stats.lifeTime;
    user.resetTime = stats.resetTime;
    user.lastReset = stats.lastReset;
    
    const userItem = document.createElement('div');
    userItem.className = 'user-order-item fade-in';
    if (selectedUserId === user.phone) userItem.classList.add('active');
    
    const lastResetText = user.lastReset ? 
      `(Zuletzt: ${new Date(user.lastReset).toLocaleString('de-DE')})` : 
      '(Noch nie zur√ºckgesetzt)';
    
    userItem.innerHTML = `
      <div style="font-weight:700" class="mobile-optimized-text">${escapeHtml(user.userName)}</div>
      <div class="kv mobile-optimized-text">üìû ${escapeHtml(user.phone)}</div>
      <div class="kv mobile-optimized-text" style="margin-top: 8px;">
        <div>üîÑ LifeTime: ${user.lifeTime} Bestellung${user.lifeTime !== 1 ? 'en' : ''}</div>
        <div>‚è∞ ResetTime: ${user.resetTime} Bestellung${user.resetTime !== 1 ? 'en' : ''}</div>
        <div class="kv" style="font-size: 0.7rem; margin-top: 4px;">${lastResetText}</div>
      </div>
      <div style="margin-top: 8px; display: flex; gap: 6px;">
        <button class="btn small-btn reset-time-btn" style="background: var(--warning-color);">üîÑ ResetTime zur√ºcksetzen</button>
        <button class="btn small-btn view-user-orders" style="background: var(--secondary-color);">üìã Bestellungen anzeigen</button>
      </div>`;
    
    usersList.appendChild(userItem);
    
    const resetBtn = userItem.querySelector('.reset-time-btn');
    resetBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      resetUserTime(user);
    });
    
    const detailsBtn = userItem.querySelector('.view-user-orders');
    detailsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      userItem.click();
    });
    
    userItem.addEventListener('click', () => {
      document.querySelectorAll('.user-order-item').forEach(item => item.classList.remove('active'));
      userItem.classList.add('active');
      selectedUserId = user.phone;
      renderUserOrders(user);
    });
  }
}

function renderUserOrders(user) {
  const userOrdersDetails = document.getElementById('userOrdersDetails');
  userOrdersDetails.innerHTML = '';
  
  if (!user || !user.orders.length) { 
    userOrdersDetails.innerHTML = '<div class="kv mobile-optimized-text">Keine Bestellungen f√ºr diesen Nutzer gefunden.</div>'; 
    return; 
  }
  
  // Header mit Statistiken
  const headerCard = document.createElement('div');
  headerCard.className = 'order-card';
  
  const lastResetText = user.lastReset ? 
    `(Zuletzt zur√ºckgesetzt: ${new Date(user.lastReset).toLocaleString('de-DE')})` : 
    '(Noch nie zur√ºckgesetzt)';
  
  headerCard.innerHTML = `
    <div class="order-card-header">
      <div class="mobile-optimized-text">
        <strong>üìä Statistiken f√ºr ${escapeHtml(user.userName)}</strong>
        <div class="kv">üìû ${escapeHtml(user.phone)}</div>
      </div>
    </div>
    <div class="user-stats-grid">
      <div class="stat-card stat-lifetime">
        <div class="stat-value">${user.lifeTime}</div>
        <div class="kv">LifeTime Bestellungen</div>
        <div class="kv" style="font-size:0.7rem">Gesamtanzahl aller Bestellungen</div>
      </div>
      <div class="stat-card stat-resettime">
        <div class="stat-value">${user.resetTime}</div>
        <div class="kv">ResetTime Bestellungen</div>
        <div class="kv" style="font-size:0.7rem">Aktuelle Periode</div>
      </div>
    </div>
    <div style="margin-top:12px;font-size:0.8rem;color:var(--muted)" class="mobile-optimized-text">
      ${lastResetText}
    </div>
    <div style="margin-top:12px;">
      <button class="btn reset-time-btn-details" style="background:var(--warning-color);width:100%;">
        üîÑ ResetTime auf 0 zur√ºcksetzen
      </button>
    </div>`;
  
  userOrdersDetails.appendChild(headerCard);
  
  // Reset-Button Event Listener f√ºr Details-Ansicht
  headerCard.querySelector('.reset-time-btn-details').addEventListener('click', () => {
    resetUserTime(user);
  });
  
  // Bestellungen anzeigen
  const sortedOrders = user.orders.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
  
  sortedOrders.forEach(order => {
    const orderCard = document.createElement('div');
    orderCard.className = 'order-card fade-in';
    
    const date = order.createdAt ? new Date(order.createdAt).toLocaleString('de-DE') : '-';
    
    let statusClass = 'status-open';
    let statusText = '‚óè Offen';
    if (order.status === 'bearbeitet') {
      statusClass = 'status-processed';
      statusText = '‚úì Bearbeitet';
    } else if (order.status === 'storniert') {
      statusClass = 'status-cancelled';
      statusText = '‚úó Storniert';
    }
    
    orderCard.innerHTML = `
      <div class="order-card-header">
        <div class="mobile-optimized-text">
          <strong>Bestellcode: ${escapeHtml(order.code)}</strong>
          <div class="kv">${escapeHtml(date)}</div>
        </div>
        <div>
          <span class="status-badge ${statusClass}">${statusText}</span>
        </div>
      </div>`;
    
    if (order.items && order.items.length > 0) {
      const itemsList = document.createElement('div');
      itemsList.style.marginTop = '8px';
      order.items.forEach(item => {
        const resourceText = Object.entries(item.resources || {}).map(([k, v]) => `${k}: ${v}`).join(', ');
        const itemDiv = document.createElement('div');
        itemDiv.style.marginBottom = '6px';
        itemDiv.style.padding = '6px';
        itemDiv.style.background = 'rgba(255,255,255,0.02)';
        itemDiv.style.borderRadius = '4px';
        itemDiv.innerHTML = `
          <div class="mobile-optimized-text"><b>${escapeHtml(item.name)}</b> ‚Äî ${item.quantity}x</div>
          <div class="kv mobile-optimized-text">${escapeHtml(resourceText)}</div>`;
        itemsList.appendChild(itemDiv);
      });
      orderCard.appendChild(itemsList);
    }
    
    userOrdersDetails.appendChild(orderCard);
  });
}

// KATEGORIEN Management
onValue(categoriesRef, snapshot => {
  categories = [];
  snapshot.forEach(child => {
    const data = child.val(); 
    data.key = child.key; 
    categories.push(data);
  });
  renderCategoriesList();
  populateCategorySelects();
});

function renderCategoriesList(){
  const categoriesList = document.getElementById('categoriesList');
  categoriesList.innerHTML = '';
  
  if(categories.length === 0){ 
    categoriesList.innerHTML = '<div class="kv mobile-optimized-text">Keine Kategorien vorhanden.</div>'; 
    return; 
  }
  
  categories.forEach(category => {
    const div = document.createElement('div');
    div.className = 'category-item fade-in';
    div.innerHTML = `
      <div class="mobile-optimized-text">${escapeHtml(category.name)}</div>
      <div style="display:flex;gap:6px">
        <button class="btn small-btn edit-category" data-key="${category.key}">‚úèÔ∏è</button>
        <button class="btn small-btn delete-category" data-key="${category.key}" style="background:var(--error-color)">üóëÔ∏è L√∂schen</button>
      </div>`;
    categoriesList.appendChild(div);
    
    div.querySelector('.delete-category').addEventListener('click', async () => {
      if(!confirm('Kategorie wirklich l√∂schen?')) return;
      try{ 
        await remove(ref(db, 'categories/' + category.key)); 
        showToast('Kategorie gel√∂scht', 'success');
      } 
      catch(e){ console.error(e); showToast('Fehler beim L√∂schen', 'error'); }
    });
    
    div.querySelector('.edit-category').addEventListener('click', () => {
      const newName = prompt('Neuer Kategorie-Name', category.name);
      if(newName && newName.trim()){
        update(ref(db, 'categories/' + category.key), { name: newName.trim() })
          .then(() => showToast('Kategorie umbenannt', 'success'))
          .catch(() => showToast('Fehler beim Umbenennen', 'error'));
      }
    });
  });
}

function populateCategorySelects(){
  const prodCategorySelect = document.getElementById('prodCategorySelect');
  const shopCategoryFilter = document.getElementById('shopCategoryFilter');
  
  prodCategorySelect.innerHTML = '<option value="">‚Äî Keine Kategorie ‚Äî</option>';
  shopCategoryFilter.innerHTML = '<option value="">‚Äî Alle Kategorien ‚Äî</option>';

  categories.forEach(category => {
    const option1 = document.createElement('option');
    option1.value = category.name;
    option1.textContent = category.name;
    option1.className = 'mobile-optimized-text';
    prodCategorySelect.appendChild(option1);
    
    const option2 = document.createElement('option');
    option2.value = category.name;
    option2.textContent = category.name;
    option2.className = 'mobile-optimized-text';
    shopCategoryFilter.appendChild(option2);
  });
}

// BESTELLUNG Funktionen
function ensureOrderUiInCart() {
  if(saveOrderBtnEl) return;
  
  const wrapper = document.createElement('div');
  wrapper.style.marginTop = '12px';
  
  saveOrderBtnEl = document.createElement('button');
  saveOrderBtnEl.className = 'btn';
  saveOrderBtnEl.style.background = 'var(--success-color)';
  saveOrderBtnEl.textContent = '‚úÖ Bestellung speichern (Code erzeugen)';
  saveOrderBtnEl.addEventListener('click', saveCartAsOrder);
  wrapper.appendChild(saveOrderBtnEl);
  
  orderCodeDisplayEl = document.createElement('div');
  orderCodeDisplayEl.style.marginTop = '8px';
  orderCodeDisplayEl.style.fontWeight = '700';
  orderCodeDisplayEl.style.fontSize = '1.05rem';
  orderCodeDisplayEl.className = 'success mobile-optimized-text';
  orderCodeDisplayEl.textContent = '';
  
  const copyBtn = document.createElement('button');
  copyBtn.className = 'btn small-btn';
  copyBtn.style.marginLeft = '8px';
  copyBtn.textContent = 'üìã Kopieren';
  copyBtn.addEventListener('click', () => {
    const txt = (orderCodeDisplayEl.textContent || '').replace('Bestellcode: ','').trim();
    if(!txt) return showToast('Kein Bestellcode vorhanden', 'warning');
    navigator.clipboard?.writeText(txt).then(() => showToast('Code kopiert', 'success')).catch(() => showToast('Kopieren nicht m√∂glich', 'error'));
  });
  
  const codeWrap = document.createElement('div');
  codeWrap.style.display = 'flex';
  codeWrap.style.alignItems = 'center';
  codeWrap.style.gap = '8px';
  codeWrap.appendChild(orderCodeDisplayEl);
  codeWrap.appendChild(copyBtn);
  wrapper.appendChild(codeWrap);
  
  document.getElementById('cartView').appendChild(wrapper);
}

function generate4DigitCode() { 
  return Math.floor(1000 + Math.random() * 9000).toString(); 
}

async function saveCartAsOrder() {
  if(cart.length === 0) return showToast('Warenkorb ist leer', 'warning');
  
  const userName = prompt('Bitte Namen eingeben f√ºr Bestellung:');
  const userPhone = prompt('Bitte Telefonnummer eingeben:');
  
  if(!userName || !userPhone) {
    showToast('Bestellung abgebrochen: Name und Telefon werden ben√∂tigt', 'error');
    return;
  }
  
  const code = generate4DigitCode();
  const orderData = { 
    code: code, 
    createdAt: Date.now(), 
    items: [...cart], 
    status: 'offen', 
    userName: userName, 
    phone: userPhone 
  };
  
  try {
    const newOrderRef = push(ordersRef);
    await update(newOrderRef, orderData);
    
    // Discord Webhook senden
    await sendDiscordWebhook(orderData);
    
    if(!orderCodeDisplayEl) ensureOrderUiInCart();
    orderCodeDisplayEl.textContent = 'Bestellcode: ' + code;
    cart = [];
    renderCartView();
    showToast(`Bestellung gespeichert mit Code: ${code}`, 'success');
    
  } catch (e) { 
    console.error(e); 
    showToast('Fehler beim Speichern der Bestellung', 'error'); 
  }
}

// Globale Funktionen f√ºr Cart
window.updateCartQuantity = function(productKey, newQuantity) {
  const item = cart.find(item => item.key === productKey);
  if (item && newQuantity > 0) {
    const product = products.find(p => p.key === productKey);
    if (product) {
      const resourceMap = resourcesToMap(product.resources);
      item.quantity = newQuantity;
      item.resources = {};
      for (let i = 0; i < newQuantity; i++) {
        for (const resource in resourceMap) {
          item.resources[resource] = (item.resources[resource] || 0) + resourceMap[resource];
        }
      }
    }
    renderCartView();
  } else if (newQuantity <= 0) {
    removeFromCart(productKey);
  }
}

window.removeFromCart = function(productKey) {
  const index = cart.findIndex(item => item.key === productKey);
  if (index !== -1) {
    cart.splice(index, 1);
    renderCartView();
    showToast('Produkt aus Warenkorb entfernt', 'success');
  }
}

// Globale Funktion f√ºr Reset
window.resetUserTime = resetUserTime;

function escapeHtml(text) {
  if(!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ... (Rest des Codes bleibt gleich wie vorher) ...

// Initialisierung
setupImageUpload();
ensureOrderUiInCart();
renderCartView();

// Settings von Firebase laden
onValue(settingsRef, snapshot => {
  const val = snapshot.val();
  if(val){
    settings.title = val.title || settings.title;
    settings.headerImage = val.headerImage || settings.headerImage;
  }
  document.getElementById('pageTitle').innerText = settings.title || 'Bullet Farm v3';
  document.getElementById('headerLogo').src = settings.headerImage || 'https://via.placeholder.com/48';
  if(document.getElementById('settingTitle')) document.getElementById('settingTitle').value = settings.title || '';
  if(document.getElementById('settingHeaderImage')) document.getElementById('settingHeaderImage').value = settings.headerImage || '';
});

// Farben von Firebase laden
onValue(colorsRef, snapshot => {
  const colors = snapshot.val();
  if (colors) {
    applyColors(colors);
  }
});

console.log('üöÄ Bullet Farm v3 Shop komplett initialisiert - MIT LIFETIME/RESETTIME STATISTIKEN!');
</script>
</body>
</html>

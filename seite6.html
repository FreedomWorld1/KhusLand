<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bullet Farm v3 — Shop</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root {
  --bg: #0f1724;
  --card: #0b1220;
  --muted: #9ca3af;
  --accent: #06b6d4;
  --primary-color: #22c55e;
  --secondary-color: #3b82f6;
  --success-color: #10b981;
  --warning-color: #f59e0b;
  --error-color: #ef4444;
  --background-color: #0f1724;
}

body {
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
  background: var(--background-color);
  color: #e6eef8;
  margin: 0;
  line-height: 1.5;
  transition: background-color 0.3s ease;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 12px;
}

.card {
  background: linear-gradient(180deg, var(--card), rgba(255,255,255,0.01));
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: 12px;
  padding: 16px;
}

.shadow-soft {
  box-shadow: 0 8px 30px rgba(2,6,23,0.6);
}

.small-muted {
  color: var(--muted);
  font-size: 0.85rem;
  margin-top: 4px;
}

.btn {
  transition: all 0.12s ease;
  border-radius: 8px;
  padding: 0.45rem 0.8rem;
  cursor: pointer;
  background: #111827;
  color: #e6eef8;
  border: 1px solid rgba(255,255,255,0.03);
  font-size: 0.9rem;
  white-space: nowrap;
}

.btn:hover {
  transform: translateY(-2px);
  background: #1f2937;
}

.btn:active {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.hidden-el {
  display: none !important;
}

.product-image {
  width: 100%;
  height: 130px;
  object-fit: cover;
  border-radius: 8px;
}

.product-image-admin {
  width: 80px;
  height: 50px;
  object-fit: cover;
  border-radius: 6px;
}

#productsGrid .card {
  margin: 0 auto;
  transition: transform 0.2s ease;
}

#productsGrid .card:hover {
  transform: translateY(-5px);
}

.modal-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(4,6,11,0.6);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.22s ease;
  z-index: 80;
  backdrop-filter: blur(4px);
  padding: 12px;
}

.modal-overlay.active {
  opacity: 1;
  pointer-events: all;
}

.modal-box {
  width: 100%;
  max-width: 980px;
  background: linear-gradient(180deg, var(--card), var(--background-color));
  border-radius: 12px;
  padding: 16px;
  border: 1px solid rgba(255,255,255,0.04);
  box-shadow: 0 20px 60px rgba(2,6,23,0.7);
  transform: translateY(-8px);
  transition: transform 0.22s ease;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-overlay.active .modal-box {
  transform: translateY(0);
}

.tab-btn {
  padding: 8px 12px;
  border-radius: 8px;
  background: rgba(255,255,255,0.02);
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid transparent;
  font-size: 0.85rem;
  white-space: nowrap;
}

.tab-btn.active {
  background: linear-gradient(90deg, #94a3b8, #06b6d4);
  color: #041628;
  font-weight: 700;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table th, .table td {
  padding: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  text-align: left;
  font-size: 0.92rem;
}

.kv {
  font-size: 0.9rem;
  color: var(--muted);
}

.category-item {
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: space-between;
  padding: 8px;
  background: rgba(255,255,255,0.02);
  border-radius: 8px;
  margin-bottom: 6px;
}

.input, textarea, select {
  background: #071224;
  border: 1px solid rgba(255,255,255,0.04);
  color: #e6eef8;
  padding: 0.5rem;
  border-radius: 8px;
  width: 100%;
  font-size: 16px;
}

.input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: rgba(6, 182, 212, 0.5);
}

.color-input {
  width: 48px;
  height: 36px;
  padding: 0;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.04);
  background: #fff;
  cursor: pointer;
}

.small-btn {
  padding: 0.35rem 0.6rem;
  border-radius: 6px;
  font-size: 0.8rem;
}

.success { color: var(--success-color); }
.warning { color: var(--warning-color); }
.error { color: var(--error-color); }
.info { color: var(--secondary-color); }

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

.fade-in {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.orders-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-top: 16px;
}

.orders-column {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.user-order-item {
  background: rgba(255,255,255,0.02);
  border-radius: 8px;
  padding: 12px;
  border: 1px solid rgba(255,255,255,0.03);
  cursor: pointer;
  transition: all 0.2s ease;
}

.user-order-item:hover {
  background: rgba(255,255,255,0.04);
}

.user-order-item.active {
  background: rgba(6, 182, 212, 0.1);
  border-color: rgba(6, 182, 212, 0.3);
}

.user-orders-list, .order-details-container {
  max-height: 50vh;
  overflow-y: auto;
}

.status-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

.status-open {
  background: rgba(245, 158, 11, 0.2);
  color: var(--warning-color);
}

.status-processed {
  background: rgba(16, 185, 129, 0.2);
  color: var(--success-color);
}

.status-cancelled {
  background: rgba(239, 68, 68, 0.2);
  color: var(--error-color);
}

.order-card {
  background: rgba(255,255,255,0.02);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
  border: 1px solid rgba(255,255,255,0.03);
}

.order-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.order-card-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}

/* Bild-Upload Stile */
.image-upload-container {
  position: relative;
  display: inline-block;
}

.image-upload-btn {
  background: var(--secondary-color);
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: background 0.2s ease;
}

.image-upload-btn:hover {
  background: #2563eb;
}

.image-preview-container {
  margin-top: 8px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.image-preview {
  width: 80px;
  height: 60px;
  object-fit: cover;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.1);
}

.file-input {
  display: none;
}

/* Mobile Styles */
@media (max-width: 768px) {
  .container {
    padding: 8px;
  }
  
  .card {
    padding: 12px;
  }
  
  .grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .product-image {
    height: 120px;
  }
  
  .flex.gap-2 {
    flex-wrap: wrap;
    gap: 6px;
  }
  
  .tab-btn {
    padding: 6px 10px;
    font-size: 0.8rem;
    flex: 1;
    text-align: center;
  }
  
  .table-container {
    overflow-x: auto;
  }
  
  .table {
    font-size: 0.8rem;
    min-width: 500px;
  }
  
  .btn {
    padding: 0.4rem 0.7rem;
    font-size: 0.85rem;
  }
  
  .orders-layout {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .shop-header {
    flex-direction: column;
    gap: 10px;
    align-items: flex-start !important;
  }
  
  .shop-filter {
    width: 100% !important;
  }
  
  .admin-actions {
    flex-direction: column;
    gap: 8px;
  }
  
  .admin-actions .btn {
    width: 100%;
  }
  
  .order-card-header {
    flex-direction: column;
    gap: 8px;
  }
  
  .order-card-actions {
    flex-wrap: wrap;
  }
}

@media (max-width: 480px) {
  .grid {
    gap: 10px;
  }
  
  .product-image {
    height: 100px;
  }
  
  .container {
    padding: 6px;
  }
  
  .card {
    padding: 10px;
  }
}

/* Text-Optimierungen */
.mobile-optimized-text {
  word-break: break-word;
  overflow-wrap: break-word;
  hyphens: auto;
  line-height: 1.4;
}

.product-card-text {
  word-break: break-word;
  overflow-wrap: break-word;
  line-height: 1.4;
}

.table-text-fix {
  word-break: break-word;
  overflow-wrap: break-word;
  max-width: 200px;
}

.resource-text-fix {
  word-break: break-word;
  overflow-wrap: break-word;
  white-space: normal !important;
}

/* Toast Notifications */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.toast {
  padding: 12px 16px;
  border-radius: 8px;
  color: white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  animation: slideInRight 0.3s ease;
  max-width: 300px;
}

.toast-success {
  background: var(--success-color);
}

.toast-error {
  background: var(--error-color);
}

.toast-warning {
  background: var(--warning-color);
}

.toast-info {
  background: var(--secondary-color);
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Loading Spinner */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Search Input */
.search-input {
  position: relative;
}

.search-input input {
  padding-left: 36px;
}

.search-icon {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--muted);
}

/* Settings Search */
.settings-search-container {
  margin-bottom: 16px;
}

.no-search-results {
  text-align: center;
  padding: 20px;
  color: var(--muted);
  font-style: italic;
}

/* User Stats */
.user-stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 8px;
}

.stat-card {
  padding: 12px;
  border-radius: 8px;
  text-align: center;
}

.stat-lifetime {
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.2);
}

.stat-resettime {
  background: rgba(245, 158, 11, 0.1);
  border: 1px solid rgba(245, 158, 11, 0.2);
}

.stat-value {
  font-size: 1.5rem;
  font-weight: bold;
  margin-bottom: 4px;
}

.stat-lifetime .stat-value {
  color: var(--success-color);
}

.stat-resettime .stat-value {
  color: var(--warning-color);
}

/* Color Settings */
.color-setting-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px;
  background: rgba(255,255,255,0.02);
  border-radius: 8px;
  margin-bottom: 8px;
}

.color-preview {
  width: 24px;
  height: 24px;
  border-radius: 4px;
  border: 1px solid rgba(255,255,255,0.1);
}

.color-input-wide {
  width: 80px;
  height: 36px;
}
</style>
</head>
<body>
  <div class="container">
    <header class="card shadow-soft mb-6 flex items-center justify-between fade-in">
      <div class="flex items-center gap-4">
        <img id="headerLogo" src="https://via.placeholder.com/48" alt="Logo" style="width:48px;height:48px;object-fit:cover;border-radius:8px">
        <div>
          <h1 id="pageTitle" style="font-size:1.4rem;font-weight:700;color:var(--primary-color);margin:0" class="mobile-optimized-text">Bullet Farm v3</h1>
          <div class="small-muted mobile-optimized-text">Shop System</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnShop" class="btn">Shop</button>
        <button id="btnCart" class="btn">Warenkorb <span id="cartCount" style="margin-left:4px;background:var(--secondary-color);border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:0.7rem;"></span></button>
        <button id="openSettingsBtn" class="btn">⚙️</button>
      </div>
    </header>

    <main id="mainContent">
      <section id="shopView" class="card mb-6 fade-in">
        <div class="shop-header flex items-center justify-between mb-4">
          <div class="flex items-center gap-3" style="flex-wrap: wrap;">
            <h2 style="font-weight:700;color:var(--primary-color);margin:0" class="mobile-optimized-text">🛒 Produkte</h2>
            <div class="kv mobile-optimized-text" style="white-space: nowrap;">Filter:</div>
            <select id="shopCategoryFilter" class="input shop-filter" style="width:200px; min-width: 150px;">
              <option value="">— Alle Kategorien —</option>
            </select>
          </div>
          <div class="search-input" style="position:relative">
            <div class="search-icon">🔍</div>
            <input id="productSearch" type="text" class="input" placeholder="Produkte suchen..." style="padding-left:36px;width:200px">
          </div>
        </div>
        <div id="productsGrid" class="grid"></div>
      </section>

      <section id="cartView" class="card mb-6 hidden-el fade-in">
        <div class="flex items-center justify-between mb-4">
          <h2 style="font-weight:700;color:var(--primary-color)" class="mobile-optimized-text">🛍️ Warenkorb</h2>
          <div class="kv mobile-optimized-text">Ressourcen & Anzahl</div>
        </div>
        <div class="table-container">
          <table class="table" id="cartTable">
            <thead>
              <tr>
                <th class="mobile-optimized-text">Produkt</th>
                <th class="mobile-optimized-text">Ressourcen</th>
                <th style="text-align:right" class="mobile-optimized-text">Anzahl</th>
                <th style="width:80px" class="mobile-optimized-text">Aktionen</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:12px;font-weight:700" id="cartSummary" class="mobile-optimized-text">Gesamt Ressourcen: keine</div>
      </section>
    </main>
  </div>

  <div id="settingsModal" class="modal-overlay hidden-el" aria-hidden="true">
    <div class="modal-box">
      <div class="flex items-start justify-between mb-4">
        <div>
          <h3 style="font-size:1.15rem;font-weight:700;color:#94a3b8;margin:0" class="mobile-optimized-text">⚙️ Einstellungen</h3>
          <div class="kv mobile-optimized-text">Passwortgeschützte — Funktionen</div>
        </div>
        <div class="flex gap-2 items-center">
          <button id="settingsCloseBtn" class="btn">✖</button>
        </div>
      </div>

      <div id="settingsLoginArea">
        <label class="kv mb-2 mobile-optimized-text">Admin Passwort</label>
        <div class="flex items-center gap-2 mb-3">
          <input id="settingsPassword" type="password" class="input" placeholder="Passwort (1101)"/>
          <button id="settingsUnlockBtn" class="btn">Einloggen</button>
        </div>
        <div id="settingsLoginError" class="error kv mobile-optimized-text" style="display:none">❌ Falsches Passwort</div>
      </div>

      <div id="settingsEditor" class="hidden-el">
        <div class="mb-4">
          <div class="flex gap-2">
            <button class="tab-btn active" data-tab="products">Produkte</button>
            <button class="tab-btn" data-tab="categories">Kategorien</button>
            <button class="tab-btn" data-tab="general">Allgemein</button>
            <button class="tab-btn" data-tab="orders">Bestellungen</button>
            <button class="tab-btn" data-tab="users">Nutzer</button>
            <button class="tab-btn" data-tab="colors">Farben</button>
            <button class="tab-btn" data-tab="discord">Discord</button>
          </div>
        </div>

        <div id="tabProducts" class="tab-panel">
          <div class="flex items-center justify-between mb-3 admin-actions">
            <h4 style="font-weight:700" class="mobile-optimized-text">Produkte verwalten</h4>
            <div class="flex gap-2">
              <button id="btnNewProduct" class="btn">Neues Produkt</button>
              <button id="btnReloadProducts" class="btn">Neu laden</button>
            </div>
          </div>

          <div id="productFormCard" class="card mb-3 hidden-el">
            <form id="productForm">
              <input id="prodId" type="hidden"/>
              <div style="display:grid;grid-template-columns:1fr 120px;gap:10px;margin-bottom:10px">
                <div>
                  <input id="prodName" class="input mobile-optimized-text" placeholder="Name" required />
                  <div style="display:flex;gap:8px;margin-top:8px">
                    <input id="prodImg" class="input mobile-optimized-text" placeholder="Bild-URL oder Datei auswählen"/>
                    <div class="image-upload-container">
                      <input type="file" id="prodImgFile" class="file-input" accept="image/*">
                      <label for="prodImgFile" class="image-upload-btn">📁 Datei</label>
                    </div>
                  </div>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px">
                  <label class="kv mobile-optimized-text">Vorschau</label>
                  <img id="prodPreview" src="https://via.placeholder.com/150x100" alt="Vorschau" style="width:100%;height:80px;object-fit:cover;border-radius:6px;border:1px solid rgba(255,255,255,0.03)">
                </div>
              </div>

              <textarea id="prodDesc" class="input mobile-optimized-text" rows="2" placeholder="Beschreibung (optional)" style="margin-bottom:8px"></textarea>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px">
                <select id="prodCategorySelect" class="input mobile-optimized-text">
                  <option value="">— Keine Kategorie —</option>
                </select>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <label class="kv mobile-optimized-text">Name-Farbe</label>
                  <input id="colorNameInput" type="color" class="color-input" value="#22c55e">
                  <label class="kv mobile-optimized-text">Anzahl-Farbe</label>
                  <input id="colorQuantityInput" type="color" class="color-input" value="#3b82f6">
                </div>
              </div>

              <div id="resourceTableContainer" style="margin-bottom:8px">
                <h5 style="margin:0 0 8px 0;font-weight:700" class="mobile-optimized-text">Ressourcen (Name:Anzahl:Farbe)</h5>
                <div class="table-container">
                  <table class="table" id="resourceTable">
                    <thead>
                      <tr>
                        <th class="mobile-optimized-text">Ressource</th>
                        <th style="width:120px;text-align:right" class="mobile-optimized-text">Anzahl</th>
                        <th style="width:120px" class="mobile-optimized-text">Farbe</th>
                        <th style="width:60px" class="mobile-optimized-text">Aktion</th>
                      </tr>
                    </thead>
                    <tbody style="background:transparent"></tbody>
                  </table>
                </div>
                <div style="margin-top:8px">
                  <button id="addResourceBtn" type="button" class="btn">Ressource hinzufügen</button>
                </div>
              </div>

              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button type="submit" class="btn" style="background:var(--success-color)">✅ Speichern</button>
                <button id="cancelProductBtn" type="button" class="btn" style="background:var(--error-color)">❌ Abbrechen</button>
              </div>
            </form>
          </div>

          <div class="card" style="max-height:46vh;overflow:auto">
            <div class="table-container">
              <table class="table" style="width:100%">
                <thead>
                  <tr>
                    <th class="mobile-optimized-text">Vorschau</th>
                    <th class="mobile-optimized-text">Name</th>
                    <th class="mobile-optimized-text">Kategorie</th>
                    <th class="mobile-optimized-text">Ressourcen</th>
                    <th style="width:140px" class="mobile-optimized-text">Aktionen</th>
                  </tr>
                </thead>
                <tbody id="productsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="tabCategories" class="tab-panel hidden-el">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
            <h4 style="font-weight:700" class="mobile-optimized-text">Kategorien verwalten</h4>
            <div style="display:flex;gap:8px;width:100%;max-width:360px;">
              <input id="newCategoryInput" class="input mobile-optimized-text" placeholder="Neue Kategorie" />
              <button id="addCategoryBtn" class="btn">Hinzufügen</button>
            </div>
          </div>
          <div id="categoriesList" class="card" style="max-height:36vh;overflow:auto;padding:12px"></div>
        </div>

        <div id="tabGeneral" class="tab-panel hidden-el">
          <h4 style="font-weight:700;margin-bottom:8px" class="mobile-optimized-text">Allgemein</h4>
          <label class="kv mb-2 mobile-optimized-text">Titel</label>
          <input id="settingTitle" class="input mobile-optimized-text" placeholder="Seiten-Titel"/>
          <label class="kv mb-2 mobile-optimized-text" style="margin-top:8px">Header Bild URL (48x48 empfohlen)</label>
          <input id="settingHeaderImage" class="input mobile-optimized-text" placeholder="Bild-URL"/>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
            <button id="saveGeneralBtn" class="btn" style="background:var(--success-color)">✅ Speichern</button>
            <button id="resetGeneralBtn" class="btn" style="background:var(--error-color)">❌ Zurücksetzen</button>
          </div>
        </div>

        <div id="tabOrders" class="tab-panel hidden-el">
          <div class="settings-search-container">
            <div class="search-input">
              <div class="search-icon">🔍</div>
              <input id="ordersSearch" type="text" class="input" placeholder="Bestellungen suchen (Code, Name, Telefon, Status)..." style="padding-left:36px">
            </div>
          </div>

          <h4 style="font-weight:700;margin-bottom:8px" class="mobile-optimized-text">Bestellungen verwalten</h4>

          <div class="flex items-center gap-2 mb-3" style="flex-wrap:wrap;">
            <input id="orderCodeInput" class="input mobile-optimized-text" placeholder="Bestellcode eingeben (z. B. 4272)" style="width:200px;min-width:150px;">
            <button id="loadOrderBtn" class="btn">Laden</button>
            <button id="refreshOrdersBtn" class="btn">🔄 Aktualisieren</button>
          </div>

          <div id="orderDetails" class="card" style="margin-bottom:12px;display:none">
            <h5 style="margin:0 0 8px 0" class="mobile-optimized-text">Bestelldetails</h5>
            <div id="orderCodeDisplay" class="kv mobile-optimized-text" style="margin-bottom:8px"></div>
            <div id="orderItems" class="kv mobile-optimized-text"></div>
            <div style="margin-top:8px">
              <input id="orderUserName" class="input mobile-optimized-text" placeholder="Name des Kunden" style="margin-top:6px">
              <input id="orderPhone" class="input mobile-optimized-text" placeholder="Telefonnummer" style="margin-top:6px">
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                <button id="saveOrderUserBtn" class="btn" style="background:var(--success-color)">✅ Daten speichern</button>
                <button id="markOrderProcessedBtn" class="btn" style="background:var(--success-color)">✅ Als bearbeitet</button>
                <button id="markOrderOpenBtn" class="btn" style="background:var(--warning-color)">🔄 Als offen</button>
                <button id="markOrderCancelledBtn" class="btn" style="background:var(--error-color)">❌ Stornieren</button>
              </div>
            </div>
          </div>

          <h5 style="margin-top:10px" class="mobile-optimized-text">Alle Bestellungen</h5>
          <div id="ordersList" class="card" style="max-height:40vh;overflow:auto;padding:12px"></div>
        </div>

        <div id="tabUsers" class="tab-panel hidden-el">
          <div class="settings-search-container">
            <div class="search-input">
              <div class="search-icon">🔍</div>
              <input id="usersSearch" type="text" class="input" placeholder="Nutzer suchen (Name, Telefon)..." style="padding-left:36px">
            </div>
          </div>

          <h4 style="font-weight:700;margin-bottom:8px" class="mobile-optimized-text">Nutzer & Bestellungen</h4>
          <div class="kv mb-3 mobile-optimized-text">Klicke auf einen Nutzer, um alle seine Bestellungen zu sehen</div>
          
          <div class="orders-layout">
            <div class="orders-column">
              <h5 class="mobile-optimized-text">📞 Nutzer</h5>
              <div id="usersList" class="card user-orders-list" style="padding:12px">
                <div class="kv mobile-optimized-text">Lade Nutzer...</div>
              </div>
            </div>
            
            <div class="orders-column">
              <h5 class="mobile-optimized-text">📋 Bestellungen des Nutzers</h5>
              <div id="userOrdersDetails" class="card order-details-container" style="padding:12px">
                <div class="kv mobile-optimized-text">Wähle einen Nutzer aus, um seine Bestellungen zu sehen</div>
              </div>
            </div>
          </div>
        </div>

        <div id="tabColors" class="tab-panel hidden-el">
          <h4 style="font-weight:700;margin-bottom:8px" class="mobile-optimized-text">🎨 Globale Farben verwalten</h4>
          <div class="kv mb-3 mobile-optimized-text">Ändere hier die Farben der gesamten Webseite</div>
          
          <div class="card" style="margin-bottom:16px">
            <h5 style="margin:0 0 12px 0;font-weight:700" class="mobile-optimized-text">Hintergrund & Karten</h5>
            
            <div class="color-setting-item">
              <div>
                <div style="font-weight:600" class="mobile-optimized-text">Hintergrundfarbe</div>
                <div class="kv mobile-optimized-text">Haupt-Hintergrund der gesamten Webseite</div>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div class="color-preview" id="backgroundColorPreview" style="background:var(--background-color)"></div>
                <input type="color" id="backgroundColorInput" class="color-input-wide" value="#0f1724">
              </div>
            </div>
            
            <div class="color-setting-item">
              <div>
                <div style="font-weight:600" class="mobile-optimized-text">Karten-Hintergrund</div>
                <div class="kv mobile-optimized-text">Hintergrundfarbe der Karten/Container</div>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div class="color-preview" id="cardColorPreview" style="background:var(--card)"></div>
                <input type="color" id="cardColorInput" class="color-input-wide" value="#0b1220">
              </div>
            </div>
            
            <h5 style="margin:20px 0 12px 0;font-weight:700" class="mobile-optimized-text">Hauptfarben</h5>
            
            <div class="color-setting-item">
              <div>
                <div style="font-weight:600" class="mobile-optimized-text">Primärfarbe</div>
                <div class="kv mobile-optimized-text">Titel, Überschriften, wichtige Elemente</div>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div class="color-preview" id="primaryColorPreview" style="background:var(--primary-color)"></div>
                <input type="color" id="primaryColorInput" class="color-input-wide" value="#22c55e">
              </div>
            </div>
            
            <div class="color-setting-item">
              <div>
                <div style="font-weight:600" class="mobile-optimized-text">Sekundärfarbe</div>
                <div class="kv mobile-optimized-text">Warenkorb-Zähler, Buttons, sekundäre Elemente</div>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div class="color-preview" id="secondaryColorPreview" style="background:var(--secondary-color)"></div>
                <input type="color" id="secondaryColorInput" class="color-input-wide" value="#3b82f6">
              </div>
            </div>
            
            <div class="color-setting-item">
              <div>
                <div style="font-weight:600" class="mobile-optimized-text">Erfolgsfarbe</div>
                <div class="kv mobile-optimized-text">Positive Aktionen, Bestätigungen</div>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div class="color-preview" id="successColorPreview" style="background:var(--success-color)"></div>
                <input type="color" id="successColorInput" class="color-input-wide" value="#10b981">
              </div>
            </div>
            
            <div class="color-setting-item">
              <div>
                <div style="font-weight:600" class="mobile-optimized-text">Warnfarbe</div>
                <div class="kv mobile-optimized-text">Warnungen, Status "offen"</div>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div class="color-preview" id="warningColorPreview" style="background:var(--warning-color)"></div>
                <input type="color" id="warningColorInput" class="color-input-wide" value="#f59e0b">
              </div>
            </div>
            
            <div class="color-setting-item">
              <div>
                <div style="font-weight:600" class="mobile-optimized-text">Fehlerfarbe</div>
                <div class="kv mobile-optimized-text">Fehler, Stornierungen, negative Aktionen</div>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div class="color-preview" id="errorColorPreview" style="background:var(--error-color)"></div>
                <input type="color" id="errorColorInput" class="color-input-wide" value="#ef4444">
              </div>
            </div>
          </div>
          
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="saveColorsBtn" class="btn" style="background:var(--success-color)">✅ Farben speichern</button>
            <button id="resetColorsBtn" class="btn" style="background:var(--error-color)">❌ Farben zurücksetzen</button>
            <button id="applyColorsBtn" class="btn" style="background:var(--secondary-color)">🎨 Vorschau anwenden</button>
          </div>
          
          <div class="kv mobile-optimized-text" style="margin-top:12px">
            <strong>Tipp:</strong> Verwende "Vorschau anwenden" um die Änderungen zu testen, bevor du sie speicherst.
          </div>
        </div>

        <!-- NEU: Discord Tab -->
        <div id="tabDiscord" class="tab-panel hidden-el">
          <h4 style="font-weight:700;margin-bottom:8px" class="mobile-optimized-text">🤖 Discord Webhook</h4>
          <div class="kv mb-3 mobile-optimized-text">Stelle hier deinen Discord Webhook ein, um bei neuen Bestellungen Benachrichtigungen zu erhalten</div>
          
          <div class="card" style="margin-bottom:16px">
            <div style="margin-bottom:12px">
              <label class="kv mb-2 mobile-optimized-text">Discord Webhook URL</label>
              <input id="discordWebhookUrl" class="input mobile-optimized-text" placeholder="https://discord.com/api/webhooks/..."/>
              <div class="kv mobile-optimized-text" style="margin-top:4px">
                Erstelle einen Webhook in deinem Discord Server unter: Server-Einstellungen → Integrationen → Webhooks
              </div>
            </div>
            
            <div style="margin-bottom:12px">
              <label class="kv mb-2 mobile-optimized-text">Benachrichtigungs-Kanal Name (optional)</label>
              <input id="discordChannelName" class="input mobile-optimized-text" placeholder="#bestellungen"/>
            </div>
            
            <div style="margin-bottom:12px">
              <label class="kv mb-2 mobile-optimized-text">Bot Name (optional)</label>
              <input id="discordBotName" class="input mobile-optimized-text" placeholder="Bullet Farm Bot"/>
            </div>
            
            <div>
              <label class="kv mb-2 mobile-optimized-text">Bot Avatar URL (optional)</label>
              <input id="discordBotAvatar" class="input mobile-optimized-text" placeholder="https://example.com/avatar.png"/>
            </div>
          </div>
          
          <div class="card" style="margin-bottom:16px">
            <h5 style="margin:0 0 12px 0;font-weight:700" class="mobile-optimized-text">Testbereich</h5>
            <div class="kv mb-3 mobile-optimized-text">Teste deine Webhook-Einstellungen</div>
            
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button id="testDiscordBtn" class="btn" style="background:var(--secondary-color)">🧪 Webhook testen</button>
              <button id="saveDiscordBtn" class="btn" style="background:var(--success-color)">✅ Discord Einstellungen speichern</button>
              <button id="resetDiscordBtn" class="btn" style="background:var(--error-color)">❌ Zurücksetzen</button>
            </div>
            
            <div id="discordTestResult" class="kv mobile-optimized-text" style="margin-top:12px"></div>
          </div>
          
          <div class="kv mobile-optimized-text" style="margin-top:12px">
            <strong>Info:</strong> Bei jeder neuen Bestellung wird automatisch eine Nachricht an deinen Discord Channel gesendet.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = { 
  apiKey: "AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
  authDomain: "khusland-b7d13.firebaseapp.com",
  databaseURL: "https://khusland-b7d13-default-rtdb.firebaseio.com",
  projectId: "khusland-b7d13",
  storageBucket: "khusland-b7d13.firebasestorage.app",
  messagingSenderId: "69573193613",
  appId: "1:69573193613:web:86c4d839281b1e343cd7c4",
  measurementId: "G-JSCWR4207G"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const productsRef = ref(db, 'products');
const settingsRef = ref(db, 'settings');
const categoriesRef = ref(db, 'categories');
const ordersRef = ref(db, 'orders');
const userStatsRef = ref(db, 'userStats');
const colorsRef = ref(db, 'colors');
const discordRef = ref(db, 'discord');

const ADMIN_PASSWORD = '1101';

let products = [];
let settings = { title: 'Bullet Farm v3', headerImage: 'https://via.placeholder.com/48' };
let categories = [];
let cart = [];
let allOrders = [];
let saveOrderBtnEl = null;
let orderCodeDisplayEl = null;
let selectedUserId = null;
let selectedOrder = null;
let discordSettings = {};

// Standard Farben
const defaultColors = {
  primary: '#22c55e',
  secondary: '#3b82f6',
  success: '#10b981',
  warning: '#f59e0b',
  error: '#ef4444',
  background: '#0f1724',
  card: '#0b1220'
};

// Toast Funktionen
function showToast(message, type = 'info', duration = 4000) {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  
  const container = document.getElementById('toastContainer');
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideInRight 0.3s ease reverse';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, duration);
}

// Funktion zur Behandlung von Bildfehlern
function handleImageError(img) {
  img.onerror = null;
  img.src = 'https://via.placeholder.com/300x120?text=Bild+nicht+verfügbar';
  img.style.opacity = '0.7';
}

// NEUE FUNKTION: Discord Webhook senden
async function sendDiscordWebhook(order) {
  if (!discordSettings.webhookUrl) {
    console.log('Keine Discord Webhook URL konfiguriert');
    return;
  }

  try {
    const itemsText = order.items.map(item => 
      `• ${item.quantity}x **${item.name}**\n  ${Object.entries(item.resources || {}).map(([k, v]) => `${k}: ${v}`).join(', ')}`
    ).join('\n');

    const embed = {
      title: '🛒 Neue Bestellung eingegangen!',
      color: 0x00ff00,
      fields: [
        {
          name: '📋 Bestellcode',
          value: `**${order.code}**`,
          inline: true
        },
        {
          name: '👤 Kunde',
          value: order.userName || 'Unbekannt',
          inline: true
        },
        {
          name: '📞 Telefon',
          value: order.phone || 'Nicht angegeben',
          inline: true
        },
        {
          name: '🛍️ Bestellte Artikel',
          value: itemsText || 'Keine Artikel',
          inline: false
        },
        {
          name: '⏰ Bestelldatum',
          value: new Date(order.createdAt).toLocaleString('de-DE'),
          inline: true
        },
        {
          name: '📊 Artikel gesamt',
          value: order.items.reduce((sum, item) => sum + item.quantity, 0).toString(),
          inline: true
        }
      ],
      timestamp: new Date().toISOString(),
      footer: {
        text: 'Bullet Farm v3 Shop System'
      }
    };

    const payload = {
      embeds: [embed],
      username: discordSettings.botName || 'Bullet Farm Bot',
      avatar_url: discordSettings.botAvatar || ''
    };

    if (discordSettings.channelName) {
      payload.content = `Neue Bestellung in ${discordSettings.channelName}`;
    }

    const response = await fetch(discordSettings.webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error(`Discord API error: ${response.status}`);
    }

    console.log('Discord Webhook erfolgreich gesendet');
    return true;
  } catch (error) {
    console.error('Fehler beim Senden des Discord Webhooks:', error);
    return false;
  }
}

// NEUE FUNKTION: Discord Webhook testen
async function testDiscordWebhook() {
  const webhookUrl = document.getElementById('discordWebhookUrl').value.trim();
  
  if (!webhookUrl) {
    document.getElementById('discordTestResult').innerHTML = '<span class="error">❌ Bitte gib eine Webhook URL ein</span>';
    return;
  }

  document.getElementById('discordTestResult').innerHTML = '<span class="info">⏳ Sende Testnachricht...</span>';
  document.getElementById('testDiscordBtn').disabled = true;

  try {
    const testPayload = {
      content: '🔔 **Testnachricht von Bullet Farm v3**\nDein Discord Webhook funktioniert einwandfrei! ✅',
      username: document.getElementById('discordBotName').value.trim() || 'Bullet Farm Bot',
      avatar_url: document.getElementById('discordBotAvatar').value.trim() || ''
    };

    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(testPayload)
    });

    if (response.ok) {
      document.getElementById('discordTestResult').innerHTML = '<span class="success">✅ Testnachricht erfolgreich gesendet!</span>';
    } else {
      throw new Error(`HTTP ${response.status}`);
    }
  } catch (error) {
    document.getElementById('discordTestResult').innerHTML = `<span class="error">❌ Fehler: ${error.message}</span>`;
  } finally {
    document.getElementById('testDiscordBtn').disabled = false;
  }
}

// NEUE FUNKTION: Discord Einstellungen laden
onValue(discordRef, snapshot => {
  const data = snapshot.val();
  if (data) {
    discordSettings = data;
    document.getElementById('discordWebhookUrl').value = data.webhookUrl || '';
    document.getElementById('discordChannelName').value = data.channelName || '';
    document.getElementById('discordBotName').value = data.botName || '';
    document.getElementById('discordBotAvatar').value = data.botAvatar || '';
  }
});

// NEUE FUNKTION: Discord Einstellungen speichern
async function saveDiscordSettings() {
  const settings = {
    webhookUrl: document.getElementById('discordWebhookUrl').value.trim(),
    channelName: document.getElementById('discordChannelName').value.trim(),
    botName: document.getElementById('discordBotName').value.trim(),
    botAvatar: document.getElementById('discordBotAvatar').value.trim()
  };

  try {
    await update(discordRef, settings);
    discordSettings = settings;
    showToast('Discord Einstellungen gespeichert', 'success');
  } catch (error) {
    console.error('Fehler beim Speichern der Discord Einstellungen:', error);
    showToast('Fehler beim Speichern der Discord Einstellungen', 'error');
  }
}

// NEUE FUNKTION: Bild-Upload Handler
function setupImageUpload() {
  document.getElementById('prodImgFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('prodImg').value = e.target.result;
          document.getElementById('prodPreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
      } else {
        showToast('Bitte wähle eine Bilddatei aus', 'error');
      }
    }
  });
}

// Globale Farben anwenden
function applyColors(colors = null) {
  const colorSettings = colors || defaultColors;
  
  document.documentElement.style.setProperty('--primary-color', colorSettings.primary);
  document.documentElement.style.setProperty('--secondary-color', colorSettings.secondary);
  document.documentElement.style.setProperty('--success-color', colorSettings.success);
  document.documentElement.style.setProperty('--warning-color', colorSettings.warning);
  document.documentElement.style.setProperty('--error-color', colorSettings.error);
  document.documentElement.style.setProperty('--background-color', colorSettings.background);
  document.documentElement.style.setProperty('--card', colorSettings.card);
  
  if (document.getElementById('primaryColorInput')) {
    document.getElementById('primaryColorInput').value = colorSettings.primary;
    document.getElementById('primaryColorPreview').style.background = colorSettings.primary;
  }
  if (document.getElementById('secondaryColorInput')) {
    document.getElementById('secondaryColorInput').value = colorSettings.secondary;
    document.getElementById('secondaryColorPreview').style.background = colorSettings.secondary;
  }
  if (document.getElementById('successColorInput')) {
    document.getElementById('successColorInput').value = colorSettings.success;
    document.getElementById('successColorPreview').style.background = colorSettings.success;
  }
  if (document.getElementById('warningColorInput')) {
    document.getElementById('warningColorInput').value = colorSettings.warning;
    document.getElementById('warningColorPreview').style.background = colorSettings.warning;
  }
  if (document.getElementById('errorColorInput')) {
    document.getElementById('errorColorInput').value = colorSettings.error;
    document.getElementById('errorColorPreview').style.background = colorSettings.error;
  }
  if (document.getElementById('backgroundColorInput')) {
    document.getElementById('backgroundColorInput').value = colorSettings.background;
    document.getElementById('backgroundColorPreview').style.background = colorSettings.background;
  }
  if (document.getElementById('cardColorInput')) {
    document.getElementById('cardColorInput').value = colorSettings.card;
    document.getElementById('cardColorPreview').style.background = colorSettings.card;
  }
}

// User-Stats bei "Als bearbeitet" erhöhen
async function incrementUserStatsOnProcessed(order) {
  try {
    const userPhone = order.phone;
    const userName = order.userName;
    
    if (!userPhone) {
      console.error('Keine Telefonnummer in der Bestellung gefunden');
      return;
    }

    const userStatsRef = ref(db, `userStats/${userPhone}`);
    const snapshot = await get(userStatsRef);
    
    let currentStats = {};
    if (snapshot.exists()) {
      currentStats = snapshot.val();
    }
    
    const currentResetTime = currentStats.resetTime || 0;
    const currentLifeTime = currentStats.lifeTime || 0;
    
    const newStats = {
      userName: userName,
      phone: userPhone,
      lifeTime: currentLifeTime + 1,
      resetTime: currentResetTime + 1,
      lastReset: currentStats.lastReset || null
    };
    
    await update(userStatsRef, newStats);
    console.log(`User Stats erhöht für ${userName}: LifeTime ${currentLifeTime} → ${currentLifeTime + 1}, ResetTime ${currentResetTime} → ${currentResetTime + 1}`);
    
  } catch (error) {
    console.error('Fehler beim Erhöhen der User-Stats:', error);
  }
}

function showModal() { 
  document.getElementById('settingsModal').classList.remove('hidden-el'); 
  setTimeout(() => document.getElementById('settingsModal').classList.add('active'), 10); 
  document.body.style.overflow = 'hidden'; 
}

function hideModal() { 
  document.getElementById('settingsModal').classList.remove('active'); 
  document.body.style.overflow = ''; 
  setTimeout(() => document.getElementById('settingsModal').classList.add('hidden-el'), 240); 
}

// Event Listeners für Discord
document.getElementById('testDiscordBtn').addEventListener('click', testDiscordWebhook);
document.getElementById('saveDiscordBtn').addEventListener('click', saveDiscordSettings);
document.getElementById('resetDiscordBtn').addEventListener('click', async () => {
  if (!confirm('Discord Einstellungen zurücksetzen?')) return;
  try {
    await update(discordRef, {
      webhookUrl: '',
      channelName: '',
      botName: '',
      botAvatar: ''
    });
    document.getElementById('discordWebhookUrl').value = '';
    document.getElementById('discordChannelName').value = '';
    document.getElementById('discordBotName').value = '';
    document.getElementById('discordBotAvatar').value = '';
    showToast('Discord Einstellungen zurückgesetzt', 'success');
  } catch (error) {
    console.error('Fehler beim Zurücksetzen der Discord Einstellungen:', error);
    showToast('Fehler beim Zurücksetzen der Discord Einstellungen', 'error');
  }
});

// Basis Event Listeners
document.getElementById('openSettingsBtn').addEventListener('click', () => {
  document.getElementById('settingsPassword').value = '';
  document.getElementById('settingsLoginError').style.display = 'none';
  document.getElementById('settingsLoginArea').style.display = '';
  document.getElementById('settingsEditor').classList.add('hidden-el');
  showModal();
});

document.getElementById('settingsCloseBtn').addEventListener('click', hideModal);
document.getElementById('settingsModal').addEventListener('click', (e) => { 
  if(e.target === document.getElementById('settingsModal')) hideModal(); 
});

document.addEventListener('keydown', (e) => { 
  if(e.key === 'Escape' && !document.getElementById('settingsModal').classList.contains('hidden-el')) hideModal(); 
});

document.getElementById('settingsUnlockBtn').addEventListener('click', () => {
  const password = (document.getElementById('settingsPassword').value || '').trim();
  if(password === ADMIN_PASSWORD){
    document.getElementById('settingsLoginError').style.display = 'none';
    document.getElementById('settingsLoginArea').style.display = 'none';
    document.getElementById('settingsEditor').classList.remove('hidden-el');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden-el'));
    document.getElementById('tabProducts').classList.remove('hidden-el');
  } else {
    document.getElementById('settingsLoginError').style.display = '';
  }
});

// Tab Navigation
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const tabName = btn.dataset.tab;
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden-el'));
    document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.remove('hidden-el');
    if (tabName === 'users') renderUsersList();
    if (tabName === 'orders') renderOrdersList();
  });
});

// Shop/Warenkorb Navigation
document.getElementById('btnShop').addEventListener('click', () => {
  document.getElementById('shopView').classList.remove('hidden-el');
  document.getElementById('cartView').classList.add('hidden-el');
});

document.getElementById('btnCart').addEventListener('click', () => {
  document.getElementById('shopView').classList.add('hidden-el');
  document.getElementById('cartView').classList.remove('hidden-el');
  renderCartView();
});

// PRODUKTE mit RESSOURCEN laden und anzeigen
onValue(productsRef, snapshot => {
  products = [];
  snapshot.forEach(child => {
    const data = child.val(); 
    data.key = child.key; 
    products.push(data);
  });
  renderProductsGrid();
  renderProductsTable();
  populateCategorySelects();
});

function renderProductsGrid() {
  const productsGrid = document.getElementById('productsGrid');
  productsGrid.innerHTML = '';
  
  products.forEach(product => {
    const card = document.createElement('div');
    card.className = 'card fade-in';
    
    const img = document.createElement('img');
    img.src = product.image || 'https://via.placeholder.com/300x120';
    img.className = 'product-image';
    img.alt = product.name || 'Produktbild';
    img.onerror = () => handleImageError(img);
    
    const title = document.createElement('div');
    title.className = 'mobile-optimized-text product-card-text';
    title.style.fontWeight = '700';
    title.style.fontSize = '1rem';
    title.style.marginTop = '8px';
    title.style.color = product.colorName || 'var(--primary-color)';
    title.textContent = product.name || '';
    
    const desc = document.createElement('div');
    desc.className = 'small-muted mobile-optimized-text product-card-text';
    desc.textContent = product.description || '';
    
    card.appendChild(img);
    card.appendChild(title);
    card.appendChild(desc);

    // RESSOURCEN anzeigen
    if(product.resources){
      const pairs = product.resources.split(';').map(x => x.trim()).filter(Boolean);
      if(pairs.length > 0){
        const table = document.createElement('table');
        table.className = 'table';
        table.style.marginTop = '8px';
        table.innerHTML = `
          <thead>
            <tr>
              <th class="mobile-optimized-text">Ressource</th>
              <th style="text-align:right" class="mobile-optimized-text">Anzahl</th>
            </tr>
          </thead>
          <tbody>
            ${pairs.map(resource => {
              const [name, value, color] = resource.split(':');
              return `
                <tr>
                  <td style="color:${color || '#facc15'}" class="mobile-optimized-text resource-text-fix">${escapeHtml(name)}</td>
                  <td style="text-align:right;color:${product.colorQuantity || 'var(--secondary-color)'}" class="mobile-optimized-text">
                    ${Number(value).toLocaleString('de-DE')}
                  </td>
                </tr>`;
            }).join('')}
          </tbody>`;
        card.appendChild(table);
      }
    }

    if(product.category) {
      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'kv mobile-optimized-text product-card-text';
      categoryDiv.style.marginTop = '8px';
      categoryDiv.textContent = 'Kategorie: ' + product.category;
      card.appendChild(categoryDiv);
    }

    const addButton = document.createElement('button');
    addButton.className = 'btn';
    addButton.style.background = 'var(--success-color)';
    addButton.style.marginTop = '8px';
    addButton.textContent = '✅ In den Warenkorb';
    addButton.onclick = () => { 
      addToCartByProductKey(product.key); 
      showToast(`"${product.name}" zum Warenkorb hinzugefügt`, 'success'); 
    };
    card.appendChild(addButton);

    productsGrid.appendChild(card);
  });
}

function renderProductsTable() {
  const productsTableBody = document.getElementById('productsTableBody');
  productsTableBody.innerHTML = '';
  
  products.forEach(product => {
    const resourcesText = product.resources ? 
      product.resources.split(';').map(resource => {
        const [name, value] = resource.split(':');
        return `${name}: ${value}`;
      }).join(', ') : '';
    
    const row = document.createElement('tr');
    row.className = 'fade-in';
    row.innerHTML = `
      <td style="padding:8px">
        <img src="${product.image || 'https://via.placeholder.com/80'}" 
             class="product-image-admin" 
             alt="${escapeHtml(product.name || '')}">
      </td>
      <td style="padding:8px" class="mobile-optimized-text table-text-fix">${escapeHtml(product.name || '')}</td>
      <td style="padding:8px" class="mobile-optimized-text table-text-fix">${escapeHtml(product.category || '')}</td>
      <td style="padding:8px" class="mobile-optimized-text table-text-fix">${escapeHtml(resourcesText)}</td>
      <td style="padding:8px">
        <button class="btn small-btn edit-product" data-key="${product.key}" style="margin-right:6px">✏️ Bearbeiten</button>
        <button class="btn small-btn delete-product" data-key="${product.key}" style="background:var(--error-color)">🗑️ Löschen</button>
      </td>`;
    productsTableBody.appendChild(row);
    
    row.querySelector('.edit-product').addEventListener('click', () => openProductForm(product));
    row.querySelector('.delete-product').addEventListener('click', () => { 
      if(confirm('Produkt wirklich löschen?')) {
        remove(ref(db, 'products/' + product.key))
          .then(() => showToast('Produkt gelöscht', 'success'))
          .catch(() => showToast('Fehler beim Löschen', 'error'));
      }
    });
  });
}

function openProductForm(product = null) {
  document.getElementById('productFormCard').classList.remove('hidden-el');
  document.querySelector('#resourceTable tbody').innerHTML = '';
  
  if(product){
    document.getElementById('prodId').value = product.key || '';
    document.getElementById('prodName').value = product.name || '';
    document.getElementById('prodImg').value = product.image || '';
    document.getElementById('prodPreview').src = product.image || 'https://via.placeholder.com/150x100';
    document.getElementById('prodDesc').value = product.description || '';
    document.getElementById('prodCategorySelect').value = product.category || '';
    document.getElementById('colorNameInput').value = product.colorName || '#22c55e';
    document.getElementById('colorQuantityInput').value = product.colorQuantity || '#3b82f6';
    
    if(product.resources){
      const pairs = product.resources.split(';').map(x => x.trim()).filter(Boolean);
      pairs.forEach(resource => {
        const [name, value, color] = resource.split(':');
        addResourceRow(name, value, color || '#facc15');
      });
    }
  } else {
    document.getElementById('prodId').value = '';
    document.getElementById('productForm').reset();
    document.getElementById('prodPreview').src = 'https://via.placeholder.com/150x100';
    document.getElementById('colorNameInput').value = '#22c55e';
    document.getElementById('colorQuantityInput').value = '#3b82f6';
  }
}

function addResourceRow(name = '', value = '', color = '#facc15') {
  const row = document.createElement('tr');
  row.className = 'fade-in';
  row.innerHTML = `
    <td><input class="input mobile-optimized-text" value="${escapeHtml(name)}" placeholder="Ressourcenname" /></td>
    <td style="text-align:right"><input type="number" min="0" class="input mobile-optimized-text" value="${escapeHtml(value)}" placeholder="0" /></td>
    <td><input type="color" class="color-input" value="${escapeHtml(color)}" /></td>
    <td style="text-align:center"><button class="btn small-btn" type="button" style="background:var(--error-color)">❌ Löschen</button></td>`;
  
  const deleteButton = row.querySelector('button');
  deleteButton.addEventListener('click', () => row.remove());
  document.querySelector('#resourceTable tbody').appendChild(row);
}

function addToCartByProductKey(productKey) {
  const product = products.find(p => p.key === productKey);
  if (!product) return;
  
  const resourceMap = resourcesToMap(product.resources);
  const existingIndex = cart.findIndex(item => item.key === productKey);
  
  if (existingIndex === -1) {
    cart.push({ 
      key: productKey, 
      name: product.name, 
      resources: {...resourceMap}, 
      quantity: 1 
    });
  } else {
    cart[existingIndex].quantity += 1;
    for(const resource in resourceMap) {
      cart[existingIndex].resources[resource] = (cart[existingIndex].resources[resource] || 0) + resourceMap[resource];
    }
  }
  
  renderCartView();
}

function resourcesToMap(resourcesString) {
  const map = {};
  if(!resourcesString) return map;
  const pairs = resourcesString.split(';').map(x => x.trim()).filter(Boolean);
  pairs.forEach(resource => {
    const [name, value] = resource.split(':');
    if(name && value) map[name] = (map[name] || 0) + Number(value);
  });
  return map;
}

function renderCartView() {
  const cartTableBody = document.querySelector('#cartTable tbody');
  cartTableBody.innerHTML = '';
  const totalResources = {};
  
  if (cart.length === 0) {
    cartTableBody.innerHTML = '<tr><td colspan="4" class="kv mobile-optimized-text" style="text-align:center;padding:20px">Warenkorb ist leer</td></tr>';
  } else {
    cart.forEach(entry => {
      const resText = Object.entries(entry.resources).map(([k,v])=>`${k}: ${v}`).join(', ');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mobile-optimized-text">${escapeHtml(entry.name)}</td>
        <td class="mobile-optimized-text resource-text-fix">${escapeHtml(resText)}</td>
        <td style="text-align:right" class="mobile-optimized-text">
          <div style="display:flex;align-items:center;justify-content:flex-end;gap:8px">
            <button class="btn small-btn" onclick="updateCartQuantity('${entry.key}', ${entry.quantity - 1})">-</button>
            <span>${entry.quantity}</span>
            <button class="btn small-btn" onclick="updateCartQuantity('${entry.key}', ${entry.quantity + 1})">+</button>
          </div>
        </td>
        <td style="text-align:center">
          <button class="btn small-btn" style="background:var(--error-color)" onclick="removeFromCart('${entry.key}')">🗑️</button>
        </td>`;
      cartTableBody.appendChild(tr);
      
      for(const k in entry.resources) {
        totalResources[k] = (totalResources[k] || 0) + entry.resources[k];
      }
    });
  }
  
  const summary = Object.entries(totalResources).map(([k,v])=>`${k}: ${v}`).join(', ') || 'keine';
  document.getElementById('cartSummary').innerText = 'Gesamt Ressourcen: ' + summary;
  
  const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
  document.getElementById('cartCount').textContent = totalItems > 0 ? totalItems : '';
  document.getElementById('cartCount').style.display = totalItems > 0 ? 'flex' : 'none';
  
  ensureOrderUiInCart();
}

// BESTELLUNGEN laden und anzeigen
onValue(ordersRef, snapshot => {
  allOrders = [];
  snapshot.forEach(child => { 
    const o = child.val(); 
    o.key = child.key; 
    allOrders.push(o); 
  });
  renderOrdersList();
});

function renderOrdersList() {
  const ordersList = document.getElementById('ordersList');
  ordersList.innerHTML = '';
  
  const visibleOrders = allOrders.filter(o => o.status !== 'bearbeitet' && !o.removedFromOrders);
  
  if(visibleOrders.length === 0){ 
    ordersList.innerHTML = '<div class="kv mobile-optimized-text">Keine offenen Bestellungen vorhanden.</div>'; 
    return; 
  }
  
  visibleOrders.sort((a,b)=> {
    const statusOrder = { 'offen': 0, 'bearbeitet': 1, 'storniert': 2 };
    const statusA = statusOrder[a.status] || 0;
    const statusB = statusOrder[b.status] || 0;
    
    if (statusA !== statusB) {
      return statusA - statusB;
    }
    
    return (b.createdAt||0) - (a.createdAt||0);
  });
  
  visibleOrders.forEach(o => {
    const div = document.createElement('div');
    div.className = 'order-card fade-in';
    const name = o.userName || '— unbekannt —';
    const phone = o.phone || '';
    const total = o.items?.length || 0;
    const date = o.createdAt ? new Date(o.createdAt).toLocaleString('de-DE') : '-';
    
    let statusClass = 'status-open';
    let statusText = '● Offen';
    if (o.status === 'bearbeitet') {
      statusClass = 'status-processed';
      statusText = '✓ Bearbeitet';
    } else if (o.status === 'storniert') {
      statusClass = 'status-cancelled';
      statusText = '✗ Storniert';
    }
    
    div.innerHTML = `
      <div class="order-card-header">
        <div class="mobile-optimized-text">
          <strong>${escapeHtml(o.code)}</strong><br>
          <div class="kv">${escapeHtml(date)}</div>
          ${escapeHtml(name)} ${phone ? '📞 '+escapeHtml(phone) : ''}
        </div>
        <div>
          <span class="status-badge ${statusClass}">${statusText}</span>
          <div class="kv mobile-optimized-text" style="text-align:right;margin-top:4px">${total} Artikel</div>
        </div>
      </div>
      <div class="order-card-actions">
        <button class="btn small-btn view-order" data-code="${escapeHtml(o.code)}">👁️ Ansehen</button>
        <button class="btn small-btn delete-order" data-key="${escapeHtml(o.key)}" style="background:var(--error-color)">🗑️ Löschen</button>
      </div>`;
    ordersList.appendChild(div);
    
    div.querySelector('.delete-order').addEventListener('click', () => { 
      if(confirm('Bestellung wirklich löschen?')) 
        remove(ref(db,'orders/'+o.key))
          .then(() => showToast('Bestellung gelöscht', 'success'))
          .catch(() => showToast('Fehler beim Löschen', 'error')); 
    });
    
    div.querySelector('.view-order').addEventListener('click', () => loadOrderByCode(o.code));
  });
}

function loadOrderByCode(code) {
  const order = allOrders.find(o => (o.code||'').toString() === code.toString());
  if(!order) return showToast('Keine Bestellung mit diesem Code gefunden', 'error');
  
  selectedOrder = order;
  document.getElementById('orderDetails').style.display = '';
  document.getElementById('orderCodeDisplay').textContent = `Bestellcode: ${order.code}`;
  document.getElementById('orderItems').innerHTML = '';
  
  (order.items || []).forEach(item => {
    const div = document.createElement('div');
    const resText = Object.entries(item.resources || {}).map(([k,v])=>`${k}: ${v}`).join(', ');
    div.innerHTML = `<div style="margin-bottom:6px" class="mobile-optimized-text"><b>${escapeHtml(item.name)}</b> — ${escapeHtml(String(item.quantity))}x</div><div class="kv mobile-optimized-text">${escapeHtml(resText)}</div>`;
    document.getElementById('orderItems').appendChild(div);
  });
  
  document.getElementById('orderUserName').value = order.userName || '';
  document.getElementById('orderPhone').value = order.phone || '';
  
  document.getElementById('markOrderProcessedBtn').disabled = order.status === 'bearbeitet';
  document.getElementById('markOrderOpenBtn').disabled = order.status === 'offen';
  document.getElementById('markOrderCancelledBtn').disabled = order.status === 'storniert';
}

// NUTZER laden und anzeigen
function renderUsersList() {
  const usersMap = new Map();
  
  allOrders.forEach(order => {
    if (order.phone && order.userName) {
      const userKey = `${order.phone}-${order.userName}`;
      if (!usersMap.has(userKey)) {
        usersMap.set(userKey, { 
          phone: order.phone, 
          userName: order.userName, 
          orders: []
        });
      }
      usersMap.get(userKey).orders.push(order);
    }
  });
  
  const users = Array.from(usersMap.values());
  const usersList = document.getElementById('usersList');
  usersList.innerHTML = '';
  
  if (users.length === 0) { 
    usersList.innerHTML = '<div class="kv mobile-optimized-text">Keine Nutzer mit Telefonnummern gefunden.</div>'; 
    return; 
  }
  
  users.sort((a, b) => a.userName.localeCompare(b.userName));
  
  users.forEach(user => {
    const userItem = document.createElement('div');
    userItem.className = 'user-order-item fade-in';
    if (selectedUserId === user.phone) userItem.classList.add('active');
    
    userItem.innerHTML = `
      <div style="font-weight:700" class="mobile-optimized-text">${escapeHtml(user.userName)}</div>
      <div class="kv mobile-optimized-text">📞 ${escapeHtml(user.phone)}</div>
      <div class="kv mobile-optimized-text" style="margin-top: 8px;">
        <div>📊 ${user.orders.length} Bestellung${user.orders.length !== 1 ? 'en' : ''}</div>
      </div>
      <div style="margin-top: 8px;">
        <button class="btn small-btn view-user-orders" style="background: var(--secondary-color);">📋 Bestellungen anzeigen</button>
      </div>`;
    
    usersList.appendChild(userItem);
    
    userItem.querySelector('.view-user-orders').addEventListener('click', (e) => {
      e.stopPropagation();
      userItem.click();
    });
    
    userItem.addEventListener('click', () => {
      document.querySelectorAll('.user-order-item').forEach(item => item.classList.remove('active'));
      userItem.classList.add('active');
      selectedUserId = user.phone;
      renderUserOrders(user);
    });
  });
}

function renderUserOrders(user) {
  const userOrdersDetails = document.getElementById('userOrdersDetails');
  userOrdersDetails.innerHTML = '';
  
  if (!user || !user.orders.length) { 
    userOrdersDetails.innerHTML = '<div class="kv mobile-optimized-text">Keine Bestellungen für diesen Nutzer gefunden.</div>'; 
    return; 
  }
  
  const sortedOrders = user.orders.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
  
  sortedOrders.forEach(order => {
    const orderCard = document.createElement('div');
    orderCard.className = 'order-card fade-in';
    
    const date = order.createdAt ? new Date(order.createdAt).toLocaleString('de-DE') : '-';
    
    let statusClass = 'status-open';
    let statusText = '● Offen';
    if (order.status === 'bearbeitet') {
      statusClass = 'status-processed';
      statusText = '✓ Bearbeitet';
    } else if (order.status === 'storniert') {
      statusClass = 'status-cancelled';
      statusText = '✗ Storniert';
    }
    
    orderCard.innerHTML = `
      <div class="order-card-header">
        <div class="mobile-optimized-text">
          <strong>Bestellcode: ${escapeHtml(order.code)}</strong>
          <div class="kv">${escapeHtml(date)}</div>
        </div>
        <div>
          <span class="status-badge ${statusClass}">${statusText}</span>
        </div>
      </div>`;
    
    if (order.items && order.items.length > 0) {
      const itemsList = document.createElement('div');
      itemsList.style.marginTop = '8px';
      order.items.forEach(item => {
        const resourceText = Object.entries(item.resources || {}).map(([k, v]) => `${k}: ${v}`).join(', ');
        const itemDiv = document.createElement('div');
        itemDiv.style.marginBottom = '6px';
        itemDiv.style.padding = '6px';
        itemDiv.style.background = 'rgba(255,255,255,0.02)';
        itemDiv.style.borderRadius = '4px';
        itemDiv.innerHTML = `
          <div class="mobile-optimized-text"><b>${escapeHtml(item.name)}</b> — ${item.quantity}x</div>
          <div class="kv mobile-optimized-text">${escapeHtml(resourceText)}</div>`;
        itemsList.appendChild(itemDiv);
      });
      orderCard.appendChild(itemsList);
    }
    
    userOrdersDetails.appendChild(orderCard);
  });
}

// KATEGORIEN Management
onValue(categoriesRef, snapshot => {
  categories = [];
  snapshot.forEach(child => {
    const data = child.val(); 
    data.key = child.key; 
    categories.push(data);
  });
  renderCategoriesList();
  populateCategorySelects();
});

function renderCategoriesList(){
  const categoriesList = document.getElementById('categoriesList');
  categoriesList.innerHTML = '';
  
  if(categories.length === 0){ 
    categoriesList.innerHTML = '<div class="kv mobile-optimized-text">Keine Kategorien vorhanden.</div>'; 
    return; 
  }
  
  categories.forEach(category => {
    const div = document.createElement('div');
    div.className = 'category-item fade-in';
    div.innerHTML = `
      <div class="mobile-optimized-text">${escapeHtml(category.name)}</div>
      <div style="display:flex;gap:6px">
        <button class="btn small-btn edit-category" data-key="${category.key}">✏️</button>
        <button class="btn small-btn delete-category" data-key="${category.key}" style="background:var(--error-color)">🗑️ Löschen</button>
      </div>`;
    categoriesList.appendChild(div);
    
    div.querySelector('.delete-category').addEventListener('click', async () => {
      if(!confirm('Kategorie wirklich löschen?')) return;
      try{ 
        await remove(ref(db, 'categories/' + category.key)); 
        showToast('Kategorie gelöscht', 'success');
      } 
      catch(e){ console.error(e); showToast('Fehler beim Löschen', 'error'); }
    });
    
    div.querySelector('.edit-category').addEventListener('click', () => {
      const newName = prompt('Neuer Kategorie-Name', category.name);
      if(newName && newName.trim()){
        update(ref(db, 'categories/' + category.key), { name: newName.trim() })
          .then(() => showToast('Kategorie umbenannt', 'success'))
          .catch(() => showToast('Fehler beim Umbenennen', 'error'));
      }
    });
  });
}

function populateCategorySelects(){
  const prodCategorySelect = document.getElementById('prodCategorySelect');
  const shopCategoryFilter = document.getElementById('shopCategoryFilter');
  
  prodCategorySelect.innerHTML = '<option value="">— Keine Kategorie —</option>';
  shopCategoryFilter.innerHTML = '<option value="">— Alle Kategorien —</option>';

  categories.forEach(category => {
    const option1 = document.createElement('option');
    option1.value = category.name;
    option1.textContent = category.name;
    option1.className = 'mobile-optimized-text';
    prodCategorySelect.appendChild(option1);
    
    const option2 = document.createElement('option');
    option2.value = category.name;
    option2.textContent = category.name;
    option2.className = 'mobile-optimized-text';
    shopCategoryFilter.appendChild(option2);
  });
}

// BESTELLUNG Funktionen
function ensureOrderUiInCart() {
  if(saveOrderBtnEl) return;
  
  const wrapper = document.createElement('div');
  wrapper.style.marginTop = '12px';
  
  saveOrderBtnEl = document.createElement('button');
  saveOrderBtnEl.className = 'btn';
  saveOrderBtnEl.style.background = 'var(--success-color)';
  saveOrderBtnEl.textContent = '✅ Bestellung speichern (Code erzeugen)';
  saveOrderBtnEl.addEventListener('click', saveCartAsOrder);
  wrapper.appendChild(saveOrderBtnEl);
  
  orderCodeDisplayEl = document.createElement('div');
  orderCodeDisplayEl.style.marginTop = '8px';
  orderCodeDisplayEl.style.fontWeight = '700';
  orderCodeDisplayEl.style.fontSize = '1.05rem';
  orderCodeDisplayEl.className = 'success mobile-optimized-text';
  orderCodeDisplayEl.textContent = '';
  
  const copyBtn = document.createElement('button');
  copyBtn.className = 'btn small-btn';
  copyBtn.style.marginLeft = '8px';
  copyBtn.textContent = '📋 Kopieren';
  copyBtn.addEventListener('click', () => {
    const txt = (orderCodeDisplayEl.textContent || '').replace('Bestellcode: ','').trim();
    if(!txt) return showToast('Kein Bestellcode vorhanden', 'warning');
    navigator.clipboard?.writeText(txt).then(() => showToast('Code kopiert', 'success')).catch(() => showToast('Kopieren nicht möglich', 'error'));
  });
  
  const codeWrap = document.createElement('div');
  codeWrap.style.display = 'flex';
  codeWrap.style.alignItems = 'center';
  codeWrap.style.gap = '8px';
  codeWrap.appendChild(orderCodeDisplayEl);
  codeWrap.appendChild(copyBtn);
  wrapper.appendChild(codeWrap);
  
  document.getElementById('cartView').appendChild(wrapper);
}

function generate4DigitCode() { 
  return Math.floor(1000 + Math.random() * 9000).toString(); 
}

async function saveCartAsOrder() {
  if(cart.length === 0) return showToast('Warenkorb ist leer', 'warning');
  
  const userName = prompt('Bitte Namen eingeben für Bestellung:');
  const userPhone = prompt('Bitte Telefonnummer eingeben:');
  
  if(!userName || !userPhone) {
    showToast('Bestellung abgebrochen: Name und Telefon werden benötigt', 'error');
    return;
  }
  
  const code = generate4DigitCode();
  const orderData = { 
    code: code, 
    createdAt: Date.now(), 
    items: [...cart], 
    status: 'offen', 
    userName: userName, 
    phone: userPhone 
  };
  
  try {
    const newOrderRef = push(ordersRef);
    await update(newOrderRef, orderData);
    
    // Discord Webhook senden
    await sendDiscordWebhook(orderData);
    
    if(!orderCodeDisplayEl) ensureOrderUiInCart();
    orderCodeDisplayEl.textContent = 'Bestellcode: ' + code;
    cart = [];
    renderCartView();
    showToast(`Bestellung gespeichert mit Code: ${code}`, 'success');
    
  } catch (e) { 
    console.error(e); 
    showToast('Fehler beim Speichern der Bestellung', 'error'); 
  }
}

// Globale Funktionen für Cart
window.updateCartQuantity = function(productKey, newQuantity) {
  const item = cart.find(item => item.key === productKey);
  if (item && newQuantity > 0) {
    const product = products.find(p => p.key === productKey);
    if (product) {
      const resourceMap = resourcesToMap(product.resources);
      item.quantity = newQuantity;
      item.resources = {};
      for (let i = 0; i < newQuantity; i++) {
        for (const resource in resourceMap) {
          item.resources[resource] = (item.resources[resource] || 0) + resourceMap[resource];
        }
      }
    }
    renderCartView();
  } else if (newQuantity <= 0) {
    removeFromCart(productKey);
  }
}

window.removeFromCart = function(productKey) {
  const index = cart.findIndex(item => item.key === productKey);
  if (index !== -1) {
    cart.splice(index, 1);
    renderCartView();
    showToast('Produkt aus Warenkorb entfernt', 'success');
  }
}

function escapeHtml(text) {
  if(!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// EINSTELLUNGEN FUNKTIONEN

// Produkt Management
document.getElementById('btnNewProduct').addEventListener('click', () => {
  document.getElementById('productFormCard').classList.remove('hidden-el');
  document.getElementById('productForm').reset();
  document.getElementById('prodId').value = '';
  document.getElementById('prodPreview').src = 'https://via.placeholder.com/150x100';
});

document.getElementById('cancelProductBtn').addEventListener('click', () => {
  document.getElementById('productFormCard').classList.add('hidden-el');
});

document.getElementById('addResourceBtn').addEventListener('click', () => {
  addResourceRow();
});

document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const rows = Array.from(document.querySelectorAll('#resourceTable tbody tr'));
  const resources = rows.map(row => {
    const name = row.children[0].querySelector('input').value.trim();
    const quantity = row.children[1].querySelector('input').value.trim();
    const color = row.children[2].querySelector('input').value;
    return name && quantity ? `${name}:${quantity}:${color}` : '';
  }).filter(Boolean).join(';');

  const payload = {
    name: document.getElementById('prodName').value.trim(),
    image: document.getElementById('prodImg').value.trim(),
    description: document.getElementById('prodDesc').value.trim(),
    category: document.getElementById('prodCategorySelect').value.trim(),
    resources: resources,
    colorName: document.getElementById('colorNameInput').value,
    colorQuantity: document.getElementById('colorQuantityInput').value,
    updatedAt: Date.now()
  };

  try{
    if(document.getElementById('prodId').value){
      await update(ref(db, 'products/' + document.getElementById('prodId').value), payload);
      showToast('Produkt aktualisiert', 'success');
    } else {
      await push(productsRef, payload);
      showToast('Produkt angelegt', 'success');
    }
    document.getElementById('productFormCard').classList.add('hidden-el');
  } catch(error){ 
    console.error(error); 
    showToast('Fehler beim Speichern des Produkts', 'error'); 
  }
});

// Kategorien Management
document.getElementById('addCategoryBtn').addEventListener('click', async () => {
  const name = (document.getElementById('newCategoryInput').value || '').trim();
  if(!name) return showToast('Bitte Namen eingeben', 'warning');
  try{
    await push(categoriesRef, { name });
    document.getElementById('newCategoryInput').value = '';
    showToast('Kategorie hinzugefügt', 'success');
  } catch(e){ console.error(e); showToast('Fehler beim Anlegen', 'error'); }
});

// Allgemeine Einstellungen
document.getElementById('saveGeneralBtn').addEventListener('click', async () => {
  const title = (document.getElementById('settingTitle').value || '').trim() || 'Bullet Farm v3';
  const image = (document.getElementById('settingHeaderImage').value || '').trim() || 'https://via.placeholder.com/48';
  try{ 
    await update(settingsRef, { title, headerImage: image }); 
    showToast('Allgemeine Einstellungen gespeichert', 'success');
  } catch(e){ console.error(e); showToast('Fehler beim Speichern', 'error'); }
});

document.getElementById('resetGeneralBtn').addEventListener('click', async () => {
  if(!confirm('Auf Standard zurücksetzen?')) return;
  try{ 
    await update(settingsRef, { title: 'Bullet Farm v3', headerImage: 'https://via.placeholder.com/48' }); 
    showToast('Einstellungen zurückgesetzt', 'success');
  } catch(e){ console.error(e); showToast('Fehler beim Zurücksetzen', 'error'); }
});

// Bestellungen Event Listener
document.getElementById('loadOrderBtn').addEventListener('click', () => {
  const code = (document.getElementById('orderCodeInput').value||'').trim();
  if(!code) return showToast('Code eingeben', 'warning');
  loadOrderByCode(code);
});

document.getElementById('refreshOrdersBtn').addEventListener('click', () => {
  get(ordersRef)
    .then(() => showToast('Bestellungen aktualisiert', 'success'))
    .catch(() => showToast('Aktualisieren fehlgeschlagen', 'error'));
});

document.getElementById('saveOrderUserBtn').addEventListener('click', async () => {
  if (!selectedOrder) return;
  try { 
    await update(ref(db,'orders/'+selectedOrder.key), { 
      userName: (document.getElementById('orderUserName').value||'').trim(), 
      phone: (document.getElementById('orderPhone').value||'').trim() 
    }); 
    showToast('Kundendaten gespeichert', 'success'); 
  }
  catch(e){ console.error(e); showToast('Fehler beim Speichern', 'error'); }
});

document.getElementById('markOrderProcessedBtn').addEventListener('click', async () => {
  if(!selectedOrder) return;
  if(!confirm('Bestellung als bearbeitet markieren und aus Bestellungen entfernen?')) return;
  try { 
    await incrementUserStatsOnProcessed(selectedOrder);
    
    await update(ref(db,'orders/'+selectedOrder.key), { 
      status: 'bearbeitet',
      removedFromOrders: true
    }); 
    
    document.getElementById('orderDetails').style.display = 'none';
    document.getElementById('orderCodeInput').value = '';
    selectedOrder = null;
    
    showToast('Bestellung als bearbeitet markiert und aus Bestellungen entfernt', 'success'); 
  }
  catch(e){ console.error(e); showToast('Fehler', 'error'); }
});

document.getElementById('markOrderOpenBtn').addEventListener('click', async () => {
  if(!selectedOrder) return;
  if(!confirm('Bestellung als offen markieren?')) return;
  try { 
    await update(ref(db,'orders/'+selectedOrder.key), { status: 'offen' }); 
    showToast('Bestellung als offen markiert', 'success'); 
  }
  catch(e){ console.error(e); showToast('Fehler', 'error'); }
});

document.getElementById('markOrderCancelledBtn').addEventListener('click', async () => {
  if(!selectedOrder) return;
  if(!confirm('Bestellung stornieren?')) return;
  try { 
    await update(ref(db,'orders/'+selectedOrder.key), { status: 'storniert' }); 
    showToast('Bestellung storniert', 'success'); 
  }
  catch(e){ console.error(e); showToast('Fehler', 'error'); }
});

// Farben Einstellungen
document.getElementById('applyColorsBtn').addEventListener('click', () => {
  const currentColors = {
    primary: document.getElementById('primaryColorInput').value,
    secondary: document.getElementById('secondaryColorInput').value,
    success: document.getElementById('successColorInput').value,
    warning: document.getElementById('warningColorInput').value,
    error: document.getElementById('errorColorInput').value,
    background: document.getElementById('backgroundColorInput').value,
    card: document.getElementById('cardColorInput').value
  };
  
  applyColors(currentColors);
  showToast('Farbvorschau angewendet', 'info');
});

document.getElementById('saveColorsBtn').addEventListener('click', async () => {
  const colors = {
    primary: document.getElementById('primaryColorInput').value,
    secondary: document.getElementById('secondaryColorInput').value,
    success: document.getElementById('successColorInput').value,
    warning: document.getElementById('warningColorInput').value,
    error: document.getElementById('errorColorInput').value,
    background: document.getElementById('backgroundColorInput').value,
    card: document.getElementById('cardColorInput').value
  };
  
  try {
    await update(colorsRef, colors);
    showToast('Farben gespeichert', 'success');
  } catch (error) {
    console.error('Fehler beim Speichern der Farben:', error);
    showToast('Fehler beim Speichern der Farben', 'error');
  }
});

document.getElementById('resetColorsBtn').addEventListener('click', async () => {
  if(!confirm('Farben auf Standard zurücksetzen?')) return;
  try {
    await update(colorsRef, defaultColors);
    applyColors(defaultColors);
    showToast('Farben zurückgesetzt', 'success');
  } catch (error) {
    console.error('Fehler beim Zurücksetzen der Farben:', error);
    showToast('Fehler beim Zurücksetzen der Farben', 'error');
  }
});

// Initialisierung
setupImageUpload();
ensureOrderUiInCart();
renderCartView();

// Settings von Firebase laden
onValue(settingsRef, snapshot => {
  const val = snapshot.val();
  if(val){
    settings.title = val.title || settings.title;
    settings.headerImage = val.headerImage || settings.headerImage;
  }
  document.getElementById('pageTitle').innerText = settings.title || 'Bullet Farm v3';
  document.getElementById('headerLogo').src = settings.headerImage || 'https://via.placeholder.com/48';
  if(document.getElementById('settingTitle')) document.getElementById('settingTitle').value = settings.title || '';
  if(document.getElementById('settingHeaderImage')) document.getElementById('settingHeaderImage').value = settings.headerImage || '';
});

// Farben von Firebase laden
onValue(colorsRef, snapshot => {
  const colors = snapshot.val();
  if (colors) {
    applyColors(colors);
  }
});

console.log('🚀 Bullet Farm v3 Shop komplett initialisiert - ALLE FUNKTIONEN AKTIV!');
</script>
</body>
</html>

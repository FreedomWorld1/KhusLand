<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KhusLand Panel</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link href="https://fonts.bunny.net/css?family=inter:400,500,600,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --darker: #0a0f1c;
            --text: #f1f5f9;
            --text-light: #cbd5e1;
            --text-lighter: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(99, 102, 241, 0.2);
            --sidebar-width: 260px;
            --header-height: 70px;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }
        
        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(99, 102, 241, 0.1);
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 0 0.5rem;
        }
        
        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .sidebar-title {
            font-weight: 700;
            font-size: 1.25rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1rem;
            border-radius: 10px;
            color: var(--text-light);
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text);
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
        }
        
        .sidebar-footer {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0.5rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            background-size: cover;
            background-position: center;
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .user-role {
            font-size: 0.75rem;
            color: var(--text-lighter);
        }
        
        .logout-btn {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.8rem;
            width: 100%;
            margin-top: 0.5rem;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
            background: var(--dark);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        /* Cards - VERBESSERT mit gr√∂√üeren Buttons */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2.2rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }
        
        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .card.disabled:hover {
            transform: none;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: var(--card-border);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .card-icon {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }
        
        .card-title {
            font-size: 1.6rem;
            margin-bottom: 1.2rem;
            color: var(--text);
        }
        
        .card-content {
            color: var(--text-light);
            line-height: 1.7;
            margin-bottom: 1.5rem;
            flex-grow: 1;
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }
        
        .card-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-lighter);
        }
        
        /* STATUS INDICATOR STYLES - VERBESSERT */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-online {
            background: var(--secondary);
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }
        
        .status-offline {
            background: var(--danger);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }
        
        .status-warning {
            background: var(--warning);
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
        }
        
        .status-maintenance {
            background: var(--primary);
            box-shadow: 0 0 8px rgba(99, 102, 241, 0.5);
        }
        
        .access-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .access-allowed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--secondary);
        }
        
        .access-denied {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        /* Tables */
        .table-container {
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--card-border);
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 2rem;
        }
        
        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .table-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--secondary) 0%, #0d966c 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            text-align: left;
            padding: 1rem 1.5rem;
            background: rgba(15, 23, 42, 0.5);
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
            color: var(--text-light);
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .table tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }
        
        .user-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .user-info-small {
            display: flex;
            flex-direction: column;
        }
        
        .user-name-small {
            font-weight: 600;
            color: var(--text);
        }
        
        .user-id {
            font-size: 0.75rem;
            color: var(--text-lighter);
        }
        
        .role-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .role-founder {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: white;
        }
        
        .role-overseer {
            background: linear-gradient(135deg, #ff6b00 0%, #cc5500 100%);
            color: white;
        }
        
        .role-consigliere {
            background: linear-gradient(135deg, #ff0080 0%, #cc0066 100%);
            color: white;
        }
        
        .role-manager {
            background: linear-gradient(135deg, #9900ff 0%, #7700cc 100%);
            color: white;
        }
        
        .role-organisator {
            background: linear-gradient(135deg, #0099ff 0%, #0077cc 100%);
            color: white;
        }
        
        .role-aufseher {
            background: linear-gradient(135deg, #00cc99 0%, #00aa77 100%);
            color: white;
        }
        
        .role-sammler {
            background: linear-gradient(135deg, #ffcc00 0%, #ccaa00 100%);
            color: white;
        }
        
        .role-verteiler {
            background: linear-gradient(135deg, #ff9900 0%, #cc7700 100%);
            color: white;
        }
        
        .role-gaertner {
            background: linear-gradient(135deg, #66cc00 0%, #55aa00 100%);
            color: white;
        }
        
        .role-runner {
            background: linear-gradient(135deg, #00ccff 0%, #00aacc 100%);
            color: white;
        }
        
        .role-helfer {
            background: linear-gradient(135deg, #999999 0%, #777777 100%);
            color: white;
        }
        
        .role-neuling {
            background: linear-gradient(135deg, #666666 0%, #444444 100%);
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            color: white;
            font-size: 0.9rem;
        }
        
        .btn-promote {
            background: rgba(16, 185, 129, 0.2);
            color: var(--secondary);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .btn-promote:hover {
            background: rgba(16, 185, 129, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-demote {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .btn-demote:hover {
            background: rgba(245, 158, 11, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-terminate {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .btn-terminate:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-2px);
        }
        
        /* Login Page */
        .login-container {
            background: rgba(15, 23, 42, 0.95);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 440px;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid rgba(99, 102, 241, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.8rem;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }
        
        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .login-subtitle {
            color: var(--text-light);
            margin-bottom: 2rem;
        }
        
        .discord-login-btn {
            background: #5865F2;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);
        }
        
        .discord-login-btn:hover {
            background: #4752c4;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(88, 101, 242, 0.4);
        }
        
        .loading {
            display: none;
            margin-top: 1.5rem;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 1rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            display: none;
            border-left: 4px solid var(--danger);
        }
        
        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: rgba(15, 23, 42, 0.95);
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(99, 102, 241, 0.2);
            backdrop-filter: blur(10px);
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .modal-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.85rem 1rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            font-size: 1rem;
            color: var(--text);
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        /* Settings */
        .settings-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 2rem;
        }
        
        .settings-section h3 {
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .settings-section h3 i {
            color: var(--primary);
        }
        
        .webhook-container {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        .webhook-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .webhook-title {
            font-weight: 600;
            color: var(--text);
        }
        
        .webhook-input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .webhook-input {
            flex: 1;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            color: var(--text);
            font-size: 0.9rem;
        }
        
        .role-management {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .role-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
        }
        
        .role-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }
        
        .role-emoji {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        
        .role-input-group {
            margin-bottom: 1rem;
        }
        
        .role-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .role-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }
        
        .role-id {
            font-size: 0.8rem;
            color: var(--text-lighter);
            margin-bottom: 1rem;
        }
        
        .add-role-btn {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .add-role-btn:hover {
            background: rgba(16, 185, 129, 0.2);
        }
        
        .remove-role-btn {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .remove-role-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        .history-item {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .history-action {
            font-weight: 600;
            color: var(--text);
        }
        
        .history-date {
            font-size: 0.8rem;
            color: var(--text-lighter);
        }
        
        .history-details {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 1100;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            max-width: 400px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--secondary) 0%, #0d966c 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }
        
        /* Warnungs-Badge */
        .warning-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .nav-item {
            position: relative;
        }
        
        /* Warning Button */
        .btn-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .btn-warning:hover {
            background: rgba(245, 158, 11, 0.3);
            transform: translateY(-2px);
        }
        
        /* Hidden utility */
        .hidden {
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 70px;
                padding: 1.5rem 0.5rem;
            }
            
            .sidebar-title, .user-details, .nav-item span {
                display: none;
            }
            
            .sidebar-header {
                justify-content: center;
            }
            
            .user-info {
                justify-content: center;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage">
        <div class="login-container">
            <div class="login-logo">KL</div>
            <h1 class="login-title">KhusLand Panel</h1>
            <p class="login-subtitle">Bitte mit Discord anmelden um fortzufahren</p>
            
            <div class="error-message" id="errorMessage"></div>
            
            <button id="discordLogin" class="discord-login-btn">
                <i class="fab fa-discord"></i> Mit Discord anmelden
            </button>
            
            <div class="loading" id="loginLoading">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: var(--text-light);">Anmeldung l√§uft...</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainContent" class="app-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">KL</div>
                <div class="sidebar-title">KhusLand</div>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-tab="users">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                    <div class="warning-badge hidden" id="userWarningBadge">!</div>
                </a>
                <a href="#" class="nav-item" data-tab="settings">
                    <i class="fas fa-cog"></i>
                    <span>Einstellungen</span>
                </a>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Benutzer</div>
                        <div class="user-role" id="userRole">Administrator</div>
                    </div>
                </div>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Abmelden
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <div class="header">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="header-actions">
                        <div class="status-badge">
                            <i class="fas fa-circle"></i>
                            <span>Alle Systeme Online</span>
                        </div>
                        <button class="btn btn-primary" id="addUserBtn">
                            <i class="fas fa-user-plus"></i>
                            Spieler einstellen
                        </button>
                    </div>
                </div>
                
                <div class="cards-grid">
                    <div class="card" data-page="index.html">
                        <div class="card-icon">üåø</div>
                        <h3 class="card-title">Weed Ankauf</h3>
                        <div class="card-content">
                            Den Weed-Einkauf auf korrekte Abl√§ufe und Vollst√§ndigkeit √ºberpr√ºfen.
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <div class="status-indicator status-offline"></div>
                                <span>System offline</span>
                            </div>
                            <div class="access-badge access-allowed">Zugriff</div>
                        </div>
                    </div>
                    
                    <div class="card" data-page="seite2.html">
                        <div class="card-icon">‚ùÑÔ∏è</div>
                        <h3 class="card-title">Kokain Ankauf</h3>
                        <div class="card-content">
                            Den Kokain-Einkauf auf korrekte Abl√§ufe und Vollst√§ndigkeit √ºberpr√ºfen.
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <div class="status-indicator status-online"></div>
                                <span>System online</span>
                            </div>
                            <div class="access-badge access-allowed">Zugriff</div>
                        </div>
                    </div>
                    
                    <div class="card" data-page="seite3.html">
                        <div class="card-icon">‚ôªÔ∏è</div>
                        <h3 class="card-title">Materialrecycler - Produkte</h3>
                        <div class="card-content">
                            Recyclingprozesse sowie die daraus entstandenen Materialien verwalten.
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <div class="status-indicator status-online"></div>
                                <span>System online</span>
                            </div>
                            <div class="access-badge access-allowed">Zugriff</div>
                        </div>
                    </div>
                    
                    <div class="card" data-page="seite4.html">
                        <div class="card-icon">üîß</div>
                        <h3 class="card-title">Werkbank Manager</h3>
                        <div class="card-content">
                            √úberpr√ºfe, dass alle Rohstoffe f√ºr die Werkstatt vorhanden sind.
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <div class="status-indicator status-online"></div>
                                <span>System online</span>
                            </div>
                            <div class="access-badge access-allowed">Zugriff</div>
                        </div>
                    </div>
                    
                    <div class="card" data-page="seite5.html">
                        <div class="card-icon">üõ£Ô∏è</div>
                        <h3 class="card-title">Drogenrouten</h3>
                        <div class="card-content">
                            Behalte die Drogenrouten im Blick.
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <div class="status-indicator status-online"></div>
                                <span>System online</span>
                            </div>
                            <div class="access-badge access-allowed">Zugriff</div>
                        </div>
                    </div>
                    
                    <div class="card" data-page="seite6.html">
                        <div class="card-icon">üèûÔ∏è</div>
                        <h3 class="card-title">KhusLand Management</h3>
                        <div class="card-content">
                            Verwalten Sie Mitarbeiter.
                        </div>
                        <div class="card-footer">
                            <div class="card-status">
                                <div class="status-indicator status-online"></div>
                                <span>System online</span>
                            </div>
                            <div class="access-badge access-allowed">Zugriff</div>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h2 class="table-title">Aktive Benutzer</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="refreshUsers">
                                <i class="fas fa-sync-alt"></i>
                                Aktualisieren
                            </button>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Benutzer</th>
                                <th>Rolle</th>
                                <th>Eingestellt am</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Users Tab -->
            <div id="users" class="tab-content hidden">
                <div class="header">
                    <h1 class="page-title">User Management</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="addUserBtn2">
                            <i class="fas fa-user-plus"></i>
                            Spieler einstellen
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h2 class="table-title">Eingestellte Spieler</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" id="exportUsers">
                                <i class="fas fa-download"></i>
                                Exportieren
                            </button>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Benutzer</th>
                                <th>Rolle</th>
                                <th>Eingestellt am</th>
                                <th>Eingestellt von</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="userManagementTableBody">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content hidden">
                <div class="header">
                    <h1 class="page-title">Einstellungen</h1>
                </div>
                
                <!-- Discord Webhooks Konfiguration -->
                <div class="settings-section">
                    <h3><i class="fab fa-discord"></i> Discord Webhooks Konfiguration</h3>
                    
                    <div class="webhook-container">
                        <div class="webhook-header">
                            <div class="webhook-title">üéÆ Spieler Einstellungen</div>
                        </div>
                        <div class="webhook-input-group">
                            <input type="text" id="webhookHiring" class="webhook-input" placeholder="Webhook URL f√ºr Spieler-Einstellungen">
                            <button class="btn btn-primary test-webhook" data-type="hiring">
                                <i class="fas fa-bell"></i> Testen
                            </button>
                            <button class="btn btn-success save-webhook" data-type="hiring">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </div>
                    </div>
                    
                    <div class="webhook-container">
                        <div class="webhook-header">
                            <div class="webhook-title">üéñÔ∏è Bef√∂rderungen</div>
                        </div>
                        <div class="webhook-input-group">
                            <input type="text" id="webhookPromotions" class="webhook-input" placeholder="Webhook URL f√ºr Bef√∂rderungen">
                            <button class="btn btn-primary test-webhook" data-type="promotions">
                                <i class="fas fa-bell"></i> Testen
                            </button>
                            <button class="btn btn-success save-webhook" data-type="promotions">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </div>
                    </div>
                    
                    <div class="webhook-container">
                        <div class="webhook-header">
                            <div class="webhook-title">üìâ Degradierungen</div>
                        </div>
                        <div class="webhook-input-group">
                            <input type="text" id="webhookDemotions" class="webhook-input" placeholder="Webhook URL f√ºr Degradierungen">
                            <button class="btn btn-primary test-webhook" data-type="demotions">
                                <i class="fas fa-bell"></i> Testen
                            </button>
                            <button class="btn btn-success save-webhook" data-type="demotions">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </div>
                    </div>
                    
                    <div class="webhook-container">
                        <div class="webhook-header">
                            <div class="webhook-title">üö™ K√ºndigungen</div>
                        </div>
                        <div class="webhook-input-group">
                            <input type="text" id="webhookTerminations" class="webhook-input" placeholder="Webhook URL f√ºr K√ºndigungen">
                            <button class="btn btn-primary test-webhook" data-type="terminations">
                                <i class="fas fa-bell"></i> Testen
                            </button>
                            <button class="btn btn-success save-webhook" data-type="terminations">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </div>
                    </div>
                    
                    <!-- NEUER WEBHOOK F√úR TEAM VERWARNUNG -->
                    <div class="webhook-container">
                        <div class="webhook-header">
                            <div class="webhook-title">‚ö†Ô∏è Team Verwarnungen</div>
                        </div>
                        <div class="webhook-input-group">
                            <input type="text" id="webhookWarnings" class="webhook-input" placeholder="Webhook URL f√ºr Team Verwarnungen">
                            <button class="btn btn-primary test-webhook" data-type="warnings">
                                <i class="fas fa-bell"></i> Testen
                            </button>
                            <button class="btn btn-success save-webhook" data-type="warnings">
                                <i class="fas fa-save"></i> Speichern
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Rollenverwaltung -->
                <div class="settings-section">
                    <h3><i class="fas fa-user-shield"></i> Rollenverwaltung</h3>
                    <div class="role-management" id="roleManagement">
                        <!-- Roles will be populated here -->
                    </div>
                </div>
                
                <!-- Aktionshistorie -->
                <div class="settings-section">
                    <h3><i class="fas fa-history"></i> Aktionshistorie</h3>
                    <div id="actionHistory">
                        <!-- History will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <h2 class="modal-title">Spieler einstellen</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="discordUserId">Discord User ID</label>
                <input type="text" id="discordUserId" class="form-input" placeholder="123456789012345678">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="playerName">Spieler Name</label>
                <input type="text" id="playerName" class="form-input" placeholder="Name des Spielers">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="userRoleSelect">Rolle</label>
                <select id="userRoleSelect" class="form-input">
                    <!-- Roles will be populated here -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="hiringReason">Grund</label>
                <textarea id="hiringReason" class="form-input form-textarea" placeholder="Grund f√ºr die Einstellung..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn" id="cancelAddUser">Abbrechen</button>
                <button class="btn btn-primary" id="saveUser">Spieler einstellen</button>
            </div>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div id="promotionModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <h2 class="modal-title">Spieler bef√∂rdern</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="promotionUserId">User ID</label>
                <input type="text" id="promotionUserId" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="promotionRoleSelect">Neue Rolle</label>
                <select id="promotionRoleSelect" class="form-input">
                    <!-- Roles will be populated here -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="promotionReason">Grund</label>
                <textarea id="promotionReason" class="form-input form-textarea" placeholder="Grund f√ºr die Bef√∂rderung..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn" id="cancelPromotion">Abbrechen</button>
                <button class="btn btn-primary" id="savePromotion">Bef√∂rderung best√§tigen</button>
            </div>
        </div>
    </div>

    <!-- Demotion Modal -->
    <div id="demotionModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <h2 class="modal-title">Spieler degradieren</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="demotionUserId">User ID</label>
                <input type="text" id="demotionUserId" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="demotionRoleSelect">Neue Rolle</label>
                <select id="demotionRoleSelect" class="form-input">
                    <!-- Roles will be populated here -->
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="demotionReason">Grund</label>
                <textarea id="demotionReason" class="form-input form-textarea" placeholder="Grund f√ºr die Degradierung..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn" id="cancelDemotion">Abbrechen</button>
                <button class="btn btn-warning" id="saveDemotion">Degradierung best√§tigen</button>
            </div>
        </div>
    </div>

    <!-- Termination Modal -->
    <div id="terminationModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-times"></i>
                </div>
                <h2 class="modal-title">Spieler k√ºndigen</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="terminationUserId">User ID</label>
                <input type="text" id="terminationUserId" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="terminationReason">Grund</label>
                <textarea id="terminationReason" class="form-input form-textarea" placeholder="Grund f√ºr die K√ºndigung..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn" id="cancelTermination">Abbrechen</button>
                <button class="btn btn-danger" id="saveTermination">K√ºndigung best√§tigen</button>
            </div>
        </div>
    </div>

    <!-- Warning Modal -->
    <div id="warningModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon" style="background: var(--danger);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2 class="modal-title">Team Verwarnung</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="warningUserId">User ID</label>
                <input type="text" id="warningUserId" class="form-input" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="warningReason">Verwarnungsgrund</label>
                <textarea id="warningReason" class="form-input form-textarea" placeholder="Grund f√ºr die Verwarnung..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn" id="cancelWarning">Abbrechen</button>
                <button class="btn btn-danger" id="saveWarning">Verwarnung senden</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification hidden"></div>

    <!-- Firebase Import -->
    <script type="module">
        // Firebase Import und Konfiguration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, push, onValue, remove, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
            authDomain: "khusland-b7d13.firebaseapp.com",
            databaseURL: "https://khusland-b7d13-default-rtdb.firebaseio.com",
            projectId: "khusland-b7d13",
            storageBucket: "khusland-b7d13.firebasestorage.app",
            messagingSenderId: "69573193613",
            appId: "1:69573193613:web:86c4d839281b1e343cd7c4",
            measurementId: "G-JSCWR4207G"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Discord OAuth Konfiguration
        const DISCORD_CLIENT_ID = '1432942180770644079';
        const DISCORD_REDIRECT_URI = window.location.origin + window.location.pathname;
        const BACKEND_URL = 'https://discord-oauth.ehrlichcolin2.workers.dev';

        // Seiten-URLs f√ºr Weiterleitungen
        const PAGE_URLS = {
            'index.html': 'https://freedomworld1.github.io/KhusLand/index.html',
            'seite2.html': 'https://freedomworld1.github.io/KhusLand/seite2.html',
            'seite3.html': 'https://freedomworld1.github.io/KhusLand/seite3.html',
            'seite4.html': 'https://freedomworld1.github.io/KhusLand/seite4.html',
            'seite5.html': 'https://freedomworld1.github.io/KhusLand/seite5.html',
            'seite6.html': 'https://freedomworld1.github.io/KhusLand/seite6.html'
        };

        // Feste Rollen - DIREKT IM CODE
        const FIXED_ROLES = [
            {
                id: 'role_founder',
                name: 'KL‚îÉ‚ù± Founder ‚îÉ12',
                discordRoleId: '1420622115157049505',
                emoji: 'üëë',
                color: 'role-founder'
            },
            {
                id: 'role_overseer',
                name: 'KL‚îÉ‚ù± Overseer ‚îÉ11',
                discordRoleId: '1420627856412905513',
                emoji: 'üõ°Ô∏è',
                color: 'role-overseer'
            },
            {
                id: 'role_consigliere',
                name: 'KL‚îÉ‚ù± Consigliere ‚îÉ10',
                discordRoleId: '1420628139436015748',
                emoji: 'üíº',
                color: 'role-consigliere'
            },
            {
                id: 'role_manager',
                name: 'KL‚îÉ‚ù± Manger ‚îÉ9',
                discordRoleId: '1420628642920267886',
                emoji: 'üìä',
                color: 'role-manager'
            },
            {
                id: 'role_organisator',
                name: 'KL‚îÉ‚ù± Organisator ‚îÉ 8',
                discordRoleId: '1420629056201949257',
                emoji: 'üìã',
                color: 'role-organisator'
            },
            {
                id: 'role_aufseher',
                name: 'KL‚îÉ‚ù± Aufseher ‚îÉ7',
                discordRoleId: '1420629498805751891',
                emoji: 'üëÅÔ∏è',
                color: 'role-aufseher'
            },
            {
                id: 'role_sammler',
                name: 'KL‚îÉ‚ù± Sammler ‚îÉ6',
                discordRoleId: '1420629795934310510',
                emoji: 'üì¶',
                color: 'role-sammler'
            },
            {
                id: 'role_verteiler',
                name: 'KL‚îÉ‚ù± Verteiler ‚îÉ5',
                discordRoleId: '1420629919972593766',
                emoji: 'üöö',
                color: 'role-verteiler'
            },
            {
                id: 'role_gaertner',
                name: 'KL‚îÉ‚ù± G√§rtner ‚îÉ4',
                discordRoleId: '1420630031188889610',
                emoji: 'üåø',
                color: 'role-gaertner'
            },
            {
                id: 'role_runner',
                name: 'KL‚îÉ‚ù± Runner ‚îÉ3',
                discordRoleId: '1420630156611158137',
                emoji: 'üèÉ',
                color: 'role-runner'
            },
            {
                id: 'role_helfer',
                name: 'KL‚îÉ‚ù± Helfer‚îÉ2',
                discordRoleId: '1420630262722723840',
                emoji: 'ü§ù',
                color: 'role-helfer'
            },
            {
                id: 'role_neuling',
                name: 'KL‚îÉ‚ù± Neuling‚îÉ1',
                discordRoleId: '1420630384055554069',
                emoji: 'üÜï',
                color: 'role-neuling'
            }
        ];

        // System Variablen
        let currentUser = null;
        let userRoles = [];
        let customRoles = FIXED_ROLES; // DIREKT die festen Rollen verwenden
        let actionHistory = [];
        let webhooks = {
            hiring: '',
            promotions: '',
            demotions: '',
            terminations: '',
            warnings: ''
        };

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const mainContent = document.getElementById('mainContent');
        const errorMessage = document.getElementById('errorMessage');
        const discordLoginBtn = document.getElementById('discordLogin');
        const loginLoading = document.getElementById('loginLoading');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userAvatar = document.getElementById('userAvatar');
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const userTableBody = document.getElementById('userTableBody');
        const userManagementTableBody = document.getElementById('userManagementTableBody');
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserBtn2 = document.getElementById('addUserBtn2');
        const addUserModal = document.getElementById('addUserModal');
        const cancelAddUser = document.getElementById('cancelAddUser');
        const saveUser = document.getElementById('saveUser');
        const promotionModal = document.getElementById('promotionModal');
        const cancelPromotion = document.getElementById('cancelPromotion');
        const savePromotion = document.getElementById('savePromotion');
        const demotionModal = document.getElementById('demotionModal');
        const cancelDemotion = document.getElementById('cancelDemotion');
        const saveDemotion = document.getElementById('saveDemotion');
        const terminationModal = document.getElementById('terminationModal');
        const cancelTermination = document.getElementById('cancelTermination');
        const saveTermination = document.getElementById('saveTermination');
        const warningModal = document.getElementById('warningModal');
        const cancelWarning = document.getElementById('cancelWarning');
        const saveWarning = document.getElementById('saveWarning');
        const refreshUsers = document.getElementById('refreshUsers');
        const exportUsers = document.getElementById('exportUsers');
        const roleManagement = document.getElementById('roleManagement');
        const actionHistoryContainer = document.getElementById('actionHistory');
        const notification = document.getElementById('notification');
        const userWarningBadge = document.getElementById('userWarningBadge');

        // Firebase Referenzen
        const usersRef = ref(db, 'users');
        const rolesRef = ref(db, 'roles');
        const historyRef = ref(db, 'history');
        const webhooksRef = ref(db, 'webhooks');
        const warningsRef = ref(db, 'warnings');

        // Discord OAuth Funktionen
        function startDiscordOAuth() {
            const scope = 'identify';
            const state = generateRandomState();
            
            sessionStorage.setItem('oauth_state', state);
            
            const authUrl = new URL('https://discord.com/api/oauth2/authorize');
            authUrl.searchParams.set('client_id', DISCORD_CLIENT_ID);
            authUrl.searchParams.set('redirect_uri', DISCORD_REDIRECT_URI);
            authUrl.searchParams.set('response_type', 'code');
            authUrl.searchParams.set('scope', scope);
            authUrl.searchParams.set('state', state);
            authUrl.searchParams.set('prompt', 'none');
            
            window.location.href = authUrl.toString();
        }

        function generateRandomState() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        async function exchangeCodeForToken(code) {
            try {
                loginLoading.style.display = 'block';
                discordLoginBtn.disabled = true;
                
                const response = await fetch(`${BACKEND_URL}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        code: code, 
                        redirect_uri: DISCORD_REDIRECT_URI
                    })
                });

                if (!response.ok) {
                    throw new Error(`Worker responded with status ${response.status}`);
                }

                const data = await response.json();

                if (data.access_token) {
                    await verifyUser(data.access_token);
                } else {
                    throw new Error('Kein Access Token erhalten');
                }
            } catch (error) {
                console.error('Fehler beim Token-Austausch:', error);
                showError('Fehler bei der Anmeldung. Bitte versuche es sp√§ter erneut.');
                loginLoading.style.display = 'none';
                discordLoginBtn.disabled = false;
            }
        }

        async function verifyUser(accessToken) {
            try {
                const response = await fetch(`${BACKEND_URL}/verify-user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        accessToken: accessToken,
                        currentPage: 'dashboard'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Verification failed with status ${response.status}`);
                }

                const data = await response.json();

                if (data.isAuthorized) {
                    localStorage.setItem('discord_user', JSON.stringify(data.user));
                    localStorage.setItem('discord_access_token', accessToken);
                    
                    const user = data.user;
                    currentUser = {
                        id: user.id,
                        username: user.username,
                        avatar: user.avatar
                    };
                    
                    await loadDiscordAvatar(user);
                    showMainApp();
                    showNotification(`Erfolgreich als ${user.username} angemeldet`, 'success');
                } else {
                    showError('Zugriff verweigert. Du bist nicht in der Benutzerliste eingetragen.');
                }
            } catch (error) {
                console.error('Fehler bei der Benutzer√ºberpr√ºfung:', error);
                showError('Fehler bei der Berechtigungspr√ºfung');
            } finally {
                loginLoading.style.display = 'none';
                discordLoginBtn.disabled = false;
            }
        }

        // Discord Avatar laden
        async function loadDiscordAvatar(userData) {
            try {
                if (userData.avatar) {
                    const avatarUrl = `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png?size=256`;
                    userAvatar.style.backgroundImage = `url('${avatarUrl}')`;
                    userAvatar.innerHTML = '';
                    
                    const img = new Image();
                    img.onerror = () => {
                        const firstLetter = userData.username.charAt(0).toUpperCase();
                        userAvatar.style.backgroundImage = '';
                        userAvatar.innerHTML = `<span>${firstLetter}</span>`;
                    };
                    img.src = avatarUrl;
                } else {
                    const firstLetter = userData.username.charAt(0).toUpperCase();
                    userAvatar.style.backgroundImage = '';
                    userAvatar.innerHTML = `<span>${firstLetter}</span>`;
                }
                
                userName.textContent = userData.username;
                userRole.textContent = 'Administrator';
            } catch (error) {
                console.error('Error loading Discord avatar:', error);
                userAvatar.style.backgroundImage = '';
                userAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
        }

        // Initialize the application
        function initApp() {
            const userData = localStorage.getItem('discord_user');
            const token = localStorage.getItem('discord_access_token');
            
            if (userData && token) {
                try {
                    const user = JSON.parse(userData);
                    currentUser = {
                        id: user.id,
                        username: user.username,
                        avatar: user.avatar
                    };
                    
                    loadDiscordAvatar(user);
                    showMainApp();
                    showNotification(`Willkommen zur√ºck, ${user.username}`, 'info');
                } catch (e) {
                    console.error('Fehler beim Laden der Benutzerdaten:', e);
                    showLoginPage();
                }
            } else {
                showLoginPage();
            }
            
            // Load data from Firebase
            loadFirebaseData();
            setupEventListeners();
            
            // DIREKT die Rollen initialisieren
            updateRoleSelects();
            renderRoleManagement();
        }

        // Load data from Firebase
        function loadFirebaseData() {
            // Load users
            onValue(usersRef, (snapshot) => {
                userRoles = [];
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        userRoles.push({
                            id: childSnapshot.key,
                            ...userData
                        });
                    });
                }
                populateUserTables();
            });

            // Load history
            onValue(historyRef, (snapshot) => {
                actionHistory = [];
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        actionHistory.push(childSnapshot.val());
                    });
                }
                renderActionHistory();
            });

            // Load webhooks
            onValue(webhooksRef, (snapshot) => {
                if (snapshot.exists()) {
                    webhooks = snapshot.val();
                    updateWebhookInputs();
                }
            });

            // Load warnings and show badge if there are active warnings
            onValue(warningsRef, (snapshot) => {
                if (snapshot.exists()) {
                    const warnings = [];
                    snapshot.forEach((childSnapshot) => {
                        warnings.push(childSnapshot.val());
                    });
                    
                    // Show warning badge if there are active warnings
                    const activeWarnings = warnings.filter(w => !w.resolved);
                    if (activeWarnings.length > 0) {
                        userWarningBadge.textContent = activeWarnings.length;
                        userWarningBadge.classList.remove('hidden');
                    } else {
                        userWarningBadge.classList.add('hidden');
                    }
                } else {
                    userWarningBadge.classList.add('hidden');
                }
            });
        }

        // Show login page
        function showLoginPage() {
            loginPage.classList.remove('hidden');
            mainContent.classList.add('hidden');
        }

        // Show main application
        function showMainApp() {
            loginPage.classList.add('hidden');
            mainContent.classList.remove('hidden');
        }

        // Populate user tables with data
        function populateUserTables() {
            userTableBody.innerHTML = '';
            userManagementTableBody.innerHTML = '';
            
            if (userRoles.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="5" style="text-align: center; color: var(--text-lighter); padding: 2rem;">
                        Keine Spieler eingestellt
                    </td>
                `;
                userTableBody.appendChild(emptyRow);
                userManagementTableBody.appendChild(emptyRow.cloneNode(true));
                return;
            }
            
            userRoles.forEach(user => {
                const userRow = createUserRow(user);
                userTableBody.appendChild(userRow);
                
                // F√ºr die User Management Tabelle eine Kopie erstellen
                const userRowCopy = createUserRow(user);
                userManagementTableBody.appendChild(userRowCopy);
            });
        }

        // Create a user table row
        function createUserRow(user) {
            const row = document.createElement('tr');
            
            // Find the role by roleId
            const role = customRoles.find(r => r.id === user.roleId) || { 
                name: 'Unbekannt', 
                color: 'role-founder',
                discordRoleId: ''
            };
            
            row.innerHTML = `
                <td>
                    <div class="user-cell">
                        <div class="user-avatar-small">${user.name ? user.name.charAt(0) : '?'}</div>
                        <div class="user-info-small">
                            <div class="user-name-small">${user.name || 'Unbekannt'}</div>
                            <div class="user-id">ID: ${user.userId}</div>
                        </div>
                    </div>
                </td>
                <td><span class="role-badge ${role.color}">${role.name}</span></td>
                <td>${user.date || 'Unbekannt'}</td>
                <td>${user.assignedBy || 'Unbekannt'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon btn-promote" data-user-id="${user.userId}" data-user-name="${user.name || 'Unbekannt'}">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="btn-icon btn-demote" data-user-id="${user.userId}" data-user-name="${user.name || 'Unbekannt'}">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="btn-icon btn-warning" data-user-id="${user.userId}" data-user-name="${user.name || 'Unbekannt'}">
                            <i class="fas fa-exclamation-triangle"></i>
                        </button>
                        <button class="btn-icon btn-terminate" data-user-id="${user.userId}" data-user-name="${user.name || 'Unbekannt'}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </td>
            `;
            
            return row;
        }

        // Render role management
        function renderRoleManagement() {
            roleManagement.innerHTML = '';
            
            customRoles.forEach((role, index) => {
                const roleCard = document.createElement('div');
                roleCard.className = 'role-card';
                roleCard.innerHTML = `
                    <div class="role-emoji">${role.emoji || 'üë§'}</div>
                    <div class="role-name">${role.name}</div>
                    <div class="role-id">ID: ${role.discordRoleId}</div>
                    <div class="role-badge ${role.color}" style="margin-top: 0.5rem;">${role.name}</div>
                `;
                roleManagement.appendChild(roleCard);
            });
        }

        // Update role selects in modals
        function updateRoleSelects() {
            const roleSelects = [
                document.getElementById('userRoleSelect'),
                document.getElementById('promotionRoleSelect'),
                document.getElementById('demotionRoleSelect')
            ];

            roleSelects.forEach(select => {
                if (select) {
                    select.innerHTML = '';
                    customRoles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = role.name;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Update webhook inputs
        function updateWebhookInputs() {
            document.getElementById('webhookHiring').value = webhooks.hiring || '';
            document.getElementById('webhookPromotions').value = webhooks.promotions || '';
            document.getElementById('webhookDemotions').value = webhooks.demotions || '';
            document.getElementById('webhookTerminations').value = webhooks.terminations || '';
            document.getElementById('webhookWarnings').value = webhooks.warnings || '';
        }

        // Render action history
        function renderActionHistory() {
            actionHistoryContainer.innerHTML = '';
            
            if (actionHistory.length === 0) {
                actionHistoryContainer.innerHTML = '<p style="color: var(--text-lighter); text-align: center;">Keine Aktionen vorhanden</p>';
                return;
            }
            
            // Sort by timestamp descending and take last 10
            const recentHistory = [...actionHistory]
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10);
            
            recentHistory.forEach(action => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                let actionIcon = 'üìù';
                let actionText = '';
                
                switch (action.type) {
                    case 'hiring':
                        actionIcon = 'üéÆ';
                        actionText = `Spieler <strong>${action.userName}</strong> wurde als <strong>${action.roleName}</strong> eingestellt`;
                        break;
                    case 'promotion':
                        actionIcon = 'üéñÔ∏è';
                        actionText = `Spieler <strong>${action.userName}</strong> wurde zum <strong>${action.roleName}</strong> bef√∂rdert`;
                        break;
                    case 'demotion':
                        actionIcon = 'üìâ';
                        actionText = `Spieler <strong>${action.userName}</strong> wurde zum <strong>${action.roleName}</strong> degradiert`;
                        break;
                    case 'termination':
                        actionIcon = 'üö™';
                        actionText = `Spieler <strong>${action.userName}</strong> wurde gek√ºndigt`;
                        break;
                    case 'warning':
                        actionIcon = '‚ö†Ô∏è';
                        actionText = `Spieler <strong>${action.userName}</strong> hat eine Verwarnung erhalten`;
                        break;
                }
                
                if (action.reason) {
                    actionText += `. Grund: "${action.reason}"`;
                }
                
                historyItem.innerHTML = `
                    <div class="history-header">
                        <div class="history-action">${actionIcon} ${action.type}</div>
                        <div class="history-date">${new Date(action.timestamp).toLocaleString('de-DE')}</div>
                    </div>
                    <div class="history-details">
                        ${actionText}
                    </div>
                `;
                
                actionHistoryContainer.appendChild(historyItem);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Discord login
            discordLoginBtn.addEventListener('click', startDiscordOAuth);
            
            // Logout
            logoutBtn.addEventListener('click', handleLogout);
            
            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tab = this.getAttribute('data-tab');
                    switchTab(tab);
                });
            });
            
            // Add user buttons
            addUserBtn.addEventListener('click', () => addUserModal.classList.add('active'));
            addUserBtn2.addEventListener('click', () => addUserModal.classList.add('active'));
            
            // Modal actions
            cancelAddUser.addEventListener('click', () => {
                addUserModal.classList.remove('active');
                document.getElementById('hiringReason').value = ''; // Grund-Feld leeren
                document.getElementById('playerName').value = ''; // Name-Feld leeren
            });
            saveUser.addEventListener('click', handleAddUser);
            cancelPromotion.addEventListener('click', () => promotionModal.classList.remove('active'));
            savePromotion.addEventListener('click', handlePromotion);
            cancelDemotion.addEventListener('click', () => demotionModal.classList.remove('active'));
            saveDemotion.addEventListener('click', handleDemotion);
            cancelTermination.addEventListener('click', () => terminationModal.classList.remove('active'));
            saveTermination.addEventListener('click', handleTermination);
            cancelWarning.addEventListener('click', () => warningModal.classList.remove('active'));
            saveWarning.addEventListener('click', handleWarning);
            
            // Refresh and export buttons
            refreshUsers.addEventListener('click', () => {
                showNotification('Benutzerliste aktualisiert', 'success');
            });
            
            exportUsers.addEventListener('click', () => {
                showNotification('Benutzerliste exportiert', 'success');
            });
            
            // Webhook buttons
            document.querySelectorAll('.test-webhook').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    testWebhook(type);
                });
            });
            
            document.querySelectorAll('.save-webhook').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    saveWebhook(type);
                });
            });
            
            // Card clicks
            document.querySelectorAll('.card').forEach(card => {
                card.addEventListener('click', function() {
                    if (!this.classList.contains('disabled')) {
                        const page = this.getAttribute('data-page');
                        const pageUrl = PAGE_URLS[page];
                        
                        if (pageUrl) {
                            showNotification(`Weiterleitung zu ${page}...`, 'info', 1500);
                            setTimeout(() => {
                                window.location.href = pageUrl;
                            }, 1500);
                        } else {
                            showNotification(`Seite ${page} nicht gefunden`, 'error');
                        }
                    }
                });
            });
            
            // Action buttons in tables
            document.addEventListener('click', function(e) {
                if (e.target.closest('.btn-promote')) {
                    const userId = e.target.closest('.btn-promote').getAttribute('data-user-id');
                    const userName = e.target.closest('.btn-promote').getAttribute('data-user-name');
                    openPromotionModal(userId, userName);
                }
                
                if (e.target.closest('.btn-demote')) {
                    const userId = e.target.closest('.btn-demote').getAttribute('data-user-id');
                    const userName = e.target.closest('.btn-demote').getAttribute('data-user-name');
                    openDemotionModal(userId, userName);
                }
                
                if (e.target.closest('.btn-warning')) {
                    const userId = e.target.closest('.btn-warning').getAttribute('data-user-id');
                    const userName = e.target.closest('.btn-warning').getAttribute('data-user-name');
                    openWarningModal(userId, userName);
                }
                
                if (e.target.closest('.btn-terminate')) {
                    const userId = e.target.closest('.btn-terminate').getAttribute('data-user-id');
                    const userName = e.target.closest('.btn-terminate').getAttribute('data-user-name');
                    openTerminationModal(userId, userName);
                }
            });
        }

        // Handle logout
        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('discord_user');
            localStorage.removeItem('discord_access_token');
            showLoginPage();
            showNotification('Erfolgreich abgemeldet', 'info');
        }

        // Switch between tabs
        function switchTab(tabName) {
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-tab') === tabName) {
                    item.classList.add('active');
                }
            });
            
            tabContents.forEach(tab => {
                tab.classList.add('hidden');
                if (tab.id === tabName) {
                    tab.classList.remove('hidden');
                }
            });
        }

        // Handle adding a new user
        async function handleAddUser() {
            const userId = document.getElementById('discordUserId').value;
            const playerName = document.getElementById('playerName').value;
            const roleId = document.getElementById('userRoleSelect').value;
            const reason = document.getElementById('hiringReason').value || "Neueinstellung";
            
            if (!userId) {
                showNotification('Bitte geben Sie eine User ID ein', 'error');
                return;
            }
            
            if (!playerName) {
                showNotification('Bitte geben Sie einen Spieler Namen ein', 'error');
                return;
            }
            
            if (!/^\d+$/.test(userId)) {
                showNotification('Bitte geben Sie eine g√ºltige Discord User ID ein (nur Zahlen)', 'error');
                return;
            }
            
            const selectedRole = customRoles.find(r => r.id === roleId);
            if (!selectedRole) {
                showNotification('Bitte w√§hlen Sie eine g√ºltige Rolle aus', 'error');
                return;
            }
            
            const userData = {
                userId: userId,
                name: playerName,
                roleId: roleId,
                date: new Date().toLocaleDateString('de-DE'),
                assignedBy: currentUser.username,
                timestamp: new Date().toISOString()
            };
            
            try {
                // Save to Firebase
                const newUserRef = push(usersRef);
                await set(newUserRef, userData);
                
                // Add to history
                const historyData = {
                    type: 'hiring',
                    userId: userId,
                    userName: playerName,
                    roleName: selectedRole.name,
                    reason: reason,
                    executedBy: currentUser.username,
                    timestamp: new Date().toISOString()
                };
                await push(historyRef, historyData);
                
                // Send to Discord if webhook is configured
                if (webhooks.hiring) {
                    await sendToDiscord(webhooks.hiring, {
                        title: "üéÆ Einstellung",
                        description: `**Hiermit wird** <@${userId}> **als** <@&${selectedRole.discordRoleId **eingestellt.**|| 'unknown-role'}>.\n\n**Grund:** ${reason}`,
                        color: 0x00ff00
                    });
                }
                
                addUserModal.classList.remove('active');
                showNotification(`Spieler ${playerName} erfolgreich eingestellt`, 'success');
                document.getElementById('discordUserId').value = '';
                document.getElementById('playerName').value = '';
                document.getElementById('hiringReason').value = ''; // Feld leeren
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                showNotification('Fehler beim Speichern des Spielers', 'error');
            }
        }

        // Open promotion modal
        function openPromotionModal(userId, userName) {
            document.getElementById('promotionUserId').value = userId;
            document.getElementById('promotionReason').value = '';
            promotionModal.classList.add('active');
        }

        // Handle promotion
        async function handlePromotion() {
            const userId = document.getElementById('promotionUserId').value;
            const roleId = document.getElementById('promotionRoleSelect').value;
            const reason = document.getElementById('promotionReason').value;
            
            const selectedRole = customRoles.find(r => r.id === roleId);
            if (!selectedRole) {
                showNotification('Bitte w√§hlen Sie eine g√ºltige Rolle aus', 'error');
                return;
            }
            
            try {
                // Find and update user in Firebase
                const userSnapshot = await get(usersRef);
                let userKey = null;
                let currentUserData = null;
                
                userSnapshot.forEach((childSnapshot) => {
                    const userData = childSnapshot.val();
                    if (userData.userId === userId) {
                        userKey = childSnapshot.key;
                        currentUserData = userData;
                    }
                });
                
                if (userKey && currentUserData) {
                    // ALLE Benutzerdaten behalten, nur die Rolle aktualisieren
                    const updatedUserData = {
                        ...currentUserData,
                        roleId: roleId
                    };
                    
                    const userRef = ref(db, `users/${userKey}`);
                    await set(userRef, updatedUserData);
                    
                    // Add to history
                    const historyData = {
                        type: 'promotion',
                        userId: userId,
                        userName: currentUserData.name,
                        roleName: selectedRole.name,
                        reason: reason || 'Kein Grund angegeben',
                        executedBy: currentUser.username,
                        timestamp: new Date().toISOString()
                    };
                    await push(historyRef, historyData);
                    
                    // Send to Discord if webhook is configured
                    if (webhooks.promotions) {
                        await sendToDiscord(webhooks.promotions, {
                            title: "üéñÔ∏è Bef√∂rderung",
                            description: `**Hiermit wurde** <@${userId}> **zum** <@&${selectedRole.discordRoleId **Bef√∂rdert.**|| 'unknown-role'}>.\n\n**Grund:** ${reason || "Kein Grund angegeben"}`,
                            color: 0xffd700
                        });
                    }
                    
                    promotionModal.classList.remove('active');
                    showNotification(`Spieler ${currentUserData.name} wurde bef√∂rdert`, 'success');
                } else {
                    showNotification(`Spieler nicht gefunden`, 'error');
                }
            } catch (error) {
                console.error('Fehler bei der Bef√∂rderung:', error);
                showNotification('Fehler bei der Bef√∂rderung', 'error');
            }
        }

        // Open demotion modal
        function openDemotionModal(userId, userName) {
            document.getElementById('demotionUserId').value = userId;
            document.getElementById('demotionReason').value = '';
            demotionModal.classList.add('active');
        }

        // Handle demotion
        async function handleDemotion() {
            const userId = document.getElementById('demotionUserId').value;
            const roleId = document.getElementById('demotionRoleSelect').value;
            const reason = document.getElementById('demotionReason').value;
            
            const selectedRole = customRoles.find(r => r.id === roleId);
            if (!selectedRole) {
                showNotification('Bitte w√§hlen Sie eine g√ºltige Rolle aus', 'error');
                return;
            }
            
            try {
                // Find and update user in Firebase
                const userSnapshot = await get(usersRef);
                let userKey = null;
                let currentUserData = null;
                
                userSnapshot.forEach((childSnapshot) => {
                    const userData = childSnapshot.val();
                    if (userData.userId === userId) {
                        userKey = childSnapshot.key;
                        currentUserData = userData;
                    }
                });
                
                if (userKey && currentUserData) {
                    // ALLE Benutzerdaten behalten, nur die Rolle aktualisieren
                    const updatedUserData = {
                        ...currentUserData,
                        roleId: roleId
                    };
                    
                    const userRef = ref(db, `users/${userKey}`);
                    await set(userRef, updatedUserData);
                    
                    // Add to history
                    const historyData = {
                        type: 'demotion',
                        userId: userId,
                        userName: currentUserData.name,
                        roleName: selectedRole.name,
                        reason: reason || 'Kein Grund angegeben',
                        executedBy: currentUser.username,
                        timestamp: new Date().toISOString()
                    };
                    await push(historyRef, historyData);
                    
                    // Send to Discord if webhook is configured
                    if (webhooks.demotions) {
                        await sendToDiscord(webhooks.demotions, {
                            title: "üìâ Degradierung",
                            description: `**Hiermit wird** <@${userId}> **zum** <@&${selectedRole.discordRoleId **Degradiert**|| 'unknown-role'}>.\n\n**Grund:** ${reason || "Kein Grund angegeben"}`,
                            color: 0xffa500
                        });
                    }
                    
                    demotionModal.classList.remove('active');
                    showNotification(`Spieler ${currentUserData.name} wurde degradiert`, 'warning');
                } else {
                    showNotification(`Spieler nicht gefunden`, 'error');
                }
            } catch (error) {
                console.error('Fehler bei der Degradierung:', error);
                showNotification('Fehler bei der Degradierung', 'error');
            }
        }

        // Open warning modal
        function openWarningModal(userId, userName) {
            document.getElementById('warningUserId').value = userId;
            document.getElementById('warningReason').value = '';
            warningModal.classList.add('active');
        }

        // Handle warning
        async function handleWarning() {
            const userId = document.getElementById('warningUserId').value;
            const reason = document.getElementById('warningReason').value;
            
            if (!userId) {
                showNotification('Ung√ºltige User ID', 'error');
                return;
            }
            
            if (!reason) {
                showNotification('Bitte geben Sie einen Grund f√ºr die Verwarnung an', 'error');
                return;
            }
            
            try {
                // Find user in Firebase
                const userSnapshot = await get(usersRef);
                let currentUserData = null;
                
                userSnapshot.forEach((childSnapshot) => {
                    const userData = childSnapshot.val();
                    if (userData.userId === userId) {
                        currentUserData = userData;
                    }
                });
                
                if (currentUserData) {
                    // Save warning to Firebase
                    const warningData = {
                        userId: userId,
                        userName: currentUserData.name,
                        reason: reason,
                        executedBy: currentUser.username,
                        timestamp: new Date().toISOString(),
                        resolved: false
                    };
                    
                    await push(warningsRef, warningData);
                    
                    // Add to history
                    const historyData = {
                        type: 'warning',
                        userId: userId,
                        userName: currentUserData.name,
                        roleName: '',
                        reason: reason,
                        executedBy: currentUser.username,
                        timestamp: new Date().toISOString()
                    };
                    await push(historyRef, historyData);
                    
                    // Send to Discord if webhook is configured
                    if (webhooks.warnings) {
                        await sendToDiscord(webhooks.warnings, {
                            title: "‚ö†Ô∏è Team Verwarnung",
                            description: `**Familien Updates**\n\n**Hiermit erh√§lt** <@${userId}> **eine Verwarnung.*\n\n**Grund:** ${reason}`,
                            color: 0xff0000
                        });
                    }
                    
                    warningModal.classList.remove('active');
                    showNotification(`Verwarnung an Spieler ${currentUserData.name} gesendet`, 'warning');
                } else {
                    showNotification(`Spieler nicht gefunden`, 'error');
                }
            } catch (error) {
                console.error('Fehler beim Senden der Verwarnung:', error);
                showNotification('Fehler beim Senden der Verwarnung', 'error');
            }
        }

        // Open termination modal
        function openTerminationModal(userId, userName) {
            document.getElementById('terminationUserId').value = userId;
            document.getElementById('terminationReason').value = '';
            terminationModal.classList.add('active');
        }

        // Handle termination
        async function handleTermination() {
            const userId = document.getElementById('terminationUserId').value;
            const reason = document.getElementById('terminationReason').value;
            
            if (!userId) {
                showNotification('Ung√ºltige User ID', 'error');
                return;
            }
            
            try {
                // Find and remove user from Firebase
                const userSnapshot = await get(usersRef);
                let userKey = null;
                let currentUserData = null;
                
                userSnapshot.forEach((childSnapshot) => {
                    const userData = childSnapshot.val();
                    if (userData.userId === userId) {
                        userKey = childSnapshot.key;
                        currentUserData = userData;
                    }
                });
                
                if (userKey && currentUserData) {
                    const userRef = ref(db, `users/${userKey}`);
                    await remove(userRef);
                    
                    // UI sofort aktualisieren
                    populateUserTables();
                    
                    // Add to history
                    const historyData = {
                        type: 'termination',
                        userId: userId,
                        userName: currentUserData.name,
                        roleName: '',
                        reason: reason || 'Kein Grund angegeben',
                        executedBy: currentUser.username,
                        timestamp: new Date().toISOString()
                    };
                    await push(historyRef, historyData);
                    
                    // Send to Discord if webhook is configured
                    if (webhooks.terminations) {
                        await sendToDiscord(webhooks.terminations, {
                            title: "üì¢ Blood Out",
                            description: `**Hiermit bekommt** <@${userId}> **offiziell seinen blood out.**\n\n**Grund:** ${reason || "Kein Grund angegeben"}`,
                            color: 0xff0000
                        });
                    }
                    
                    terminationModal.classList.remove('active');
                    showNotification(`Spieler ${currentUserData.name} wurde gek√ºndigt`, 'success');
                } else {
                    showNotification(`Spieler nicht gefunden`, 'error');
                }
            } catch (error) {
                console.error('Fehler bei der K√ºndigung:', error);
                showNotification('Fehler bei der K√ºndigung', 'error');
            }
        }

        // Test webhook
        async function testWebhook(type) {
            const url = document.getElementById(`webhook${type.charAt(0).toUpperCase() + type.slice(1)}`).value;
            
            if (!url) {
                showNotification('Bitte geben Sie eine Webhook URL ein', 'error');
                return;
            }
            
            if (!url.startsWith('https://discord.com/api/webhooks/')) {
                showNotification('Bitte geben Sie eine g√ºltige Discord Webhook URL ein', 'error');
                return;
            }
            
            try {
                await sendToDiscord(url, {
                    title: "üîß Webhook Test",
                    description: `Dies ist ein Test f√ºr den ${type} Webhook.`,
                    color: 0x00ff00
                });
                showNotification('Webhook Test erfolgreich gesendet', 'success');
            } catch (error) {
                showNotification('Webhook Test fehlgeschlagen', 'error');
            }
        }

        // Save webhook
        async function saveWebhook(type) {
            const url = document.getElementById(`webhook${type.charAt(0).toUpperCase() + type.slice(1)}`).value;
            
            if (!url) {
                showNotification('Bitte geben Sie eine Webhook URL ein', 'error');
                return;
            }
            
            if (!url.startsWith('https://discord.com/api/webhooks/')) {
                showNotification('Bitte geben Sie eine g√ºltige Discord Webhook URL ein', 'error');
                return;
            }
            
            try {
                webhooks[type] = url;
                await set(webhooksRef, webhooks);
                showNotification('Webhook URL erfolgreich gespeichert', 'success');
            } catch (error) {
                console.error('Fehler beim Speichern des Webhooks:', error);
                showNotification('Fehler beim Speichern des Webhooks', 'error');
            }
        }

        // Send message to Discord
        async function sendToDiscord(webhookUrl, embed) {
            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    embeds: [{
                        title: embed.title,
                        description: embed.description,
                        color: embed.color
                    }]
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to send Discord message');
            }
            
            return true;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 300);
            }, 4000);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            
            // Check for OAuth code in URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            
            if (code && state) {
                const newUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                exchangeCodeForToken(code);
            }
        });
    </script>
</body>
</html>
